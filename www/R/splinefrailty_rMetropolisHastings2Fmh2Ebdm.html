<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="../robodoc.css" type="text/css" />
<title>./splinesurv/R/splinefrailty.r</title>
<!-- Source: ./splinesurv/R/splinefrailty.r -->
<!-- Generated with ROBODoc Version 4.99.36 (Jun 17 2008) -->
</head>
<body>
<div id="logo">
<a name="robo_top_of_doc">splinesurv</a>
</div> <!-- logo -->
<div id="navigation">
<a class="menuitem" href="./splinefrailty_rRFitting2FMetropolisHastings.html#robo17">MetropolisHastings</a><a class="menuitem" href="../robo_functions.html#robo_top_of_doc">Functions</a></div> <!-- navigation -->
<div id="content">
<h3>TABLE OF CONTENTS</h3>
<ul>
<li>1. <a href="#robo143">MetropolisHastings/mh.bdm</a></li>
</ul>
<hr />
<a name="MetropolisHastings2fmh2ebdm"></a>
<a name="robo143"></a><h2>MetropolisHastings/mh.bdm [ Functions ]</h2>

<p class="item_name">NAME</p>
<pre>    <strong>mh.bdm</strong> --- RJMCMC for Birth-death-move steps
</pre>
<p class="item_name">FUNCTION</p>
<p>    This function handles the reversible-jump MCMC steps for adding, removing, or moving
    knots in the adaptive knot selection procedure. It can work with either the hazard
    or frailty curve.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2896 </span><strong>mh.bdm</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span><span class="keyword">which</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    which      string, can be either "hazard" or "frailty"
    hazard     <a href="./splinefrailty_r01structures2FRCurve.html#robo26">RCurve</a> for hazard
    frailty    <a href="./splinefrailty_r01structures2FRCurve.html#robo26">RCurve</a> for frailty
    regression <a href="./splinefrailty_r01structures2FRRegression.html#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      updated <a href="./splinefrailty_r01structures2FRCurve.html#robo26">RCurve</a> for either hazard or frailty
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2899 </span><span class="sign">{</span>
<span class="line_number">2900 </span>    <span class="comment"># get all the needed components</span>
<span class="line_number">2901 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> curve <span class="sign">&lt;</span><span class="sign">-</span> hazard
<span class="line_number">2902 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> curve <span class="sign">&lt;</span><span class="sign">-</span> frailty
<span class="line_number">2903 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>curve<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2904 </span>    knots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>knots
<span class="line_number">2905 </span>    ord <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ord
<span class="line_number">2906 </span>    params <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>par
<span class="line_number">2907 </span>    nknots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots
<span class="line_number">2908 </span>    candknots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>candknots
<span class="line_number">2909 </span>    ncandknots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ncandknots
<span class="line_number">2910 </span>    occ <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span>
<span class="line_number">2911 </span>    occind <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">which</span><span class="sign">(</span>occ <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span>
<span class="line_number">2912 </span>    <span class="comment"># evaluate the prior probability of k knots, k+1 knots, and k-1 knots</span>
<span class="line_number">2913 </span>    pk <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rsplineUtils2FnknotsPrior.html#robo187">nknotsPrior</a><span class="sign">(</span>nknots<span class="sign">,</span> curve<span class="sign">)</span>
<span class="line_number">2914 </span>    pkp1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>nknots <span class="sign">&lt;</span> curve<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">)</span> <a href="./splinefrailty_rsplineUtils2FnknotsPrior.html#robo187">nknotsPrior</a><span class="sign">(</span>nknots <span class="sign">+</span> 1<span class="sign">,</span> curve<span class="sign">)</span> <span class="keyword">else</span> 0
<span class="line_number">2915 </span>    pkm1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>nknots <span class="sign">&gt;</span> 1<span class="sign">)</span> <a href="./splinefrailty_rsplineUtils2FnknotsPrior.html#robo187">nknotsPrior</a><span class="sign">(</span>nknots <span class="sign">-</span> 1<span class="sign">,</span> curve<span class="sign">)</span> <span class="keyword">else</span> 0
<span class="line_number">2916 </span>    <span class="comment"># compute probability of birth, death and move steps</span>
<span class="line_number">2917 </span>    pb <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>bdmconst <span class="sign">*</span> min<span class="sign">(</span>1<span class="sign">,</span> pkp1 <span class="sign">/</span> pk<span class="sign">)</span> <span class="comment"># P(birth)</span>
<span class="line_number">2918 </span>    pd <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>bdmconst <span class="sign">*</span> min<span class="sign">(</span>1<span class="sign">,</span> pkm1 <span class="sign">/</span> pk<span class="sign">)</span> <span class="comment"># P(death)</span>
<span class="line_number">2919 </span>    pm <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>0<span class="sign">,</span> 1 <span class="sign">-</span> pb <span class="sign">-</span> pd<span class="sign">)</span> <span class="comment"># P(move)</span>
<span class="line_number">2920 </span>    u <span class="sign">&lt;</span><span class="sign">-</span> runif<span class="sign">(</span>1<span class="sign">)</span>
<span class="line_number">2921 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> 
<span class="line_number">2922 </span>        baselik <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Espline2Ehaz.html#robo137">mklik.spline.haz</a><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2923 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> 
<span class="line_number">2924 </span>        baselik <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Espline2Efrail.html#robo135">mklik.spline.frail</a><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2925 </span>    <span class="keyword">if</span><span class="sign">(</span>u <span class="sign">&lt;</span> pd<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2926 </span>        <span class="comment"># Death step</span>
<span class="line_number">2927 </span>        j <span class="sign">&lt;</span><span class="sign">-</span> sample<span class="sign">(</span>1<span class="sign">:</span>nknots<span class="sign">,</span> 1<span class="sign">)</span> <span class="sign">+</span> ord <span class="comment"># index of dying knot</span>
<span class="line_number">2928 </span>        x <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span>j<span class="sign">]</span>
<span class="line_number">2929 </span>            <span class="comment">#cat("Remove knot ", j, " at ", knots[j], "(occ", occ[occind[j - ord]], ")\n")</span>
<span class="line_number">2930 </span>        knots2 <span class="sign">&lt;</span><span class="sign">-</span> knots
<span class="line_number">2931 </span>        params2 <span class="sign">&lt;</span><span class="sign">-</span> params
<span class="line_number">2932 </span>        knots2 <span class="sign">&lt;</span><span class="sign">-</span> knots2<span class="sign">[</span> <span class="sign">-</span> j<span class="sign">]</span> <span class="comment"># remove the knot</span>
<span class="line_number">2933 </span>        <span class="comment"># update parameters symetrically to birth step</span>
<span class="line_number">2934 </span>        params2 <span class="sign">&lt;</span><span class="sign">-</span> params2<span class="sign">[</span> <span class="sign">-</span> <span class="sign">(</span>j <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2935 </span>        <span class="keyword">if</span><span class="sign">(</span>ord <span class="sign">&gt;</span> 2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span>j2 in <span class="sign">(</span>j <span class="sign">-</span> ord <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span>j <span class="sign">-</span> 2<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2936 </span>             r2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>x <span class="sign">-</span> knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>knots2<span class="sign">[</span>j2 <span class="sign">+</span> ord <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">-</span> knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2937 </span>             inner <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">/</span> r2 <span class="sign">*</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> <span class="sign">(</span>1 <span class="sign">-</span> r2<span class="sign">)</span> <span class="sign">/</span> r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2 <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2938 </span>             <span class="keyword">if</span><span class="sign">(</span>inner <span class="sign">&gt;</span> 0<span class="sign">)</span> params2<span class="sign">[</span>j2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>inner<span class="sign">)</span> <span class="keyword">else</span> params2<span class="sign">[</span>j2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>min
<span class="line_number">2939 </span>        <span class="sign">}</span>
<span class="line_number">2940 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"boundary"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"boundary"</span><span class="sign">)</span>
<span class="line_number">2941 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"order"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"order"</span><span class="sign">)</span>
<span class="line_number">2942 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"index"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">:</span><span class="sign">(</span>nknots <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">-</span> ord
<span class="line_number">2943 </span>        <span class="comment"># create a temporary curve that is identical to the original, except for</span>
<span class="line_number">2944 </span>        <span class="comment"># the spline.knots and spline.params components</span>
<span class="line_number">2945 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> curve
<span class="line_number">2946 </span>        temp<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> knots2
<span class="line_number">2947 </span>        temp<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> nknots <span class="sign">-</span> 1
<span class="line_number">2948 </span>        occ2 <span class="sign">&lt;</span><span class="sign">-</span> occ<span class="sign">;</span> occ2<span class="sign">[</span>occind<span class="sign">[</span>j <span class="sign">-</span> ord<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2949 </span>        attr<span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> occ2
<span class="line_number">2950 </span>        <span class="comment"># Compute the spline basis of the temp curve</span>
<span class="line_number">2951 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rsplineUtils2Fmakesplinebasis.html#robo184">makesplinebasis</a><span class="sign">(</span>temp<span class="sign">)</span>
<span class="line_number">2952 </span>        <span class="comment"># Jacobian of the transformation</span>
<span class="line_number">2953 </span>        J <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j <span class="sign">-</span> 2<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2954 </span>        <span class="keyword">if</span><span class="sign">(</span>ord <span class="sign">&gt;</span> 2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span>j2 in <span class="sign">(</span>j <span class="sign">-</span> ord <span class="sign">+</span> 2<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span>j <span class="sign">-</span> 2<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2955 </span>            r2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>x <span class="sign">-</span> knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>knots2<span class="sign">[</span>j2 <span class="sign">+</span> ord <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">-</span> knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2956 </span>            J <span class="sign">&lt;</span><span class="sign">-</span> J <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2957 </span>        <span class="sign">}</span>
<span class="line_number">2958 </span>        <span class="comment"># candidate likelihood</span>
<span class="line_number">2959 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2960 </span>            temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fupdatespline.html#robo110">updatespline</a><span class="sign">(</span>temp<span class="sign">,</span> params2<span class="sign">)</span>
<span class="line_number">2961 </span>            candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Espline2Ehaz.html#robo137">mklik.spline.haz</a><span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> temp<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2962 </span>        <span class="sign">}</span>
<span class="line_number">2963 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2964 </span>            <span class="comment"># for the frailty, adjust the mean to make sure it is 1</span>
<span class="line_number">2965 </span>            newmean <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp <span class="sign">-</span>
<span class="line_number">2966 </span>                <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j <span class="sign">-</span> 2<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>j <span class="sign">-</span> 2<span class="sign">]</span>
<span class="line_number">2967 </span>            newinner <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>newmean <span class="sign">/</span> temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>j <span class="sign">-</span> 2<span class="sign">]</span>
<span class="line_number">2968 </span>            <span class="keyword">if</span><span class="sign">(</span>newinner <span class="sign">&lt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2969 </span>                candlik<span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>Inf
<span class="line_number">2970 </span>            <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2971 </span>                params2<span class="sign">[</span>j <span class="sign">-</span> 2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>newinner<span class="sign">)</span>
<span class="line_number">2972 </span>                temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fupdatespline.html#robo110">updatespline</a><span class="sign">(</span>temp<span class="sign">,</span> params2<span class="sign">)</span>
<span class="line_number">2973 </span>                candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Espline2Efrail.html#robo135">mklik.spline.frail</a><span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> temp<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2974 </span>            <span class="sign">}</span>
<span class="line_number">2975 </span>        <span class="sign">}</span>
<span class="line_number">2976 </span>        <span class="comment"># compute acceptance ratio, and accept-reject</span>
<span class="line_number">2977 </span>        ratio <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sqrt</span><span class="sign">(</span>2 <span class="sign">*</span> pi <span class="sign">*</span> curve<span class="sign">$</span>spline<span class="sign">.</span>priorvar<span class="sign">)</span> <span class="sign">*</span> abs<span class="sign">(</span>J<span class="sign">)</span>
<span class="line_number">2978 </span>        acc <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Facceptreject.html#robo141">acceptreject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> ratio<span class="sign">)</span>
<span class="line_number">2979 </span>            <span class="comment">#cat("Lik: ", baselik, candlik, J, ratio, acc, "\n")</span>
<span class="line_number">2980 </span>        <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>knots2<span class="sign">[</span><span class="sign">(</span>ord <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>knots2<span class="sign">)</span> <span class="sign">-</span> ord<span class="sign">)</span><span class="sign">]</span> <span class="sign">!</span><span class="sign">=</span> candknots<span class="sign">[</span>occ2 <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">2981 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>temp<span class="sign">)</span> <span class="keyword">else</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">2982 </span>    <span class="sign">}</span>
<span class="line_number">2983 </span>
<span class="line_number">2984 </span>    <span class="keyword">if</span><span class="sign">(</span>u <span class="sign">&gt;</span> pd <span class="sign">&amp;</span> u <span class="sign">&lt;</span> pd <span class="sign">+</span> pb<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2985 </span>        <span class="comment"># Birth of a knot</span>
<span class="line_number">2986 </span>        params <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>par
<span class="line_number">2987 </span>        <span class="comment"># choose an unoccupied candidate knot location at random</span>
<span class="line_number">2988 </span>        birthind <span class="sign">&lt;</span><span class="sign">-</span> occind<span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">2989 </span>        <span class="keyword">while</span><span class="sign">(</span>occ<span class="sign">[</span>birthind<span class="sign">]</span> <span class="sign">&gt;</span> 0<span class="sign">)</span> birthind <span class="sign">&lt;</span><span class="sign">-</span> floor<span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">,</span> 1<span class="sign">,</span> ncandknots <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">+</span> ord
<span class="line_number">2990 </span>        <span class="comment"># get the position and interval of candidate knot</span>
<span class="line_number">2991 </span>        x <span class="sign">&lt;</span><span class="sign">-</span> candknots<span class="sign">[</span>birthind<span class="sign">]</span>
<span class="line_number">2992 </span>        i <span class="sign">&lt;</span><span class="sign">-</span> findInterval<span class="sign">(</span>x<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">2993 </span>            <span class="comment">#cat("Birth at ", x, " after knot ", i, "\n");</span>
<span class="line_number">2994 </span>        <span class="comment"># Compute new knots and parameters</span>
<span class="line_number">2995 </span>        knots2 <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>knots<span class="sign">[</span>1<span class="sign">:</span>i<span class="sign">]</span><span class="sign">,</span> x<span class="sign">,</span> knots<span class="sign">[</span><span class="sign">(</span>i <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>knots<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2996 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"boundary"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"boundary"</span><span class="sign">)</span>
<span class="line_number">2997 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"order"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"order"</span><span class="sign">)</span>
<span class="line_number">2998 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"index"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">:</span><span class="sign">(</span>nknots <span class="sign">+</span> 1<span class="sign">)</span> <span class="sign">-</span> ord
<span class="line_number">2999 </span>        params2 <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>params<span class="sign">[</span>1<span class="sign">:</span><span class="sign">(</span>i <span class="sign">-</span> ord <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> 0<span class="sign">,</span> params<span class="sign">[</span><span class="sign">(</span>i <span class="sign">-</span> ord <span class="sign">+</span> 2<span class="sign">)</span><span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>params<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">3000 </span>        <span class="comment"># Even though it is possible to add a knot non-destructively, we need to generate</span>
<span class="line_number">3001 </span>        <span class="comment"># another random number to maintain dimension matching and detailed balance</span>
<span class="line_number">3002 </span>        <span class="keyword">for</span><span class="sign">(</span>i2 in <span class="sign">(</span>i <span class="sign">-</span> ord <span class="sign">+</span> 2<span class="sign">)</span><span class="sign">:</span>i<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3003 </span>            r2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>x <span class="sign">-</span> knots<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>knots<span class="sign">[</span>i2 <span class="sign">+</span> ord <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">-</span> knots<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">3004 </span>            <span class="keyword">if</span><span class="sign">(</span>i2 <span class="sign">=</span><span class="sign">=</span> i<span class="sign">)</span> r2 <span class="sign">&lt;</span><span class="sign">-</span> runif<span class="sign">(</span>1<span class="sign">)</span>
<span class="line_number">3005 </span>            params2<span class="sign">[</span>i2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span> <span class="sign">+</span> <span class="sign">(</span>1 <span class="sign">-</span> r2<span class="sign">)</span> <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>i2 <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3006 </span>        <span class="sign">}</span>
<span class="line_number">3007 </span>        <span class="comment"># Create a temp curve with new knots and params</span>
<span class="line_number">3008 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> curve
<span class="line_number">3009 </span>        temp<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> knots2
<span class="line_number">3010 </span>        temp<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> nknots <span class="sign">+</span> 1
<span class="line_number">3011 </span>        occ2 <span class="sign">&lt;</span><span class="sign">-</span> occ<span class="sign">;</span> occ2<span class="sign">[</span>birthind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">3012 </span>        attr<span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> occ2
<span class="line_number">3013 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rsplineUtils2Fmakesplinebasis.html#robo184">makesplinebasis</a><span class="sign">(</span>temp<span class="sign">)</span>
<span class="line_number">3014 </span>        <span class="comment"># Jacobian of the transformation</span>
<span class="line_number">3015 </span>        J <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>i <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">3016 </span>        <span class="keyword">if</span><span class="sign">(</span>ord <span class="sign">&gt;</span> 2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span>i2 in <span class="sign">(</span>i <span class="sign">-</span> ord <span class="sign">+</span> 2<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span>i <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3017 </span>            r2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>x <span class="sign">-</span> knots<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>knots<span class="sign">[</span>i2 <span class="sign">+</span> ord <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">-</span> knots<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">3018 </span>            J <span class="sign">&lt;</span><span class="sign">-</span> J <span class="sign">*</span> r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">3019 </span>        <span class="sign">}</span>
<span class="line_number">3020 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3021 </span>            temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fupdatespline.html#robo110">updatespline</a><span class="sign">(</span>temp<span class="sign">,</span> params2<span class="sign">)</span>
<span class="line_number">3022 </span>            candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Espline2Ehaz.html#robo137">mklik.spline.haz</a><span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> temp<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">3023 </span>        <span class="sign">}</span>
<span class="line_number">3024 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3025 </span>            <span class="comment"># adjust frailty mean</span>
<span class="line_number">3026 </span>            newmean <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">3027 </span>                temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>i<span class="sign">]</span>
<span class="line_number">3028 </span>            newinner <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>newmean <span class="sign">/</span> temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>i<span class="sign">]</span>
<span class="line_number">3029 </span>            <span class="keyword">if</span><span class="sign">(</span>newinner <span class="sign">&lt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3030 </span>                candlik<span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>Inf
<span class="line_number">3031 </span>            <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">3032 </span>                params2<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>newinner<span class="sign">)</span>
<span class="line_number">3033 </span>                temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fupdatespline.html#robo110">updatespline</a><span class="sign">(</span>temp<span class="sign">,</span> params2<span class="sign">)</span>
<span class="line_number">3034 </span>                candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Espline2Efrail.html#robo135">mklik.spline.frail</a><span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> temp<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">3035 </span>            <span class="sign">}</span>
<span class="line_number">3036 </span>        <span class="sign">}</span>
<span class="line_number">3037 </span>        <span class="comment"># acceptance ratio</span>
<span class="line_number">3038 </span>        ratio <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">/</span> <span class="keyword">sqrt</span><span class="sign">(</span>2 <span class="sign">*</span> pi <span class="sign">*</span> curve<span class="sign">$</span>spline<span class="sign">.</span>priorvar<span class="sign">)</span> <span class="sign">*</span> abs<span class="sign">(</span>J<span class="sign">)</span>
<span class="line_number">3039 </span>        acc <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Facceptreject.html#robo141">acceptreject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> ratio<span class="sign">)</span>
<span class="line_number">3040 </span>            <span class="comment">#cat("Lik: ", baselik, candlik, J, ratio, acc, "\n")</span>
<span class="line_number">3041 </span>        <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>knots2<span class="sign">[</span><span class="sign">(</span>ord <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>knots2<span class="sign">)</span> <span class="sign">-</span> ord<span class="sign">)</span><span class="sign">]</span> <span class="sign">!</span><span class="sign">=</span> candknots<span class="sign">[</span>occ2 <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">3042 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>temp<span class="sign">)</span> <span class="keyword">else</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">3043 </span>
<span class="line_number">3044 </span>    <span class="sign">}</span>
<span class="line_number">3045 </span>
<span class="line_number">3046 </span>    <span class="keyword">if</span><span class="sign">(</span>u <span class="sign">&gt;</span> pd <span class="sign">+</span> pb<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3047 </span>        <span class="comment"># Move a knot</span>
<span class="line_number">3048 </span>        <span class="comment"># choose a random knot to move</span>
<span class="line_number">3049 </span>        moveind <span class="sign">&lt;</span><span class="sign">-</span> floor<span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">,</span> 1<span class="sign">,</span> nknots <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3050 </span>        <span class="comment"># compute the range of candidate knot indices to which the knot can be moved</span>
<span class="line_number">3051 </span>        leftknotind <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>moveind <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> ord <span class="sign">+</span> 1 <span class="keyword">else</span> occind<span class="sign">[</span>moveind <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> 1
<span class="line_number">3052 </span>        rightknotind <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>moveind <span class="sign">=</span><span class="sign">=</span> nknots<span class="sign">)</span> ncandknots <span class="sign">+</span> ord <span class="keyword">else</span> occind<span class="sign">[</span>moveind <span class="sign">+</span> 1<span class="sign">]</span> <span class="sign">-</span> 1
<span class="line_number">3053 </span>        newknotind <span class="sign">&lt;</span><span class="sign">-</span> floor<span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">,</span> leftknotind<span class="sign">,</span> rightknotind <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3054 </span>        oldknotind <span class="sign">&lt;</span><span class="sign">-</span> occind<span class="sign">[</span>moveind<span class="sign">]</span>
<span class="line_number">3055 </span>        <span class="comment">#cat("Moveind: ", moveind, "\n");</span>
<span class="line_number">3056 </span>        <span class="comment">#cat("Old / New: ", candknots[oldknotind], candknots[newknotind], "\n");</span>
<span class="line_number">3057 </span>        <span class="keyword">if</span><span class="sign">(</span>newknotind <span class="sign">=</span><span class="sign">=</span> oldknotind<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">3058 </span>        <span class="comment"># create new knots and parameters</span>
<span class="line_number">3059 </span>        knots2 <span class="sign">&lt;</span><span class="sign">-</span> knots
<span class="line_number">3060 </span>        params2 <span class="sign">&lt;</span><span class="sign">-</span> params
<span class="line_number">3061 </span>        knots2<span class="sign">[</span>moveind <span class="sign">+</span> ord<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> candknots<span class="sign">[</span>newknotind<span class="sign">]</span>
<span class="line_number">3062 </span>        <span class="comment"># update occupied knot indices</span>
<span class="line_number">3063 </span>        occ2 <span class="sign">&lt;</span><span class="sign">-</span> occ
<span class="line_number">3064 </span>        occ2<span class="sign">[</span>newknotind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">3065 </span>        occ2<span class="sign">[</span>occind<span class="sign">[</span>moveind<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">3066 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>occ <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="sign">&lt;</span> nknots<span class="sign">)</span> browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">3067 </span>        <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span><span class="keyword">diff</span><span class="sign">(</span>knots2<span class="sign">)</span> <span class="sign">&lt;</span> 0<span class="sign">)</span><span class="sign">)</span> browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">3068 </span>        <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>knots2<span class="sign">[</span><span class="sign">(</span>ord <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>knots2<span class="sign">)</span> <span class="sign">-</span> ord<span class="sign">)</span><span class="sign">]</span> <span class="sign">!</span><span class="sign">=</span> candknots<span class="sign">[</span>occ2 <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">3069 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> curve
<span class="line_number">3070 </span>        temp<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> knots2
<span class="line_number">3071 </span>        attr<span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> occ2
<span class="line_number">3072 </span>        <span class="comment"># update the spline basis</span>
<span class="line_number">3073 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rsplineUtils2Fmakesplinebasis.html#robo184">makesplinebasis</a><span class="sign">(</span>temp<span class="sign">)</span>
<span class="line_number">3074 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3075 </span>            candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Espline2Ehaz.html#robo137">mklik.spline.haz</a><span class="sign">(</span>params2<span class="sign">,</span> temp<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">3076 </span>        <span class="sign">}</span>
<span class="line_number">3077 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3078 </span>            <span class="comment"># adjust frailty mean</span>
<span class="line_number">3079 </span>            newmean <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>moveind <span class="sign">+</span> ord<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">3080 </span>                temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>moveind <span class="sign">+</span> ord<span class="sign">]</span>
<span class="line_number">3081 </span>            newinner <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>newmean <span class="sign">/</span> temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>moveind <span class="sign">+</span> ord<span class="sign">]</span>
<span class="line_number">3082 </span>            <span class="keyword">if</span><span class="sign">(</span>newinner <span class="sign">&lt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3083 </span>                candlik<span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>Inf
<span class="line_number">3084 </span>            <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">3085 </span>                params2<span class="sign">[</span>moveind <span class="sign">+</span> ord<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>newinner<span class="sign">)</span>
<span class="line_number">3086 </span>                temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fupdatespline.html#robo110">updatespline</a><span class="sign">(</span>temp<span class="sign">,</span> params2<span class="sign">)</span>
<span class="line_number">3087 </span>                candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Espline2Efrail.html#robo135">mklik.spline.frail</a><span class="sign">(</span>params2<span class="sign">,</span> hazard<span class="sign">,</span> temp<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">3088 </span>            <span class="sign">}</span>
<span class="line_number">3089 </span>        <span class="sign">}</span>
<span class="line_number">3090 </span>        acc <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Facceptreject.html#robo141">acceptreject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">3091 </span>            <span class="comment">#cat("Lik: ", baselik, candlik, acc, "\n")</span>
<span class="line_number">3092 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>temp<span class="sign">)</span> <span class="keyword">else</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">3093 </span>    <span class="sign">}</span>
<span class="line_number">3094 </span>
<span class="line_number">3095 </span><span class="sign">}</span>
</pre>

</div> <!-- content -->
<div id="footer">
<p>Generated from ./splinesurv/R/splinefrailty.r with <a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> V4.99.36 on Sun Jun 29 2008 13:50:50
</p>
</div> <!-- footer -->

<!-- Start of StatCounter Code -->
<script type="text/javascript">
var sc_project=3825578; 
var sc_invisible=1; 
var sc_partition=34; 
var sc_click_stat=1; 
var sc_security="6730661a"; 
</script>

<script type="text/javascript" src="http://www.statcounter.com/counter/counter_xhtml.js"></script><noscript><div class="statcounter"><a href="http://www.statcounter.com/" target="_blank"><img class="statcounter" src="http://c.statcounter.com/3825578/0/6730661a/1/" alt="free hit counter script" ></a></div></noscript>
<!-- End of StatCounter Code -->
</body>

</html>
