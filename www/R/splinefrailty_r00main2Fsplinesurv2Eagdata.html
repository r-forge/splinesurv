<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="../robodoc.css" type="text/css" />
<title>./splinesurv/R/splinefrailty.r</title>
<!-- Source: ./splinesurv/R/splinefrailty.r -->
<!-- Generated with ROBODoc Version 4.99.36 (Jun 17 2008) -->
</head>
<body>
<div id="logo">

<a name="robo_top_of_doc" href="http://splinesurv.r-forge.r-project.org/">splinesurv</a>
</div> <!-- logo -->
<div id="navigation">
<a class="menuitem" href="./splinefrailty_r2F00main.html#robo0">00main</a><a class="menuitem" href="../robo_functions.html#robo_top_of_doc">Functions</a></div> <!-- navigation -->
<div id="content">
<h3>TABLE OF CONTENTS</h3>
<ul>
<li>1. <a href="#robo21">00main/splinesurv.agdata</a></li>
</ul>
<hr />
<a name="00main2fsplinesurv2eagdata"></a>
<a name="robo21"></a><h2>00main/splinesurv.agdata [ Functions ]</h2>

<p class="item_name">NAME</p>
<pre>    <strong>splinesurv.agdata</strong> --- main estimation function
</pre>
<p class="item_name">FUNCTION</p>
<p>    This is the main fitting function for the <a href="./splinefrailty_rS3Methods2Fsplinesurv.html#robo166">splinesurv</a> routine. It accepts a data
    frame in a specified format, conducts the initialization procedure, then
    either starts the MCMC loop within R or calls compiled C code that does the same
    thing. 
</p>

<p>    See also the call graph linked from <a href="./splinefrailty_r2F00main.html#robo0">00main</a>.
</p>
   
<p>    This function should not be called directly, instead the interface provided by
    <a href="./splinefrailty_rS3Methods2Fsplinesurv2Eformula.html#robo168">splinesurv.formula</a> should be used.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">4246 </span><strong>splinesurv.agdata</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> hazard <span class="sign">=</span> NULL<span class="sign">,</span> frailty <span class="sign">=</span> NULL<span class="sign">,</span> regression <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4247 </span>    control <span class="sign">=</span> NULL<span class="sign">,</span> coda <span class="sign">=</span> FALSE<span class="sign">,</span> initial <span class="sign">=</span> NULL<span class="sign">,</span> verbose <span class="sign">=</span> 3<span class="sign">,</span> usec <span class="sign">=</span> TRUE<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    x      a data frame with the following columns:
           i       cluster index
           j       subject index
           time    event time
           delta   event indicator
           ...     covariates
    See the package documentation for detail on the remaining options
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    an object of class <a href="./splinefrailty_rS3Methods2Fsplinesurv.html#robo166">splinesurv</a>, see package documentation.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">4250 </span><span class="sign">{</span>
<span class="line_number">4251 </span>        
<span class="line_number">4252 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Initializing...\n"</span><span class="sign">)</span>
<span class="line_number">4253 </span>    
<span class="line_number">4254 </span>    agdata <span class="sign">&lt;</span><span class="sign">-</span> x
<span class="line_number">4255 </span>    rm<span class="sign">(</span>x<span class="sign">)</span>
<span class="line_number">4256 </span>    <span class="keyword">call</span> <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span><span class="keyword">call</span><span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4257 </span>    m <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span><span class="keyword">unique</span><span class="sign">(</span>agdata<span class="sign">$</span>i<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4258 </span>    <span class="keyword">if</span><span class="sign">(</span>m <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> warning<span class="sign">(</span><span class="quote">"Single cluster: frailty density estimate is meaningless"</span><span class="sign">)</span>
<span class="line_number">4259 </span>    Ji <span class="sign">&lt;</span><span class="sign">-</span> table<span class="sign">(</span>agdata<span class="sign">$</span>i<span class="sign">)</span>
<span class="line_number">4260 </span>    
<span class="line_number">4261 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tSetting initial parameters...\n"</span><span class="sign">)</span>
<span class="line_number">4262 </span>    
<span class="line_number">4263 </span>    <span class="comment"># Parse input (control)</span>
<span class="line_number">4264 </span>    control<span class="sign">.</span>in <span class="sign">&lt;</span><span class="sign">-</span> control
<span class="line_number">4265 </span>    <span class="comment"># default control options</span>
<span class="line_number">4266 </span>    control<span class="sign">.</span>default <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>
<span class="line_number">4267 </span>        burnin <span class="sign">=</span> 500<span class="sign">,</span> <span class="comment"># Length of the burn - in period</span>
<span class="line_number">4268 </span>        maxiter <span class="sign">=</span> 1000<span class="sign">,</span> <span class="comment"># Max number of iterations</span>
<span class="line_number">4269 </span>        thin <span class="sign">=</span> 1<span class="sign">,</span> <span class="comment"># Degree of thinning</span>
<span class="line_number">4270 </span>        tun<span class="sign">.</span>auto <span class="sign">=</span> TRUE<span class="sign">,</span> <span class="comment"># Auto - calibrate tuning parameters</span>
<span class="line_number">4271 </span>        tun<span class="sign">.</span><span class="keyword">int</span> <span class="sign">=</span> 100 <span class="comment"># Interval for calibration of the acceptance rate</span>
<span class="line_number">4272 </span>    <span class="sign">)</span>
<span class="line_number">4273 </span>    control <span class="sign">&lt;</span><span class="sign">-</span> control<span class="sign">.</span>default
<span class="line_number">4274 </span>    controlnames <span class="sign">&lt;</span><span class="sign">-</span> names<span class="sign">(</span>control<span class="sign">)</span>
<span class="line_number">4275 </span>    innames <span class="sign">&lt;</span><span class="sign">-</span> names<span class="sign">(</span>control<span class="sign">.</span>in<span class="sign">)</span>
<span class="line_number">4276 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>control<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4277 </span>        <span class="comment"># replace default control settings by any specified in input</span>
<span class="line_number">4278 </span>        <span class="keyword">for</span><span class="sign">(</span>n in innames<span class="sign">)</span> eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"control$"</span><span class="sign">,</span>
<span class="line_number">4279 </span>            match<span class="sign">.</span>arg<span class="sign">(</span>n<span class="sign">,</span> controlnames<span class="sign">)</span><span class="sign">,</span> <span class="quote">" &lt;- control.in$"</span><span class="sign">,</span> n<span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4280 </span>    <span class="sign">}</span>
<span class="line_number">4281 </span>    <span class="keyword">if</span><span class="sign">(</span>control<span class="sign">$</span>burnin <span class="sign">&gt;</span> control<span class="sign">$</span>maxiter<span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"Burnin cannot be greater than maxiter"</span><span class="sign">)</span>
<span class="line_number">4282 </span>     
<span class="line_number">4283 </span>     <span class="comment"># Parse input (frailty)   </span>
<span class="line_number">4284 </span>    frailty<span class="sign">.</span>in <span class="sign">&lt;</span><span class="sign">-</span> frailty
<span class="line_number">4285 </span>    <span class="comment"># default settings for frailty <a href="./splinefrailty_r01structures2FRCurve.html#robo26">RCurve</a> options</span>
<span class="line_number">4286 </span>    frailty<span class="sign">.</span>default <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>
<span class="line_number">4287 </span>        type <span class="sign">=</span> <span class="quote">"spline"</span><span class="sign">,</span>
<span class="line_number">4288 </span>        spline<span class="sign">.</span>ord <span class="sign">=</span> 4<span class="sign">,</span>
<span class="line_number">4289 </span>        spline<span class="sign">.</span>adaptive <span class="sign">=</span> TRUE<span class="sign">,</span>
<span class="line_number">4290 </span>        spline<span class="sign">.</span>knots <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4291 </span>        spline<span class="sign">.</span>knotspacing <span class="sign">=</span> <span class="quote">"equal"</span><span class="sign">,</span>
<span class="line_number">4292 </span>        spline<span class="sign">.</span>nknots <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4293 </span>        spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4294 </span>        spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4295 </span>        spline<span class="sign">.</span>ncandknots <span class="sign">=</span> 100<span class="sign">,</span>
<span class="line_number">4296 </span>        spline<span class="sign">.</span>bdmconst<span class="sign">=</span><span class="sign">.</span>4<span class="sign">,</span>
<span class="line_number">4297 </span>        spline<span class="sign">.</span>maxoccknots <span class="sign">=</span> 35<span class="sign">,</span>
<span class="line_number">4298 </span>        spline<span class="sign">.</span>maxknot <span class="sign">=</span> 5<span class="sign">,</span>
<span class="line_number">4299 </span>        spline<span class="sign">.</span>par <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4300 </span>        spline<span class="sign">.</span>min<span class="sign">=</span><span class="sign">-</span>100<span class="sign">,</span>
<span class="line_number">4301 </span>        spline<span class="sign">.</span>penalty <span class="sign">=</span> <span class="quote">"none"</span><span class="sign">,</span>
<span class="line_number">4302 </span>        spline<span class="sign">.</span>penaltyfactor <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4303 </span>        spline<span class="sign">.</span>meanpenalty <span class="sign">=</span> 1e10<span class="sign">,</span>
<span class="line_number">4304 </span>        spline<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4305 </span>        spline<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">.</span>01<span class="sign">,</span> 0<span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4306 </span>        spline<span class="sign">.</span>tun <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4307 </span>        spline<span class="sign">.</span>accept <span class="sign">=</span> 0<span class="sign">,</span>       
<span class="line_number">4308 </span>        param<span class="sign">.</span>dist <span class="sign">=</span> <span class="quote">"none"</span><span class="sign">,</span>
<span class="line_number">4309 </span>        param<span class="sign">.</span>par <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4310 </span>        param<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4311 </span>        param<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">.</span>01<span class="sign">,</span> 0<span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4312 </span>        param<span class="sign">.</span>tun <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4313 </span>        param<span class="sign">.</span>accept <span class="sign">=</span> 0<span class="sign">,</span>
<span class="line_number">4314 </span>        weight <span class="sign">=</span> 0<span class="sign">.</span>5<span class="sign">,</span>
<span class="line_number">4315 </span>        weight<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4316 </span>        weight<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>1<span class="sign">,</span> 2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4317 </span>        weight<span class="sign">.</span>tun <span class="sign">=</span> 0<span class="sign">.</span>01<span class="sign">,</span>
<span class="line_number">4318 </span>        weight<span class="sign">.</span>accept <span class="sign">=</span> 0<span class="sign">,</span>
<span class="line_number">4319 </span>        accept <span class="sign">=</span> 0
<span class="line_number">4320 </span>    <span class="sign">)</span>
<span class="line_number">4321 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">.</span>default
<span class="line_number">4322 </span>    frailtynames <span class="sign">&lt;</span><span class="sign">-</span> names<span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4323 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4324 </span>        <span class="comment"># replace default frailty options by input</span>
<span class="line_number">4325 </span>        <span class="keyword">for</span><span class="sign">(</span>n in names<span class="sign">(</span>frailty<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span> eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"frailty$"</span><span class="sign">,</span>
<span class="line_number">4326 </span>            match<span class="sign">.</span>arg<span class="sign">(</span>n<span class="sign">,</span> frailtynames<span class="sign">)</span><span class="sign">,</span> <span class="quote">" &lt;- frailty.in$"</span><span class="sign">,</span> n<span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4327 </span>    <span class="sign">}</span>
<span class="line_number">4328 </span>    <span class="comment"># set additional <a href="./splinefrailty_r01structures2FRCurve.html#robo26">RCurve</a> settings</span>
<span class="line_number">4329 </span>    frailty<span class="sign">$</span>type <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>frailty<span class="sign">$</span>type<span class="sign">,</span> c<span class="sign">(</span><span class="quote">"spline"</span><span class="sign">,</span> <span class="quote">"parametric"</span><span class="sign">,</span> <span class="quote">"both"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4330 </span>    frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a> <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"spline"</span> <span class="sign">|</span> frailty<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span>
<span class="line_number">4331 </span>    frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a> <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"parametric"</span> <span class="sign">|</span> frailty<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span>
<span class="line_number">4332 </span>    frailty<span class="sign">$</span>spline<span class="sign">.</span>knotspacing <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knotspacing<span class="sign">,</span> c<span class="sign">(</span><span class="quote">"equal"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4333 </span>    frailty<span class="sign">$</span>spline<span class="sign">.</span>penalty <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>penalty<span class="sign">,</span>
<span class="line_number">4334 </span>        c<span class="sign">(</span><span class="quote">"2diff"</span><span class="sign">,</span> <span class="quote">"2deriv"</span><span class="sign">,</span> <span class="quote">"log2deriv"</span><span class="sign">,</span> <span class="quote">"none"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4335 </span>    frailty<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>frailty<span class="sign">$</span>param<span class="sign">.</span>dist<span class="sign">,</span> c<span class="sign">(</span><span class="quote">"none"</span><span class="sign">,</span> <span class="quote">"gamma"</span><span class="sign">,</span> <span class="quote">"lognormal"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4336 </span>    <span class="keyword">if</span><span class="sign">(</span>m <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">&amp;</span> frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a><span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"parametric component not allowed for single cluster"</span><span class="sign">)</span>
<span class="line_number">4337 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a> <span class="sign">&amp;</span> frailty<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"none"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">4338 </span>        warning<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"no distribution specified for frailty parametric component"</span><span class="sign">,</span>
<span class="line_number">4339 </span>            <span class="quote">"-- setting to gamma"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4340 </span>        frailty<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"gamma"</span>
<span class="line_number">4341 </span>    <span class="sign">}</span>
<span class="line_number">4342 </span>    <span class="comment"># match prior settings and set default hyperparameters</span>
<span class="line_number">4343 </span>    frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior<span class="sign">,</span>
<span class="line_number">4344 </span>        c<span class="sign">(</span><span class="quote">"poisson"</span><span class="sign">,</span> <span class="quote">"geometric"</span><span class="sign">,</span> <span class="quote">"poissonmix"</span><span class="sign">,</span> <span class="quote">"negbin"</span><span class="sign">,</span> <span class="quote">"power"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4345 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poisson"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4346 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> 10
<span class="line_number">4347 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"geometric"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4348 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">.</span>1
<span class="line_number">4349 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poissonmix"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4350 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>10<span class="sign">,</span> 30<span class="sign">)</span>
<span class="line_number">4351 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"negbin"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4352 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>2<span class="sign">,</span> <span class="sign">.</span>1<span class="sign">)</span>
<span class="line_number">4353 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"power"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4354 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>1 <span class="sign">/</span> 2
<span class="line_number">4355 </span>
<span class="line_number">4356 </span>    frailty<span class="sign">$</span>spline<span class="sign">.</span>norm <span class="sign">&lt;</span><span class="sign">-</span> TRUE
<span class="line_number">4357 </span>    frailty<span class="sign">$</span>name <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"frailty"</span>
<span class="line_number">4358 </span>    
<span class="line_number">4359 </span>     <span class="comment"># Parse input (hazard)   </span>
<span class="line_number">4360 </span>    hazard<span class="sign">.</span>in <span class="sign">&lt;</span><span class="sign">-</span> hazard
<span class="line_number">4361 </span>    <span class="comment"># default hazard <a href="./splinefrailty_r01structures2FRCurve.html#robo26">RCurve</a></span>
<span class="line_number">4362 </span>    hazard<span class="sign">.</span>default <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>
<span class="line_number">4363 </span>        type <span class="sign">=</span> <span class="quote">"spline"</span><span class="sign">,</span>
<span class="line_number">4364 </span>        spline<span class="sign">.</span>ord <span class="sign">=</span> 4<span class="sign">,</span>
<span class="line_number">4365 </span>        spline<span class="sign">.</span>adaptive <span class="sign">=</span> TRUE<span class="sign">,</span>
<span class="line_number">4366 </span>        spline<span class="sign">.</span>knotspacing <span class="sign">=</span> <span class="quote">"mixed"</span><span class="sign">,</span>
<span class="line_number">4367 </span>        spline<span class="sign">.</span>nknots <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4368 </span>        spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4369 </span>        spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4370 </span>        spline<span class="sign">.</span>ncandknots <span class="sign">=</span> 100<span class="sign">,</span>
<span class="line_number">4371 </span>        spline<span class="sign">.</span>maxoccknots <span class="sign">=</span> 35<span class="sign">,</span>
<span class="line_number">4372 </span>        spline<span class="sign">.</span>bdmconst<span class="sign">=</span><span class="sign">.</span>4<span class="sign">,</span>
<span class="line_number">4373 </span>        spline<span class="sign">.</span>knots <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4374 </span>        spline<span class="sign">.</span>par <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4375 </span>        spline<span class="sign">.</span>min<span class="sign">=</span><span class="sign">-</span>100<span class="sign">,</span>
<span class="line_number">4376 </span>        spline<span class="sign">.</span>penalty <span class="sign">=</span> <span class="quote">"none"</span><span class="sign">,</span>
<span class="line_number">4377 </span>        spline<span class="sign">.</span>penaltyfactor <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4378 </span>        spline<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4379 </span>        spline<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">.</span>01<span class="sign">,</span> 0<span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4380 </span>        spline<span class="sign">.</span>tun <span class="sign">=</span> 1<span class="sign">,</span>      
<span class="line_number">4381 </span>        spline<span class="sign">.</span>accept <span class="sign">=</span> 0<span class="sign">,</span> 
<span class="line_number">4382 </span>        param<span class="sign">.</span>dist <span class="sign">=</span> <span class="quote">"none"</span><span class="sign">,</span>
<span class="line_number">4383 </span>        param<span class="sign">.</span>par <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4384 </span>        param<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4385 </span>        param<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">.</span>01<span class="sign">,</span> 0<span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4386 </span>        param<span class="sign">.</span>tun <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4387 </span>        param<span class="sign">.</span>accept <span class="sign">=</span> 0<span class="sign">,</span>
<span class="line_number">4388 </span>        weight <span class="sign">=</span> 0<span class="sign">.</span>5<span class="sign">,</span>
<span class="line_number">4389 </span>        weight<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4390 </span>        weight<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>1<span class="sign">,</span> 2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4391 </span>        weight<span class="sign">.</span>tun <span class="sign">=</span> 0<span class="sign">.</span>01<span class="sign">,</span>
<span class="line_number">4392 </span>        weight<span class="sign">.</span>accept <span class="sign">=</span> 0
<span class="line_number">4393 </span>    <span class="sign">)</span>
<span class="line_number">4394 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">.</span>default
<span class="line_number">4395 </span>    haznames <span class="sign">&lt;</span><span class="sign">-</span> names<span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">4396 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4397 </span>        <span class="keyword">for</span><span class="sign">(</span>n in names<span class="sign">(</span>hazard<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span> eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"hazard$"</span><span class="sign">,</span>
<span class="line_number">4398 </span>            match<span class="sign">.</span>arg<span class="sign">(</span>n<span class="sign">,</span> haznames<span class="sign">)</span><span class="sign">,</span> <span class="quote">" &lt;- hazard.in$"</span><span class="sign">,</span> n<span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4399 </span>    <span class="sign">}</span>
<span class="line_number">4400 </span>    <span class="comment"># other hazard settings</span>
<span class="line_number">4401 </span>    hazard<span class="sign">$</span>type <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>hazard<span class="sign">$</span>type<span class="sign">,</span> c<span class="sign">(</span><span class="quote">"spline"</span><span class="sign">,</span> <span class="quote">"parametric"</span><span class="sign">,</span> <span class="quote">"both"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4402 </span>    hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a> <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"spline"</span> <span class="sign">|</span> hazard<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span>
<span class="line_number">4403 </span>    hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a> <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"parametric"</span> <span class="sign">|</span> hazard<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span>
<span class="line_number">4404 </span>    hazard<span class="sign">$</span>spline<span class="sign">.</span>knotspacing <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>knotspacing<span class="sign">,</span>
<span class="line_number">4405 </span>        c<span class="sign">(</span><span class="quote">"quantile"</span><span class="sign">,</span> <span class="quote">"equal"</span><span class="sign">,</span> <span class="quote">"mixed"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4406 </span>    hazard<span class="sign">$</span>spline<span class="sign">.</span>penalty <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>penalty<span class="sign">,</span>
<span class="line_number">4407 </span>        c<span class="sign">(</span><span class="quote">"2diff"</span><span class="sign">,</span> <span class="quote">"2deriv"</span><span class="sign">,</span> <span class="quote">"log2deriv"</span><span class="sign">,</span> <span class="quote">"none"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4408 </span>    hazard<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>hazard<span class="sign">$</span>param<span class="sign">.</span>dist<span class="sign">,</span>
<span class="line_number">4409 </span>        c<span class="sign">(</span><span class="quote">"none"</span><span class="sign">,</span> <span class="quote">"exponential"</span><span class="sign">,</span> <span class="quote">"weibull"</span><span class="sign">,</span> <span class="quote">"lognormal"</span><span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">4410 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a> <span class="sign">&amp;</span> hazard<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"none"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">4411 </span>        warning<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"no distribution specified for hazard parametric component"</span><span class="sign">,</span>
<span class="line_number">4412 </span>            <span class="quote">"-- setting to weibull"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4413 </span>        hazard<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"weibull"</span>
<span class="line_number">4414 </span>    <span class="sign">}</span>
<span class="line_number">4415 </span>    <span class="comment"># priors and hyperparameters for the number of knots</span>
<span class="line_number">4416 </span>    hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior<span class="sign">,</span>
<span class="line_number">4417 </span>        c<span class="sign">(</span><span class="quote">"poisson"</span><span class="sign">,</span> <span class="quote">"geometric"</span><span class="sign">,</span> <span class="quote">"poissonmix"</span><span class="sign">,</span> <span class="quote">"negbin"</span><span class="sign">,</span> <span class="quote">"power"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4418 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poisson"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4419 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> 10
<span class="line_number">4420 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"geometric"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4421 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">.</span>1
<span class="line_number">4422 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poissonmix"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4423 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>10<span class="sign">,</span> 30<span class="sign">)</span>
<span class="line_number">4424 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"negbin"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4425 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>2<span class="sign">,</span> <span class="sign">.</span>1<span class="sign">)</span>
<span class="line_number">4426 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"power"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4427 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>1 <span class="sign">/</span> 2
<span class="line_number">4428 </span>
<span class="line_number">4429 </span>    <span class="comment"># default weight settings</span>
<span class="line_number">4430 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a><span class="sign">)</span> hazard<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">4431 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span> hazard<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">4432 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a><span class="sign">)</span> frailty<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">4433 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span> frailty<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">4434 </span>    
<span class="line_number">4435 </span>    hazard<span class="sign">$</span>spline<span class="sign">.</span>norm <span class="sign">&lt;</span><span class="sign">-</span> FALSE
<span class="line_number">4436 </span>    hazard<span class="sign">$</span>name <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"hazard"</span>
<span class="line_number">4437 </span>    hazard<span class="sign">$</span>x <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">$</span>time
<span class="line_number">4438 </span>     
<span class="line_number">4439 </span>    <span class="comment"># Parse input (regression)</span>
<span class="line_number">4440 </span>    reg<span class="sign">.</span>in <span class="sign">&lt;</span><span class="sign">-</span> regression
<span class="line_number">4441 </span>    reg<span class="sign">.</span>default <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>
<span class="line_number">4442 </span>        priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4443 </span>        hyper <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">.</span>01<span class="sign">,</span> 0<span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4444 </span>        tun <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4445 </span>        accept <span class="sign">=</span> 0
<span class="line_number">4446 </span>    <span class="sign">)</span>
<span class="line_number">4447 </span>    regression <span class="sign">&lt;</span><span class="sign">-</span> reg<span class="sign">.</span>default
<span class="line_number">4448 </span>    regnames <span class="sign">&lt;</span><span class="sign">-</span> names<span class="sign">(</span>regression<span class="sign">)</span>
<span class="line_number">4449 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>reg<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span>n in names<span class="sign">(</span>reg<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4450 </span>        eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"regression$"</span><span class="sign">,</span> match<span class="sign">.</span>arg<span class="sign">(</span>n<span class="sign">,</span> regnames<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4451 </span>            <span class="quote">" &lt;- reg.in$"</span><span class="sign">,</span> n<span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4452 </span>
<span class="line_number">4453 </span>     <span class="comment"># Default settings for the initial number of knots</span>
<span class="line_number">4454 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">)</span><span class="sign">)</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>adaptive<span class="sign">)</span> 
<span class="line_number">4455 </span>        min<span class="sign">(</span><a href="./splinefrailty_rinitRoutine2FnknotsPriorMean.html#robo127">nknotsPriorMean</a><span class="sign">(</span>hazard<span class="sign">)</span><span class="sign">,</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">)</span> <span class="keyword">else</span> 
<span class="line_number">4456 </span>        max<span class="sign">(</span>min<span class="sign">(</span>round<span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span> <span class="sign">/</span> 4<span class="sign">)</span><span class="sign">,</span> 35<span class="sign">)</span><span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">4457 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">)</span><span class="sign">)</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>adaptive<span class="sign">)</span>
<span class="line_number">4458 </span>        min<span class="sign">(</span><a href="./splinefrailty_rinitRoutine2FnknotsPriorMean.html#robo127">nknotsPriorMean</a><span class="sign">(</span>frailty<span class="sign">)</span><span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">)</span> <span class="keyword">else</span> 
<span class="line_number">4459 </span>        max<span class="sign">(</span>1<span class="sign">,</span> min<span class="sign">(</span>round<span class="sign">(</span>m <span class="sign">/</span> 4<span class="sign">)</span><span class="sign">,</span> 35<span class="sign">)</span><span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">4460 </span>    
<span class="line_number">4461 </span>    
<span class="line_number">4462 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tFitting Cox survival models...\n"</span><span class="sign">)</span>
<span class="line_number">4463 </span>    
<span class="line_number">4464 </span>    <span class="comment"># Cox fit with gamma frailties for initial values of Ui and beta</span>
<span class="line_number">4465 </span>    varnames <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">colnames</span><span class="sign">(</span>agdata<span class="sign">)</span><span class="sign">[</span> <span class="sign">-</span> <span class="sign">(</span>1<span class="sign">:</span>4<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">4466 </span>    qvarnames <span class="sign">&lt;</span><span class="sign">-</span> paste<span class="sign">(</span><span class="quote">"`"</span><span class="sign">,</span> varnames<span class="sign">,</span> <span class="quote">"`"</span><span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span>
<span class="line_number">4467 </span>    <span class="keyword">if</span><span class="sign">(</span>m <span class="sign">&gt;</span> 1<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4468 </span>        coxfit <span class="sign">&lt;</span><span class="sign">-</span> coxph<span class="sign">(</span>as<span class="sign">.</span>formula<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"Surv(time, delta)~"</span><span class="sign">,</span>
<span class="line_number">4469 </span>            paste<span class="sign">(</span>qvarnames<span class="sign">,</span> collapse <span class="sign">=</span> <span class="quote">" + "</span><span class="sign">)</span><span class="sign">,</span> <span class="quote">" + frailty(i)"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> data <span class="sign">=</span> agdata<span class="sign">)</span>
<span class="line_number">4470 </span>        Ui <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>coxfit<span class="sign">$</span>frail<span class="sign">)</span>
<span class="line_number">4471 </span>        <span class="keyword">if</span><span class="sign">(</span>var<span class="sign">(</span>Ui<span class="sign">)</span> <span class="sign">&lt;</span> 1e<span class="sign">-</span>5<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">4472 </span>            Ui <span class="sign">&lt;</span><span class="sign">-</span> 2 <span class="sign">*</span> runif<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4473 </span>            Ui <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">+</span> <span class="sign">(</span>Ui <span class="sign">-</span> mean<span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4474 </span>            Ui<span class="sign">[</span>Ui <span class="sign">&lt;</span> 0<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">4475 </span>        <span class="sign">}</span>
<span class="line_number">4476 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">4477 </span>        coxfit <span class="sign">&lt;</span><span class="sign">-</span> coxph<span class="sign">(</span>as<span class="sign">.</span>formula<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"Surv(time, delta)~"</span><span class="sign">,</span>
<span class="line_number">4478 </span>            paste<span class="sign">(</span>qvarnames<span class="sign">,</span> collapse <span class="sign">=</span> <span class="quote">" + "</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> data <span class="sign">=</span> agdata<span class="sign">)</span>
<span class="line_number">4479 </span>        Ui <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">4480 </span>    <span class="sign">}</span> 
<span class="line_number">4481 </span>    <span class="comment"># set initial frailies and regression structure</span>
<span class="line_number">4482 </span>    frailty<span class="sign">$</span>x <span class="sign">&lt;</span><span class="sign">-</span> Ui   
<span class="line_number">4483 </span>    beta <span class="sign">&lt;</span><span class="sign">-</span> coxfit<span class="sign">$</span>coef
<span class="line_number">4484 </span>    regression<span class="sign">$</span>m <span class="sign">&lt;</span><span class="sign">-</span> m
<span class="line_number">4485 </span>    regression<span class="sign">$</span>Ji <span class="sign">&lt;</span><span class="sign">-</span> Ji
<span class="line_number">4486 </span>    regression<span class="sign">$</span>covariates <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>matrix<span class="sign">(</span>agdata<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>4<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>beta<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4487 </span>    regression<span class="sign">$</span>time <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">$</span>time
<span class="line_number">4488 </span>    regression<span class="sign">$</span>status <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">$</span>delta
<span class="line_number">4489 </span>    regression<span class="sign">$</span>cluster <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>integer<span class="sign">(</span>agdata<span class="sign">$</span>i<span class="sign">)</span>
<span class="line_number">4490 </span>    regression <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fupdateregression.html#robo109">updateregression</a><span class="sign">(</span>regression<span class="sign">,</span> beta<span class="sign">)</span>
<span class="line_number">4491 </span>        
<span class="line_number">4492 </span>    rm<span class="sign">(</span>coxfit<span class="sign">)</span>
<span class="line_number">4493 </span>    
<span class="line_number">4494 </span>    <span class="comment"># Parametric fits</span>
<span class="line_number">4495 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2 <span class="sign">&amp;</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a> <span class="sign">|</span> hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a><span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">4496 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tFitting parametric components...\n"</span><span class="sign">)</span>
<span class="line_number">4497 </span>    
<span class="line_number">4498 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rinitRoutine2Ffitparametric.html#robo120">fitparametric</a><span class="sign">(</span>hazard<span class="sign">,</span> agdata<span class="sign">)</span>
<span class="line_number">4499 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rinitRoutine2Ffitparametric.html#robo120">fitparametric</a><span class="sign">(</span>frailty<span class="sign">,</span> Ui<span class="sign">)</span>
<span class="line_number">4500 </span>
<span class="line_number">4501 </span>    <span class="comment"># Spline knots</span>
<span class="line_number">4502 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2 <span class="sign">&amp;</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a> <span class="sign">|</span> hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4503 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tComputing spline knots...\n"</span><span class="sign">)</span>
<span class="line_number">4504 </span>    
<span class="line_number">4505 </span>    hazbounds <span class="sign">&lt;</span><span class="sign">-</span> range<span class="sign">(</span>agdata<span class="sign">$</span>time<span class="sign">)</span> <span class="sign">+</span> c<span class="sign">(</span><span class="sign">-</span><span class="sign">.</span>1<span class="sign">,</span> <span class="sign">.</span>1<span class="sign">)</span> <span class="sign">*</span> <span class="keyword">diff</span><span class="sign">(</span>range<span class="sign">(</span>agdata<span class="sign">$</span>time<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4506 </span>    hazbounds<span class="sign">[</span>hazbounds <span class="sign">&lt;</span> 0<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">4507 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rinitRoutine2Fmakeknots.html#robo123">makeknots</a><span class="sign">(</span>hazard<span class="sign">,</span> agdata<span class="sign">$</span>time<span class="sign">[</span>agdata<span class="sign">$</span>delta <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">]</span><span class="sign">,</span> bounds <span class="sign">=</span> hazbounds<span class="sign">)</span>
<span class="line_number">4508 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rinitRoutine2Fmakeknots.html#robo123">makeknots</a><span class="sign">(</span>frailty<span class="sign">,</span> Ui<span class="sign">,</span> bounds <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">,</span> max<span class="sign">(</span>max<span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">,</span> min<span class="sign">(</span>2 <span class="sign">*</span> max<span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4509 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>maxknot<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4510 </span>        
<span class="line_number">4511 </span>    <span class="comment"># Evaluate the splines and integrals</span>
<span class="line_number">4512 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2 <span class="sign">&amp;</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a> <span class="sign">|</span> hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4513 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tConstructing spline basis functions...\n"</span><span class="sign">)</span>
<span class="line_number">4514 </span>    
<span class="line_number">4515 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rsplineUtils2Fmakesplinebasis.html#robo184">makesplinebasis</a><span class="sign">(</span>hazard<span class="sign">,</span> usec <span class="sign">=</span> usec<span class="sign">)</span>
<span class="line_number">4516 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rsplineUtils2Fmakesplinebasis.html#robo184">makesplinebasis</a><span class="sign">(</span>frailty<span class="sign">,</span> usec <span class="sign">=</span> usec<span class="sign">)</span>
<span class="line_number">4517 </span>       
<span class="line_number">4518 </span>    <span class="comment"># Penalty matrices</span>
<span class="line_number">4519 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2 <span class="sign">&amp;</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a> <span class="sign">|</span> hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4520 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tInitializing penalty matrices...\n"</span><span class="sign">)</span>
<span class="line_number">4521 </span>
<span class="line_number">4522 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rinitRoutine2Fmakepenalty.html#robo124">makepenalty</a><span class="sign">(</span>hazard<span class="sign">,</span> usec <span class="sign">=</span> usec<span class="sign">)</span>
<span class="line_number">4523 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rinitRoutine2Fmakepenalty.html#robo124">makepenalty</a><span class="sign">(</span>frailty<span class="sign">,</span> usec <span class="sign">=</span> usec<span class="sign">)</span>    
<span class="line_number">4524 </span>        
<span class="line_number">4525 </span>
<span class="line_number">4526 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2 <span class="sign">&amp;</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a> <span class="sign">|</span> hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4527 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tObtaining initial values for spline parameters...\n"</span><span class="sign">)</span>
<span class="line_number">4528 </span>
<span class="line_number">4529 </span>    <span class="sign">{</span><span class="sign">{</span><span class="sign">{</span><span class="comment"># Initial values for the theta vectors</span>
<span class="line_number">4530 </span>    
<span class="line_number">4531 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a> <span class="sign">&amp;</span> hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4532 </span>        oldhazweight <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>weight
<span class="line_number">4533 </span>        hazard<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">;</span>
<span class="line_number">4534 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fweightcurve.html#robo111">weightcurve</a><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">4535 </span>    <span class="sign">}</span>
<span class="line_number">4536 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a> <span class="sign">&amp;</span> frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4537 </span>        oldfrailweight <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>weight
<span class="line_number">4538 </span>        frailty<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">;</span>
<span class="line_number">4539 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fweightcurve.html#robo111">weightcurve</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4540 </span>    <span class="sign">}</span>
<span class="line_number">4541 </span>
<span class="line_number">4542 </span>    <span class="comment"># Initial values for hazard parameters </span>
<span class="line_number">4543 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4544 </span>            theta<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">+</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span>
<span class="line_number">4545 </span>        <span class="keyword">if</span><span class="sign">(</span>usec<span class="sign">)</span><span class="sign">{</span> <span class="comment"># use fast C code to compute likelihoods</span>
<span class="line_number">4546 </span>            par <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>theta<span class="sign">.</span>haz<span class="sign">)</span><span class="sign">;</span> status <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>regression<span class="sign">$</span>status<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4547 </span>            lp <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>regression<span class="sign">$</span>lp<span class="sign">)</span><span class="sign">;</span> frailrep <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>frailty<span class="sign">$</span>x<span class="sign">,</span> Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4548 </span>            hazParY <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span><span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a><span class="sign">)</span> hazard<span class="sign">$</span>param<span class="sign">.</span>y <span class="keyword">else</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">4549 </span>            hazParYcum <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span><span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a><span class="sign">)</span> hazard<span class="sign">$</span>param<span class="sign">.</span>ycum <span class="keyword">else</span>
<span class="line_number">4550 </span>                <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">4551 </span>            weight <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>weight<span class="sign">;</span> B <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>basis<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4552 </span>            C <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>basiscum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4553 </span>            P <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>penaltyfactor <span class="sign">*</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>penaltymatrix<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4554 </span>            penaltyType <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>integer<span class="sign">(</span>pmatch<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>penalty<span class="sign">,</span>
<span class="line_number">4555 </span>                c<span class="sign">(</span><span class="quote">"none"</span><span class="sign">,</span> <span class="quote">"2diff"</span><span class="sign">,</span> <span class="quote">"2deriv"</span><span class="sign">,</span> <span class="quote">"log2deriv"</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4556 </span>            splinemin <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>min<span class="sign">)</span>
<span class="line_number">4557 </span>            sigma2 <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>priorvar
<span class="line_number">4558 </span>            sigma2 <span class="sign">&lt;</span><span class="sign">-</span> 100<span class="sign">;</span> sigma2target <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>priorvar
<span class="line_number">4559 </span>             <span class="comment">#compute initial values by slowly decreasing the prior variance for stability</span>
<span class="line_number">4560 </span>            <span class="keyword">while</span><span class="sign">(</span>sigma2 <span class="sign">&gt;</span> sigma2target<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4561 </span>                sigma2 <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sigma2 <span class="sign">/</span> 10<span class="sign">)</span>
<span class="line_number">4562 </span>                opt<span class="sign">.</span>theta<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> optim<span class="sign">(</span>par<span class="sign">,</span> fn <span class="sign">=</span> <a href="./splinefrailty_rCWrappers2Fcmklik2Espline2Ehaz.html#robo118">cmklik.spline.haz</a><span class="sign">,</span> gr <span class="sign">=</span> <a href="./splinefrailty_rCWrappers2Fcmkgr2Espline2Ehaz.html#robo116">cmkgr.spline.haz</a><span class="sign">,</span>
<span class="line_number">4563 </span>                    status <span class="sign">=</span> status<span class="sign">,</span> lp <span class="sign">=</span> lp<span class="sign">,</span> frailrep <span class="sign">=</span> frailrep<span class="sign">,</span> hazParY <span class="sign">=</span> hazParY<span class="sign">,</span> 
<span class="line_number">4564 </span>                    hazParYcum <span class="sign">=</span> hazParYcum<span class="sign">,</span> weight <span class="sign">=</span> weight<span class="sign">,</span> B <span class="sign">=</span> B<span class="sign">,</span> C <span class="sign">=</span> C<span class="sign">,</span> P <span class="sign">=</span> P<span class="sign">,</span>
<span class="line_number">4565 </span>                    penaltyType <span class="sign">=</span> penaltyType<span class="sign">,</span> sigma2 <span class="sign">=</span> sigma2<span class="sign">,</span> min <span class="sign">=</span> splinemin<span class="sign">,</span>
<span class="line_number">4566 </span>                    method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span> control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4567 </span>                par <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>opt<span class="sign">.</span>theta<span class="sign">.</span>haz<span class="sign">$</span>par<span class="sign">)</span>
<span class="line_number">4568 </span>            <span class="sign">}</span>
<span class="line_number">4569 </span>            opt<span class="sign">.</span>theta<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> optim<span class="sign">(</span>par<span class="sign">,</span> fn <span class="sign">=</span> <a href="./splinefrailty_rCWrappers2Fcmklik2Espline2Ehaz.html#robo118">cmklik.spline.haz</a><span class="sign">,</span> gr <span class="sign">=</span> <a href="./splinefrailty_rCWrappers2Fcmkgr2Espline2Ehaz.html#robo116">cmkgr.spline.haz</a><span class="sign">,</span>
<span class="line_number">4570 </span>                status <span class="sign">=</span> status<span class="sign">,</span> lp <span class="sign">=</span> lp<span class="sign">,</span> frailrep <span class="sign">=</span> frailrep<span class="sign">,</span> hazParY <span class="sign">=</span> hazParY<span class="sign">,</span>
<span class="line_number">4571 </span>                hazParYcum <span class="sign">=</span> hazParYcum<span class="sign">,</span> weight <span class="sign">=</span> weight<span class="sign">,</span> B <span class="sign">=</span> B<span class="sign">,</span> C <span class="sign">=</span> C<span class="sign">,</span> P <span class="sign">=</span> P<span class="sign">,</span>
<span class="line_number">4572 </span>                penaltyType <span class="sign">=</span> penaltyType<span class="sign">,</span> sigma2 <span class="sign">=</span> sigma2<span class="sign">,</span> min <span class="sign">=</span> splinemin<span class="sign">,</span>
<span class="line_number">4573 </span>                method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span> control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">,</span> maxit <span class="sign">=</span> 1<span class="sign">)</span><span class="sign">,</span> hessian <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4574 </span>            rm<span class="sign">(</span>par<span class="sign">,</span> status<span class="sign">,</span> lp<span class="sign">,</span> hazParY<span class="sign">,</span> hazParYcum<span class="sign">,</span> weight<span class="sign">,</span> B<span class="sign">,</span> C<span class="sign">,</span> P<span class="sign">,</span> penaltyType<span class="sign">,</span>
<span class="line_number">4575 </span>                splinemin<span class="sign">,</span> sigma2<span class="sign">)</span>
<span class="line_number">4576 </span>            gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4577 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> <span class="comment"># usec=FALSE</span>
<span class="line_number">4578 </span>            hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fupdatespline.html#robo110">updatespline</a><span class="sign">(</span>hazard<span class="sign">,</span> theta<span class="sign">.</span>haz<span class="sign">)</span>
<span class="line_number">4579 </span>            gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4580 </span>            sigma2 <span class="sign">&lt;</span><span class="sign">-</span> 100<span class="sign">;</span> sigma2target <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>priorvar
<span class="line_number">4581 </span>             <span class="comment">#compute initial values by slowly decreasing the prior variance</span>
<span class="line_number">4582 </span>            <span class="keyword">while</span><span class="sign">(</span>sigma2 <span class="sign">&gt;</span> sigma2target<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4583 </span>                sigma2 <span class="sign">&lt;</span><span class="sign">-</span> sigma2 <span class="sign">/</span> 10<span class="sign">;</span>
<span class="line_number">4584 </span>                hazard<span class="sign">$</span>spline<span class="sign">.</span>priorvar <span class="sign">&lt;</span><span class="sign">-</span> sigma2
<span class="line_number">4585 </span>                opt<span class="sign">.</span>theta<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> optim<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span>
<span class="line_number">4586 </span>                        fn <span class="sign">=</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Espline2Ehaz.html#robo137">mklik.spline.haz</a><span class="sign">,</span>
<span class="line_number">4587 </span>                        gr <span class="sign">=</span> <a href="./splinefrailty_rmakeLikelihood2Fmkgr2Espline2Ehaz.html#robo129">mkgr.spline.haz</a><span class="sign">,</span>
<span class="line_number">4588 </span>                        method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span>
<span class="line_number">4589 </span>                        control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4590 </span>                        hazard <span class="sign">=</span> hazard<span class="sign">,</span>
<span class="line_number">4591 </span>                        frailty <span class="sign">=</span> frailty<span class="sign">,</span>
<span class="line_number">4592 </span>                        regression <span class="sign">=</span> regression<span class="sign">,</span>
<span class="line_number">4593 </span>                        hessian <span class="sign">=</span> FALSE<span class="sign">)</span>
<span class="line_number">4594 </span>                hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fupdatespline.html#robo110">updatespline</a><span class="sign">(</span>hazard<span class="sign">,</span> opt<span class="sign">.</span>theta<span class="sign">.</span>haz<span class="sign">$</span>par<span class="sign">)</span>
<span class="line_number">4595 </span>            <span class="sign">}</span>
<span class="line_number">4596 </span>            opt<span class="sign">.</span>theta<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> optim<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span>
<span class="line_number">4597 </span>                    fn <span class="sign">=</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Espline2Ehaz.html#robo137">mklik.spline.haz</a><span class="sign">,</span>
<span class="line_number">4598 </span>                    gr <span class="sign">=</span> <a href="./splinefrailty_rmakeLikelihood2Fmkgr2Espline2Ehaz.html#robo129">mkgr.spline.haz</a><span class="sign">,</span>
<span class="line_number">4599 </span>                    method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span>
<span class="line_number">4600 </span>                    control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4601 </span>                    hazard <span class="sign">=</span> hazard<span class="sign">,</span>
<span class="line_number">4602 </span>                    frailty <span class="sign">=</span> frailty<span class="sign">,</span>
<span class="line_number">4603 </span>                    regression <span class="sign">=</span> regression<span class="sign">,</span>
<span class="line_number">4604 </span>                    hessian <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4605 </span>        <span class="sign">}</span>
<span class="line_number">4606 </span>        gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4607 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fupdatespline.html#robo110">updatespline</a><span class="sign">(</span>hazard<span class="sign">,</span> opt<span class="sign">.</span>theta<span class="sign">.</span>haz<span class="sign">$</span>par<span class="sign">)</span>
<span class="line_number">4608 </span>
<span class="line_number">4609 </span>    <span class="sign">}</span>
<span class="line_number">4610 </span>
<span class="line_number">4611 </span>        <span class="comment"># Initial values for frailty parameters</span>
<span class="line_number">4612 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4613 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>fixedind <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">4614 </span>        <span class="comment"># parameter vector not including the fixed index</span>
<span class="line_number">4615 </span>            theta<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">+</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>ord <span class="sign">-</span> 1<span class="sign">)</span>
<span class="line_number">4616 </span>        <span class="sign">{</span>
<span class="line_number">4617 </span>            opt<span class="sign">.</span>theta<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> optim<span class="sign">(</span>theta<span class="sign">.</span>frail<span class="sign">,</span>
<span class="line_number">4618 </span>                    fn <span class="sign">=</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Espline2Efrail2Einit.html#robo136">mklik.spline.frail.init</a><span class="sign">,</span>
<span class="line_number">4619 </span>                    method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span>
<span class="line_number">4620 </span>                    control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4621 </span>                    hazard <span class="sign">=</span> hazard<span class="sign">,</span>
<span class="line_number">4622 </span>                    frailty <span class="sign">=</span> frailty<span class="sign">,</span>
<span class="line_number">4623 </span>                    regression <span class="sign">=</span> regression<span class="sign">,</span>
<span class="line_number">4624 </span>                    hessian <span class="sign">=</span> TRUE<span class="sign">)</span>    
<span class="line_number">4625 </span>        <span class="sign">}</span>
<span class="line_number">4626 </span>        gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4627 </span>        <span class="comment"># add the fixed index back in</span>
<span class="line_number">4628 </span>        theta<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmiscUtils2Frepairfrailtypar.html#robo158">repairfrailtypar</a><span class="sign">(</span>opt<span class="sign">.</span>theta<span class="sign">.</span>frail<span class="sign">$</span>par<span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>fixedind<span class="sign">)</span>
<span class="line_number">4629 </span>        badtheta <span class="sign">&lt;</span><span class="sign">-</span> TRUE<span class="sign">;</span> j <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>
<span class="line_number">4630 </span>        <span class="comment"># set the mean of the estimated frailty density to be exactly 1</span>
<span class="line_number">4631 </span>        <span class="keyword">while</span><span class="sign">(</span>badtheta<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4632 </span>           j <span class="sign">&lt;</span><span class="sign">-</span> j <span class="sign">+</span> 1
<span class="line_number">4633 </span>           thetaj <span class="sign">&lt;</span><span class="sign">-</span> suppressWarnings<span class="sign">(</span>log<span class="sign">(</span><span class="sign">-</span><span class="keyword">sum</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span> <span class="sign">-</span> j<span class="sign">]</span> <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>theta<span class="sign">.</span>frail<span class="sign">[</span> <span class="sign">-</span> j<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4634 </span>           <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>nan<span class="sign">(</span>thetaj<span class="sign">)</span><span class="sign">)</span> badtheta <span class="sign">&lt;</span><span class="sign">-</span> FALSE
<span class="line_number">4635 </span>        <span class="sign">}</span>
<span class="line_number">4636 </span>        theta<span class="sign">.</span>frail<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> thetaj<span class="sign">;</span> 
<span class="line_number">4637 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fupdatespline.html#robo110">updatespline</a><span class="sign">(</span>frailty<span class="sign">,</span> theta<span class="sign">.</span>frail<span class="sign">)</span>
<span class="line_number">4638 </span>    <span class="sign">}</span>
<span class="line_number">4639 </span>
<span class="line_number">4640 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4641 </span>    <span class="comment"># reweight the inital curves</span>
<span class="line_number">4642 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a> <span class="sign">&amp;</span> hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4643 </span>        hazard<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> oldhazweight
<span class="line_number">4644 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fweightcurve.html#robo111">weightcurve</a><span class="sign">(</span>hazard<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4645 </span>    <span class="sign">}</span>
<span class="line_number">4646 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a> <span class="sign">&amp;</span> frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4647 </span>        frailty<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> oldfrailweight
<span class="line_number">4648 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fweightcurve.html#robo111">weightcurve</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4649 </span>    <span class="sign">}</span>
<span class="line_number">4650 </span>
<span class="line_number">4651 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span> 
<span class="line_number">4652 </span>    <span class="comment"># Evaluate variances and hessians for candidate generation</span>
<span class="line_number">4653 </span>    frailty<span class="sign">$</span>tun <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">diff</span><span class="sign">(</span>range<span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">)</span><span class="sign">^</span>2 <span class="sign">/</span> 6
<span class="line_number">4654 </span>    hess<span class="sign">.</span>coef <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmakeLikelihood2Fmkhess2Ecoef.html#robo130">mkhess.coef</a><span class="sign">(</span>regression<span class="sign">$</span>coefficients<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4655 </span>    Sigma<span class="sign">.</span>coef <span class="sign">&lt;</span><span class="sign">-</span> solve<span class="sign">(</span><span class="sign">-</span>hess<span class="sign">.</span>coef<span class="sign">)</span>
<span class="line_number">4656 </span>    regression<span class="sign">$</span>candcov <span class="sign">&lt;</span><span class="sign">-</span> Sigma<span class="sign">.</span>coef
<span class="line_number">4657 </span>    regression<span class="sign">$</span>cholcandcov <span class="sign">&lt;</span><span class="sign">-</span> chol<span class="sign">(</span>Sigma<span class="sign">.</span>coef<span class="sign">,</span> pivot <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4658 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4659 </span>        hess<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> opt<span class="sign">.</span>theta<span class="sign">.</span>haz<span class="sign">$</span>hess
<span class="line_number">4660 </span>        Sigma<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rinitRoutine2Finverthessian.html#robo122">inverthessian</a><span class="sign">(</span>hess<span class="sign">.</span>haz<span class="sign">)</span>
<span class="line_number">4661 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>candcov <span class="sign">&lt;</span><span class="sign">-</span> Sigma<span class="sign">.</span>haz
<span class="line_number">4662 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>candsd <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>1<span class="sign">,</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots <span class="sign">+</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span>
<span class="line_number">4663 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>cholcandcov <span class="sign">&lt;</span><span class="sign">-</span> chol<span class="sign">(</span>Sigma<span class="sign">.</span>haz<span class="sign">,</span> pivot <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4664 </span>        rm<span class="sign">(</span>hess<span class="sign">.</span>haz<span class="sign">,</span> Sigma<span class="sign">.</span>haz<span class="sign">)</span>
<span class="line_number">4665 </span>    <span class="sign">}</span>
<span class="line_number">4666 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4667 </span>        hess<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> opt<span class="sign">.</span>theta<span class="sign">.</span>frail<span class="sign">$</span>hess
<span class="line_number">4668 </span>        Sigma<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rinitRoutine2Finverthessian.html#robo122">inverthessian</a><span class="sign">(</span>hess<span class="sign">.</span>frail<span class="sign">)</span>
<span class="line_number">4669 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>candcov <span class="sign">&lt;</span><span class="sign">-</span> Sigma<span class="sign">.</span>frail
<span class="line_number">4670 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>candsd <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>1<span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots <span class="sign">+</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span>
<span class="line_number">4671 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>cholcandcov <span class="sign">&lt;</span><span class="sign">-</span> chol<span class="sign">(</span>Sigma<span class="sign">.</span>frail<span class="sign">,</span> pivot <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4672 </span>        rm<span class="sign">(</span>hess<span class="sign">.</span>frail<span class="sign">,</span> Sigma<span class="sign">.</span>frail<span class="sign">)</span>
<span class="line_number">4673 </span>    <span class="sign">}</span>
<span class="line_number">4674 </span>    <span class="comment"># construct a numeric hessian for the parametric parameters</span>
<span class="line_number">4675 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a><span class="sign">)</span><span class="sign">{</span> 
<span class="line_number">4676 </span>        <span class="comment"># (I don't remember why it doesn't just use <a href="./splinefrailty_rinitRoutine2FnumHess2Epar.html#robo128">numHess.par</a> like for the frailty, but</span>
<span class="line_number">4677 </span>        <span class="comment">#   there must be a reason for this inelegant setup)</span>
<span class="line_number">4678 </span>        temphaz <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a> <span class="sign">=</span> hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a><span class="sign">,</span> <a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a> <span class="sign">=</span> hazard<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">,</span>
<span class="line_number">4679 </span>        weight <span class="sign">=</span> hazard<span class="sign">$</span>weight<span class="sign">,</span> spline<span class="sign">.</span>y <span class="sign">=</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>y<span class="sign">,</span> spline<span class="sign">.</span>ycum <span class="sign">=</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>ycum<span class="sign">,</span>
<span class="line_number">4680 </span>        name <span class="sign">=</span> hazard<span class="sign">$</span>name<span class="sign">,</span> param<span class="sign">.</span>dist <span class="sign">=</span> hazard<span class="sign">$</span>param<span class="sign">.</span>dist<span class="sign">,</span> x <span class="sign">=</span> hazard<span class="sign">$</span>x<span class="sign">,</span> y <span class="sign">=</span> hazard<span class="sign">$</span>y<span class="sign">,</span>
<span class="line_number">4681 </span>        ycum <span class="sign">=</span> hazard<span class="sign">$</span>ycum<span class="sign">,</span> param<span class="sign">.</span>y <span class="sign">=</span> hazard<span class="sign">$</span>param<span class="sign">.</span>y<span class="sign">,</span> param<span class="sign">.</span>ycum <span class="sign">=</span> hazard<span class="sign">$</span>param<span class="sign">.</span>ycum<span class="sign">,</span>
<span class="line_number">4682 </span>        param<span class="sign">.</span>par <span class="sign">=</span> hazard<span class="sign">$</span>param<span class="sign">.</span>par<span class="sign">,</span> param<span class="sign">.</span>priorvar <span class="sign">=</span> hazard<span class="sign">$</span>param<span class="sign">.</span>priorvar<span class="sign">)</span>
<span class="line_number">4683 </span>        eps <span class="sign">&lt;</span><span class="sign">-</span> 1e<span class="sign">-</span>5
<span class="line_number">4684 </span>        par <span class="sign">&lt;</span><span class="sign">-</span> temphaz<span class="sign">$</span>param<span class="sign">.</span>par
<span class="line_number">4685 </span>        hess <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4686 </span>        <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4687 </span>            <span class="comment"># this constructs numerical gradients by finite differences</span>
<span class="line_number">4688 </span>            <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4689 </span>            par1 <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">;</span>par2 <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">;</span>par3 <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">;</span>
<span class="line_number">4690 </span>            <span class="keyword">if</span><span class="sign">(</span>i <span class="sign">=</span><span class="sign">=</span> j<span class="sign">)</span> <span class="sign">{</span>par1<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> eps<span class="sign">;</span>par2 <span class="sign">&lt;</span><span class="sign">-</span> par1<span class="sign">;</span>par3<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> 2 <span class="sign">*</span> eps<span class="sign">}</span>
<span class="line_number">4691 </span>            <span class="keyword">else</span> <span class="sign">{</span>par1<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> eps<span class="sign">;</span> par2<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">+</span> eps<span class="sign">;</span> par3 <span class="sign">&lt;</span><span class="sign">-</span> par1<span class="sign">;</span>
<span class="line_number">4692 </span>                par3<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">+</span> eps<span class="sign">}</span>
<span class="line_number">4693 </span>            g1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><a href="./splinefrailty_rmakeLikelihood2Fmklik2Eparam2Ehaz.html#robo134">mklik.param.haz</a><span class="sign">(</span>par1<span class="sign">,</span> temphaz<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span> <span class="sign">-</span>
<span class="line_number">4694 </span>                <a href="./splinefrailty_rmakeLikelihood2Fmklik2Eparam2Ehaz.html#robo134">mklik.param.haz</a><span class="sign">(</span>par<span class="sign">,</span> temphaz<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> eps
<span class="line_number">4695 </span>            g2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><a href="./splinefrailty_rmakeLikelihood2Fmklik2Eparam2Ehaz.html#robo134">mklik.param.haz</a><span class="sign">(</span>par3<span class="sign">,</span> temphaz<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span> <span class="sign">-</span>
<span class="line_number">4696 </span>                <a href="./splinefrailty_rmakeLikelihood2Fmklik2Eparam2Ehaz.html#robo134">mklik.param.haz</a><span class="sign">(</span>par2<span class="sign">,</span> temphaz<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> eps
<span class="line_number">4697 </span>            hess<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>g2 <span class="sign">-</span> g1<span class="sign">)</span> <span class="sign">/</span> eps
<span class="line_number">4698 </span>            <span class="sign">}</span>
<span class="line_number">4699 </span>        <span class="sign">}</span>
<span class="line_number">4700 </span>        Sigma<span class="sign">.</span>par<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rinitRoutine2Finverthessian.html#robo122">inverthessian</a><span class="sign">(</span>hess<span class="sign">)</span>
<span class="line_number">4701 </span>        hazard<span class="sign">$</span>param<span class="sign">.</span>candcov <span class="sign">&lt;</span><span class="sign">-</span> Sigma<span class="sign">.</span>par<span class="sign">.</span>haz
<span class="line_number">4702 </span>        hazard<span class="sign">$</span>param<span class="sign">.</span>cholcandcov <span class="sign">&lt;</span><span class="sign">-</span> chol<span class="sign">(</span>Sigma<span class="sign">.</span>par<span class="sign">.</span>haz<span class="sign">,</span> pivot <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4703 </span>        rm<span class="sign">(</span>Sigma<span class="sign">.</span>par<span class="sign">.</span>haz<span class="sign">,</span> hess<span class="sign">,</span> temphaz<span class="sign">)</span>
<span class="line_number">4704 </span>    <span class="sign">}</span>
<span class="line_number">4705 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhaspar.html#robo154">haspar</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4706 </span>        Sigma<span class="sign">.</span>par<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rinitRoutine2Finverthessian.html#robo122">inverthessian</a><span class="sign">(</span><a href="./splinefrailty_rinitRoutine2FnumHess2Epar.html#robo128">numHess.par</a><span class="sign">(</span>frailty<span class="sign">$</span>param<span class="sign">.</span>par<span class="sign">,</span> <a href="./splinefrailty_rmakeLikelihood2Fmklik2Eparam2Efrail.html#robo133">mklik.param.frail</a><span class="sign">,</span>
<span class="line_number">4707 </span>            hazard <span class="sign">=</span> hazard<span class="sign">,</span> frailty <span class="sign">=</span> frailty<span class="sign">,</span> regression <span class="sign">=</span> regression<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4708 </span>        frailty<span class="sign">$</span>param<span class="sign">.</span>candcov <span class="sign">&lt;</span><span class="sign">-</span> Sigma<span class="sign">.</span>par<span class="sign">.</span>frail
<span class="line_number">4709 </span>        frailty<span class="sign">$</span>param<span class="sign">.</span>cholcandcov <span class="sign">&lt;</span><span class="sign">-</span> chol<span class="sign">(</span>Sigma<span class="sign">.</span>par<span class="sign">.</span>frail<span class="sign">,</span> pivot <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4710 </span>        rm<span class="sign">(</span>Sigma<span class="sign">.</span>par<span class="sign">.</span>frail<span class="sign">)</span>
<span class="line_number">4711 </span>    <span class="sign">}</span>
<span class="line_number">4712 </span>    
<span class="line_number">4713 </span>    
<span class="line_number">4714 </span>    <span class="sign">}</span><span class="sign">}</span><span class="sign">}</span>
<span class="line_number">4715 </span>
<span class="line_number">4716 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">)</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>fvar <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rsplineUtils2Ffrailtysplinefvar.html#robo182">frailtysplinefvar</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4717 </span>    <span class="comment">#browser()</span>
<span class="line_number">4718 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4719 </span>    <span class="comment"># Store initial values in parameter history</span>
<span class="line_number">4720 </span>    history <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rinitRoutine2Finithistory.html#robo121">inithistory</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">,</span> control<span class="sign">)</span>
<span class="line_number">4721 </span>    avg<span class="sign">.</span>tunhist <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">4722 </span>    avg<span class="sign">.</span>accepthist <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">4723 </span>    
<span class="line_number">4724 </span>
<span class="line_number">4725 </span>    <span class="comment"># an internal function to prepare the curve structures for calling the C code</span>
<span class="line_number">4726 </span>    prepforCall <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4727 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"parametric"</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">4728 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span> curve<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4729 </span>            addcols <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots <span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots
<span class="line_number">4730 </span>            curve<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4731 </span>            curve<span class="sign">$</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4732 </span>            curve<span class="sign">$</span>spline<span class="sign">.</span>candsd <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>candsd<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4733 </span>            curve<span class="sign">$</span>spline<span class="sign">.</span>basis <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basis<span class="sign">,</span> matrix<span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> 
<span class="line_number">4734 </span>                <span class="keyword">dim</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basis<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4735 </span>            curve<span class="sign">$</span>spline<span class="sign">.</span>basisint <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basisint<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4736 </span>            <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> curve<span class="sign">$</span>spline<span class="sign">.</span>basiscum <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basiscum<span class="sign">,</span>
<span class="line_number">4737 </span>                matrix<span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basiscum<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4738 </span>            <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> curve<span class="sign">$</span>spline<span class="sign">.</span>basisexp <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">,</span>
<span class="line_number">4739 </span>                <span class="keyword">rep</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4740 </span>        <span class="sign">}</span>
<span class="line_number">4741 </span>        curve<span class="sign">$</span>spline<span class="sign">.</span>candocc <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span>
<span class="line_number">4742 </span>        <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">4743 </span>    <span class="sign">}</span>
<span class="line_number">4744 </span>    <span class="keyword">if</span><span class="sign">(</span>usec<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4745 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> prepforCall<span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">4746 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> prepforCall<span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4747 </span>    <span class="sign">}</span>
<span class="line_number">4748 </span>
<span class="line_number">4749 </span>     <span class="comment"># this does nothing, it just creates a useful marker</span>
<span class="line_number">4750 </span>     main <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span><span class="sign">)</span> <span class="sign">{</span><span class="sign">}</span>
<span class="line_number">4751 </span>        
<span class="line_number">4752 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Starting MCMC...\n"</span><span class="sign">)</span>
<span class="line_number">4753 </span>    
<span class="line_number">4754 </span>    iter <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="comment"># Counts the recorded iterations</span>
<span class="line_number">4755 </span>    iter<span class="sign">.</span>el <span class="sign">&lt;</span><span class="sign">-</span> 0 <span class="comment"># Counts elapsed iterations in each thinning cycle</span>
<span class="line_number">4756 </span>    
<span class="line_number">4757 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 3<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span>iter<span class="sign">,</span> <span class="quote">" "</span><span class="sign">)</span>
<span class="line_number">4758 </span>
<span class="line_number">4759 </span>    
<span class="line_number">4760 </span>    <span class="keyword">while</span><span class="sign">(</span>iter <span class="sign">&lt;</span> control<span class="sign">$</span>maxiter<span class="sign">)</span>
<span class="line_number">4761 </span>    <span class="sign">{</span>
<span class="line_number">4762 </span>        <span class="keyword">if</span><span class="sign">(</span>usec<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4763 </span>            <span class="comment"># C version of the main loop</span>
<span class="line_number">4764 </span>            gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4765 </span>            nexttunint <span class="sign">&lt;</span><span class="sign">-</span> iter <span class="sign">-</span> iter<span class="sign">%</span><span class="sign">%</span>control<span class="sign">$</span>tun<span class="sign">.</span><span class="keyword">int</span> <span class="sign">+</span> control<span class="sign">$</span>tun<span class="sign">.</span><span class="keyword">int</span>
<span class="line_number">4766 </span>            enditer <span class="sign">&lt;</span><span class="sign">-</span> min<span class="sign">(</span>nexttunint<span class="sign">,</span> control<span class="sign">$</span>maxiter<span class="sign">)</span>
<span class="line_number">4767 </span>            out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span><span class="keyword">Call</span><span class="sign">(</span><span class="quote">"<a href="../src/mainloop_c00main2FSplineSurvMainLoop.html#robo22">SplineSurvMainLoop</a>"</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">,</span> history<span class="sign">,</span> iter<span class="sign">,</span>
<span class="line_number">4768 </span>                enditer<span class="sign">,</span> control<span class="sign">$</span>thin<span class="sign">,</span> verbose<span class="sign">)</span> 
<span class="line_number">4769 </span>            iter <span class="sign">&lt;</span><span class="sign">-</span> enditer
<span class="line_number">4770 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">4771 </span>
<span class="line_number">4772 </span>            <span class="comment"># R version of the main loop</span>
<span class="line_number">4773 </span>
<span class="line_number">4774 </span>            iter<span class="sign">.</span>el <span class="sign">&lt;</span><span class="sign">-</span> iter<span class="sign">.</span>el <span class="sign">+</span> 1
<span class="line_number">4775 </span>
<span class="line_number">4776 </span>            <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 4<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span>iter<span class="sign">.</span>el<span class="sign">)</span>
<span class="line_number">4777 </span>                
<span class="line_number">4778 </span>            <span class="comment"># MH update of frailties</span>
<span class="line_number">4779 </span>            frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fmh2Efrail.html#robo145">mh.frail</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4780 </span>            
<span class="line_number">4781 </span>            <span class="comment"># MH update of regression parameters</span>
<span class="line_number">4782 </span>            regression <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fmh2Ecoef.html#robo144">mh.coef</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4783 </span>
<span class="line_number">4784 </span>            <span class="comment"># MH update of baseline parameters</span>
<span class="line_number">4785 </span>            hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fmh2Ehazard2Espline.html#robo149">mh.hazard.spline</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4786 </span>            
<span class="line_number">4787 </span>            <span class="comment"># MH update of frailty density parameters</span>
<span class="line_number">4788 </span>            frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fmh2Efrailty2Espline.html#robo147">mh.frailty.spline</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4789 </span>                    
<span class="line_number">4790 </span>            <span class="comment"># MH update of parametric baseline parameters</span>
<span class="line_number">4791 </span>            hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fmh2Ehazard2Eparam.html#robo148">mh.hazard.param</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4792 </span>            
<span class="line_number">4793 </span>            <span class="comment"># MH update of parametric frailty parameters</span>
<span class="line_number">4794 </span>            frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fmh2Efrailty2Eparam.html#robo146">mh.frailty.param</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4795 </span>
<span class="line_number">4796 </span>            <span class="comment"># MH update of weights</span>
<span class="line_number">4797 </span>            hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fmh2Eweight.html#robo150">mh.weight</a><span class="sign">(</span><span class="quote">"hazard"</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4798 </span>            frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fmh2Eweight.html#robo150">mh.weight</a><span class="sign">(</span><span class="quote">"frailty"</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4799 </span>
<span class="line_number">4800 </span>            <span class="comment"># Update of the sigmas / taus</span>
<span class="line_number">4801 </span>            hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fupdatepostvar2Ecurve.html#robo152">updatepostvar.curve</a><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">4802 </span>            frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fupdatepostvar2Ecurve.html#robo152">updatepostvar.curve</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4803 </span>            regression <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fupdatepostvar2Ecoef.html#robo151">updatepostvar.coef</a><span class="sign">(</span>regression<span class="sign">)</span>
<span class="line_number">4804 </span>
<span class="line_number">4805 </span>            <span class="comment"># Birth - death - move</span>
<span class="line_number">4806 </span>            <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>adaptive<span class="sign">)</span>
<span class="line_number">4807 </span>                hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fmh2Ebdm.html#robo143">mh.bdm</a><span class="sign">(</span><span class="quote">"hazard"</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4808 </span>            <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>adaptive<span class="sign">)</span>
<span class="line_number">4809 </span>                frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rMetropolisHastings2Fmh2Ebdm.html#robo143">mh.bdm</a><span class="sign">(</span><span class="quote">"frailty"</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4810 </span>
<span class="line_number">4811 </span>            <span class="comment"># record history</span>
<span class="line_number">4812 </span>            <span class="keyword">if</span><span class="sign">(</span>iter<span class="sign">.</span>el <span class="sign">=</span><span class="sign">=</span> control<span class="sign">$</span>thin<span class="sign">)</span><span class="sign">{</span>        
<span class="line_number">4813 </span>                iter <span class="sign">&lt;</span><span class="sign">-</span> iter <span class="sign">+</span> 1
<span class="line_number">4814 </span>                history <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rcurveUpdate2Fupdatehistory.html#robo107">updatehistory</a><span class="sign">(</span>history<span class="sign">,</span> iter<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4815 </span>                iter<span class="sign">.</span>el <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">4816 </span>                <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 3<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">" "</span><span class="sign">,</span> iter<span class="sign">,</span> <span class="quote">" "</span><span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span>
<span class="line_number">4817 </span>            <span class="sign">}</span>
<span class="line_number">4818 </span>        <span class="sign">}</span>
<span class="line_number">4819 </span>
<span class="line_number">4820 </span>        <span class="sign">{</span><span class="sign">{</span><span class="sign">{</span>  <span class="comment"># Periodic calibration check</span>
<span class="line_number">4821 </span>        <span class="keyword">if</span><span class="sign">(</span>iter<span class="sign">%</span><span class="sign">%</span>control<span class="sign">$</span>tun<span class="sign">.</span><span class="keyword">int</span> <span class="sign">=</span><span class="sign">=</span> 0 <span class="sign">&amp;</span> iter <span class="sign">&lt;</span> control<span class="sign">$</span>maxiter<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4822 </span>  
<span class="line_number">4823 </span>            <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">|</span> verbose <span class="sign">=</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span>iter<span class="sign">,</span> <span class="quote">" "</span><span class="sign">)</span>
<span class="line_number">4824 </span>            
<span class="line_number">4825 </span>            calinds <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>iter <span class="sign">-</span> control<span class="sign">$</span>tun<span class="sign">.</span><span class="keyword">int</span> <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span>iter   
<span class="line_number">4826 </span>
<span class="line_number">4827 </span>            <span class="comment"># Calibration of the tuning parameters for acceptance rate</span>
<span class="line_number">4828 </span>            <span class="keyword">if</span><span class="sign">(</span>control<span class="sign">$</span>tun<span class="sign">.</span>auto <span class="sign">&amp;</span> iter <span class="sign">&lt;</span><span class="sign">=</span> control<span class="sign">$</span>burnin<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4829 </span>               <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 3<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n Calibration ...\n"</span><span class="sign">)</span>
<span class="line_number">4830 </span>                      
<span class="line_number">4831 </span>                          
<span class="line_number">4832 </span>                tunnames <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="quote">"regression$tun"</span><span class="sign">,</span>
<span class="line_number">4833 </span>                    <span class="quote">"hazard$spline.tun"</span><span class="sign">,</span>
<span class="line_number">4834 </span>                    <span class="quote">"frailty$spline.tun"</span><span class="sign">,</span>
<span class="line_number">4835 </span>                    <span class="quote">"hazard$param.tun"</span><span class="sign">,</span>
<span class="line_number">4836 </span>                    <span class="quote">"frailty$param.tun"</span><span class="sign">,</span>
<span class="line_number">4837 </span>                    <span class="quote">"hazard$weight.tun"</span><span class="sign">,</span>
<span class="line_number">4838 </span>                    <span class="quote">"frailty$weight.tun"</span><span class="sign">,</span>
<span class="line_number">4839 </span>                    <span class="quote">"frailty$tun"</span><span class="sign">)</span>             
<span class="line_number">4840 </span>                alltun <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>tunnames<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4841 </span>                <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>alltun<span class="sign">)</span><span class="sign">)</span> eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"alltun["</span><span class="sign">,</span> i<span class="sign">,</span> <span class="quote">"] &lt;- "</span><span class="sign">,</span>
<span class="line_number">4842 </span>                    tunnames<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4843 </span>                avg<span class="sign">.</span>tunhist <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rbind</span><span class="sign">(</span>avg<span class="sign">.</span>tunhist<span class="sign">,</span> alltun<span class="sign">)</span>
<span class="line_number">4844 </span>                avg<span class="sign">.</span>accepthist <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rbind</span><span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">,</span>
<span class="line_number">4845 </span>                                      <span class="keyword">apply</span><span class="sign">(</span>history<span class="sign">$</span>accept<span class="sign">[</span>calinds<span class="sign">,</span> <span class="sign">]</span><span class="sign">,</span> 2<span class="sign">,</span> mean<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4846 </span>                <span class="keyword">for</span><span class="sign">(</span>g in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>alltun<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4847 </span>                    <span class="keyword">if</span><span class="sign">(</span>all<span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">&gt;</span><span class="sign">.</span>25<span class="sign">)</span><span class="sign">)</span> alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">*</span> 2
<span class="line_number">4848 </span>                    <span class="keyword">if</span><span class="sign">(</span>all<span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">&lt;</span><span class="sign">.</span>25<span class="sign">)</span><span class="sign">)</span> alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">/</span> 2
<span class="line_number">4849 </span>                    <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">&gt;</span><span class="sign">.</span>25<span class="sign">)</span> <span class="sign">&amp;</span> any<span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">&lt;</span><span class="sign">.</span>25<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4850 </span>                        <span class="comment"># build linear regression model for tuning parameters</span>
<span class="line_number">4851 </span>                        fit <span class="sign">&lt;</span><span class="sign">-</span> lm<span class="sign">(</span>y<span class="sign">~</span>x<span class="sign">,</span> data<span class="sign">.</span>frame<span class="sign">(</span>x <span class="sign">=</span> avg<span class="sign">.</span>tunhist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">,</span> 
<span class="line_number">4852 </span>                            y <span class="sign">=</span> avg<span class="sign">.</span>accepthist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4853 </span>                        out <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>max<span class="sign">(</span>1e<span class="sign">-</span>3<span class="sign">,</span> nlm<span class="sign">(</span><a href="./splinefrailty_rmiscUtils2Faccrate2Epredict2Elm.html#robo153">accrate.predict.lm</a><span class="sign">,</span> alltun<span class="sign">[</span>g<span class="sign">]</span><span class="sign">,</span> m <span class="sign">=</span> fit<span class="sign">)</span><span class="sign">$</span>est<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4854 </span>                        <span class="keyword">if</span><span class="sign">(</span>inherits<span class="sign">(</span>out<span class="sign">,</span> <span class="quote">"try-error"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4855 </span>                            alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> avg<span class="sign">.</span>tunhist<span class="sign">[</span><span class="keyword">which</span><span class="sign">.</span>min<span class="sign">(</span><span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">-</span><span class="sign">.</span>25<span class="sign">)</span><span class="sign">^</span>2<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">4856 </span>                        <span class="keyword">else</span>
<span class="line_number">4857 </span>                            alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> out
<span class="line_number">4858 </span>                    <span class="sign">}</span>
<span class="line_number">4859 </span>                <span class="sign">}</span>
<span class="line_number">4860 </span>                <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>alltun<span class="sign">)</span><span class="sign">)</span> eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span>tunnames<span class="sign">[</span>i<span class="sign">]</span><span class="sign">,</span>
<span class="line_number">4861 </span>                    <span class="quote">" &lt;- alltun["</span><span class="sign">,</span> i<span class="sign">,</span> <span class="quote">"]"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4862 </span>
<span class="line_number">4863 </span>                <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 4<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4864 </span>                    outmat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">,</span> alltun<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4865 </span>                    <span class="keyword">rownames</span><span class="sign">(</span>outmat<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> tunnames<span class="sign">;</span>
<span class="line_number">4866 </span>                    <span class="keyword">colnames</span><span class="sign">(</span>outmat<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="quote">"acceptance"</span><span class="sign">,</span> <span class="quote">"tuning"</span><span class="sign">)</span>
<span class="line_number">4867 </span>                    print<span class="sign">(</span>outmat<span class="sign">)</span>
<span class="line_number">4868 </span>                <span class="sign">}</span>
<span class="line_number">4869 </span>            <span class="sign">}</span>
<span class="line_number">4870 </span>            <span class="comment"># Print full iteration info</span>
<span class="line_number">4871 </span>            <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 5<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4872 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Frailties: "</span><span class="sign">,</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4873 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Coefficients: "</span><span class="sign">,</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>coefficients<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4874 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Hazard.spline: "</span><span class="sign">,</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4875 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Frailty.spline: "</span><span class="sign">,</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4876 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Hazard.param: "</span><span class="sign">,</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4877 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Frailty.param: "</span><span class="sign">,</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4878 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Prior variances: "</span><span class="sign">,</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>priorvar<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4879 </span>            <span class="sign">}</span>
<span class="line_number">4880 </span>            
<span class="line_number">4881 </span>            <span class="comment">#browser()</span>
<span class="line_number">4882 </span>            
<span class="line_number">4883 </span>        <span class="sign">}</span>
<span class="line_number">4884 </span>        <span class="sign">}</span><span class="sign">}</span><span class="sign">}</span>
<span class="line_number">4885 </span>        
<span class="line_number">4886 </span>    <span class="sign">}</span>   <span class="comment"># end main loop</span>
<span class="line_number">4887 </span>
<span class="line_number">4888 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4889 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span> 0<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Done!\n"</span><span class="sign">)</span>
<span class="line_number">4890 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmiscUtils2Fmakeoutputcurve.html#robo156">makeoutputcurve</a><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">4891 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="./splinefrailty_rmiscUtils2Fmakeoutputcurve.html#robo156">makeoutputcurve</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4892 </span>   
<span class="line_number">4893 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4894 </span>   <span class="sign">{</span><span class="sign">{</span><span class="sign">{</span> <span class="comment"># Construct output</span>
<span class="line_number">4895 </span>    <span class="keyword">if</span><span class="sign">(</span>control<span class="sign">$</span>burnin <span class="sign">&lt;</span> iter<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4896 </span>        <span class="keyword">if</span><span class="sign">(</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">(</span>frailty<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4897 </span>        frail<span class="sign">.</span>par<span class="sign">.</span>rs <span class="sign">&lt;</span><span class="sign">-</span> rowSums<span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4898 </span>        history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">)</span> <span class="sign">/</span> frail<span class="sign">.</span>par<span class="sign">.</span>rs
<span class="line_number">4899 </span>        <span class="sign">}</span>
<span class="line_number">4900 </span>        sub <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>1<span class="sign">:</span><span class="sign">(</span>iter<span class="sign">)</span><span class="sign">)</span> <span class="sign">&gt;</span> <span class="sign">(</span>control<span class="sign">$</span>burnin<span class="sign">)</span>
<span class="line_number">4901 </span>        posterior<span class="sign">.</span>mean <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>coefficients <span class="sign">=</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>coefficients<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4902 </span>                            frailty <span class="sign">=</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4903 </span>                            hazard<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">=</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4904 </span>                            hazard<span class="sign">.</span>param<span class="sign">.</span>par <span class="sign">=</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4905 </span>                            hazard<span class="sign">.</span>weight <span class="sign">=</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>weight<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4906 </span>                            frailty<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">=</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4907 </span>                            frailty<span class="sign">.</span>param<span class="sign">.</span>par <span class="sign">=</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4908 </span>                            frailty<span class="sign">.</span>weight <span class="sign">=</span> <a href="./splinefrailty_rmiscUtils2Fsubmean.html#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>weight<span class="sign">,</span> sub<span class="sign">)</span>
<span class="line_number">4909 </span>                        <span class="sign">)</span>
<span class="line_number">4910 </span>        <span class="comment"># save mean number of knots in spline.nknots for output</span>
<span class="line_number">4911 </span>        <span class="keyword">if</span><span class="sign">(</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">(</span>hazard<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">4912 </span>            hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> mean<span class="sign">(</span><span class="keyword">apply</span><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>sub<span class="sign">,</span> <span class="sign">]</span><span class="sign">,</span> 1<span class="sign">,</span>
<span class="line_number">4913 </span>                <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">)</span> <span class="keyword">sum</span><span class="sign">(</span>x<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> 2 <span class="sign">*</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>ord
<span class="line_number">4914 </span>        <span class="keyword">if</span><span class="sign">(</span><a href="./splinefrailty_rmiscUtils2Fhasspline.html#robo155">hasspline</a><span class="sign">(</span>frailty<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">4915 </span>            frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> mean<span class="sign">(</span><span class="keyword">apply</span><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>sub<span class="sign">,</span> <span class="sign">]</span><span class="sign">,</span> 1<span class="sign">,</span>
<span class="line_number">4916 </span>                <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">)</span> <span class="keyword">sum</span><span class="sign">(</span>x<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> 2 <span class="sign">*</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>ord
<span class="line_number">4917 </span>            history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">4918 </span>            posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">4919 </span>        <span class="sign">}</span>
<span class="line_number">4920 </span>        <span class="keyword">colnames</span><span class="sign">(</span>history<span class="sign">$</span>coefficients<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> varnames
<span class="line_number">4921 </span>        names<span class="sign">(</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>coefficients<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> varnames
<span class="line_number">4922 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">4923 </span>        postmean <span class="sign">=</span> NULL
<span class="line_number">4924 </span>    <span class="sign">}</span>
<span class="line_number">4925 </span>    <span class="keyword">if</span><span class="sign">(</span>coda<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4926 </span>        <span class="comment"># convert history to mcmc objects</span>
<span class="line_number">4927 </span>        library<span class="sign">(</span>coda<span class="sign">)</span>
<span class="line_number">4928 </span>        <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>history<span class="sign">)</span><span class="sign">)</span> history<span class="sign">[</span><span class="sign">[</span>i<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>mcmc<span class="sign">(</span>history<span class="sign">[</span><span class="sign">[</span>i<span class="sign">]</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">4929 </span>    <span class="sign">}</span>
<span class="line_number">4930 </span>    <span class="comment"># clear history rownames</span>
<span class="line_number">4931 </span>    <span class="keyword">rownames</span><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rownames</span><span class="sign">(</span>history<span class="sign">$</span>coefficients<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span>
<span class="line_number">4932 </span>        <span class="keyword">rownames</span><span class="sign">(</span>history<span class="sign">$</span>splinepar<span class="sign">.</span>haz<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rownames</span><span class="sign">(</span>history<span class="sign">$</span>splinepar<span class="sign">.</span>frail<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">4933 </span>    control<span class="sign">$</span>iter <span class="sign">&lt;</span><span class="sign">-</span> iter
<span class="line_number">4934 </span>    <span class="sign">}</span><span class="sign">}</span><span class="sign">}</span>
<span class="line_number">4935 </span>
<span class="line_number">4936 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4937 </span>    <span class="comment"># output object</span>
<span class="line_number">4938 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span><span class="keyword">call</span> <span class="sign">=</span> <span class="keyword">call</span><span class="sign">,</span> history <span class="sign">=</span> history<span class="sign">,</span> posterior<span class="sign">.</span>mean <span class="sign">=</span> posterior<span class="sign">.</span>mean<span class="sign">,</span>
<span class="line_number">4939 </span>        hazard <span class="sign">=</span> hazard<span class="sign">,</span> frailty <span class="sign">=</span> frailty<span class="sign">,</span> control <span class="sign">=</span> control<span class="sign">,</span> data <span class="sign">=</span> agdata<span class="sign">)</span>
<span class="line_number">4940 </span>    class<span class="sign">(</span>out<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"<a href="./splinefrailty_rS3Methods2Fsplinesurv.html#robo166">splinesurv</a>"</span>
<span class="line_number">4941 </span>    <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">)</span>
<span class="line_number">4942 </span><span class="sign">}</span>
</pre>

</div> <!-- content -->
<div id="footer">
<p>Generated from ./splinesurv/R/splinefrailty.r with <a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> V4.99.36 on Wed Jul 16 2008 11:21:32
</p>
</div> <!-- footer -->

<!-- Start of StatCounter Code -->
<script type="text/javascript">
var sc_project=3825578; 
var sc_invisible=1; 
var sc_partition=34; 
var sc_click_stat=1; 
var sc_security="6730661a"; 
</script>

<script type="text/javascript" src="http://www.statcounter.com/counter/counter_xhtml.js"></script><noscript><div class="statcounter"><a href="http://www.statcounter.com/" target="_blank"><img class="statcounter" src="http://c.statcounter.com/3825578/0/6730661a/1/" alt="free hit counter script" ></a></div></noscript>
<!-- End of StatCounter Code -->
</body>

</html>
