<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="../robodoc.css" type="text/css" />
<title>./splinesurv/R/splinefrailty.r</title>
<!-- Source: ./splinesurv/R/splinefrailty.r -->
<!-- Generated with ROBODoc Version 4.99.36 (Jun 17 2008) -->
</head>
<body>
<div id="logo">
<a name="robo_top_of_doc">splinesurv</a>
</div> <!-- logo -->
<div id="navigation">
<a class="menuitem" href="../toc_index.html#top">Table of Contents</a>
<a class="menuitem" href="../robo_sourcefiles.html#top">Sourcefiles</a>
<a class="menuitem" href="../masterindex.html#top">Index</a>
<a class="menuitem" href="../robo_definitions.html#top">Definitions</a>
<a class="menuitem" href="../robo_functions.html#top">Functions</a>
<a class="menuitem" href="../robo_modules.html#top">Modules</a>
</div> <!-- navigation -->
<div id="content">
<h3>TABLE OF CONTENTS</h3>
<ul>
<li>1. <a href="#robo0">/00main</a></li>
<ul>
<li>1.1. <a href="#robo21">00main/splinesurv.agdata</a></li>
<li>1.2. <a href="../src/mainloop_c.html#robo22">00main/SplineSurvMainLoop</a></li>
</ul>
<li>2. <a href="#robo1">/01structures</a></li>
<ul>
<li>2.1. <a href="../src/mainloop_c.html#robo23">01structures/CCurve</a></li>
<li>2.2. <a href="../src/mainloop_c.html#robo24">01structures/CHistory</a></li>
<li>2.3. <a href="../src/mainloop_c.html#robo25">01structures/CRegression</a></li>
<li>2.4. <a href="#robo26">01structures/RCurve</a></li>
<li>2.5. <a href="#robo27">01structures/RHistory</a></li>
<li>2.6. <a href="#robo28">01structures/RRegression</a></li>
</ul>
<li>3. <a href="#robo3">/initRoutine</a></li>
<ul>
<li>3.1. <a href="../src/init_c.html#robo13">initRoutine/CinitRoutine</a></li>
<ul>
<li>3.1.1. <a href="../src/init_c.html#robo51">CinitRoutine/addInitSmoothnessPenaltyGr</a></li>
<li>3.1.2. <a href="../src/init_c.html#robo52">CinitRoutine/cInitGrHazSpline</a></li>
<li>3.1.3. <a href="../src/init_c.html#robo53">CinitRoutine/cInitLikFrailSpline</a></li>
<li>3.1.4. <a href="../src/init_c.html#robo54">CinitRoutine/cInitLikHazSpline</a></li>
<li>3.1.5. <a href="../src/init_c.html#robo55">CinitRoutine/cInitMultAndWeight</a></li>
<li>3.1.6. <a href="../src/init_c.html#robo56">CinitRoutine/cMakePenalty2diff</a></li>
<li>3.1.7. <a href="../src/init_c.html#robo57">CinitRoutine/InitSmoothnessPenalty</a></li>
</ul>
<li>3.2. <a href="#robo120">initRoutine/fitparametric</a></li>
<li>3.3. <a href="#robo121">initRoutine/inithistory</a></li>
<li>3.4. <a href="#robo122">initRoutine/inverthessian</a></li>
<li>3.5. <a href="#robo123">initRoutine/makeknots</a></li>
<li>3.6. <a href="#robo124">initRoutine/makepenalty</a></li>
<li>3.7. <a href="#robo125">initRoutine/makePenalty.2deriv</a></li>
<li>3.8. <a href="#robo126">initRoutine/makePenalty.2diff</a></li>
<li>3.9. <a href="#robo127">initRoutine/nknotsPriorMean</a></li>
<li>3.10. <a href="#robo128">initRoutine/numHess.par</a></li>
</ul>
<li>4. <a href="#robo4">/RFitting</a></li>
<ul>
<li>4.1. <a href="#robo14">RFitting/curveUpdate</a></li>
<ul>
<li>4.1.1. <a href="#robo104">curveUpdate/evalparametric</a></li>
<li>4.1.2. <a href="#robo105">curveUpdate/evalspline</a></li>
<li>4.1.3. <a href="#robo106">curveUpdate/updatecurvex</a></li>
<li>4.1.4. <a href="#robo107">curveUpdate/updatehistory</a></li>
<li>4.1.5. <a href="#robo108">curveUpdate/updateparametric</a></li>
<li>4.1.6. <a href="#robo109">curveUpdate/updateregression</a></li>
<li>4.1.7. <a href="#robo110">curveUpdate/updatespline</a></li>
<li>4.1.8. <a href="#robo111">curveUpdate/weightcurve</a></li>
</ul>
<li>4.2. <a href="#robo15">RFitting/CWrappers</a></li>
<ul>
<li>4.2.1. <a href="#robo112">CWrappers/cevalBinte</a></li>
<li>4.2.2. <a href="#robo113">CWrappers/cevalCinte</a></li>
<li>4.2.3. <a href="#robo114">CWrappers/cevalEinte</a></li>
<li>4.2.4. <a href="#robo115">CWrappers/cmakePenalty.2deriv</a></li>
<li>4.2.5. <a href="#robo116">CWrappers/cmkgr.spline.haz</a></li>
<li>4.2.6. <a href="#robo117">CWrappers/cmklik.spline.frail</a></li>
<li>4.2.7. <a href="#robo118">CWrappers/cmklik.spline.haz</a></li>
<li>4.2.8. <a href="#robo119">CWrappers/csplinedesign</a></li>
</ul>
<li>4.3. <a href="#robo16">RFitting/makeLikelihood</a></li>
<ul>
<li>4.3.1. <a href="#robo129">makeLikelihood/mkgr.spline.haz</a></li>
<li>4.3.2. <a href="#robo130">makeLikelihood/mkhess.coef</a></li>
<li>4.3.3. <a href="#robo131">makeLikelihood/mklik.coef</a></li>
<li>4.3.4. <a href="#robo132">makeLikelihood/mklik.frail</a></li>
<li>4.3.5. <a href="#robo133">makeLikelihood/mklik.param.frail</a></li>
<li>4.3.6. <a href="#robo134">makeLikelihood/mklik.param.haz</a></li>
<li>4.3.7. <a href="#robo135">makeLikelihood/mklik.spline.frail</a></li>
<li>4.3.8. <a href="#robo136">makeLikelihood/mklik.spline.frail.init</a></li>
<li>4.3.9. <a href="#robo137">makeLikelihood/mklik.spline.haz</a></li>
<li>4.3.10. <a href="#robo138">makeLikelihood/mklik.weight.frail</a></li>
<li>4.3.11. <a href="#robo139">makeLikelihood/mklik.weight.haz</a></li>
<li>4.3.12. <a href="#robo140">makeLikelihood/smoothpen</a></li>
</ul>
<li>4.4. <a href="#robo17">RFitting/MetropolisHastings</a></li>
<ul>
<li>4.4.1. <a href="#robo141">MetropolisHastings/acceptreject</a></li>
<li>4.4.2. <a href="#robo142">MetropolisHastings/mh</a></li>
<li>4.4.3. <a href="#robo143">MetropolisHastings/mh.bdm</a></li>
<li>4.4.4. <a href="#robo144">MetropolisHastings/mh.coef</a></li>
<li>4.4.5. <a href="#robo145">MetropolisHastings/mh.frail</a></li>
<li>4.4.6. <a href="#robo146">MetropolisHastings/mh.frailty.param</a></li>
<li>4.4.7. <a href="#robo147">MetropolisHastings/mh.frailty.spline</a></li>
<li>4.4.8. <a href="#robo148">MetropolisHastings/mh.hazard.param</a></li>
<li>4.4.9. <a href="#robo149">MetropolisHastings/mh.hazard.spline</a></li>
<li>4.4.10. <a href="#robo150">MetropolisHastings/mh.weight</a></li>
<li>4.4.11. <a href="#robo151">MetropolisHastings/updatepostvar.coef</a></li>
<li>4.4.12. <a href="#robo152">MetropolisHastings/updatepostvar.curve</a></li>
</ul>
<li>4.5. <a href="#robo18">RFitting/miscUtils</a></li>
<ul>
<li>4.5.1. <a href="#robo153">miscUtils/accrate.predict.lm</a></li>
<li>4.5.2. <a href="#robo154">miscUtils/haspar</a></li>
<li>4.5.3. <a href="#robo155">miscUtils/hasspline</a></li>
<li>4.5.4. <a href="#robo156">miscUtils/makeoutputcurve</a></li>
<li>4.5.5. <a href="#robo157">miscUtils/mdiag</a></li>
<li>4.5.6. <a href="#robo158">miscUtils/repairfrailtypar</a></li>
<li>4.5.7. <a href="#robo159">miscUtils/submean</a></li>
</ul>
<li>4.6. <a href="#robo19">RFitting/splineUtils</a></li>
<ul>
<li>4.6.1. <a href="#robo179">splineUtils/evalBinte</a></li>
<li>4.6.2. <a href="#robo180">splineUtils/evalCinte</a></li>
<li>4.6.3. <a href="#robo181">splineUtils/evalEinte</a></li>
<li>4.6.4. <a href="#robo182">splineUtils/frailtysplinefvar</a></li>
<li>4.6.5. <a href="#robo183">splineUtils/ki</a></li>
<li>4.6.6. <a href="#robo184">splineUtils/makesplinebasis</a></li>
<li>4.6.7. <a href="#robo185">splineUtils/mysplineDesign</a></li>
<li>4.6.8. <a href="#robo186">splineUtils/nBsmom</a></li>
<li>4.6.9. <a href="#robo187">splineUtils/nknotsPrior</a></li>
<li>4.6.10. <a href="#robo188">splineUtils/plotspline</a></li>
<li>4.6.11. <a href="#robo189">splineUtils/splineconv</a></li>
<li>4.6.12. <a href="#robo190">splineUtils/splinederivint</a></li>
</ul>
<li>4.7. <a href="#robo20">RFitting/ZZdebug</a></li>
<ul>
<li>4.7.1. <a href="#robo191">ZZdebug/rmkgr.spline.haz</a></li>
<li>4.7.2. <a href="#robo192">ZZdebug/rmklik.spline.haz</a></li>
</ul>
</ul>
<li>5. <a href="#robo5">/S3Methods</a></li>
<ul>
<li>5.1. <a href="#robo160">S3Methods/plot.splinesurv</a></li>
<li>5.2. <a href="#robo161">S3Methods/post.fvar</a></li>
<li>5.3. <a href="#robo162">S3Methods/predict.splinesurv</a></li>
<li>5.4. <a href="#robo163">S3Methods/print.splinesurv</a></li>
<li>5.5. <a href="#robo164">S3Methods/print.summary.splinesurv</a></li>
<li>5.6. <a href="#robo165">S3Methods/printcurvesummary</a></li>
<li>5.7. <a href="#robo166">S3Methods/splinesurv</a></li>
<li>5.8. <a href="#robo167">S3Methods/splinesurv.data.frame</a></li>
<li>5.9. <a href="#robo168">S3Methods/splinesurv.formula</a></li>
<li>5.10. <a href="#robo169">S3Methods/splinesurvtkplot</a></li>
<li>5.11. <a href="#robo170">S3Methods/summary.splinesurv</a></li>
</ul>
<li>6. <a href="#robo6">/simSurvival</a></li>
<ul>
<li>6.1. <a href="#robo171">simSurvival/bs.survfn</a></li>
<li>6.2. <a href="#robo172">simSurvival/dnegbin</a></li>
<li>6.3. <a href="#robo173">simSurvival/generateevents</a></li>
<li>6.4. <a href="#robo174">simSurvival/generaterandom</a></li>
<li>6.5. <a href="#robo175">simSurvival/makeagdata</a></li>
<li>6.6. <a href="#robo176">simSurvival/MYmvrnorm</a></li>
<li>6.7. <a href="#robo177">simSurvival/rinvgamma</a></li>
<li>6.8. <a href="#robo178">simSurvival/sim.sample</a></li>
</ul>
</ul>
<hr />
<a name="2f00main"></a>
<a name="robo0"></a><h2>/00main [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>00main</strong> --- main fitting routines
</pre>
<p class="item_name">FUNCTION</p>
<p>   The <a href="#robo166">splinesurv</a> package contains 
   utilities for nonparametric Bayesian analysis of clustered 
   survival data. The baseline hazard function and frailty density are modeled
   using penalized B-splines. Options include adaptive knot selection and the 
   inclusion of a parametric component.
</p>

<p>   The most important function is <a href="#robo21">splinesurv.agdata</a>, which does most
   of the model fitting. After initializing, the method either continues in
   R (if the option usec=TRUE is set), callling the various <a href="#robo142">mh</a>.* procedures,
   or calls <a href="../src/mainloop_c.html#robo22">SplineSurvMainLoop</a> in the C compiled code, which does the same
   thing, only faster. The R implemented routines are thus primarily for
   debugging.
</p>

<p>   The call graph below is rather small and unhelpful. See a larger but 
   equally unhelpful pdf version here:
   <a href="callgraph.pdf">callgraph.pdf</a>
</p>

<p><img src="dot_graph_1.png">
</p>
<p class="item_name">USAGE</p>
<pre>   For usage instructions, see the R package documentation
</pre>
<p class="item_name">AUTHOR</p>
<p>  Emmanuel Sharef
</p>

<hr />
<a name="2f01structures"></a>
<a name="robo1"></a><h2>/01structures [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>01structures</strong> --- data structures used
</pre>
<p class="item_name">FUNCTION</p>
<p>    The R and C implementations of this routine use particular data structures
    to contain curves, regression information and estimation history, which are
    documented here
</p>

<hr />
<a name="2finitRoutine"></a>
<a name="robo3"></a><h2>/initRoutine [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>   <strong>initRoutine</strong> --- Initialize the <a href="#robo166">splinesurv</a> routine
</pre>
<p class="item_name">FUNCTION</p>
<p>   Compute initial values for all parameters of interest and allocate the
   necessary storage
</p>

<hr />
<a name="2fRFitting"></a>
<a name="robo4"></a><h2>/RFitting [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>   <strong>RFitting</strong> --- model fitting routines in R
</pre>
<p class="item_name">FUNCTION</p>
<p>   Functions used to sample the MCMC chain from within R, without calling the C
   main loop. Some of these may make calls to C code occasionally, but the model-
   fitting on the whole is done in R. This gives the same results as C, but it's
   easier to debug and understand.
</p>

<hr />
<a name="2fS3Methods"></a>
<a name="robo5"></a><h2>/S3Methods [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>   <strong>S3Methods</strong> --- Methods for S3 classes
</pre>
<p class="item_name">FUNCTION</p>
<p>   Define the handling for the <a href="#robo166">splinesurv</a> and <a href="#robo166">splinesurv</a>.summary classes.
</p>

<hr />
<a name="2fsimSurvival"></a>
<a name="robo6"></a><h2>/simSurvival [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>     <strong>simSurvival</strong> --- Simulate survival data
</pre>
<p class="item_name">FUNCTION</p>
<p>     Generate simulated clustered survival data with arbitrary baseline hazard
     and frailty distributions. The main user-visible function here is <a href="#robo178">sim.sample</a>,
     which calls other simulation routines
</p>

<hr />
<a name="RFitting2fcurveUpdate"></a>
<a name="robo14"></a><h2>RFitting/curveUpdate [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo4">RFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>   <strong>curveUpdate</strong> --- Update B-spline curves
</pre>
<p class="item_name">FUNCTION</p>
<p>   Re-evaluate B-spline curves, usually with new parameters, different
   knots or component weights. The routines in R are relatively slow and
   easier to understand, the ones in C are designed to be faster.
</p>

<hr />
<a name="RFitting2fCWrappers"></a>
<a name="robo15"></a><h2>RFitting/CWrappers [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo4">RFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>   <strong>CWrappers</strong> --- Wrappers for functions written in C
</pre>
<p class="item_name">FUNCTION</p>
<p>   Make it easy to call functions written in C from inside R
</p>

<hr />
<a name="RFitting2fmakeLikelihood"></a>
<a name="robo16"></a><h2>RFitting/makeLikelihood [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo4">RFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>   <strong>makeLikelihood</strong> --- Compute likelihoods of parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>   Compute parameter likelihoods for use in Metropolis-Hastings steps
</p>

<hr />
<a name="RFitting2fMetropolisHastings"></a>
<a name="robo17"></a><h2>RFitting/MetropolisHastings [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo4">RFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>   <strong>MetropolisHastings</strong> --- MH and RJMCMC steps
</pre>
<p class="item_name">FUNCTION</p>
<p>   Execute each type of MH and Reversible-Jump step needed for the chain
</p>

<hr />
<a name="RFitting2fmiscUtils"></a>
<a name="robo18"></a><h2>RFitting/miscUtils [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo4">RFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>   <strong>miscUtils</strong> --- miscellaneous
</pre>
<p class="item_name">FUNCTION</p>
<p>   Miscellanous useful utilities
</p>

<hr />
<a name="RFitting2fsplineUtils"></a>
<a name="robo19"></a><h2>RFitting/splineUtils [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo4">RFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>     <strong>splineUtils</strong> --- Utilities for evaluating splines and related integrals
</pre>
<p class="item_name">FUNCTION</p>
<p>     Evaluate B-splines and integrals over B-splines, either in R or fast
     C code.
</p>

<hr />
<a name="RFitting2fZZdebug"></a>
<a name="robo20"></a><h2>RFitting/ZZdebug [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo4">RFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>   <strong>ZZdebug</strong> --- debugging functions
 FUNCTIONS
   Functions whose sole purpose is debugging, that have not been removed from the codebase
</pre>

<hr />
<a name="00main2fsplinesurv2eagdata"></a>
<a name="robo21"></a><h2>00main/splinesurv.agdata [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo0">00main</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>splinesurv.agdata</strong> --- main estimation function
</pre>
<p class="item_name">FUNCTION</p>
<p>    This is the main fitting function for the <a href="#robo166">splinesurv</a> routine. It accepts a data
    frame in a specified format, conducts the initialization procedure, then
    either starts the MCMC loop within R or calls compiled C code that does the same
    thing. 
</p>

<p>    See also the call graph linked from <a href="#robo0">00main</a>.
</p>
   
<p>    This function should not be called directly, instead the interface provided by
    <a href="#robo168">splinesurv.formula</a> should be used.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">4099 </span><strong>splinesurv.agdata</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> hazard <span class="sign">=</span> NULL<span class="sign">,</span> frailty <span class="sign">=</span> NULL<span class="sign">,</span> regression <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4100 </span>    control <span class="sign">=</span> NULL<span class="sign">,</span> coda <span class="sign">=</span> FALSE<span class="sign">,</span> initial <span class="sign">=</span> NULL<span class="sign">,</span> verbose <span class="sign">=</span> 3<span class="sign">,</span> usec <span class="sign">=</span> TRUE<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    x      a data frame with the following columns:
           i       cluster index
           j       subject index
           time    event time
           delta   event indicator
           ...     covariates
    See the package documentation for detail on the remaining options
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    an object of class <a href="#robo166">splinesurv</a>, see package documentation.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">4103 </span><span class="sign">{</span>
<span class="line_number">4104 </span>        
<span class="line_number">4105 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Initializing...\n"</span><span class="sign">)</span>
<span class="line_number">4106 </span>    
<span class="line_number">4107 </span>    agdata <span class="sign">&lt;</span><span class="sign">-</span> x
<span class="line_number">4108 </span>    rm<span class="sign">(</span>x<span class="sign">)</span>
<span class="line_number">4109 </span>    <span class="keyword">call</span> <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span><span class="keyword">call</span><span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4110 </span>    m <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span><span class="keyword">unique</span><span class="sign">(</span>agdata<span class="sign">$</span>i<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4111 </span>    <span class="keyword">if</span><span class="sign">(</span>m <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> warning<span class="sign">(</span><span class="quote">"Single cluster: frailty density estimate is meaningless"</span><span class="sign">)</span>
<span class="line_number">4112 </span>    Ji <span class="sign">&lt;</span><span class="sign">-</span> table<span class="sign">(</span>agdata<span class="sign">$</span>i<span class="sign">)</span>
<span class="line_number">4113 </span>    
<span class="line_number">4114 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tSetting initial parameters...\n"</span><span class="sign">)</span>
<span class="line_number">4115 </span>    
<span class="line_number">4116 </span>    <span class="comment"># Parse input (control)</span>
<span class="line_number">4117 </span>    control<span class="sign">.</span>in <span class="sign">&lt;</span><span class="sign">-</span> control
<span class="line_number">4118 </span>    <span class="comment"># default control options</span>
<span class="line_number">4119 </span>    control<span class="sign">.</span>default <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>
<span class="line_number">4120 </span>        burnin <span class="sign">=</span> 500<span class="sign">,</span> <span class="comment"># Length of the burn - in period</span>
<span class="line_number">4121 </span>        maxiter <span class="sign">=</span> 1000<span class="sign">,</span> <span class="comment"># Max number of iterations</span>
<span class="line_number">4122 </span>        thin <span class="sign">=</span> 1<span class="sign">,</span> <span class="comment"># Degree of thinning</span>
<span class="line_number">4123 </span>        tun<span class="sign">.</span>auto <span class="sign">=</span> TRUE<span class="sign">,</span> <span class="comment"># Auto - calibrate tuning parameters</span>
<span class="line_number">4124 </span>        tun<span class="sign">.</span><span class="keyword">int</span> <span class="sign">=</span> 100 <span class="comment"># Interval for calibration of the acceptance rate</span>
<span class="line_number">4125 </span>    <span class="sign">)</span>
<span class="line_number">4126 </span>    control <span class="sign">&lt;</span><span class="sign">-</span> control<span class="sign">.</span>default
<span class="line_number">4127 </span>    controlnames <span class="sign">&lt;</span><span class="sign">-</span> names<span class="sign">(</span>control<span class="sign">)</span>
<span class="line_number">4128 </span>    innames <span class="sign">&lt;</span><span class="sign">-</span> names<span class="sign">(</span>control<span class="sign">.</span>in<span class="sign">)</span>
<span class="line_number">4129 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>control<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4130 </span>        <span class="comment"># replace default control settings by any specified in input</span>
<span class="line_number">4131 </span>        <span class="keyword">for</span><span class="sign">(</span>n in innames<span class="sign">)</span> eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"control$"</span><span class="sign">,</span>
<span class="line_number">4132 </span>            match<span class="sign">.</span>arg<span class="sign">(</span>n<span class="sign">,</span> controlnames<span class="sign">)</span><span class="sign">,</span> <span class="quote">" &lt;- control.in$"</span><span class="sign">,</span> n<span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4133 </span>    <span class="sign">}</span>
<span class="line_number">4134 </span>    <span class="keyword">if</span><span class="sign">(</span>control<span class="sign">$</span>burnin <span class="sign">&gt;</span> control<span class="sign">$</span>maxiter<span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"Burnin cannot be greater than maxiter"</span><span class="sign">)</span>
<span class="line_number">4135 </span>     
<span class="line_number">4136 </span>     <span class="comment"># Parse input (frailty)   </span>
<span class="line_number">4137 </span>    frailty<span class="sign">.</span>in <span class="sign">&lt;</span><span class="sign">-</span> frailty
<span class="line_number">4138 </span>    <span class="comment"># default settings for frailty <a href="#robo26">RCurve</a> options</span>
<span class="line_number">4139 </span>    frailty<span class="sign">.</span>default <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>
<span class="line_number">4140 </span>        type <span class="sign">=</span> <span class="quote">"spline"</span><span class="sign">,</span>
<span class="line_number">4141 </span>        spline<span class="sign">.</span>ord <span class="sign">=</span> 4<span class="sign">,</span>
<span class="line_number">4142 </span>        spline<span class="sign">.</span>adaptive <span class="sign">=</span> TRUE<span class="sign">,</span>
<span class="line_number">4143 </span>        spline<span class="sign">.</span>knots <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4144 </span>        spline<span class="sign">.</span>knotspacing <span class="sign">=</span> <span class="quote">"equal"</span><span class="sign">,</span>
<span class="line_number">4145 </span>        spline<span class="sign">.</span>nknots <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4146 </span>        spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4147 </span>        spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4148 </span>        spline<span class="sign">.</span>ncandknots <span class="sign">=</span> 100<span class="sign">,</span>
<span class="line_number">4149 </span>        spline<span class="sign">.</span>bdmconst<span class="sign">=</span><span class="sign">.</span>4<span class="sign">,</span>
<span class="line_number">4150 </span>        spline<span class="sign">.</span>maxoccknots <span class="sign">=</span> 35<span class="sign">,</span>
<span class="line_number">4151 </span>        spline<span class="sign">.</span>maxknot <span class="sign">=</span> 5<span class="sign">,</span>
<span class="line_number">4152 </span>        spline<span class="sign">.</span>par <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4153 </span>        spline<span class="sign">.</span>min<span class="sign">=</span><span class="sign">-</span>100<span class="sign">,</span>
<span class="line_number">4154 </span>        spline<span class="sign">.</span>penalty <span class="sign">=</span> <span class="quote">"none"</span><span class="sign">,</span>
<span class="line_number">4155 </span>        spline<span class="sign">.</span>penaltyfactor <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4156 </span>        spline<span class="sign">.</span>meanpenalty <span class="sign">=</span> 1e10<span class="sign">,</span>
<span class="line_number">4157 </span>        spline<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4158 </span>        spline<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">.</span>01<span class="sign">,</span> 0<span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4159 </span>        spline<span class="sign">.</span>tun <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4160 </span>        spline<span class="sign">.</span>accept <span class="sign">=</span> 0<span class="sign">,</span>       
<span class="line_number">4161 </span>        param<span class="sign">.</span>dist <span class="sign">=</span> <span class="quote">"none"</span><span class="sign">,</span>
<span class="line_number">4162 </span>        param<span class="sign">.</span>par <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4163 </span>        param<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4164 </span>        param<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">.</span>01<span class="sign">,</span> 0<span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4165 </span>        param<span class="sign">.</span>tun <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4166 </span>        param<span class="sign">.</span>accept <span class="sign">=</span> 0<span class="sign">,</span>
<span class="line_number">4167 </span>        weight <span class="sign">=</span> 0<span class="sign">.</span>5<span class="sign">,</span>
<span class="line_number">4168 </span>        weight<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4169 </span>        weight<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>1<span class="sign">,</span> 2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4170 </span>        weight<span class="sign">.</span>tun <span class="sign">=</span> 0<span class="sign">.</span>01<span class="sign">,</span>
<span class="line_number">4171 </span>        weight<span class="sign">.</span>accept <span class="sign">=</span> 0<span class="sign">,</span>
<span class="line_number">4172 </span>        accept <span class="sign">=</span> 0
<span class="line_number">4173 </span>    <span class="sign">)</span>
<span class="line_number">4174 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">.</span>default
<span class="line_number">4175 </span>    frailtynames <span class="sign">&lt;</span><span class="sign">-</span> names<span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4176 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4177 </span>        <span class="comment"># replace default frailty options by input</span>
<span class="line_number">4178 </span>        <span class="keyword">for</span><span class="sign">(</span>n in names<span class="sign">(</span>frailty<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span> eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"frailty$"</span><span class="sign">,</span>
<span class="line_number">4179 </span>            match<span class="sign">.</span>arg<span class="sign">(</span>n<span class="sign">,</span> frailtynames<span class="sign">)</span><span class="sign">,</span> <span class="quote">" &lt;- frailty.in$"</span><span class="sign">,</span> n<span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4180 </span>    <span class="sign">}</span>
<span class="line_number">4181 </span>    <span class="comment"># set additional <a href="#robo26">RCurve</a> settings</span>
<span class="line_number">4182 </span>    frailty<span class="sign">$</span>type <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>frailty<span class="sign">$</span>type<span class="sign">,</span> c<span class="sign">(</span><span class="quote">"spline"</span><span class="sign">,</span> <span class="quote">"parametric"</span><span class="sign">,</span> <span class="quote">"both"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4183 </span>    frailty<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"spline"</span> <span class="sign">|</span> frailty<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span>
<span class="line_number">4184 </span>    frailty<span class="sign">$</span><a href="#robo154">haspar</a> <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"parametric"</span> <span class="sign">|</span> frailty<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span>
<span class="line_number">4185 </span>    frailty<span class="sign">$</span>spline<span class="sign">.</span>knotspacing <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knotspacing<span class="sign">,</span> c<span class="sign">(</span><span class="quote">"equal"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4186 </span>    frailty<span class="sign">$</span>spline<span class="sign">.</span>penalty <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>penalty<span class="sign">,</span>
<span class="line_number">4187 </span>        c<span class="sign">(</span><span class="quote">"2diff"</span><span class="sign">,</span> <span class="quote">"2deriv"</span><span class="sign">,</span> <span class="quote">"log2deriv"</span><span class="sign">,</span> <span class="quote">"none"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4188 </span>    frailty<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>frailty<span class="sign">$</span>param<span class="sign">.</span>dist<span class="sign">,</span> c<span class="sign">(</span><span class="quote">"none"</span><span class="sign">,</span> <span class="quote">"gamma"</span><span class="sign">,</span> <span class="quote">"lognormal"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4189 </span>    <span class="keyword">if</span><span class="sign">(</span>m <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">&amp;</span> frailty<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"parametric component not allowed for single cluster"</span><span class="sign">)</span>
<span class="line_number">4190 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo154">haspar</a> <span class="sign">&amp;</span> frailty<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"none"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">4191 </span>        warning<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"no distribution specified for frailty parametric component"</span><span class="sign">,</span>
<span class="line_number">4192 </span>            <span class="quote">"-- setting to gamma"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4193 </span>        frailty<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"gamma"</span>
<span class="line_number">4194 </span>    <span class="sign">}</span>
<span class="line_number">4195 </span>    <span class="comment"># match prior settings and set default hyperparameters</span>
<span class="line_number">4196 </span>    frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior<span class="sign">,</span>
<span class="line_number">4197 </span>        c<span class="sign">(</span><span class="quote">"poisson"</span><span class="sign">,</span> <span class="quote">"geometric"</span><span class="sign">,</span> <span class="quote">"poissonmix"</span><span class="sign">,</span> <span class="quote">"negbin"</span><span class="sign">,</span> <span class="quote">"power"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4198 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poisson"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4199 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> 10
<span class="line_number">4200 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"geometric"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4201 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">.</span>1
<span class="line_number">4202 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poissonmix"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4203 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>10<span class="sign">,</span> 30<span class="sign">)</span>
<span class="line_number">4204 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"negbin"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4205 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>2<span class="sign">,</span> <span class="sign">.</span>1<span class="sign">)</span>
<span class="line_number">4206 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"power"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4207 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>1 <span class="sign">/</span> 2
<span class="line_number">4208 </span>
<span class="line_number">4209 </span>    frailty<span class="sign">$</span>spline<span class="sign">.</span>norm <span class="sign">&lt;</span><span class="sign">-</span> TRUE
<span class="line_number">4210 </span>    frailty<span class="sign">$</span>name <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"frailty"</span>
<span class="line_number">4211 </span>    
<span class="line_number">4212 </span>     <span class="comment"># Parse input (hazard)   </span>
<span class="line_number">4213 </span>    hazard<span class="sign">.</span>in <span class="sign">&lt;</span><span class="sign">-</span> hazard
<span class="line_number">4214 </span>    <span class="comment"># default hazard <a href="#robo26">RCurve</a></span>
<span class="line_number">4215 </span>    hazard<span class="sign">.</span>default <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>
<span class="line_number">4216 </span>        type <span class="sign">=</span> <span class="quote">"spline"</span><span class="sign">,</span>
<span class="line_number">4217 </span>        spline<span class="sign">.</span>ord <span class="sign">=</span> 4<span class="sign">,</span>
<span class="line_number">4218 </span>        spline<span class="sign">.</span>adaptive <span class="sign">=</span> TRUE<span class="sign">,</span>
<span class="line_number">4219 </span>        spline<span class="sign">.</span>knotspacing <span class="sign">=</span> <span class="quote">"mixed"</span><span class="sign">,</span>
<span class="line_number">4220 </span>        spline<span class="sign">.</span>nknots <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4221 </span>        spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4222 </span>        spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4223 </span>        spline<span class="sign">.</span>ncandknots <span class="sign">=</span> 100<span class="sign">,</span>
<span class="line_number">4224 </span>        spline<span class="sign">.</span>maxoccknots <span class="sign">=</span> 35<span class="sign">,</span>
<span class="line_number">4225 </span>        spline<span class="sign">.</span>bdmconst<span class="sign">=</span><span class="sign">.</span>4<span class="sign">,</span>
<span class="line_number">4226 </span>        spline<span class="sign">.</span>knots <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4227 </span>        spline<span class="sign">.</span>par <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4228 </span>        spline<span class="sign">.</span>min<span class="sign">=</span><span class="sign">-</span>100<span class="sign">,</span>
<span class="line_number">4229 </span>        spline<span class="sign">.</span>penalty <span class="sign">=</span> <span class="quote">"none"</span><span class="sign">,</span>
<span class="line_number">4230 </span>        spline<span class="sign">.</span>penaltyfactor <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4231 </span>        spline<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4232 </span>        spline<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">.</span>01<span class="sign">,</span> 0<span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4233 </span>        spline<span class="sign">.</span>tun <span class="sign">=</span> 1<span class="sign">,</span>      
<span class="line_number">4234 </span>        spline<span class="sign">.</span>accept <span class="sign">=</span> 0<span class="sign">,</span> 
<span class="line_number">4235 </span>        param<span class="sign">.</span>dist <span class="sign">=</span> <span class="quote">"none"</span><span class="sign">,</span>
<span class="line_number">4236 </span>        param<span class="sign">.</span>par <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">4237 </span>        param<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4238 </span>        param<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">.</span>01<span class="sign">,</span> 0<span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4239 </span>        param<span class="sign">.</span>tun <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4240 </span>        param<span class="sign">.</span>accept <span class="sign">=</span> 0<span class="sign">,</span>
<span class="line_number">4241 </span>        weight <span class="sign">=</span> 0<span class="sign">.</span>5<span class="sign">,</span>
<span class="line_number">4242 </span>        weight<span class="sign">.</span>priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4243 </span>        weight<span class="sign">.</span>hyper <span class="sign">=</span> c<span class="sign">(</span>1<span class="sign">,</span> 2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4244 </span>        weight<span class="sign">.</span>tun <span class="sign">=</span> 0<span class="sign">.</span>01<span class="sign">,</span>
<span class="line_number">4245 </span>        weight<span class="sign">.</span>accept <span class="sign">=</span> 0
<span class="line_number">4246 </span>    <span class="sign">)</span>
<span class="line_number">4247 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">.</span>default
<span class="line_number">4248 </span>    haznames <span class="sign">&lt;</span><span class="sign">-</span> names<span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">4249 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4250 </span>        <span class="keyword">for</span><span class="sign">(</span>n in names<span class="sign">(</span>hazard<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span> eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"hazard$"</span><span class="sign">,</span>
<span class="line_number">4251 </span>            match<span class="sign">.</span>arg<span class="sign">(</span>n<span class="sign">,</span> haznames<span class="sign">)</span><span class="sign">,</span> <span class="quote">" &lt;- hazard.in$"</span><span class="sign">,</span> n<span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4252 </span>    <span class="sign">}</span>
<span class="line_number">4253 </span>    <span class="comment"># other hazard settings</span>
<span class="line_number">4254 </span>    hazard<span class="sign">$</span>type <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>hazard<span class="sign">$</span>type<span class="sign">,</span> c<span class="sign">(</span><span class="quote">"spline"</span><span class="sign">,</span> <span class="quote">"parametric"</span><span class="sign">,</span> <span class="quote">"both"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4255 </span>    hazard<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"spline"</span> <span class="sign">|</span> hazard<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span>
<span class="line_number">4256 </span>    hazard<span class="sign">$</span><a href="#robo154">haspar</a> <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"parametric"</span> <span class="sign">|</span> hazard<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span>
<span class="line_number">4257 </span>    hazard<span class="sign">$</span>spline<span class="sign">.</span>knotspacing <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>knotspacing<span class="sign">,</span>
<span class="line_number">4258 </span>        c<span class="sign">(</span><span class="quote">"quantile"</span><span class="sign">,</span> <span class="quote">"equal"</span><span class="sign">,</span> <span class="quote">"mixed"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4259 </span>    hazard<span class="sign">$</span>spline<span class="sign">.</span>penalty <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>penalty<span class="sign">,</span>
<span class="line_number">4260 </span>        c<span class="sign">(</span><span class="quote">"2diff"</span><span class="sign">,</span> <span class="quote">"2deriv"</span><span class="sign">,</span> <span class="quote">"log2deriv"</span><span class="sign">,</span> <span class="quote">"none"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4261 </span>    hazard<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>hazard<span class="sign">$</span>param<span class="sign">.</span>dist<span class="sign">,</span>
<span class="line_number">4262 </span>        c<span class="sign">(</span><span class="quote">"none"</span><span class="sign">,</span> <span class="quote">"exponential"</span><span class="sign">,</span> <span class="quote">"weibull"</span><span class="sign">,</span> <span class="quote">"lognormal"</span><span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">4263 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo154">haspar</a> <span class="sign">&amp;</span> hazard<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"none"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">4264 </span>        warning<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"no distribution specified for hazard parametric component"</span><span class="sign">,</span>
<span class="line_number">4265 </span>            <span class="quote">"-- setting to weibull"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4266 </span>        hazard<span class="sign">$</span>param<span class="sign">.</span>dist <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"weibull"</span>
<span class="line_number">4267 </span>    <span class="sign">}</span>
<span class="line_number">4268 </span>    <span class="comment"># priors and hyperparameters for the number of knots</span>
<span class="line_number">4269 </span>    hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior<span class="sign">,</span>
<span class="line_number">4270 </span>        c<span class="sign">(</span><span class="quote">"poisson"</span><span class="sign">,</span> <span class="quote">"geometric"</span><span class="sign">,</span> <span class="quote">"poissonmix"</span><span class="sign">,</span> <span class="quote">"negbin"</span><span class="sign">,</span> <span class="quote">"power"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4271 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poisson"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4272 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> 10
<span class="line_number">4273 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"geometric"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4274 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">.</span>1
<span class="line_number">4275 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poissonmix"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4276 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>10<span class="sign">,</span> 30<span class="sign">)</span>
<span class="line_number">4277 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"negbin"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4278 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>2<span class="sign">,</span> <span class="sign">.</span>1<span class="sign">)</span>
<span class="line_number">4279 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"power"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4280 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>1 <span class="sign">/</span> 2
<span class="line_number">4281 </span>
<span class="line_number">4282 </span>    <span class="comment"># default weight settings</span>
<span class="line_number">4283 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> hazard<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">4284 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> hazard<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">4285 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>frailty<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> frailty<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">4286 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> frailty<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">4287 </span>    
<span class="line_number">4288 </span>    hazard<span class="sign">$</span>spline<span class="sign">.</span>norm <span class="sign">&lt;</span><span class="sign">-</span> FALSE
<span class="line_number">4289 </span>    hazard<span class="sign">$</span>name <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"hazard"</span>
<span class="line_number">4290 </span>    hazard<span class="sign">$</span>x <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">$</span>time
<span class="line_number">4291 </span>     
<span class="line_number">4292 </span>    <span class="comment"># Parse input (regression)</span>
<span class="line_number">4293 </span>    reg<span class="sign">.</span>in <span class="sign">&lt;</span><span class="sign">-</span> regression
<span class="line_number">4294 </span>    reg<span class="sign">.</span>default <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>
<span class="line_number">4295 </span>        priorvar <span class="sign">=</span> 0<span class="sign">.</span>1<span class="sign">,</span>
<span class="line_number">4296 </span>        hyper <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">.</span>01<span class="sign">,</span> 0<span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4297 </span>        tun <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">4298 </span>        accept <span class="sign">=</span> 0
<span class="line_number">4299 </span>    <span class="sign">)</span>
<span class="line_number">4300 </span>    regression <span class="sign">&lt;</span><span class="sign">-</span> reg<span class="sign">.</span>default
<span class="line_number">4301 </span>    regnames <span class="sign">&lt;</span><span class="sign">-</span> names<span class="sign">(</span>regression<span class="sign">)</span>
<span class="line_number">4302 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>reg<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span>n in names<span class="sign">(</span>reg<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4303 </span>        eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"regression$"</span><span class="sign">,</span> match<span class="sign">.</span>arg<span class="sign">(</span>n<span class="sign">,</span> regnames<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4304 </span>            <span class="quote">" &lt;- reg.in$"</span><span class="sign">,</span> n<span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4305 </span>
<span class="line_number">4306 </span>     <span class="comment"># Default settings for the initial number of knots</span>
<span class="line_number">4307 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">)</span><span class="sign">)</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>adaptive<span class="sign">)</span> 
<span class="line_number">4308 </span>        min<span class="sign">(</span><a href="#robo127">nknotsPriorMean</a><span class="sign">(</span>hazard<span class="sign">)</span><span class="sign">,</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">)</span> <span class="keyword">else</span> 
<span class="line_number">4309 </span>        max<span class="sign">(</span>min<span class="sign">(</span>round<span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span> <span class="sign">/</span> 4<span class="sign">)</span><span class="sign">,</span> 35<span class="sign">)</span><span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">4310 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">)</span><span class="sign">)</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>adaptive<span class="sign">)</span>
<span class="line_number">4311 </span>        min<span class="sign">(</span><a href="#robo127">nknotsPriorMean</a><span class="sign">(</span>frailty<span class="sign">)</span><span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">)</span> <span class="keyword">else</span> 
<span class="line_number">4312 </span>        max<span class="sign">(</span>1<span class="sign">,</span> min<span class="sign">(</span>round<span class="sign">(</span>m <span class="sign">/</span> 4<span class="sign">)</span><span class="sign">,</span> 35<span class="sign">)</span><span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">4313 </span>    
<span class="line_number">4314 </span>    
<span class="line_number">4315 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tFitting Cox survival models...\n"</span><span class="sign">)</span>
<span class="line_number">4316 </span>    
<span class="line_number">4317 </span>    <span class="comment"># Cox fit with gamma frailties for initial values of Ui and beta</span>
<span class="line_number">4318 </span>    varnames <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">colnames</span><span class="sign">(</span>agdata<span class="sign">)</span><span class="sign">[</span> <span class="sign">-</span> <span class="sign">(</span>1<span class="sign">:</span>4<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">4319 </span>    qvarnames <span class="sign">&lt;</span><span class="sign">-</span> paste<span class="sign">(</span><span class="quote">"`"</span><span class="sign">,</span> varnames<span class="sign">,</span> <span class="quote">"`"</span><span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span>
<span class="line_number">4320 </span>    <span class="keyword">if</span><span class="sign">(</span>m <span class="sign">&gt;</span> 1<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4321 </span>        coxfit <span class="sign">&lt;</span><span class="sign">-</span> coxph<span class="sign">(</span>as<span class="sign">.</span>formula<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"Surv(time, delta)~"</span><span class="sign">,</span>
<span class="line_number">4322 </span>            paste<span class="sign">(</span>qvarnames<span class="sign">,</span> collapse <span class="sign">=</span> <span class="quote">" + "</span><span class="sign">)</span><span class="sign">,</span> <span class="quote">" + frailty(i)"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> data <span class="sign">=</span> agdata<span class="sign">)</span>
<span class="line_number">4323 </span>        Ui <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>coxfit<span class="sign">$</span>frail<span class="sign">)</span>
<span class="line_number">4324 </span>        <span class="keyword">if</span><span class="sign">(</span>var<span class="sign">(</span>Ui<span class="sign">)</span> <span class="sign">&lt;</span> 1e<span class="sign">-</span>5<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">4325 </span>            Ui <span class="sign">&lt;</span><span class="sign">-</span> 2 <span class="sign">*</span> runif<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4326 </span>            Ui <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">+</span> <span class="sign">(</span>Ui <span class="sign">-</span> mean<span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4327 </span>            Ui<span class="sign">[</span>Ui <span class="sign">&lt;</span> 0<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">4328 </span>        <span class="sign">}</span>
<span class="line_number">4329 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">4330 </span>        coxfit <span class="sign">&lt;</span><span class="sign">-</span> coxph<span class="sign">(</span>as<span class="sign">.</span>formula<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"Surv(time, delta)~"</span><span class="sign">,</span>
<span class="line_number">4331 </span>            paste<span class="sign">(</span>qvarnames<span class="sign">,</span> collapse <span class="sign">=</span> <span class="quote">" + "</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> data <span class="sign">=</span> agdata<span class="sign">)</span>
<span class="line_number">4332 </span>        Ui <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">4333 </span>    <span class="sign">}</span> 
<span class="line_number">4334 </span>    <span class="comment"># set initial frailies and regression structure</span>
<span class="line_number">4335 </span>    frailty<span class="sign">$</span>x <span class="sign">&lt;</span><span class="sign">-</span> Ui   
<span class="line_number">4336 </span>    beta <span class="sign">&lt;</span><span class="sign">-</span> coxfit<span class="sign">$</span>coef
<span class="line_number">4337 </span>    regression<span class="sign">$</span>m <span class="sign">&lt;</span><span class="sign">-</span> m
<span class="line_number">4338 </span>    regression<span class="sign">$</span>Ji <span class="sign">&lt;</span><span class="sign">-</span> Ji
<span class="line_number">4339 </span>    regression<span class="sign">$</span>covariates <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>matrix<span class="sign">(</span>agdata<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>4<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>beta<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4340 </span>    regression<span class="sign">$</span>time <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">$</span>time
<span class="line_number">4341 </span>    regression<span class="sign">$</span>status <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">$</span>delta
<span class="line_number">4342 </span>    regression<span class="sign">$</span>cluster <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>integer<span class="sign">(</span>agdata<span class="sign">$</span>i<span class="sign">)</span>
<span class="line_number">4343 </span>    regression <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo109">updateregression</a><span class="sign">(</span>regression<span class="sign">,</span> beta<span class="sign">)</span>
<span class="line_number">4344 </span>        
<span class="line_number">4345 </span>    rm<span class="sign">(</span>coxfit<span class="sign">)</span>
<span class="line_number">4346 </span>    
<span class="line_number">4347 </span>    <span class="comment"># Parametric fits</span>
<span class="line_number">4348 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2 <span class="sign">&amp;</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo154">haspar</a> <span class="sign">|</span> hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">4349 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tFitting parametric components...\n"</span><span class="sign">)</span>
<span class="line_number">4350 </span>    
<span class="line_number">4351 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo120">fitparametric</a><span class="sign">(</span>hazard<span class="sign">,</span> agdata<span class="sign">)</span>
<span class="line_number">4352 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo120">fitparametric</a><span class="sign">(</span>frailty<span class="sign">,</span> Ui<span class="sign">)</span>
<span class="line_number">4353 </span>
<span class="line_number">4354 </span>    <span class="comment"># Spline knots</span>
<span class="line_number">4355 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2 <span class="sign">&amp;</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">|</span> hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4356 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tComputing spline knots...\n"</span><span class="sign">)</span>
<span class="line_number">4357 </span>    
<span class="line_number">4358 </span>    hazbounds <span class="sign">&lt;</span><span class="sign">-</span> range<span class="sign">(</span>agdata<span class="sign">$</span>time<span class="sign">)</span> <span class="sign">+</span> c<span class="sign">(</span><span class="sign">-</span><span class="sign">.</span>1<span class="sign">,</span> <span class="sign">.</span>1<span class="sign">)</span> <span class="sign">*</span> <span class="keyword">diff</span><span class="sign">(</span>range<span class="sign">(</span>agdata<span class="sign">$</span>time<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4359 </span>    hazbounds<span class="sign">[</span>hazbounds <span class="sign">&lt;</span> 0<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">4360 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo123">makeknots</a><span class="sign">(</span>hazard<span class="sign">,</span> agdata<span class="sign">$</span>time<span class="sign">[</span>agdata<span class="sign">$</span>delta <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">]</span><span class="sign">,</span> bounds <span class="sign">=</span> hazbounds<span class="sign">)</span>
<span class="line_number">4361 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo123">makeknots</a><span class="sign">(</span>frailty<span class="sign">,</span> Ui<span class="sign">,</span> bounds <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">,</span> max<span class="sign">(</span>max<span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">,</span> min<span class="sign">(</span>2 <span class="sign">*</span> max<span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4362 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>maxknot<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4363 </span>        
<span class="line_number">4364 </span>    <span class="comment"># Evaluate the splines and integrals</span>
<span class="line_number">4365 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2 <span class="sign">&amp;</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">|</span> hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4366 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tConstructing spline basis functions...\n"</span><span class="sign">)</span>
<span class="line_number">4367 </span>    
<span class="line_number">4368 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo184">makesplinebasis</a><span class="sign">(</span>hazard<span class="sign">,</span> usec <span class="sign">=</span> usec<span class="sign">)</span>
<span class="line_number">4369 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo184">makesplinebasis</a><span class="sign">(</span>frailty<span class="sign">,</span> usec <span class="sign">=</span> usec<span class="sign">)</span>
<span class="line_number">4370 </span>       
<span class="line_number">4371 </span>    <span class="comment"># Penalty matrices</span>
<span class="line_number">4372 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2 <span class="sign">&amp;</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">|</span> hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4373 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tInitializing penalty matrices...\n"</span><span class="sign">)</span>
<span class="line_number">4374 </span>
<span class="line_number">4375 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo124">makepenalty</a><span class="sign">(</span>hazard<span class="sign">,</span> usec <span class="sign">=</span> usec<span class="sign">)</span>
<span class="line_number">4376 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo124">makepenalty</a><span class="sign">(</span>frailty<span class="sign">,</span> usec <span class="sign">=</span> usec<span class="sign">)</span>    
<span class="line_number">4377 </span>        
<span class="line_number">4378 </span>
<span class="line_number">4379 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2 <span class="sign">&amp;</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">|</span> hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4380 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tObtaining initial values for spline parameters...\n"</span><span class="sign">)</span>
<span class="line_number">4381 </span>
<span class="line_number">4382 </span>    <span class="sign">{</span><span class="sign">{</span><span class="sign">{</span><span class="comment"># Initial values for the theta vectors</span>
<span class="line_number">4383 </span>    
<span class="line_number">4384 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo154">haspar</a> <span class="sign">&amp;</span> hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4385 </span>        oldhazweight <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>weight
<span class="line_number">4386 </span>        hazard<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">;</span>
<span class="line_number">4387 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo111">weightcurve</a><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">4388 </span>    <span class="sign">}</span>
<span class="line_number">4389 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo154">haspar</a> <span class="sign">&amp;</span> frailty<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4390 </span>        oldfrailweight <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>weight
<span class="line_number">4391 </span>        frailty<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">;</span>
<span class="line_number">4392 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo111">weightcurve</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4393 </span>    <span class="sign">}</span>
<span class="line_number">4394 </span>
<span class="line_number">4395 </span>    <span class="comment"># Initial values for hazard parameters </span>
<span class="line_number">4396 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4397 </span>            theta<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">+</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span>
<span class="line_number">4398 </span>        <span class="keyword">if</span><span class="sign">(</span>usec<span class="sign">)</span><span class="sign">{</span> <span class="comment"># use fast C code to compute likelihoods</span>
<span class="line_number">4399 </span>            par <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>theta<span class="sign">.</span>haz<span class="sign">)</span><span class="sign">;</span> status <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>regression<span class="sign">$</span>status<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4400 </span>            lp <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>regression<span class="sign">$</span>lp<span class="sign">)</span><span class="sign">;</span> frailrep <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>frailty<span class="sign">$</span>x<span class="sign">,</span> Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4401 </span>            hazParY <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span><span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> hazard<span class="sign">$</span>param<span class="sign">.</span>y <span class="keyword">else</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">4402 </span>            hazParYcum <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span><span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> hazard<span class="sign">$</span>param<span class="sign">.</span>ycum <span class="keyword">else</span>
<span class="line_number">4403 </span>                <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">4404 </span>            weight <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>weight<span class="sign">;</span> B <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>basis<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4405 </span>            C <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>basiscum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4406 </span>            P <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>penaltyfactor <span class="sign">*</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>penaltymatrix<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4407 </span>            penaltyType <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>integer<span class="sign">(</span>pmatch<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>penalty<span class="sign">,</span>
<span class="line_number">4408 </span>                c<span class="sign">(</span><span class="quote">"none"</span><span class="sign">,</span> <span class="quote">"2diff"</span><span class="sign">,</span> <span class="quote">"2deriv"</span><span class="sign">,</span> <span class="quote">"log2deriv"</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4409 </span>            splinemin <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>min<span class="sign">)</span>
<span class="line_number">4410 </span>            sigma2 <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>priorvar
<span class="line_number">4411 </span>            sigma2 <span class="sign">&lt;</span><span class="sign">-</span> 100<span class="sign">;</span> sigma2target <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>priorvar
<span class="line_number">4412 </span>             <span class="comment">#compute initial values by slowly decreasing the prior variance for stability</span>
<span class="line_number">4413 </span>            <span class="keyword">while</span><span class="sign">(</span>sigma2 <span class="sign">&gt;</span> sigma2target<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4414 </span>                sigma2 <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sigma2 <span class="sign">/</span> 10<span class="sign">)</span>
<span class="line_number">4415 </span>                opt<span class="sign">.</span>theta<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> optim<span class="sign">(</span>par<span class="sign">,</span> fn <span class="sign">=</span> <a href="#robo118">cmklik.spline.haz</a><span class="sign">,</span> gr <span class="sign">=</span> <a href="#robo116">cmkgr.spline.haz</a><span class="sign">,</span>
<span class="line_number">4416 </span>                    status <span class="sign">=</span> status<span class="sign">,</span> lp <span class="sign">=</span> lp<span class="sign">,</span> frailrep <span class="sign">=</span> frailrep<span class="sign">,</span> hazParY <span class="sign">=</span> hazParY<span class="sign">,</span> 
<span class="line_number">4417 </span>                    hazParYcum <span class="sign">=</span> hazParYcum<span class="sign">,</span> weight <span class="sign">=</span> weight<span class="sign">,</span> B <span class="sign">=</span> B<span class="sign">,</span> C <span class="sign">=</span> C<span class="sign">,</span> P <span class="sign">=</span> P<span class="sign">,</span>
<span class="line_number">4418 </span>                    penaltyType <span class="sign">=</span> penaltyType<span class="sign">,</span> sigma2 <span class="sign">=</span> sigma2<span class="sign">,</span> min <span class="sign">=</span> splinemin<span class="sign">,</span>
<span class="line_number">4419 </span>                    method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span> control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4420 </span>                par <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>opt<span class="sign">.</span>theta<span class="sign">.</span>haz<span class="sign">$</span>par<span class="sign">)</span>
<span class="line_number">4421 </span>            <span class="sign">}</span>
<span class="line_number">4422 </span>            opt<span class="sign">.</span>theta<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> optim<span class="sign">(</span>par<span class="sign">,</span> fn <span class="sign">=</span> <a href="#robo118">cmklik.spline.haz</a><span class="sign">,</span> gr <span class="sign">=</span> <a href="#robo116">cmkgr.spline.haz</a><span class="sign">,</span>
<span class="line_number">4423 </span>                status <span class="sign">=</span> status<span class="sign">,</span> lp <span class="sign">=</span> lp<span class="sign">,</span> frailrep <span class="sign">=</span> frailrep<span class="sign">,</span> hazParY <span class="sign">=</span> hazParY<span class="sign">,</span>
<span class="line_number">4424 </span>                hazParYcum <span class="sign">=</span> hazParYcum<span class="sign">,</span> weight <span class="sign">=</span> weight<span class="sign">,</span> B <span class="sign">=</span> B<span class="sign">,</span> C <span class="sign">=</span> C<span class="sign">,</span> P <span class="sign">=</span> P<span class="sign">,</span>
<span class="line_number">4425 </span>                penaltyType <span class="sign">=</span> penaltyType<span class="sign">,</span> sigma2 <span class="sign">=</span> sigma2<span class="sign">,</span> min <span class="sign">=</span> splinemin<span class="sign">,</span>
<span class="line_number">4426 </span>                method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span> control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">,</span> maxit <span class="sign">=</span> 1<span class="sign">)</span><span class="sign">,</span> hessian <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4427 </span>            rm<span class="sign">(</span>par<span class="sign">,</span> status<span class="sign">,</span> lp<span class="sign">,</span> hazParY<span class="sign">,</span> hazParYcum<span class="sign">,</span> weight<span class="sign">,</span> B<span class="sign">,</span> C<span class="sign">,</span> P<span class="sign">,</span> penaltyType<span class="sign">,</span>
<span class="line_number">4428 </span>                splinemin<span class="sign">,</span> sigma2<span class="sign">)</span>
<span class="line_number">4429 </span>            gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4430 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> <span class="comment"># usec=FALSE</span>
<span class="line_number">4431 </span>            hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>hazard<span class="sign">,</span> theta<span class="sign">.</span>haz<span class="sign">)</span>
<span class="line_number">4432 </span>            gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4433 </span>            sigma2 <span class="sign">&lt;</span><span class="sign">-</span> 100<span class="sign">;</span> sigma2target <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>priorvar
<span class="line_number">4434 </span>             <span class="comment">#compute initial values by slowly decreasing the prior variance</span>
<span class="line_number">4435 </span>            <span class="keyword">while</span><span class="sign">(</span>sigma2 <span class="sign">&gt;</span> sigma2target<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4436 </span>                sigma2 <span class="sign">&lt;</span><span class="sign">-</span> sigma2 <span class="sign">/</span> 10<span class="sign">;</span>
<span class="line_number">4437 </span>                hazard<span class="sign">$</span>spline<span class="sign">.</span>priorvar <span class="sign">&lt;</span><span class="sign">-</span> sigma2
<span class="line_number">4438 </span>                opt<span class="sign">.</span>theta<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> optim<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span>
<span class="line_number">4439 </span>                        fn <span class="sign">=</span> <a href="#robo137">mklik.spline.haz</a><span class="sign">,</span>
<span class="line_number">4440 </span>                        gr <span class="sign">=</span> <a href="#robo129">mkgr.spline.haz</a><span class="sign">,</span>
<span class="line_number">4441 </span>                        method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span>
<span class="line_number">4442 </span>                        control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4443 </span>                        hazard <span class="sign">=</span> hazard<span class="sign">,</span>
<span class="line_number">4444 </span>                        frailty <span class="sign">=</span> frailty<span class="sign">,</span>
<span class="line_number">4445 </span>                        regression <span class="sign">=</span> regression<span class="sign">,</span>
<span class="line_number">4446 </span>                        hessian <span class="sign">=</span> FALSE<span class="sign">)</span>
<span class="line_number">4447 </span>                hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>hazard<span class="sign">,</span> opt<span class="sign">.</span>theta<span class="sign">.</span>haz<span class="sign">$</span>par<span class="sign">)</span>
<span class="line_number">4448 </span>            <span class="sign">}</span>
<span class="line_number">4449 </span>            opt<span class="sign">.</span>theta<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> optim<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span>
<span class="line_number">4450 </span>                    fn <span class="sign">=</span> <a href="#robo137">mklik.spline.haz</a><span class="sign">,</span>
<span class="line_number">4451 </span>                    gr <span class="sign">=</span> <a href="#robo129">mkgr.spline.haz</a><span class="sign">,</span>
<span class="line_number">4452 </span>                    method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span>
<span class="line_number">4453 </span>                    control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4454 </span>                    hazard <span class="sign">=</span> hazard<span class="sign">,</span>
<span class="line_number">4455 </span>                    frailty <span class="sign">=</span> frailty<span class="sign">,</span>
<span class="line_number">4456 </span>                    regression <span class="sign">=</span> regression<span class="sign">,</span>
<span class="line_number">4457 </span>                    hessian <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4458 </span>        <span class="sign">}</span>
<span class="line_number">4459 </span>        gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4460 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>hazard<span class="sign">,</span> opt<span class="sign">.</span>theta<span class="sign">.</span>haz<span class="sign">$</span>par<span class="sign">)</span>
<span class="line_number">4461 </span>
<span class="line_number">4462 </span>    <span class="sign">}</span>
<span class="line_number">4463 </span>
<span class="line_number">4464 </span>        <span class="comment"># Initial values for frailty parameters</span>
<span class="line_number">4465 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4466 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>fixedind <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">4467 </span>        <span class="comment"># parameter vector not including the fixed index</span>
<span class="line_number">4468 </span>            theta<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">+</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>ord <span class="sign">-</span> 1<span class="sign">)</span>
<span class="line_number">4469 </span>        <span class="sign">{</span>
<span class="line_number">4470 </span>            opt<span class="sign">.</span>theta<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> optim<span class="sign">(</span>theta<span class="sign">.</span>frail<span class="sign">,</span>
<span class="line_number">4471 </span>                    fn <span class="sign">=</span> <a href="#robo136">mklik.spline.frail.init</a><span class="sign">,</span>
<span class="line_number">4472 </span>                    method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span>
<span class="line_number">4473 </span>                    control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4474 </span>                    hazard <span class="sign">=</span> hazard<span class="sign">,</span>
<span class="line_number">4475 </span>                    frailty <span class="sign">=</span> frailty<span class="sign">,</span>
<span class="line_number">4476 </span>                    regression <span class="sign">=</span> regression<span class="sign">,</span>
<span class="line_number">4477 </span>                    hessian <span class="sign">=</span> TRUE<span class="sign">)</span>    
<span class="line_number">4478 </span>        <span class="sign">}</span>
<span class="line_number">4479 </span>        gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4480 </span>        <span class="comment"># add the fixed index back in</span>
<span class="line_number">4481 </span>        theta<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo158">repairfrailtypar</a><span class="sign">(</span>opt<span class="sign">.</span>theta<span class="sign">.</span>frail<span class="sign">$</span>par<span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>fixedind<span class="sign">)</span>
<span class="line_number">4482 </span>        badtheta <span class="sign">&lt;</span><span class="sign">-</span> TRUE<span class="sign">;</span> j <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>
<span class="line_number">4483 </span>        <span class="comment"># set the mean of the estimated frailty density to be exactly 1</span>
<span class="line_number">4484 </span>        <span class="keyword">while</span><span class="sign">(</span>badtheta<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4485 </span>           j <span class="sign">&lt;</span><span class="sign">-</span> j <span class="sign">+</span> 1
<span class="line_number">4486 </span>           thetaj <span class="sign">&lt;</span><span class="sign">-</span> suppressWarnings<span class="sign">(</span>log<span class="sign">(</span><span class="sign">-</span><span class="keyword">sum</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span> <span class="sign">-</span> j<span class="sign">]</span> <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>theta<span class="sign">.</span>frail<span class="sign">[</span> <span class="sign">-</span> j<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4487 </span>           <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>nan<span class="sign">(</span>thetaj<span class="sign">)</span><span class="sign">)</span> badtheta <span class="sign">&lt;</span><span class="sign">-</span> FALSE
<span class="line_number">4488 </span>        <span class="sign">}</span>
<span class="line_number">4489 </span>        theta<span class="sign">.</span>frail<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> thetaj<span class="sign">;</span> 
<span class="line_number">4490 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>frailty<span class="sign">,</span> theta<span class="sign">.</span>frail<span class="sign">)</span>
<span class="line_number">4491 </span>    <span class="sign">}</span>
<span class="line_number">4492 </span>
<span class="line_number">4493 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4494 </span>    <span class="comment"># reweight the inital curves</span>
<span class="line_number">4495 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&amp;</span> hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4496 </span>        hazard<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> oldhazweight
<span class="line_number">4497 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo111">weightcurve</a><span class="sign">(</span>hazard<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4498 </span>    <span class="sign">}</span>
<span class="line_number">4499 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&amp;</span> frailty<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4500 </span>        frailty<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> oldfrailweight
<span class="line_number">4501 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo111">weightcurve</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4502 </span>    <span class="sign">}</span>
<span class="line_number">4503 </span>
<span class="line_number">4504 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span> 
<span class="line_number">4505 </span>    <span class="comment"># Evaluate variances and hessians for candidate generation</span>
<span class="line_number">4506 </span>    frailty<span class="sign">$</span>tun <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">diff</span><span class="sign">(</span>range<span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">)</span><span class="sign">^</span>2 <span class="sign">/</span> 6
<span class="line_number">4507 </span>    hess<span class="sign">.</span>coef <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo130">mkhess.coef</a><span class="sign">(</span>regression<span class="sign">$</span>coefficients<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4508 </span>    Sigma<span class="sign">.</span>coef <span class="sign">&lt;</span><span class="sign">-</span> solve<span class="sign">(</span><span class="sign">-</span>hess<span class="sign">.</span>coef<span class="sign">)</span>
<span class="line_number">4509 </span>    regression<span class="sign">$</span>candcov <span class="sign">&lt;</span><span class="sign">-</span> Sigma<span class="sign">.</span>coef
<span class="line_number">4510 </span>    regression<span class="sign">$</span>cholcandcov <span class="sign">&lt;</span><span class="sign">-</span> chol<span class="sign">(</span>Sigma<span class="sign">.</span>coef<span class="sign">,</span> pivot <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4511 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4512 </span>        hess<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> opt<span class="sign">.</span>theta<span class="sign">.</span>haz<span class="sign">$</span>hess
<span class="line_number">4513 </span>        Sigma<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo122">inverthessian</a><span class="sign">(</span>hess<span class="sign">.</span>haz<span class="sign">)</span>
<span class="line_number">4514 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>candcov <span class="sign">&lt;</span><span class="sign">-</span> Sigma<span class="sign">.</span>haz
<span class="line_number">4515 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>candsd <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>1<span class="sign">,</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots <span class="sign">+</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span>
<span class="line_number">4516 </span>        hazard<span class="sign">$</span>spline<span class="sign">.</span>cholcandcov <span class="sign">&lt;</span><span class="sign">-</span> chol<span class="sign">(</span>Sigma<span class="sign">.</span>haz<span class="sign">,</span> pivot <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4517 </span>        rm<span class="sign">(</span>hess<span class="sign">.</span>haz<span class="sign">,</span> Sigma<span class="sign">.</span>haz<span class="sign">)</span>
<span class="line_number">4518 </span>    <span class="sign">}</span>
<span class="line_number">4519 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4520 </span>        hess<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> opt<span class="sign">.</span>theta<span class="sign">.</span>frail<span class="sign">$</span>hess
<span class="line_number">4521 </span>        Sigma<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo122">inverthessian</a><span class="sign">(</span>hess<span class="sign">.</span>frail<span class="sign">)</span>
<span class="line_number">4522 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>candcov <span class="sign">&lt;</span><span class="sign">-</span> Sigma<span class="sign">.</span>frail
<span class="line_number">4523 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>candsd <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>1<span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots <span class="sign">+</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span>
<span class="line_number">4524 </span>        frailty<span class="sign">$</span>spline<span class="sign">.</span>cholcandcov <span class="sign">&lt;</span><span class="sign">-</span> chol<span class="sign">(</span>Sigma<span class="sign">.</span>frail<span class="sign">,</span> pivot <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4525 </span>        rm<span class="sign">(</span>hess<span class="sign">.</span>frail<span class="sign">,</span> Sigma<span class="sign">.</span>frail<span class="sign">)</span>
<span class="line_number">4526 </span>    <span class="sign">}</span>
<span class="line_number">4527 </span>    <span class="comment"># construct a numeric hessian for the parametric parameters</span>
<span class="line_number">4528 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span><span class="sign">{</span> 
<span class="line_number">4529 </span>        <span class="comment"># (I don't remember why it doesn't just use <a href="#robo128">numHess.par</a> like for the frailty, but</span>
<span class="line_number">4530 </span>        <span class="comment">#   there must be a reason for this inelegant setup)</span>
<span class="line_number">4531 </span>        temphaz <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span><a href="#robo154">haspar</a> <span class="sign">=</span> hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">,</span> <a href="#robo155">hasspline</a> <span class="sign">=</span> hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">,</span>
<span class="line_number">4532 </span>        weight <span class="sign">=</span> hazard<span class="sign">$</span>weight<span class="sign">,</span> spline<span class="sign">.</span>y <span class="sign">=</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>y<span class="sign">,</span> spline<span class="sign">.</span>ycum <span class="sign">=</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>ycum<span class="sign">,</span>
<span class="line_number">4533 </span>        name <span class="sign">=</span> hazard<span class="sign">$</span>name<span class="sign">,</span> param<span class="sign">.</span>dist <span class="sign">=</span> hazard<span class="sign">$</span>param<span class="sign">.</span>dist<span class="sign">,</span> x <span class="sign">=</span> hazard<span class="sign">$</span>x<span class="sign">,</span> y <span class="sign">=</span> hazard<span class="sign">$</span>y<span class="sign">,</span>
<span class="line_number">4534 </span>        ycum <span class="sign">=</span> hazard<span class="sign">$</span>ycum<span class="sign">,</span> param<span class="sign">.</span>y <span class="sign">=</span> hazard<span class="sign">$</span>param<span class="sign">.</span>y<span class="sign">,</span> param<span class="sign">.</span>ycum <span class="sign">=</span> hazard<span class="sign">$</span>param<span class="sign">.</span>ycum<span class="sign">,</span>
<span class="line_number">4535 </span>        param<span class="sign">.</span>par <span class="sign">=</span> hazard<span class="sign">$</span>param<span class="sign">.</span>par<span class="sign">,</span> param<span class="sign">.</span>priorvar <span class="sign">=</span> hazard<span class="sign">$</span>param<span class="sign">.</span>priorvar<span class="sign">)</span>
<span class="line_number">4536 </span>        eps <span class="sign">&lt;</span><span class="sign">-</span> 1e<span class="sign">-</span>5
<span class="line_number">4537 </span>        par <span class="sign">&lt;</span><span class="sign">-</span> temphaz<span class="sign">$</span>param<span class="sign">.</span>par
<span class="line_number">4538 </span>        hess <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4539 </span>        <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4540 </span>            <span class="comment"># this constructs numerical gradients by finite differences</span>
<span class="line_number">4541 </span>            <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4542 </span>            par1 <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">;</span>par2 <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">;</span>par3 <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">;</span>
<span class="line_number">4543 </span>            <span class="keyword">if</span><span class="sign">(</span>i <span class="sign">=</span><span class="sign">=</span> j<span class="sign">)</span> <span class="sign">{</span>par1<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> eps<span class="sign">;</span>par2 <span class="sign">&lt;</span><span class="sign">-</span> par1<span class="sign">;</span>par3<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> 2 <span class="sign">*</span> eps<span class="sign">}</span>
<span class="line_number">4544 </span>            <span class="keyword">else</span> <span class="sign">{</span>par1<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> eps<span class="sign">;</span> par2<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">+</span> eps<span class="sign">;</span> par3 <span class="sign">&lt;</span><span class="sign">-</span> par1<span class="sign">;</span>
<span class="line_number">4545 </span>                par3<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">+</span> eps<span class="sign">}</span>
<span class="line_number">4546 </span>            g1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><a href="#robo134">mklik.param.haz</a><span class="sign">(</span>par1<span class="sign">,</span> temphaz<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span> <span class="sign">-</span>
<span class="line_number">4547 </span>                <a href="#robo134">mklik.param.haz</a><span class="sign">(</span>par<span class="sign">,</span> temphaz<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> eps
<span class="line_number">4548 </span>            g2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><a href="#robo134">mklik.param.haz</a><span class="sign">(</span>par3<span class="sign">,</span> temphaz<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span> <span class="sign">-</span>
<span class="line_number">4549 </span>                <a href="#robo134">mklik.param.haz</a><span class="sign">(</span>par2<span class="sign">,</span> temphaz<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> eps
<span class="line_number">4550 </span>            hess<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>g2 <span class="sign">-</span> g1<span class="sign">)</span> <span class="sign">/</span> eps
<span class="line_number">4551 </span>            <span class="sign">}</span>
<span class="line_number">4552 </span>        <span class="sign">}</span>
<span class="line_number">4553 </span>        Sigma<span class="sign">.</span>par<span class="sign">.</span>haz <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo122">inverthessian</a><span class="sign">(</span>hess<span class="sign">)</span>
<span class="line_number">4554 </span>        hazard<span class="sign">$</span>param<span class="sign">.</span>candcov <span class="sign">&lt;</span><span class="sign">-</span> Sigma<span class="sign">.</span>par<span class="sign">.</span>haz
<span class="line_number">4555 </span>        hazard<span class="sign">$</span>param<span class="sign">.</span>cholcandcov <span class="sign">&lt;</span><span class="sign">-</span> chol<span class="sign">(</span>Sigma<span class="sign">.</span>par<span class="sign">.</span>haz<span class="sign">,</span> pivot <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4556 </span>        rm<span class="sign">(</span>Sigma<span class="sign">.</span>par<span class="sign">.</span>haz<span class="sign">,</span> hess<span class="sign">,</span> temphaz<span class="sign">)</span>
<span class="line_number">4557 </span>    <span class="sign">}</span>
<span class="line_number">4558 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4559 </span>        Sigma<span class="sign">.</span>par<span class="sign">.</span>frail <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo122">inverthessian</a><span class="sign">(</span><a href="#robo128">numHess.par</a><span class="sign">(</span>frailty<span class="sign">$</span>param<span class="sign">.</span>par<span class="sign">,</span> <a href="#robo133">mklik.param.frail</a><span class="sign">,</span>
<span class="line_number">4560 </span>            hazard <span class="sign">=</span> hazard<span class="sign">,</span> frailty <span class="sign">=</span> frailty<span class="sign">,</span> regression <span class="sign">=</span> regression<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4561 </span>        frailty<span class="sign">$</span>param<span class="sign">.</span>candcov <span class="sign">&lt;</span><span class="sign">-</span> Sigma<span class="sign">.</span>par<span class="sign">.</span>frail
<span class="line_number">4562 </span>        frailty<span class="sign">$</span>param<span class="sign">.</span>cholcandcov <span class="sign">&lt;</span><span class="sign">-</span> chol<span class="sign">(</span>Sigma<span class="sign">.</span>par<span class="sign">.</span>frail<span class="sign">,</span> pivot <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4563 </span>        rm<span class="sign">(</span>Sigma<span class="sign">.</span>par<span class="sign">.</span>frail<span class="sign">)</span>
<span class="line_number">4564 </span>    <span class="sign">}</span>
<span class="line_number">4565 </span>    
<span class="line_number">4566 </span>    
<span class="line_number">4567 </span>    <span class="sign">}</span><span class="sign">}</span><span class="sign">}</span>
<span class="line_number">4568 </span>
<span class="line_number">4569 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>fvar <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo182">frailtysplinefvar</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4570 </span>    <span class="comment">#browser()</span>
<span class="line_number">4571 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4572 </span>    <span class="comment"># Store initial values in parameter history</span>
<span class="line_number">4573 </span>    history <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo121">inithistory</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">,</span> control<span class="sign">)</span>
<span class="line_number">4574 </span>    avg<span class="sign">.</span>tunhist <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">4575 </span>    avg<span class="sign">.</span>accepthist <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">4576 </span>    
<span class="line_number">4577 </span>
<span class="line_number">4578 </span>    <span class="comment"># an internal function to prepare the curve structures for calling the C code</span>
<span class="line_number">4579 </span>    prepforCall <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4580 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"parametric"</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">4581 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span> curve<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4582 </span>            addcols <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots <span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots
<span class="line_number">4583 </span>            curve<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4584 </span>            curve<span class="sign">$</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4585 </span>            curve<span class="sign">$</span>spline<span class="sign">.</span>candsd <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>candsd<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4586 </span>            curve<span class="sign">$</span>spline<span class="sign">.</span>basis <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basis<span class="sign">,</span> matrix<span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> 
<span class="line_number">4587 </span>                <span class="keyword">dim</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basis<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4588 </span>            curve<span class="sign">$</span>spline<span class="sign">.</span>basisint <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basisint<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4589 </span>            <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> curve<span class="sign">$</span>spline<span class="sign">.</span>basiscum <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basiscum<span class="sign">,</span>
<span class="line_number">4590 </span>                matrix<span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basiscum<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4591 </span>            <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> curve<span class="sign">$</span>spline<span class="sign">.</span>basisexp <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">,</span>
<span class="line_number">4592 </span>                <span class="keyword">rep</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> addcols<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4593 </span>        <span class="sign">}</span>
<span class="line_number">4594 </span>        curve<span class="sign">$</span>spline<span class="sign">.</span>candocc <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span>
<span class="line_number">4595 </span>        <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">4596 </span>    <span class="sign">}</span>
<span class="line_number">4597 </span>    <span class="keyword">if</span><span class="sign">(</span>usec<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4598 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> prepforCall<span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">4599 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> prepforCall<span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4600 </span>    <span class="sign">}</span>
<span class="line_number">4601 </span>
<span class="line_number">4602 </span>     <span class="comment"># this does nothing, it just creates a useful marker</span>
<span class="line_number">4603 </span>     main <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span><span class="sign">)</span> <span class="sign">{</span><span class="sign">}</span>
<span class="line_number">4604 </span>        
<span class="line_number">4605 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Starting MCMC...\n"</span><span class="sign">)</span>
<span class="line_number">4606 </span>    
<span class="line_number">4607 </span>    iter <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="comment"># Counts the recorded iterations</span>
<span class="line_number">4608 </span>    iter<span class="sign">.</span>el <span class="sign">&lt;</span><span class="sign">-</span> 0 <span class="comment"># Counts elapsed iterations in each thinning cycle</span>
<span class="line_number">4609 </span>    
<span class="line_number">4610 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 3<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span>iter<span class="sign">,</span> <span class="quote">" "</span><span class="sign">)</span>
<span class="line_number">4611 </span>
<span class="line_number">4612 </span>    
<span class="line_number">4613 </span>    <span class="keyword">while</span><span class="sign">(</span>iter <span class="sign">&lt;</span> control<span class="sign">$</span>maxiter<span class="sign">)</span>
<span class="line_number">4614 </span>    <span class="sign">{</span>
<span class="line_number">4615 </span>        <span class="keyword">if</span><span class="sign">(</span>usec<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4616 </span>            <span class="comment"># C version of the main loop</span>
<span class="line_number">4617 </span>            gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4618 </span>            nexttunint <span class="sign">&lt;</span><span class="sign">-</span> iter <span class="sign">-</span> iter<span class="sign">%</span><span class="sign">%</span>control<span class="sign">$</span>tun<span class="sign">.</span><span class="keyword">int</span> <span class="sign">+</span> control<span class="sign">$</span>tun<span class="sign">.</span><span class="keyword">int</span>
<span class="line_number">4619 </span>            enditer <span class="sign">&lt;</span><span class="sign">-</span> min<span class="sign">(</span>nexttunint<span class="sign">,</span> control<span class="sign">$</span>maxiter<span class="sign">)</span>
<span class="line_number">4620 </span>            out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span><span class="keyword">Call</span><span class="sign">(</span><span class="quote">"<a href="../src/mainloop_c.html#robo22">SplineSurvMainLoop</a>"</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">,</span> history<span class="sign">,</span> iter<span class="sign">,</span>
<span class="line_number">4621 </span>                enditer<span class="sign">,</span> control<span class="sign">$</span>thin<span class="sign">,</span> verbose<span class="sign">)</span> 
<span class="line_number">4622 </span>            iter <span class="sign">&lt;</span><span class="sign">-</span> enditer
<span class="line_number">4623 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">4624 </span>
<span class="line_number">4625 </span>            <span class="comment"># R version of the main loop</span>
<span class="line_number">4626 </span>
<span class="line_number">4627 </span>            iter<span class="sign">.</span>el <span class="sign">&lt;</span><span class="sign">-</span> iter<span class="sign">.</span>el <span class="sign">+</span> 1
<span class="line_number">4628 </span>
<span class="line_number">4629 </span>            <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 4<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span>iter<span class="sign">.</span>el<span class="sign">)</span>
<span class="line_number">4630 </span>                
<span class="line_number">4631 </span>            <span class="comment"># MH update of frailties</span>
<span class="line_number">4632 </span>            frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo145">mh.frail</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4633 </span>            
<span class="line_number">4634 </span>            <span class="comment"># MH update of regression parameters</span>
<span class="line_number">4635 </span>            regression <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo144">mh.coef</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4636 </span>
<span class="line_number">4637 </span>            <span class="comment"># MH update of baseline parameters</span>
<span class="line_number">4638 </span>            hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo149">mh.hazard.spline</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4639 </span>            
<span class="line_number">4640 </span>            <span class="comment"># MH update of frailty density parameters</span>
<span class="line_number">4641 </span>            frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo147">mh.frailty.spline</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4642 </span>                    
<span class="line_number">4643 </span>            <span class="comment"># MH update of parametric baseline parameters</span>
<span class="line_number">4644 </span>            hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo148">mh.hazard.param</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4645 </span>            
<span class="line_number">4646 </span>            <span class="comment"># MH update of parametric frailty parameters</span>
<span class="line_number">4647 </span>            frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo146">mh.frailty.param</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4648 </span>
<span class="line_number">4649 </span>            <span class="comment"># MH update of weights</span>
<span class="line_number">4650 </span>            hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo150">mh.weight</a><span class="sign">(</span><span class="quote">"hazard"</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4651 </span>            frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo150">mh.weight</a><span class="sign">(</span><span class="quote">"frailty"</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4652 </span>
<span class="line_number">4653 </span>            <span class="comment"># Update of the sigmas / taus</span>
<span class="line_number">4654 </span>            hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo152">updatepostvar.curve</a><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">4655 </span>            frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo152">updatepostvar.curve</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4656 </span>            regression <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo151">updatepostvar.coef</a><span class="sign">(</span>regression<span class="sign">)</span>
<span class="line_number">4657 </span>
<span class="line_number">4658 </span>            <span class="comment"># Birth - death - move</span>
<span class="line_number">4659 </span>            <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>adaptive<span class="sign">)</span>
<span class="line_number">4660 </span>                hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo143">mh.bdm</a><span class="sign">(</span><span class="quote">"hazard"</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4661 </span>            <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>adaptive<span class="sign">)</span>
<span class="line_number">4662 </span>                frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo143">mh.bdm</a><span class="sign">(</span><span class="quote">"frailty"</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4663 </span>
<span class="line_number">4664 </span>            <span class="comment"># record history</span>
<span class="line_number">4665 </span>            <span class="keyword">if</span><span class="sign">(</span>iter<span class="sign">.</span>el <span class="sign">=</span><span class="sign">=</span> control<span class="sign">$</span>thin<span class="sign">)</span><span class="sign">{</span>        
<span class="line_number">4666 </span>                iter <span class="sign">&lt;</span><span class="sign">-</span> iter <span class="sign">+</span> 1
<span class="line_number">4667 </span>                history <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo107">updatehistory</a><span class="sign">(</span>history<span class="sign">,</span> iter<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">4668 </span>                iter<span class="sign">.</span>el <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">4669 </span>                <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 3<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">" "</span><span class="sign">,</span> iter<span class="sign">,</span> <span class="quote">" "</span><span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span>
<span class="line_number">4670 </span>            <span class="sign">}</span>
<span class="line_number">4671 </span>        <span class="sign">}</span>
<span class="line_number">4672 </span>
<span class="line_number">4673 </span>        <span class="sign">{</span><span class="sign">{</span><span class="sign">{</span>  <span class="comment"># Periodic calibration check</span>
<span class="line_number">4674 </span>        <span class="keyword">if</span><span class="sign">(</span>iter<span class="sign">%</span><span class="sign">%</span>control<span class="sign">$</span>tun<span class="sign">.</span><span class="keyword">int</span> <span class="sign">=</span><span class="sign">=</span> 0 <span class="sign">&amp;</span> iter <span class="sign">&lt;</span> control<span class="sign">$</span>maxiter<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4675 </span>  
<span class="line_number">4676 </span>            <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">|</span> verbose <span class="sign">=</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span>iter<span class="sign">,</span> <span class="quote">" "</span><span class="sign">)</span>
<span class="line_number">4677 </span>            
<span class="line_number">4678 </span>            calinds <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>iter <span class="sign">-</span> control<span class="sign">$</span>tun<span class="sign">.</span><span class="keyword">int</span> <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span>iter   
<span class="line_number">4679 </span>
<span class="line_number">4680 </span>            <span class="comment"># Calibration of the tuning parameters for acceptance rate</span>
<span class="line_number">4681 </span>            <span class="keyword">if</span><span class="sign">(</span>control<span class="sign">$</span>tun<span class="sign">.</span>auto <span class="sign">&amp;</span> iter <span class="sign">&lt;</span><span class="sign">=</span> control<span class="sign">$</span>burnin<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4682 </span>               <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 3<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n Calibration ...\n"</span><span class="sign">)</span>
<span class="line_number">4683 </span>                      
<span class="line_number">4684 </span>                          
<span class="line_number">4685 </span>                tunnames <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="quote">"regression$tun"</span><span class="sign">,</span>
<span class="line_number">4686 </span>                    <span class="quote">"hazard$spline.tun"</span><span class="sign">,</span>
<span class="line_number">4687 </span>                    <span class="quote">"frailty$spline.tun"</span><span class="sign">,</span>
<span class="line_number">4688 </span>                    <span class="quote">"hazard$param.tun"</span><span class="sign">,</span>
<span class="line_number">4689 </span>                    <span class="quote">"frailty$param.tun"</span><span class="sign">,</span>
<span class="line_number">4690 </span>                    <span class="quote">"hazard$weight.tun"</span><span class="sign">,</span>
<span class="line_number">4691 </span>                    <span class="quote">"frailty$weight.tun"</span><span class="sign">,</span>
<span class="line_number">4692 </span>                    <span class="quote">"frailty$tun"</span><span class="sign">)</span>             
<span class="line_number">4693 </span>                alltun <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>tunnames<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4694 </span>                <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>alltun<span class="sign">)</span><span class="sign">)</span> eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"alltun["</span><span class="sign">,</span> i<span class="sign">,</span> <span class="quote">"] &lt;- "</span><span class="sign">,</span>
<span class="line_number">4695 </span>                    tunnames<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4696 </span>                avg<span class="sign">.</span>tunhist <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rbind</span><span class="sign">(</span>avg<span class="sign">.</span>tunhist<span class="sign">,</span> alltun<span class="sign">)</span>
<span class="line_number">4697 </span>                avg<span class="sign">.</span>accepthist <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rbind</span><span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">,</span>
<span class="line_number">4698 </span>                                      <span class="keyword">apply</span><span class="sign">(</span>history<span class="sign">$</span>accept<span class="sign">[</span>calinds<span class="sign">,</span> <span class="sign">]</span><span class="sign">,</span> 2<span class="sign">,</span> mean<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4699 </span>                <span class="keyword">for</span><span class="sign">(</span>g in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>alltun<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4700 </span>                    <span class="keyword">if</span><span class="sign">(</span>all<span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">&gt;</span><span class="sign">.</span>25<span class="sign">)</span><span class="sign">)</span> alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">*</span> 2
<span class="line_number">4701 </span>                    <span class="keyword">if</span><span class="sign">(</span>all<span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">&lt;</span><span class="sign">.</span>25<span class="sign">)</span><span class="sign">)</span> alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">/</span> 2
<span class="line_number">4702 </span>                    <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">&gt;</span><span class="sign">.</span>25<span class="sign">)</span> <span class="sign">&amp;</span> any<span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">&lt;</span><span class="sign">.</span>25<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4703 </span>                        <span class="comment"># build linear regression model for tuning parameters</span>
<span class="line_number">4704 </span>                        fit <span class="sign">&lt;</span><span class="sign">-</span> lm<span class="sign">(</span>y<span class="sign">~</span>x<span class="sign">,</span> data<span class="sign">.</span>frame<span class="sign">(</span>x <span class="sign">=</span> avg<span class="sign">.</span>tunhist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">,</span> 
<span class="line_number">4705 </span>                            y <span class="sign">=</span> avg<span class="sign">.</span>accepthist<span class="sign">[</span><span class="sign">,</span> g<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4706 </span>                        out <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>max<span class="sign">(</span>1e<span class="sign">-</span>3<span class="sign">,</span> nlm<span class="sign">(</span><a href="#robo153">accrate.predict.lm</a><span class="sign">,</span> alltun<span class="sign">[</span>g<span class="sign">]</span><span class="sign">,</span> m <span class="sign">=</span> fit<span class="sign">)</span><span class="sign">$</span>est<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4707 </span>                        <span class="keyword">if</span><span class="sign">(</span>inherits<span class="sign">(</span>out<span class="sign">,</span> <span class="quote">"try-error"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4708 </span>                            alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> avg<span class="sign">.</span>tunhist<span class="sign">[</span><span class="keyword">which</span><span class="sign">.</span>min<span class="sign">(</span><span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">-</span><span class="sign">.</span>25<span class="sign">)</span><span class="sign">^</span>2<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">4709 </span>                        <span class="keyword">else</span>
<span class="line_number">4710 </span>                            alltun<span class="sign">[</span>g<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> out
<span class="line_number">4711 </span>                    <span class="sign">}</span>
<span class="line_number">4712 </span>                <span class="sign">}</span>
<span class="line_number">4713 </span>                <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>alltun<span class="sign">)</span><span class="sign">)</span> eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span>tunnames<span class="sign">[</span>i<span class="sign">]</span><span class="sign">,</span>
<span class="line_number">4714 </span>                    <span class="quote">" &lt;- alltun["</span><span class="sign">,</span> i<span class="sign">,</span> <span class="quote">"]"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4715 </span>
<span class="line_number">4716 </span>                <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 4<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4717 </span>                    outmat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>avg<span class="sign">.</span>accepthist<span class="sign">,</span> alltun<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4718 </span>                    <span class="keyword">rownames</span><span class="sign">(</span>outmat<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> tunnames<span class="sign">;</span>
<span class="line_number">4719 </span>                    <span class="keyword">colnames</span><span class="sign">(</span>outmat<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="quote">"acceptance"</span><span class="sign">,</span> <span class="quote">"tuning"</span><span class="sign">)</span>
<span class="line_number">4720 </span>                    print<span class="sign">(</span>outmat<span class="sign">)</span>
<span class="line_number">4721 </span>                <span class="sign">}</span>
<span class="line_number">4722 </span>            <span class="sign">}</span>
<span class="line_number">4723 </span>            <span class="comment"># Print full iteration info</span>
<span class="line_number">4724 </span>            <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 5<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4725 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Frailties: "</span><span class="sign">,</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4726 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Coefficients: "</span><span class="sign">,</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>coefficients<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4727 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Hazard.spline: "</span><span class="sign">,</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4728 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Frailty.spline: "</span><span class="sign">,</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4729 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Hazard.param: "</span><span class="sign">,</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4730 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Frailty.param: "</span><span class="sign">,</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4731 </span>                <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Prior variances: "</span><span class="sign">,</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>priorvar<span class="sign">,</span> calinds<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">4732 </span>            <span class="sign">}</span>
<span class="line_number">4733 </span>            
<span class="line_number">4734 </span>            <span class="comment">#browser()</span>
<span class="line_number">4735 </span>            
<span class="line_number">4736 </span>        <span class="sign">}</span>
<span class="line_number">4737 </span>        <span class="sign">}</span><span class="sign">}</span><span class="sign">}</span>
<span class="line_number">4738 </span>        
<span class="line_number">4739 </span>    <span class="sign">}</span>   <span class="comment"># end main loop</span>
<span class="line_number">4740 </span>
<span class="line_number">4741 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4742 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span> 0<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Done!\n"</span><span class="sign">)</span>
<span class="line_number">4743 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo156">makeoutputcurve</a><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">4744 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo156">makeoutputcurve</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4745 </span>   
<span class="line_number">4746 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4747 </span>   <span class="sign">{</span><span class="sign">{</span><span class="sign">{</span> <span class="comment"># Construct output</span>
<span class="line_number">4748 </span>    <span class="keyword">if</span><span class="sign">(</span>control<span class="sign">$</span>burnin <span class="sign">&lt;</span> iter<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4749 </span>        <span class="keyword">if</span><span class="sign">(</span><a href="#robo155">hasspline</a><span class="sign">(</span>frailty<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4750 </span>        frail<span class="sign">.</span>par<span class="sign">.</span>rs <span class="sign">&lt;</span><span class="sign">-</span> rowSums<span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4751 </span>        history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">)</span> <span class="sign">/</span> frail<span class="sign">.</span>par<span class="sign">.</span>rs
<span class="line_number">4752 </span>        <span class="sign">}</span>
<span class="line_number">4753 </span>        sub <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>1<span class="sign">:</span><span class="sign">(</span>iter<span class="sign">)</span><span class="sign">)</span> <span class="sign">&gt;</span> <span class="sign">(</span>control<span class="sign">$</span>burnin<span class="sign">)</span>
<span class="line_number">4754 </span>        posterior<span class="sign">.</span>mean <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>coefficients <span class="sign">=</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>coefficients<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4755 </span>                            frailty <span class="sign">=</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4756 </span>                            hazard<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">=</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4757 </span>                            hazard<span class="sign">.</span>param<span class="sign">.</span>par <span class="sign">=</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4758 </span>                            hazard<span class="sign">.</span>weight <span class="sign">=</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>weight<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4759 </span>                            frailty<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">=</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4760 </span>                            frailty<span class="sign">.</span>param<span class="sign">.</span>par <span class="sign">=</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">,</span> sub<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">4761 </span>                            frailty<span class="sign">.</span>weight <span class="sign">=</span> <a href="#robo159">submean</a><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>weight<span class="sign">,</span> sub<span class="sign">)</span>
<span class="line_number">4762 </span>                        <span class="sign">)</span>
<span class="line_number">4763 </span>        <span class="comment"># save mean number of knots in spline.nknots for output</span>
<span class="line_number">4764 </span>        <span class="keyword">if</span><span class="sign">(</span><a href="#robo155">hasspline</a><span class="sign">(</span>hazard<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">4765 </span>            hazard<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> mean<span class="sign">(</span><span class="keyword">apply</span><span class="sign">(</span>history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>sub<span class="sign">,</span> <span class="sign">]</span><span class="sign">,</span> 1<span class="sign">,</span>
<span class="line_number">4766 </span>                <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">)</span> <span class="keyword">sum</span><span class="sign">(</span>x<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> 2 <span class="sign">*</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>ord
<span class="line_number">4767 </span>        <span class="keyword">if</span><span class="sign">(</span><a href="#robo155">hasspline</a><span class="sign">(</span>frailty<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">4768 </span>            frailty<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> mean<span class="sign">(</span><span class="keyword">apply</span><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>sub<span class="sign">,</span> <span class="sign">]</span><span class="sign">,</span> 1<span class="sign">,</span>
<span class="line_number">4769 </span>                <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">)</span> <span class="keyword">sum</span><span class="sign">(</span>x<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> 2 <span class="sign">*</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>ord
<span class="line_number">4770 </span>            history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">4771 </span>            posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">4772 </span>        <span class="sign">}</span>
<span class="line_number">4773 </span>        <span class="keyword">colnames</span><span class="sign">(</span>history<span class="sign">$</span>coefficients<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> varnames
<span class="line_number">4774 </span>        names<span class="sign">(</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>coefficients<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> varnames
<span class="line_number">4775 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">4776 </span>        postmean <span class="sign">=</span> NULL
<span class="line_number">4777 </span>    <span class="sign">}</span>
<span class="line_number">4778 </span>    <span class="keyword">if</span><span class="sign">(</span>coda<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4779 </span>        <span class="comment"># convert history to mcmc objects</span>
<span class="line_number">4780 </span>        library<span class="sign">(</span>coda<span class="sign">)</span>
<span class="line_number">4781 </span>        <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>history<span class="sign">)</span><span class="sign">)</span> history<span class="sign">[</span><span class="sign">[</span>i<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>mcmc<span class="sign">(</span>history<span class="sign">[</span><span class="sign">[</span>i<span class="sign">]</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">4782 </span>    <span class="sign">}</span>
<span class="line_number">4783 </span>    <span class="comment"># clear history rownames</span>
<span class="line_number">4784 </span>    <span class="keyword">rownames</span><span class="sign">(</span>history<span class="sign">$</span>frailty<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rownames</span><span class="sign">(</span>history<span class="sign">$</span>coefficients<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span>
<span class="line_number">4785 </span>        <span class="keyword">rownames</span><span class="sign">(</span>history<span class="sign">$</span>splinepar<span class="sign">.</span>haz<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rownames</span><span class="sign">(</span>history<span class="sign">$</span>splinepar<span class="sign">.</span>frail<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">4786 </span>    control<span class="sign">$</span>iter <span class="sign">&lt;</span><span class="sign">-</span> iter
<span class="line_number">4787 </span>    <span class="sign">}</span><span class="sign">}</span><span class="sign">}</span>
<span class="line_number">4788 </span>
<span class="line_number">4789 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">4790 </span>    <span class="comment"># output object</span>
<span class="line_number">4791 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span><span class="keyword">call</span> <span class="sign">=</span> <span class="keyword">call</span><span class="sign">,</span> history <span class="sign">=</span> history<span class="sign">,</span> posterior<span class="sign">.</span>mean <span class="sign">=</span> posterior<span class="sign">.</span>mean<span class="sign">,</span>
<span class="line_number">4792 </span>        hazard <span class="sign">=</span> hazard<span class="sign">,</span> frailty <span class="sign">=</span> frailty<span class="sign">,</span> control <span class="sign">=</span> control<span class="sign">,</span> data <span class="sign">=</span> agdata<span class="sign">)</span>
<span class="line_number">4793 </span>    class<span class="sign">(</span>out<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"<a href="#robo166">splinesurv</a>"</span>
<span class="line_number">4794 </span>    <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">)</span>
<span class="line_number">4795 </span><span class="sign">}</span>
</pre>

<hr />
<a name="01structures2fRCurve"></a>
<a name="robo26"></a><h2>01structures/RCurve [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo1">01structures</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>RCurve</strong> --- structure to store a curve in R
</pre>
<p class="item_name">FUNCTION</p>
<p>    This type of structure contains the information about a curve, either the hazard or frailty.
    This includes all parameters for spline and parametric components, weights, knot positions,
    etc, basis functions, tuning parameters, etc. It is the R analogue of the <a href="../src/mainloop_c.html#robo23">CCurve</a> structure.
</p>

<p>    In R, this is implemented as a simple list. Most of the components are defined at
    initialization, others are added during the procedure.
</p>

<p>    The components are:
</p>

<pre>        type                    "spline", "parametric" or "both"
        <a href="#robo155">hasspline</a>               boolean, whether a splien component is included
        <a href="#robo154">haspar</a>                  boolean, whether a parametric component is included
        name                    "hazard" or "frailty"
        spline.ord              order of the spline
        spline.adaptive         boolean, whether to use adaptive knot selection
        spline.knotspacing      "equal", "quantile", type of knot distribution 
        spline.nknots           number of knots
        spline.nknots.prior     prior on the number of knots
        spline.nknots.hyper     hyperparameters for the number of knots
        spline.ncandknots       number of candidate knots
        spline.candknots        candidate knots
        spline.maxoccknots      maximum number of occupied candidate knots
        spline.bdmconst         constant for birth-death-move step
        spline.knots            vector of knots
        spline.par              spline parameters
        spline.min              minimum value of a spline parameter
        spline.penalty          type of smoothness penalty to use ("none","2diff","2deriv")
        spline.penaltyfactor    scaling of the penalty
        spline.priorvar         prior variance for the spline penalty
        spline.hyper            hyperparameters for the prior variance
        spline.basis            B-spline basis
        spline.basisint         integrals of each B-spline basis function
        spline.basiscum         cumulative integrals of each basis function (hazard only)
        spline.basisexp         expectation of each spline basis function (frailty only)
        spline.candcov          covariance matrix used to generate candidate parameter sets
        spline.candcholcov      cholesky factorization of spline.candcov
        spline.fvar             frailty variance (frailty only)
        spline.fixedind         index of the spline component that remains fixed (frailty only)
        spline.tun              tuning parameter for the spline parameters
        spline.accept           acceptance rate of spline parameters
        param.dist              parametric distribution type
        param.par               parameters for the distribution
        param.priorvar          prior variance for the parametric parameters
        param.hyper             hyperparameters for the variance
        param.tun               tuning parameter
        param.accept            acceptance rate of parametric parameters
        weight                  weight of spline component
        weight.priorvar         variance of the weight
        weight.hyper            hyperparameters of the weight
        weight.tun              tuning parameter for the weight
        weight.accept           acceptance rate of the weight
        x                       observations (times for hazard, frailties for frailty curve)
        spline.y                spline component evaluated at x
        param.y                 parametric component evaluated at x
        y                       both components weighted
        spline.ycum             cumulative hazard evaluated at x using spline component
        param.ycum              cumulative hazard evaluated at y using parametric component
        ycum                    cumulative hazard
</pre>
<p></p>

<hr />
<a name="01structures2fRHistory"></a>
<a name="robo27"></a><h2>01structures/RHistory [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo1">01structures</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>RHistory</strong> --- structure to store MCMC history in R
</pre>
<p class="item_name">FUNCTION</p>
<p>    This type of structure contains the state of the MCMC procedure at each iteration.
    It is the R analogue of the <a href="../src/mainloop_c.html#robo24">CHistory</a> structure.
</p>

<p>    In R, this is implemented as a simple list. Most of the components are defined at
    initialization, others are added during the procedure. Each of the component has
    maxiter rows, and as many columns as needed to store the vector at each iteration.
    For spline parameters and knots, enough storage is allocated to store the maximum
    number of knots permitted by the adaptive selection procedure (if used). Unused storage
    is filled with -Inf.
</p>

<p>    See <a href="#robo121">inithistory</a> for the allocation procedure.
</p>

<pre>       frailty                 frailty estimates for each cluster
       coefficients            regression coefficient estimates
       hazard.spline.par       hazard spline parameters
       hazard.spline.knots     hazard spline knots
       frailty.spline.par      frailty spline parameters
       frailty.spline.knots    frailty spline knots
       frailty.spline.fvar     frailty spline variance
       hazard.param.par        hazard parametric component parameters
       frailty.param.par       frailty parametric component parameters
       hazard.weight           hazard spline component weight
       frailty.weight          frailty spline component weight
       priorvar                matrix of prior variances 
       accept                  matrix of acceptance rates
</pre>
<p></p>

<hr />
<a name="01structures2fRRegression"></a>
<a name="robo28"></a><h2>01structures/RRegression [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo1">01structures</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>RRegression</strong> --- structure to store regression information in R
</pre>
<p class="item_name">FUNCTION</p>
<p>    This type of structure contains the information about the regression components.
    It is the R analogue of the <a href="../src/mainloop_c.html#robo25">CRegression</a> structure.
</p>

<p>    In R, this is implemented as a simple list. Most of the components are defined at
    initialization, others are added during the procedure.
</p>

<p>    The components are:
</p>
<pre>        m               number of clusters
        Ji              vector of cluster sizes
        cluster         cluster index for each subject
        status          vector of status indicators
        covariates      matrix of covariates for each subject
        coefficients    regression coefficient estimates
        candcov         covariance matrix for candidate generation
        lp              vector of linear predictors
        priorvar        prior variance of regression coefficients
        hyper           hyperparameters for prior variance
        tun             tuning parameters
        accept          most recent acceptance indicator
</pre>
<p></p>

<hr />
<a name="curveUpdate2fevalparametric"></a>
<a name="robo104"></a><h2>curveUpdate/evalparametric [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo14">curveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>evalparametric</strong> --- evaluate the parametric component of a curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    Evaluate the parametric component of a curve, either at all observations
    or at a single observation.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1776 </span><strong>evalparametric</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> i <span class="sign">=</span> 0<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure
    i          the index of the observation that should be evaluated (0=all)
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      the input curve, with x[i] reevaluated at curve$param.par
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1779 </span><span class="sign">{</span>
<span class="line_number">1780 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>curve<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1781 </span>    <span class="keyword">if</span><span class="sign">(</span>i <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> ind <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>curve<span class="sign">$</span>x<span class="sign">)</span> <span class="keyword">else</span> ind <span class="sign">&lt;</span><span class="sign">-</span> i
<span class="line_number">1782 </span>    name <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>name
<span class="line_number">1783 </span>    dist <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>param<span class="sign">.</span>dist
<span class="line_number">1784 </span>    <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"none"</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1785 </span>    <span class="comment"># extract parameters and values at which to evaluate</span>
<span class="line_number">1786 </span>    par <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>param<span class="sign">.</span>par
<span class="line_number">1787 </span>    x <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>x<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">1788 </span>    <span class="keyword">if</span><span class="sign">(</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1789 </span>        <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"exponential"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1790 </span>            <span class="comment"># exponential components are parametrized by their log-baseline</span>
<span class="line_number">1791 </span>            lambda <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>par<span class="sign">)</span>
<span class="line_number">1792 </span>            y <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>lambda<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1793 </span>            ycum <span class="sign">&lt;</span><span class="sign">-</span> x <span class="sign">*</span> lambda
<span class="line_number">1794 </span>        <span class="sign">}</span>
<span class="line_number">1795 </span>        <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"weibull"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1796 </span>            <span class="comment"># weibull components are parametrized by their log-baseline and log-scale</span>
<span class="line_number">1797 </span>            lambda <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>par<span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1798 </span>            alpha <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>par<span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1799 </span>             y <span class="sign">&lt;</span><span class="sign">-</span> alpha <span class="sign">*</span> lambda <span class="sign">*</span> x<span class="sign">^</span><span class="sign">(</span>alpha <span class="sign">-</span> 1<span class="sign">)</span>
<span class="line_number">1800 </span>             ycum <span class="sign">&lt;</span><span class="sign">-</span> lambda <span class="sign">*</span> x<span class="sign">^</span>alpha
<span class="line_number">1801 </span>        <span class="sign">}</span>
<span class="line_number">1802 </span>        <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"lognormal"</span><span class="sign">)</span>
<span class="line_number">1803 </span>            stop<span class="sign">(</span><span class="quote">"lognormal distribution currently not fully supported"</span><span class="sign">)</span>
<span class="line_number">1804 </span>    <span class="sign">}</span>
<span class="line_number">1805 </span>    <span class="keyword">if</span><span class="sign">(</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1806 </span>        ycum <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">1807 </span>        <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"gamma"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1808 </span>            <span class="comment"># gamma components are parametrized by minus their log-shape</span>
<span class="line_number">1809 </span>            alpha <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span><span class="sign">-</span>par<span class="sign">)</span>
<span class="line_number">1810 </span>            y <span class="sign">&lt;</span><span class="sign">-</span> dgamma<span class="sign">(</span>x<span class="sign">,</span> shape <span class="sign">=</span> alpha<span class="sign">,</span> rate <span class="sign">=</span> alpha<span class="sign">)</span>
<span class="line_number">1811 </span>        <span class="sign">}</span>
<span class="line_number">1812 </span>        <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"lognormal"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1813 </span>            <span class="comment"># lognormal components are parametrized by their log-variance</span>
<span class="line_number">1814 </span>            alpha <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>par<span class="sign">)</span>
<span class="line_number">1815 </span>            y <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span><span class="sign">-</span><span class="sign">(</span>log<span class="sign">(</span>x<span class="sign">)</span> <span class="sign">+</span> alpha <span class="sign">/</span> 2<span class="sign">)</span><span class="sign">^</span>2 <span class="sign">/</span> <span class="sign">(</span>2 <span class="sign">*</span> alpha<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>x <span class="sign">*</span> <span class="keyword">sqrt</span><span class="sign">(</span>2 <span class="sign">*</span> pi <span class="sign">*</span> alpha<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1816 </span>        <span class="sign">}</span>
<span class="line_number">1817 </span>    <span class="sign">}</span>
<span class="line_number">1818 </span>    curve<span class="sign">$</span>param<span class="sign">.</span>y<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> y 
<span class="line_number">1819 </span>    curve<span class="sign">$</span>param<span class="sign">.</span>ycum<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> ycum
<span class="line_number">1820 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">1821 </span>         <span class="comment"># reweight the curve if it has a spline component</span>
<span class="line_number">1822 </span>         curve <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo111">weightcurve</a><span class="sign">(</span>curve<span class="sign">,</span> i<span class="sign">)</span>
<span class="line_number">1823 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1824 </span>        curve<span class="sign">$</span>y<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>param<span class="sign">.</span>y<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">1825 </span>        curve<span class="sign">$</span>ycum<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>param<span class="sign">.</span>ycum<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">1826 </span>    <span class="sign">}</span>  
<span class="line_number">1827 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1828 </span><span class="sign">}</span>
</pre>

<hr />
<a name="curveUpdate2fevalspline"></a>
<a name="robo105"></a><h2>curveUpdate/evalspline [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo14">curveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>evalspline</strong> --- evaluate the spline component of a curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    Evaluate the spline component of a curve with a new set of component weights, either
    at all observations, or at a single index.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1844 </span><strong>evalspline</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> i <span class="sign">=</span> 0<span class="sign">,</span> quick <span class="sign">=</span> FALSE<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure
    i          index of the observation that should be evaluated (0=all) 
    quick      for hazard curve, whether the cumulative basis integrals should be computed
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      the curve, with x[i] evaluated at the new curve$spline.par parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1847 </span><span class="sign">{</span>
<span class="line_number">1848 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>curve<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1849 </span>    <span class="comment"># extract observations and parameters</span>
<span class="line_number">1850 </span>    <span class="keyword">if</span><span class="sign">(</span>i <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">1851 </span>                ind <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>curve<span class="sign">$</span>x<span class="sign">)</span>
<span class="line_number">1852 </span>                curve<span class="sign">$</span>spline<span class="sign">.</span>y <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">1853 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>ind <span class="sign">&lt;</span><span class="sign">-</span> i<span class="sign">}</span>
<span class="line_number">1854 </span>    spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>par
<span class="line_number">1855 </span>    <span class="comment">#   normalize the frailty spline parameters</span>
<span class="line_number">1856 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> spline<span class="sign">.</span>par <span class="sign">-</span> log<span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1857 </span>    <span class="comment"># Evaluate the spline component</span>
<span class="line_number">1858 </span>    curve<span class="sign">$</span>spline<span class="sign">.</span>y<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> drop<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basis<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">,</span>drop <span class="sign">=</span> FALSE<span class="sign">]</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="keyword">exp</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1859 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span> <span class="sign">&amp;</span> <span class="sign">!</span>quick<span class="sign">)</span>
<span class="line_number">1860 </span>        <span class="comment"># for the hazard, evaluate the spline integrals</span>
<span class="line_number">1861 </span>        curve<span class="sign">$</span>spline<span class="sign">.</span>ycum<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> drop<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>basiscum<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">,</span>drop <span class="sign">=</span> FALSE<span class="sign">]</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="keyword">exp</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1862 </span>    <span class="keyword">else</span>
<span class="line_number">1863 </span>        curve<span class="sign">$</span>spline<span class="sign">.</span>ycum <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">1864 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">1865 </span>        <span class="comment"># Reweight the curve</span>
<span class="line_number">1866 </span>        curve <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo111">weightcurve</a><span class="sign">(</span>curve<span class="sign">,</span> i<span class="sign">)</span>
<span class="line_number">1867 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1868 </span>        curve<span class="sign">$</span>y<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>y<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">1869 </span>        curve<span class="sign">$</span>ycum<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ycum<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">1870 </span>    <span class="sign">}</span>
<span class="line_number">1871 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1872 </span><span class="sign">}</span>
</pre>

<hr />
<a name="curveUpdate2fupdatecurvex"></a>
<a name="robo106"></a><h2>curveUpdate/updatecurvex [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo14">curveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>updatecurvex</strong> --- change observations of a curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    Change the set of "x" values of a curve, that is, the set of points at which the
    curve is evaluated. This is called by <a href="#robo145">mh.frail</a>, when the frailties are updated.
    This function should be called if curve$x[i] was changed.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1940 </span><strong>updatecurvex</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> i<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure
    i          the index that was updated
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      the input curve, with the basis evaluated at x[i]
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1943 </span><span class="sign">{</span>
<span class="line_number">1944 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">!</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"Only frailty bases can be updated"</span><span class="sign">)</span>
<span class="line_number">1945 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1946 </span>        knots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">;</span> ord <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">;</span> x <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>x<span class="sign">[</span>i<span class="sign">]</span>
<span class="line_number">1947 </span>        <span class="comment"># recompute the basis at x[i]</span>
<span class="line_number">1948 </span>        curve<span class="sign">$</span>spline<span class="sign">.</span>basis<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo185">mysplineDesign</a><span class="sign">(</span>knots<span class="sign">,</span> x<span class="sign">,</span> ord<span class="sign">)</span> <span class="sign">/</span> curve<span class="sign">$</span>spline<span class="sign">.</span>basisint 
<span class="line_number">1949 </span>        <span class="comment"># evaluate the spline component</span>
<span class="line_number">1950 </span>        curve <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo105">evalspline</a><span class="sign">(</span>curve<span class="sign">,</span> i<span class="sign">)</span>
<span class="line_number">1951 </span>    <span class="sign">}</span>
<span class="line_number">1952 </span>    <span class="comment"># evaluate the parametric component</span>
<span class="line_number">1953 </span>    curve <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo104">evalparametric</a><span class="sign">(</span>curve<span class="sign">,</span> i<span class="sign">)</span>
<span class="line_number">1954 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>   
<span class="line_number">1955 </span><span class="sign">}</span>
</pre>

<hr />
<a name="curveUpdate2fupdatehistory"></a>
<a name="robo107"></a><h2>curveUpdate/updatehistory [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo14">curveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>updatehistory</strong> --- update <a href="#robo27">RHistory</a> structure
</pre>
<p class="item_name">FUNCTION</p>
<p>    Store the state of the chain at the current iteration in the <a href="#robo27">RHistory</a>
    structure.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">921 </span><strong>updatehistory</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>history<span class="sign">,</span> i<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    history        an <a href="#robo27">RHistory</a> structure
    i              integer, current iteration
    hazard         a hazard <a href="#robo26">RCurve</a>
    frailty        a frailty <a href="#robo26">RCurve</a>
    regression     a <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    history        updated Rhistory
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">924 </span><span class="sign">{</span>
<span class="line_number">925 </span>    <span class="comment"># store frailties and coefficients</span>
<span class="line_number">926 </span>    history<span class="sign">$</span>frailty<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>x
<span class="line_number">927 </span>    history<span class="sign">$</span>coefficients<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>coefficients
<span class="line_number">928 </span>    <span class="comment"># store spline knots and parameters</span>
<span class="line_number">929 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">930 </span>        history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">[</span>i<span class="sign">,</span> 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>par
<span class="line_number">931 </span>        history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>i<span class="sign">,</span> 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">)</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>knots
<span class="line_number">932 </span>    <span class="sign">}</span>
<span class="line_number">933 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">934 </span>        history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">[</span>i<span class="sign">,</span> 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>par
<span class="line_number">935 </span>        history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>i<span class="sign">,</span> 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">)</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>knots
<span class="line_number">936 </span>        history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>fvar<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>fvar
<span class="line_number">937 </span>    <span class="sign">}</span>
<span class="line_number">938 </span>    <span class="comment"># store parametric components and weights</span>
<span class="line_number">939 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> history<span class="sign">$</span>hazard<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>param<span class="sign">.</span>par
<span class="line_number">940 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> history<span class="sign">$</span>frailty<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>param<span class="sign">.</span>par
<span class="line_number">941 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&amp;</span> hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> history<span class="sign">$</span>hazard<span class="sign">.</span>weight<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>weight
<span class="line_number">942 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&amp;</span> frailty<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> history<span class="sign">$</span>frailty<span class="sign">.</span>weight<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>weight
<span class="line_number">943 </span>    <span class="comment"># store prior variance terms</span>
<span class="line_number">944 </span>    history<span class="sign">$</span>priorvar<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>regression<span class="sign">$</span>priorvar<span class="sign">,</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>priorvar<span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>priorvar<span class="sign">,</span>
<span class="line_number">945 </span>        hazard<span class="sign">$</span>param<span class="sign">.</span>priorvar<span class="sign">,</span> frailty<span class="sign">$</span>param<span class="sign">.</span>priorvar<span class="sign">,</span> hazard<span class="sign">$</span>weight<span class="sign">.</span>priorvar<span class="sign">,</span> frailty<span class="sign">$</span>weight<span class="sign">.</span>priorvar<span class="sign">)</span>
<span class="line_number">946 </span>    <span class="comment"># store acceptance history</span>
<span class="line_number">947 </span>    history<span class="sign">$</span>accept<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>regression<span class="sign">$</span>accept<span class="sign">,</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>accept<span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>accept<span class="sign">,</span>
<span class="line_number">948 </span>        hazard<span class="sign">$</span>param<span class="sign">.</span>accept<span class="sign">,</span> frailty<span class="sign">$</span>param<span class="sign">.</span>accept<span class="sign">,</span> hazard<span class="sign">$</span>weight<span class="sign">.</span>accept<span class="sign">,</span> frailty<span class="sign">$</span>weight<span class="sign">.</span>accept<span class="sign">,</span> frailty<span class="sign">$</span>accept<span class="sign">)</span>
<span class="line_number">949 </span>
<span class="line_number">950 </span>    <span class="keyword">return</span><span class="sign">(</span>history<span class="sign">)</span>
<span class="line_number">951 </span><span class="sign">}</span>
</pre>

<hr />
<a name="curveUpdate2fupdateparametric"></a>
<a name="robo108"></a><h2>curveUpdate/updateparametric [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo14">curveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>updateparametric</strong> --- update parametric component parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update a curve to use a new set of parameters for the parametric component.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1969 </span><strong>updateparametric</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> param<span class="sign">.</span>par<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure
    param.par  parameters for the parametric component
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      the input curve, re-evaluated at the new parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1972 </span><span class="sign">{</span>
<span class="line_number">1973 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>curve<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1974 </span>    <span class="comment"># copy the new parameters into the curve and re-evaluate</span>
<span class="line_number">1975 </span>    curve<span class="sign">$</span>param<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> param<span class="sign">.</span>par
<span class="line_number">1976 </span>    curve <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo104">evalparametric</a><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1977 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1978 </span><span class="sign">}</span>
</pre>

<hr />
<a name="curveUpdate2fupdateregression"></a>
<a name="robo109"></a><h2>curveUpdate/updateregression [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo14">curveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>updateregression</strong> --- update regression coefficients
</pre>
<p class="item_name">FUNCTION</p>
<p>     Recompute the <a href="#robo28">RRegression</a> structure for a new set of coefficients
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2021 </span><strong>updateregression</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>regression<span class="sign">,</span> coef<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>     regression        an <a href="#robo28">RRegression</a> structure
     coef              new set of regression coefficients
</pre>
<p class="item_name">OUTPUTS</p>
<pre>     regression        <a href="#robo28">RRegression</a> structure with the lp component updated
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2024 </span><span class="sign">{</span>
<span class="line_number">2025 </span>    regression<span class="sign">$</span>coefficients <span class="sign">&lt;</span><span class="sign">-</span> coef
<span class="line_number">2026 </span>    regression<span class="sign">$</span>lp <span class="sign">&lt;</span><span class="sign">-</span> drop<span class="sign">(</span>regression<span class="sign">$</span>covariates<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>regression<span class="sign">$</span>coefficients<span class="sign">)</span>
<span class="line_number">2027 </span>    <span class="keyword">return</span><span class="sign">(</span>regression<span class="sign">)</span>
<span class="line_number">2028 </span><span class="sign">}</span>
</pre>

<hr />
<a name="curveUpdate2fupdatespline"></a>
<a name="robo110"></a><h2>curveUpdate/updatespline [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo14">curveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>updatespline</strong> --- update the curve's spline parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update a curve with new spline parameters. This simply consists of copying the parameters
    into the curve structure and re-evaluating it using <a href="#robo105">evalspline</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1912 </span><strong>updatespline</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> spline<span class="sign">.</span>par<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure
    spline.par a new set of parameters for the spline component
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      the input curve with the spline component updated to the new parameters.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1915 </span><span class="sign">{</span>
<span class="line_number">1916 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>curve<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1917 </span>    <span class="comment"># For the frailty, make sure that the parameter at the fixed index is 0</span>
<span class="line_number">1918 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> spline<span class="sign">.</span>par <span class="sign">-</span> spline<span class="sign">.</span>par<span class="sign">[</span>curve<span class="sign">$</span>spline<span class="sign">.</span>fixedind<span class="sign">]</span>
<span class="line_number">1919 </span>    <span class="comment"># copy new parameters into the curve</span>
<span class="line_number">1920 </span>    curve<span class="sign">$</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> spline<span class="sign">.</span>par
<span class="line_number">1921 </span>    <span class="comment"># evaluate the curve</span>
<span class="line_number">1922 </span>    curve <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo105">evalspline</a><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1923 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1924 </span><span class="sign">}</span>
</pre>

<hr />
<a name="curveUpdate2fweightcurve"></a>
<a name="robo111"></a><h2>curveUpdate/weightcurve [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo14">curveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>weightcurve</strong> --- re-weight the spline and parametric components of a curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    Re-evaluate a curve if the relative weight of the spline and parametric component
    has changed, or if either of the component values has changed. Can evaluate either
    the entire curve or only a single index.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1994 </span><strong>weightcurve</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> i <span class="sign">=</span> 0<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure
    i          the index at which to evaluate (0=all)
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      the input curve, with curve$y and curve$ycum updated
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1997 </span><span class="sign">{</span>
<span class="line_number">1998 </span>    <span class="keyword">if</span><span class="sign">(</span>i <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> ind <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>curve<span class="sign">$</span>x<span class="sign">)</span> <span class="keyword">else</span> ind <span class="sign">&lt;</span><span class="sign">-</span> i
<span class="line_number">1999 </span>    <span class="comment"># reweigh curve$y</span>
<span class="line_number">2000 </span>    curve<span class="sign">$</span>y<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>weight <span class="sign">*</span> curve<span class="sign">$</span>spline<span class="sign">.</span>y<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">+</span> <span class="sign">(</span>1 <span class="sign">-</span> curve<span class="sign">$</span>weight<span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">2001 </span>        curve<span class="sign">$</span>param<span class="sign">.</span>y<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">2002 </span>    <span class="comment"># for the hazard, reweigh curve$ycum</span>
<span class="line_number">2003 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span>
<span class="line_number">2004 </span>        curve<span class="sign">$</span>ycum<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>weight <span class="sign">*</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ycum<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">+</span> <span class="sign">(</span>1 <span class="sign">-</span> curve<span class="sign">$</span>weight<span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">2005 </span>            curve<span class="sign">$</span>param<span class="sign">.</span>ycum<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">2006 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">2007 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CWrappers2fcevalBinte"></a>
<a name="robo112"></a><h2>CWrappers/cevalBinte [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo15">CWrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>cevalBinte</strong> --- wrapper for the C implementation of <a href="#robo179">evalBinte</a>
</pre>
<p class="item_name">FUNCTION</p>
<p>    see <a href="#robo179">evalBinte</a>
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3064 </span><strong>cevalBinte</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3067 </span><span class="sign">{</span>
<span class="line_number">3068 </span>    K <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>knots<span class="sign">)</span> <span class="sign">-</span> 2 <span class="sign">*</span> ord<span class="sign">;</span>
<span class="line_number">3069 </span>    binte <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">3070 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>C<span class="sign">(</span><span class="quote">"<strong>cevalBinte</strong>"</span><span class="sign">,</span>
<span class="line_number">3071 </span>            binte <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>binte<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3072 </span>            knots <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>knots<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3073 </span>            ord <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span>ord<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3074 </span>            K <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span>K<span class="sign">)</span>
<span class="line_number">3075 </span>          <span class="sign">)</span>
<span class="line_number">3076 </span>    binte <span class="sign">&lt;</span><span class="sign">-</span> out<span class="sign">$</span>binte
<span class="line_number">3077 </span>    <span class="keyword">return</span><span class="sign">(</span>binte<span class="sign">)</span>
<span class="line_number">3078 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CWrappers2fcevalCinte"></a>
<a name="robo113"></a><h2>CWrappers/cevalCinte [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo15">CWrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>cevalCinte</strong> --- wrapper for the C implementation of <strong>cevalCinte</strong>
</pre>
<p class="item_name">FUNCTION</p>
<p>    see <a href="#robo180">evalCinte</a>
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3087 </span><strong>cevalCinte</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">,</span> obs<span class="sign">,</span> Binte<span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3090 </span><span class="sign">{</span>
<span class="line_number">3091 </span>    K <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>knots<span class="sign">)</span> <span class="sign">-</span> 2 <span class="sign">*</span> ord<span class="sign">;</span>
<span class="line_number">3092 </span>    cinte <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>obs<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>Binte<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3093 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>C<span class="sign">(</span><span class="quote">"<strong>cevalCinte</strong>"</span><span class="sign">,</span>
<span class="line_number">3094 </span>            cinte <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>cinte<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3095 </span>            x <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>obs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3096 </span>            nx <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>obs<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3097 </span>            knots <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>knots<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3098 </span>            ord <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span>ord<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3099 </span>            K <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span>K<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3100 </span>            binte <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Binte<span class="sign">)</span>
<span class="line_number">3101 </span>        <span class="sign">)</span>
<span class="line_number">3102 </span>    cinte <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>out<span class="sign">$</span>cinte<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>obs<span class="sign">)</span><span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">)</span>
<span class="line_number">3103 </span>    <span class="keyword">return</span><span class="sign">(</span>cinte<span class="sign">)</span>
<span class="line_number">3104 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CWrappers2fcevalEinte"></a>
<a name="robo114"></a><h2>CWrappers/cevalEinte [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo15">CWrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>cevalEinte</strong> --- wrapper for the C implementation of <strong>cevalEinte</strong>
</pre>
<p class="item_name">FUNCTION</p>
<p>    see <a href="#robo181">evalEinte</a>
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3040 </span><strong>cevalEinte</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">,</span> N <span class="sign">=</span> 1<span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3043 </span><span class="sign">{</span>
<span class="line_number">3044 </span>    K <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>knots<span class="sign">)</span> <span class="sign">-</span> 2 <span class="sign">*</span> ord
<span class="line_number">3045 </span>    einte <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">3046 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>C<span class="sign">(</span><span class="quote">"<strong>cevalEinte</strong>"</span><span class="sign">,</span>
<span class="line_number">3047 </span>            einte <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>einte<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3048 </span>            knots <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>knots<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3049 </span>            ord <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span>ord<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3050 </span>            K <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span>K<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3051 </span>            N <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span>N<span class="sign">)</span>
<span class="line_number">3052 </span>           <span class="sign">)</span>
<span class="line_number">3053 </span>    einte <span class="sign">&lt;</span><span class="sign">-</span> out<span class="sign">$</span>einte
<span class="line_number">3054 </span>    <span class="keyword">return</span><span class="sign">(</span>einte<span class="sign">)</span>
<span class="line_number">3055 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CWrappers2fcmakePenalty2e2deriv"></a>
<a name="robo115"></a><h2>CWrappers/cmakePenalty.2deriv [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo15">CWrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>cmakePenalty.2deriv</strong> --- wrapper for <a href="../src/init_c.html#robo56">cMakePenalty2diff</a>
</pre>
<p class="item_name">FUNCTION</p>
<p>    see <a href="#robo125">makePenalty.2deriv</a>
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3113 </span><strong>cmakePenalty.2deriv</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>ord<span class="sign">,</span> knots<span class="sign">)</span><span class="sign">{</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3116 </span>    K <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>knots<span class="sign">)</span> <span class="sign">-</span> 2 <span class="sign">*</span> ord<span class="sign">;</span>
<span class="line_number">3117 </span>    P <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">)</span>
<span class="line_number">3118 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>C<span class="sign">(</span><span class="quote">"<a href="../src/init_c.html#robo56">cMakePenalty2diff</a>"</span><span class="sign">,</span>
<span class="line_number">3119 </span>        P <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>P<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3120 </span>        knots <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>knots<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3121 </span>        ord <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span>ord<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3122 </span>        K <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span>K<span class="sign">)</span>
<span class="line_number">3123 </span>    <span class="sign">)</span>
<span class="line_number">3124 </span>    P <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>out<span class="sign">$</span>P<span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">)</span>
<span class="line_number">3125 </span>    <span class="keyword">return</span><span class="sign">(</span>P<span class="sign">)</span>
<span class="line_number">3126 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CWrappers2fcmkgr2espline2ehaz"></a>
<a name="robo116"></a><h2>CWrappers/cmkgr.spline.haz [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo15">CWrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>cmkgr.spline.haz</strong> -- wrapper for <a href="../src/init_c.html#robo52">cInitGrHazSpline</a>
</pre>
<p class="item_name">FUNCTION</p>
<p>    Wrapper for <a href="../src/init_c.html#robo52">cInitGrHazSpline</a>, which computes hazard loglikelihood gradient for
    initialization only.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3227 </span><strong>cmkgr.spline.haz</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>par<span class="sign">,</span> status<span class="sign">,</span> lp<span class="sign">,</span> frailrep<span class="sign">,</span> hazParY<span class="sign">,</span> hazParYcum<span class="sign">,</span> weight<span class="sign">,</span>
<span class="line_number">3228 </span>    B<span class="sign">,</span> C<span class="sign">,</span> P<span class="sign">,</span> penaltyType<span class="sign">,</span> sigma2<span class="sign">,</span> min<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    see <a href="#robo118">cmklik.spline.haz</a> for inputs and outputs
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3231 </span><span class="sign">{</span>
<span class="line_number">3232 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3233 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>C<span class="sign">(</span><span class="quote">"<a href="../src/init_c.html#robo52">cInitGrHazSpline</a>"</span><span class="sign">,</span>
<span class="line_number">3234 </span>            gr <span class="sign">=</span> gr<span class="sign">,</span> par <span class="sign">=</span> par<span class="sign">,</span> status <span class="sign">=</span> status<span class="sign">,</span> lp <span class="sign">=</span> lp<span class="sign">,</span> frailrep <span class="sign">=</span> frailrep<span class="sign">,</span>
<span class="line_number">3235 </span>            hazParY <span class="sign">=</span> hazParY<span class="sign">,</span> hazParYcum <span class="sign">=</span> hazParYcum<span class="sign">,</span> weight <span class="sign">=</span> weight<span class="sign">,</span> B <span class="sign">=</span> B<span class="sign">,</span> C <span class="sign">=</span> C<span class="sign">,</span> P <span class="sign">=</span> P<span class="sign">,</span>
<span class="line_number">3236 </span>            penaltyType <span class="sign">=</span> penaltyType<span class="sign">,</span> sigma2 <span class="sign">=</span> sigma2<span class="sign">,</span> ny <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3237 </span>            nj <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> DUP <span class="sign">=</span> FALSE<span class="sign">)</span>
<span class="line_number">3238 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> out<span class="sign">$</span>gr
<span class="line_number">3239 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> gr <span class="sign">-</span> ifelse<span class="sign">(</span>par<span class="sign">&lt;</span> min<span class="sign">,</span> 2 <span class="sign">*</span> <span class="sign">(</span>par <span class="sign">-</span> min<span class="sign">)</span><span class="sign">,</span> 0<span class="sign">)</span>    
<span class="line_number">3240 </span>    <span class="keyword">return</span><span class="sign">(</span>gr<span class="sign">)</span>
<span class="line_number">3241 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CWrappers2fcmklik2espline2efrail"></a>
<a name="robo117"></a><h2>CWrappers/cmklik.spline.frail [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo15">CWrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>cmklik.spline.frail</strong> --- wrapper for <a href="../src/init_c.html#robo53">cInitLikFrailSpline</a>
</pre>
<p class="item_name">FUNCTION</p>
<p>    Wraps <a href="../src/init_c.html#robo53">cInitLikFrailSpline</a>, which computes the frailty spline parameter likelihood
    during initialization.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3264 </span><strong>cmklik.spline.frail</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>par<span class="sign">,</span> fixedind<span class="sign">,</span> frailParY<span class="sign">,</span> weight<span class="sign">,</span> B<span class="sign">,</span> E<span class="sign">,</span> M<span class="sign">,</span> P<span class="sign">,</span>
<span class="line_number">3265 </span>            penaltyType<span class="sign">,</span> sigma2<span class="sign">,</span> min<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    par        vector of spline parameters whose likelihood should be computed
    fixedind   index of the parameter held fixed for identifiability
    frailParY  parametric frailty density evaluated at each of the frailties
    weight     relative weight of parametric and spline component
    B          spline basis produced by <a href="../src/init_c.html#robo102">csplinedesign</a>
    E          vector of 1-means produced by <a href="../src/init_c.html#robo98">cevalEinte</a>
    M          large number used to penalize the frailty mean
    P          penalty matrix
    penaltyType    integer, see typePenalty
    sigma2     prior variance of spline parameters
    min        minimum allowed value of spline parameters
</pre>
<p class="item_name">OUTPUTS</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3268 </span><span class="sign">{</span>
<span class="line_number">3269 </span>    par <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span><a href="#robo158">repairfrailtypar</a><span class="sign">(</span>par<span class="sign">,</span> fixedind<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3270 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">3271 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>C<span class="sign">(</span><span class="quote">"<a href="../src/init_c.html#robo53">cInitLikFrailSpline</a>"</span><span class="sign">,</span> lik <span class="sign">=</span> lik<span class="sign">,</span> par <span class="sign">=</span> par<span class="sign">,</span> frailParY <span class="sign">=</span> frailParY<span class="sign">,</span>
<span class="line_number">3272 </span>        weight <span class="sign">=</span> weight<span class="sign">,</span> B <span class="sign">=</span> B<span class="sign">,</span> E <span class="sign">=</span> E<span class="sign">,</span> M <span class="sign">=</span> M<span class="sign">,</span> P <span class="sign">=</span> P<span class="sign">,</span> penaltyType <span class="sign">=</span> penaltyType<span class="sign">,</span> sigma2 <span class="sign">=</span> sigma2<span class="sign">,</span>
<span class="line_number">3273 </span>        ny <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>frailParY<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> nj <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> DUP <span class="sign">=</span> FALSE<span class="sign">)</span>
<span class="line_number">3274 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> out<span class="sign">$</span>lik
<span class="line_number">3275 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>ifelse<span class="sign">(</span>par<span class="sign">&lt;</span> min<span class="sign">,</span> <span class="sign">(</span>par <span class="sign">-</span> min<span class="sign">)</span><span class="sign">^</span>2<span class="sign">,</span> 0<span class="sign">)</span><span class="sign">)</span>    
<span class="line_number">3276 </span>    <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">3277 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CWrappers2fcmklik2espline2ehaz"></a>
<a name="robo118"></a><h2>CWrappers/cmklik.spline.haz [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo15">CWrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>cmklik.spline.haz</strong> --- spline hazard likelihood in C wrapper
</pre>
<p class="item_name">FUNCTION</p>
<p>    Wrapper for <a href="../src/init_c.html#robo54">cInitLikHazSpline</a>, likelihood function for use during initialization.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3174 </span><strong>cmklik.spline.haz</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>par<span class="sign">,</span> status<span class="sign">,</span> lp<span class="sign">,</span> frailrep<span class="sign">,</span> hazParY<span class="sign">,</span> hazParYcum<span class="sign">,</span> weight<span class="sign">,</span> 
<span class="line_number">3175 </span>        B<span class="sign">,</span> C<span class="sign">,</span> P<span class="sign">,</span> penaltyType<span class="sign">,</span> sigma2<span class="sign">,</span> min<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    par        vector of spline parameters whose likelihood should be computed
    status     vector of event indicators
    lp         vector of linear predictors, beta%*%Z
    frailrep   vector of frailties of same length as lp, repeated if necessary
    hazParY    parametric hazard evaluated at each of the event times
    hazParYcum parametric cumulative hazards
    weight     relative weight of parametric and spline component
    B          spline basis produced by <a href="../src/init_c.html#robo102">csplinedesign</a>
    C          cumulative spline basis produced by <a href="../src/init_c.html#robo95">cevalCinte</a>
    P          penalty matrix
    penaltyType    integer, see typePenalty
    sigma2     prior variance of spline parameters
    min        minimum allowed value of spline parameters
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik        loglikelihood of par
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3178 </span><span class="sign">{</span>
<span class="line_number">3179 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3180 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>C<span class="sign">(</span><span class="quote">"<a href="../src/init_c.html#robo54">cInitLikHazSpline</a>"</span><span class="sign">,</span>
<span class="line_number">3181 </span>            lik <span class="sign">=</span> lik<span class="sign">,</span> par <span class="sign">=</span> par<span class="sign">,</span> status <span class="sign">=</span> status<span class="sign">,</span> lp <span class="sign">=</span> lp<span class="sign">,</span> frailrep <span class="sign">=</span> frailrep<span class="sign">,</span>
<span class="line_number">3182 </span>            hazParY <span class="sign">=</span> hazParY<span class="sign">,</span> hazParYcum <span class="sign">=</span> hazParYcum<span class="sign">,</span> weight <span class="sign">=</span> weight<span class="sign">,</span> B <span class="sign">=</span> B<span class="sign">,</span> C <span class="sign">=</span> C<span class="sign">,</span> P <span class="sign">=</span> P<span class="sign">,</span>
<span class="line_number">3183 </span>            penaltyType <span class="sign">=</span> penaltyType<span class="sign">,</span> sigma2 <span class="sign">=</span> sigma2<span class="sign">,</span> ny <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3184 </span>            nj <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> DUP <span class="sign">=</span> FALSE<span class="sign">)</span>
<span class="line_number">3185 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> out<span class="sign">$</span>lik
<span class="line_number">3186 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>ifelse<span class="sign">(</span>par<span class="sign">&lt;</span> min<span class="sign">,</span> <span class="sign">(</span>par <span class="sign">-</span> min<span class="sign">)</span><span class="sign">^</span>2<span class="sign">,</span> 0<span class="sign">)</span><span class="sign">)</span>    
<span class="line_number">3187 </span>    <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">3188 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CWrappers2fcsplinedesign"></a>
<a name="robo119"></a><h2>CWrappers/csplinedesign [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo15">CWrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>csplinedesign</strong> --- wrapper for <strong>csplinedesign</strong>
</pre>
<p class="item_name">FUNCTION</p>
<p>    Computes a design matrix for the spline basis, by evaluating the set
    of order ord B-splines on the set of knots knots, at values x.
    Wraps the C implenentation of <strong>csplinedesign</strong>, which works identically to 
    splineDesign from the splines package,  but faster.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3015 </span><strong>csplinedesign</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>knots<span class="sign">,</span> x<span class="sign">,</span> ord<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    knots      vector of knots
    x          points at which the basis should be evaluated.
    ord        order of the spline
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    des        matrix, whose (i,j) entry is spline j evaluated at x[i]
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3018 </span><span class="sign">{</span>
<span class="line_number">3019 </span>    K <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>knots<span class="sign">)</span> <span class="sign">-</span> 2 <span class="sign">*</span> ord
<span class="line_number">3020 </span>    design <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>x<span class="sign">)</span><span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">)</span>
<span class="line_number">3021 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>C<span class="sign">(</span><span class="quote">"<strong>csplinedesign</strong>"</span><span class="sign">,</span>
<span class="line_number">3022 </span>            des <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>design<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3023 </span>            x <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>x<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3024 </span>            nx <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3025 </span>            knots <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>knots<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3026 </span>            ord <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span>ord<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3027 </span>            K <span class="sign">=</span> as<span class="sign">.</span>integer<span class="sign">(</span>K<span class="sign">)</span>
<span class="line_number">3028 </span>        <span class="sign">)</span>
<span class="line_number">3029 </span>    des <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>out<span class="sign">$</span>des<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>x<span class="sign">)</span><span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">)</span>
<span class="line_number">3030 </span>    <span class="keyword">return</span><span class="sign">(</span>des<span class="sign">)</span>
<span class="line_number">3031 </span><span class="sign">}</span>
</pre>

<hr />
<a name="initRoutine2ffitparametric"></a>
<a name="robo120"></a><h2>initRoutine/fitparametric [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo3">initRoutine</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>fitparametric</strong> --- fit a parametric component to a curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    Given a curve with a parametric component, compute a good set of initial
    values for the parametric component parameters. The parametric component
    distributions are parametrized in a way that allows Gaussian priors on the
    parameters, and this function incorporates that.
</p>

<p>    See also <a href="#robo104">evalparametric</a> for the parametrization used.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1710 </span><strong>fitparametric</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> x<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure with a parametric component
    x          a set of data points used for estimation
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      updated curve with curve$param.par holding initial values
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1713 </span><span class="sign">{</span>
<span class="line_number">1714 </span>    name <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>name
<span class="line_number">1715 </span>    dist <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>param<span class="sign">.</span>dist
<span class="line_number">1716 </span>    <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"none"</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1717 </span>    <span class="comment"># frailty curve</span>
<span class="line_number">1718 </span>    <span class="keyword">if</span><span class="sign">(</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span>
<span class="line_number">1719 </span>    <span class="sign">{</span>
<span class="line_number">1720 </span>        <span class="comment"># compute the variance of the frailties and set the parameter</span>
<span class="line_number">1721 </span>        <span class="comment"># according to the parametrization selected.</span>
<span class="line_number">1722 </span>        Ui <span class="sign">&lt;</span><span class="sign">-</span> x
<span class="line_number">1723 </span>        <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"gamma"</span><span class="sign">)</span>
<span class="line_number">1724 </span>            par <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>var<span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1725 </span>        <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"lognormal"</span><span class="sign">)</span>
<span class="line_number">1726 </span>        <span class="sign">{</span>
<span class="line_number">1727 </span>            varu <span class="sign">&lt;</span><span class="sign">-</span> var<span class="sign">(</span>Ui<span class="sign">)</span>
<span class="line_number">1728 </span>            par <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>log<span class="sign">(</span>varu <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1729 </span>        <span class="sign">}</span>
<span class="line_number">1730 </span>        curve<span class="sign">$</span>param<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> par
<span class="line_number">1731 </span>        curve<span class="sign">$</span>x <span class="sign">&lt;</span><span class="sign">-</span> Ui
<span class="line_number">1732 </span>    <span class="sign">}</span>
<span class="line_number">1733 </span>    <span class="comment"># hazard curve</span>
<span class="line_number">1734 </span>    <span class="keyword">if</span><span class="sign">(</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span>
<span class="line_number">1735 </span>    <span class="sign">{</span>
<span class="line_number">1736 </span>        agdata <span class="sign">&lt;</span><span class="sign">-</span> x
<span class="line_number">1737 </span>        varnames <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">colnames</span><span class="sign">(</span>agdata<span class="sign">)</span><span class="sign">[</span> <span class="sign">-</span> <span class="sign">(</span>1<span class="sign">:</span>4<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1738 </span>        qvarnames <span class="sign">&lt;</span><span class="sign">-</span> paste<span class="sign">(</span><span class="quote">"`"</span><span class="sign">,</span> varnames<span class="sign">,</span> <span class="quote">"`"</span><span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span>
<span class="line_number">1739 </span>        <span class="comment"># use survreg to fit a parametric component to the hazard</span>
<span class="line_number">1740 </span>        <span class="comment"># and transform the estimated parameters to the parametrization</span>
<span class="line_number">1741 </span>        fit <span class="sign">&lt;</span><span class="sign">-</span> survreg<span class="sign">(</span>as<span class="sign">.</span>formula<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"Surv(time, delta)~"</span><span class="sign">,</span> 
<span class="line_number">1742 </span>            paste<span class="sign">(</span>qvarnames<span class="sign">,</span> collapse <span class="sign">=</span> <span class="quote">" + "</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> data <span class="sign">=</span> agdata<span class="sign">,</span> dist <span class="sign">=</span> dist<span class="sign">)</span>
<span class="line_number">1743 </span>        <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"exponential"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1744 </span>            par <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>fit<span class="sign">$</span>icoef<span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1745 </span>        <span class="sign">}</span>
<span class="line_number">1746 </span>        <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"weibull"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1747 </span>            lambda <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span><span class="sign">-</span>fit<span class="sign">$</span>icoef<span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1748 </span>            gamma <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">/</span> <span class="keyword">exp</span><span class="sign">(</span>fit<span class="sign">$</span>icoef<span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1749 </span>            par <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>log<span class="sign">(</span>lambda<span class="sign">)</span><span class="sign">,</span> log<span class="sign">(</span>gamma<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1750 </span>        <span class="sign">}</span>
<span class="line_number">1751 </span>        <span class="keyword">if</span><span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"lognormal"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1752 </span>            par <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>fit<span class="sign">$</span>icoef<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> fit<span class="sign">$</span>icoef<span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1753 </span>        <span class="sign">}</span>
<span class="line_number">1754 </span>        names<span class="sign">(</span>par<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">1755 </span>        curve<span class="sign">$</span>param<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> par
<span class="line_number">1756 </span>        curve<span class="sign">$</span>x <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">$</span>time
<span class="line_number">1757 </span>    <span class="sign">}</span>
<span class="line_number">1758 </span>    <span class="comment"># Evaluate the curve at the parameter values chosen.</span>
<span class="line_number">1759 </span>    curve <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo104">evalparametric</a><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1760 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1761 </span><span class="sign">}</span>
</pre>

<hr />
<a name="initRoutine2finithistory"></a>
<a name="robo121"></a><h2>initRoutine/inithistory [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo3">initRoutine</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>inithistory</strong> --- initialize the history structure
</pre>
<p class="item_name">FUNCTION</p>
<p>    The history structure keeps track of the posterior samples from the
    chain. It contains components for all the parameters that change
    in the course of the chain. The function <a href="#robo107">updatehistory</a> is called
    at the end of each iteration to update this structure.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">863 </span><strong>inithistory</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">,</span> control<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard     a hazard <a href="#robo26">RCurve</a>
    frailty    a frailty <a href="#robo26">RCurve</a>
    regression a <a href="#robo28">RRegression</a> structure
    control    an RControl structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    an <a href="#robo27">RHistory</a> structure
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">866 </span><span class="sign">{</span>
<span class="line_number">867 </span>    history <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">868 </span>    maxiter <span class="sign">&lt;</span><span class="sign">-</span> control<span class="sign">$</span>maxiter
<span class="line_number">869 </span>    history<span class="sign">$</span>frailty <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> maxiter<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>frailty<span class="sign">$</span>x<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">870 </span>    history<span class="sign">$</span>coefficients <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> maxiter<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>regression<span class="sign">$</span>coefficients<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">871 </span>    <span class="comment"># ssorate for spline knots and parameters</span>
<span class="line_number">872 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">873 </span>        history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> maxiter<span class="sign">,</span> 
<span class="line_number">874 </span>            hazard<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots <span class="sign">+</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span>
<span class="line_number">875 </span>        history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> maxiter<span class="sign">,</span> 
<span class="line_number">876 </span>            hazard<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots <span class="sign">+</span> 2 <span class="sign">*</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span>
<span class="line_number">877 </span>    <span class="sign">}</span>
<span class="line_number">878 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">879 </span>        history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> maxiter<span class="sign">,</span> 
<span class="line_number">880 </span>            frailty<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots <span class="sign">+</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span>
<span class="line_number">881 </span>        history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">,</span> maxiter<span class="sign">,</span> 
<span class="line_number">882 </span>            frailty<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots <span class="sign">+</span> 2 <span class="sign">*</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span>
<span class="line_number">883 </span>        history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>fvar <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> maxiter<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">884 </span>    <span class="sign">}</span>
<span class="line_number">885 </span>    <span class="comment"># storage for parametric parameters</span>
<span class="line_number">886 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> history<span class="sign">$</span>hazard<span class="sign">.</span>param<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> 
<span class="line_number">887 </span>        maxiter<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>hazard<span class="sign">$</span>param<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">888 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> history<span class="sign">$</span>frailty<span class="sign">.</span>param<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> 
<span class="line_number">889 </span>        maxiter<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>frailty<span class="sign">$</span>param<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">890 </span>    <span class="comment"># storage for weights</span>
<span class="line_number">891 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&amp;</span> hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> history<span class="sign">$</span>hazard<span class="sign">.</span>weight <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> maxiter<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">892 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&amp;</span> frailty<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> history<span class="sign">$</span>frailty<span class="sign">.</span>weight <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> maxiter<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">893 </span>    <span class="comment"># storage for prior variances</span>
<span class="line_number">894 </span>    history<span class="sign">$</span>priorvar <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> maxiter<span class="sign">,</span> 7<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">895 </span>    <span class="keyword">colnames</span><span class="sign">(</span>history<span class="sign">$</span>priorvar<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="quote">"coefficients"</span><span class="sign">,</span> <span class="quote">"hazard.spline"</span><span class="sign">,</span> <span class="quote">"frailty.spline"</span><span class="sign">,</span>
<span class="line_number">896 </span>            <span class="quote">"hazard.param"</span><span class="sign">,</span> <span class="quote">"frailty.param"</span><span class="sign">,</span> <span class="quote">"hazard.weight"</span><span class="sign">,</span> <span class="quote">"frailty.weight"</span><span class="sign">)</span>
<span class="line_number">897 </span>    <span class="comment"># storage for acceptance history</span>
<span class="line_number">898 </span>    history<span class="sign">$</span>accept <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> maxiter<span class="sign">,</span> 8<span class="sign">)</span>
<span class="line_number">899 </span>    <span class="keyword">colnames</span><span class="sign">(</span>history<span class="sign">$</span>accept<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">colnames</span><span class="sign">(</span>history<span class="sign">$</span>priorvar<span class="sign">)</span><span class="sign">,</span> <span class="quote">"frailty"</span><span class="sign">)</span>
<span class="line_number">900 </span>    <span class="comment"># update with first iteration</span>
<span class="line_number">901 </span>    history <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo107">updatehistory</a><span class="sign">(</span>history<span class="sign">,</span> 1<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">902 </span>    <span class="keyword">return</span><span class="sign">(</span>history<span class="sign">)</span>
<span class="line_number">903 </span><span class="sign">}</span>
</pre>

<hr />
<a name="initRoutine2finverthessian"></a>
<a name="robo122"></a><h2>initRoutine/inverthessian [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo3">initRoutine</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>inverthessian</strong> --- invert a Hessian matrix
</pre>
<p class="item_name">FUNCTION</p>
<p>   The Hessian matrices returned by optim() are not always positive-definite
   and invertible. This function adjusts the diagonal of an input matrix until
   it is invertible. This gives an acceptable covariance matrix for subsequent use.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">775 </span><strong>inverthessian</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>hess<span class="sign">)</span><span class="sign">{</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hess   a matrix
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    Sigma  the inverse of hess, or of something very close to it
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">778 </span>    K <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>hess<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">779 </span>    <span class="comment"># Try to invert the Hessian</span>
<span class="line_number">780 </span>    Sigma <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>solve<span class="sign">(</span><span class="sign">-</span>hess<span class="sign">)</span><span class="sign">,</span> silent <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">781 </span>    d <span class="sign">&lt;</span><span class="sign">-</span> 10
<span class="line_number">782 </span>    <span class="comment"># modify the diagonal until it is invertible</span>
<span class="line_number">783 </span>    <span class="keyword">while</span><span class="sign">(</span>inherits<span class="sign">(</span>Sigma<span class="sign">,</span> <span class="quote">"try-error"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">{</span> 
<span class="line_number">784 </span>        Sigma <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>solve<span class="sign">(</span><span class="sign">-</span><span class="sign">(</span>hess <span class="sign">-</span> 10<span class="sign">^</span><span class="sign">(</span><span class="sign">-</span>d<span class="sign">)</span> <span class="sign">*</span> <a href="#robo157">mdiag</a><span class="sign">(</span>K<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> silent <span class="sign">=</span> TRUE<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">785 </span>        d <span class="sign">&lt;</span><span class="sign">-</span> d <span class="sign">-</span> 1
<span class="line_number">786 </span>    <span class="sign">}</span>
<span class="line_number">787 </span>    <span class="comment"># modify the diagonal until it is positive definite</span>
<span class="line_number">788 </span>    <span class="keyword">while</span><span class="sign">(</span><span class="sign">!</span>all<span class="sign">(</span>eigen<span class="sign">(</span>Sigma<span class="sign">)</span><span class="sign">$</span>val <span class="sign">&gt;</span> 0<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span> 
<span class="line_number">789 </span>        Sigma <span class="sign">&lt;</span><span class="sign">-</span> solve<span class="sign">(</span><span class="sign">-</span><span class="sign">(</span>hess <span class="sign">-</span> 10<span class="sign">^</span><span class="sign">(</span><span class="sign">-</span>d<span class="sign">)</span> <span class="sign">*</span> <a href="#robo157">mdiag</a><span class="sign">(</span>K<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">;</span>
<span class="line_number">790 </span>        d <span class="sign">&lt;</span><span class="sign">-</span> d <span class="sign">-</span> 1  
<span class="line_number">791 </span>    <span class="sign">}</span>
<span class="line_number">792 </span>    <span class="keyword">return</span><span class="sign">(</span>Sigma<span class="sign">)</span>
<span class="line_number">793 </span><span class="sign">}</span>
</pre>

<hr />
<a name="initRoutine2fmakeknots"></a>
<a name="robo123"></a><h2>initRoutine/makeknots [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo3">initRoutine</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makeknots</strong> --- make knots for a curve with a spline component
</pre>
<p class="item_name">FUNCTION</p>
<p>    Automatically initialize the set of spline knots if they are not given
    in the input. Also initializes candidate knots for adaptive knot selection.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1145 </span><strong>makeknots</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> x<span class="sign">,</span> bounds <span class="sign">=</span> NULL<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure
    x          a set of data points to be used for constructing knots
    bounds     optional boundary knots (length 2 vector)
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    the input <a href="#robo26">RCurve</a>, with additional spline.knots and spline.candknots components.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1148 </span><span class="sign">{</span>
<span class="line_number">1149 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>curve<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1150 </span>    <span class="comment">#   extract needed curve components</span>
<span class="line_number">1151 </span>    BUF <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">.</span>01     <span class="comment"># boundary buffer </span>
<span class="line_number">1152 </span>    knots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">;</span>
<span class="line_number">1153 </span>    nknots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">;</span>
<span class="line_number">1154 </span>    ncandknots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ncandknots<span class="sign">;</span>
<span class="line_number">1155 </span>    knotspacing <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>knotspacing<span class="sign">;</span>
<span class="line_number">1156 </span>    adaptive <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>adaptive
<span class="line_number">1157 </span>    ord <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ord
<span class="line_number">1158 </span>    candknots <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">1159 </span>    K <span class="sign">&lt;</span><span class="sign">-</span> ord <span class="sign">+</span> nknots
<span class="line_number">1160 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>bounds<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>   <span class="comment"># this version requires boundary knots to be given</span>
<span class="line_number">1161 </span>        browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">1162 </span>    <span class="sign">}</span>
<span class="line_number">1163 </span>    <span class="keyword">if</span><span class="sign">(</span>adaptive<span class="sign">)</span> nintknots <span class="sign">&lt;</span><span class="sign">-</span> ncandknots <span class="keyword">else</span> nintknots <span class="sign">&lt;</span><span class="sign">-</span> nknots
<span class="line_number">1164 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>knots<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1165 </span>        <span class="comment"># distribute knots and candidate knots as quantiles of the data</span>
<span class="line_number">1166 </span>        <span class="keyword">if</span><span class="sign">(</span>knotspacing <span class="sign">=</span><span class="sign">=</span> <span class="quote">"quantile"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1167 </span>            ibounds <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>min<span class="sign">(</span>x<span class="sign">)</span><span class="sign">,</span> max<span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1168 </span>            lrep <span class="sign">&lt;</span><span class="sign">-</span> ord<span class="sign">;</span> rrep <span class="sign">&lt;</span><span class="sign">-</span> ord
<span class="line_number">1169 </span>            <span class="keyword">if</span><span class="sign">(</span>ibounds<span class="sign">[</span>1<span class="sign">]</span> <span class="sign">=</span><span class="sign">=</span> bounds<span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span> <span class="sign">{</span>nintknots <span class="sign">&lt;</span><span class="sign">-</span> nintknots <span class="sign">+</span> 1<span class="sign">;</span> lrep <span class="sign">&lt;</span><span class="sign">-</span> ord <span class="sign">-</span> 1<span class="sign">}</span>
<span class="line_number">1170 </span>            <span class="keyword">if</span><span class="sign">(</span>ibounds<span class="sign">[</span>2<span class="sign">]</span> <span class="sign">=</span><span class="sign">=</span> bounds<span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span> <span class="sign">{</span>nintknots <span class="sign">&lt;</span><span class="sign">-</span> nintknots <span class="sign">+</span> 1<span class="sign">;</span> rrep <span class="sign">&lt;</span><span class="sign">-</span> ord <span class="sign">-</span> 1<span class="sign">}</span>
<span class="line_number">1171 </span>            candknots <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">quantile</span><span class="sign">(</span><span class="keyword">unique</span><span class="sign">(</span>x<span class="sign">)</span><span class="sign">,</span> seq<span class="sign">(</span>from <span class="sign">=</span> BUF<span class="sign">,</span> to <span class="sign">=</span> 1 <span class="sign">-</span> BUF<span class="sign">,</span> <span class="keyword">length</span> <span class="sign">=</span> nintknots<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1172 </span>            <span class="comment"># select the occupied knots as a random subset of the candidate knots</span>
<span class="line_number">1173 </span>            occknots <span class="sign">&lt;</span><span class="sign">-</span> sort<span class="sign">(</span>sample<span class="sign">(</span>1<span class="sign">:</span>nintknots<span class="sign">,</span> nknots<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1174 </span>            knots <span class="sign">&lt;</span><span class="sign">-</span> candknots<span class="sign">[</span>occknots<span class="sign">]</span>
<span class="line_number">1175 </span>            candknots <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> lrep<span class="sign">)</span><span class="sign">,</span> candknots<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> rrep<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1176 </span>            knots <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> lrep<span class="sign">)</span><span class="sign">,</span> knots<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> rrep<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1177 </span>            attr<span class="sign">(</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>2<span class="sign">,</span> lrep<span class="sign">)</span><span class="sign">,</span> <span class="sign">(</span>1<span class="sign">:</span>nintknots<span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>occknots<span class="sign">,</span> 
<span class="line_number">1178 </span>                <span class="keyword">rep</span><span class="sign">(</span>2<span class="sign">,</span> rrep<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1179 </span>        <span class="sign">}</span>
<span class="line_number">1180 </span>        <span class="comment"># distribute knots and candidate knots equally over the data range</span>
<span class="line_number">1181 </span>        <span class="keyword">if</span><span class="sign">(</span>knotspacing <span class="sign">=</span><span class="sign">=</span> <span class="quote">"equal"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1182 </span>            dbounds <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">diff</span><span class="sign">(</span>bounds<span class="sign">)</span>
<span class="line_number">1183 </span>            <span class="comment"># distribute candidate knots equally</span>
<span class="line_number">1184 </span>            candknots <span class="sign">&lt;</span><span class="sign">-</span> seq<span class="sign">(</span>from <span class="sign">=</span> bounds<span class="sign">[</span>1<span class="sign">]</span> <span class="sign">+</span> BUF <span class="sign">*</span> dbounds<span class="sign">,</span> to <span class="sign">=</span> bounds<span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> BUF <span class="sign">*</span> dbounds<span class="sign">,</span>
<span class="line_number">1185 </span>                <span class="keyword">length</span> <span class="sign">=</span> nintknots <span class="sign">+</span> 2<span class="sign">)</span>
<span class="line_number">1186 </span>            candknots <span class="sign">&lt;</span><span class="sign">-</span> candknots<span class="sign">[</span> <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">;</span>candknots <span class="sign">&lt;</span><span class="sign">-</span> candknots<span class="sign">[</span> <span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>candknots<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1187 </span>            occknots <span class="sign">&lt;</span><span class="sign">-</span> sort<span class="sign">(</span>sample<span class="sign">(</span>1<span class="sign">:</span>nintknots<span class="sign">,</span> nknots<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1188 </span>            <span class="comment"># select the occupied knots as a random subset of the candidate knots</span>
<span class="line_number">1189 </span>            knots <span class="sign">&lt;</span><span class="sign">-</span> candknots<span class="sign">[</span>occknots<span class="sign">]</span>
<span class="line_number">1190 </span>            knots <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> ord<span class="sign">)</span><span class="sign">,</span> knots<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> ord<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1191 </span>            candknots <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> ord<span class="sign">)</span><span class="sign">,</span> candknots<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> ord<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1192 </span>            attr<span class="sign">(</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>2<span class="sign">,</span> ord<span class="sign">)</span><span class="sign">,</span> <span class="sign">(</span>1<span class="sign">:</span>nintknots<span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>occknots<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span>2<span class="sign">,</span> ord<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1193 </span>        <span class="sign">}</span>
<span class="line_number">1194 </span>        <span class="comment"># half of the knots are equally distributed, the other half are quantiles</span>
<span class="line_number">1195 </span>        <span class="keyword">if</span><span class="sign">(</span>knotspacing <span class="sign">=</span><span class="sign">=</span> <span class="quote">"mixed"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1196 </span>            dbounds <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">diff</span><span class="sign">(</span>bounds<span class="sign">)</span>
<span class="line_number">1197 </span>            <span class="comment"># quantile candknots</span>
<span class="line_number">1198 </span>            candknots1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">quantile</span><span class="sign">(</span><span class="keyword">unique</span><span class="sign">(</span>x<span class="sign">)</span><span class="sign">,</span> seq<span class="sign">(</span>from <span class="sign">=</span> BUF<span class="sign">,</span> to <span class="sign">=</span> 1 <span class="sign">-</span> BUF<span class="sign">,</span>
<span class="line_number">1199 </span>                <span class="keyword">length</span> <span class="sign">=</span> floor<span class="sign">(</span>nintknots <span class="sign">/</span> 2<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1200 </span>            candknots2 <span class="sign">&lt;</span><span class="sign">-</span> seq<span class="sign">(</span>from <span class="sign">=</span> bounds<span class="sign">[</span>1<span class="sign">]</span> <span class="sign">+</span> BUF <span class="sign">*</span> dbounds<span class="sign">,</span> to <span class="sign">=</span> bounds<span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> BUF <span class="sign">*</span> dbounds<span class="sign">,</span>
<span class="line_number">1201 </span>                <span class="keyword">length</span> <span class="sign">=</span> ceiling<span class="sign">(</span>nintknots <span class="sign">/</span> 2<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1202 </span>            candknots <span class="sign">&lt;</span><span class="sign">-</span> sort<span class="sign">(</span>sample<span class="sign">(</span><span class="keyword">unique</span><span class="sign">(</span>c<span class="sign">(</span>candknots1<span class="sign">,</span> candknots2<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> nintknots<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1203 </span>            occknots <span class="sign">&lt;</span><span class="sign">-</span> sort<span class="sign">(</span>sample<span class="sign">(</span>1<span class="sign">:</span>nintknots<span class="sign">,</span> nknots<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1204 </span>            knots <span class="sign">&lt;</span><span class="sign">-</span> candknots<span class="sign">[</span>occknots<span class="sign">]</span>
<span class="line_number">1205 </span>            knots <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> ord<span class="sign">)</span><span class="sign">,</span> knots<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> ord<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1206 </span>            candknots <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> ord<span class="sign">)</span><span class="sign">,</span> candknots<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span>bounds<span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> ord<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1207 </span>            attr<span class="sign">(</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>2<span class="sign">,</span> ord<span class="sign">)</span><span class="sign">,</span> <span class="sign">(</span>1<span class="sign">:</span>nintknots<span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>occknots<span class="sign">,</span>
<span class="line_number">1208 </span>                <span class="keyword">rep</span><span class="sign">(</span>2<span class="sign">,</span> ord<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1209 </span>        <span class="sign">}</span>
<span class="line_number">1210 </span>    <span class="sign">}</span>
<span class="line_number">1211 </span>    <span class="comment"># attributes for the knots object</span>
<span class="line_number">1212 </span>    attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"boundary"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> bounds
<span class="line_number">1213 </span>    attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"index"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> seq<span class="sign">(</span>from<span class="sign">=</span><span class="sign">-</span><span class="sign">(</span>ord <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span> <span class="sign">=</span> <span class="keyword">length</span><span class="sign">(</span>knots<span class="sign">)</span><span class="sign">,</span> by <span class="sign">=</span> 1<span class="sign">)</span>
<span class="line_number">1214 </span>    attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"order"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> ord
<span class="line_number">1215 </span>    curve<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> knots
<span class="line_number">1216 </span>    curve<span class="sign">$</span>spline<span class="sign">.</span>candknots <span class="sign">&lt;</span><span class="sign">-</span> candknots
<span class="line_number">1217 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1218 </span><span class="sign">}</span>
</pre>

<hr />
<a name="initRoutine2fmakepenalty"></a>
<a name="robo124"></a><h2>initRoutine/makepenalty [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo3">initRoutine</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makepenalty</strong> --- construct a penalty matrix
</pre>
<p class="item_name">FUNCTION</p>
<p>    Construct a penalty matrix for use with penalized spline fitting. Options are
    a penalty on the squared second differences of the spline parameters, or a penalty
    on the integrated squared second derivative.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1552 </span><strong>makepenalty</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> usec <span class="sign">=</span> TRUE<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure
    usec       boolean, whether to use fast C code
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      the input curve, with spline.penaltymatrix component updated
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1555 </span><span class="sign">{</span>
<span class="line_number">1556 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>curve<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1557 </span>    penalty <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>penalty
<span class="line_number">1558 </span>    ord <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">;</span> nknots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">;</span> knots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>knots
<span class="line_number">1559 </span>    <span class="comment"># second difference penalty</span>
<span class="line_number">1560 </span>    <span class="keyword">if</span><span class="sign">(</span>penalty <span class="sign">=</span><span class="sign">=</span> <span class="quote">"2diff"</span><span class="sign">)</span> P <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo126">makePenalty.2diff</a><span class="sign">(</span>ord <span class="sign">+</span> nknots<span class="sign">)</span>
<span class="line_number">1561 </span>    <span class="comment"># second derivative penalty</span>
<span class="line_number">1562 </span>    <span class="keyword">if</span><span class="sign">(</span>penalty <span class="sign">=</span><span class="sign">=</span> <span class="quote">"2deriv"</span> <span class="sign">|</span> penalty <span class="sign">=</span><span class="sign">=</span> <span class="quote">"log2deriv"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">1563 </span>        <span class="keyword">if</span><span class="sign">(</span>usec<span class="sign">)</span> P <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo115">cmakePenalty.2deriv</a><span class="sign">(</span>ord<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">1564 </span>        <span class="keyword">else</span>  P <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo125">makePenalty.2deriv</a><span class="sign">(</span>ord<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">1565 </span>        <span class="comment"># adjust for normalized B-splines for frailties</span>
<span class="line_number">1566 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>norm<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1567 </span>            Bint <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>basisint
<span class="line_number">1568 </span>            P <span class="sign">&lt;</span><span class="sign">-</span> P <span class="sign">/</span> <span class="sign">(</span>Bint<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>Bint<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1569 </span>        <span class="sign">}</span>
<span class="line_number">1570 </span>    <span class="sign">}</span>
<span class="line_number">1571 </span>    <span class="keyword">if</span><span class="sign">(</span>penalty <span class="sign">=</span><span class="sign">=</span> <span class="quote">"none"</span><span class="sign">)</span> P <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1572 </span>    curve<span class="sign">$</span>spline<span class="sign">.</span>penaltymatrix <span class="sign">&lt;</span><span class="sign">-</span> P
<span class="line_number">1573 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1574 </span><span class="sign">}</span>
</pre>

<hr />
<a name="initRoutine2fmakePenalty2e2deriv"></a>
<a name="robo125"></a><h2>initRoutine/makePenalty.2deriv [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo3">initRoutine</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makePenalty.2deriv</strong> --- compute a penalty matrix on second derivatives of B-splines
</pre>
<p class="item_name">FUNCTION</p>
<p>    This function computes a matrix P such that
</p>
<pre>       exp(x) %*% P %*% exp(x)
</pre>
<p>    is the integral of the squared second derivative of a B-spline with a given set of
    knots and component weights exp(x)
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1617 </span><strong>makePenalty.2deriv</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>ord<span class="sign">,</span> knots<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    ord    order of the B-spline
    knots  set of basis knots
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    P      a K x K matrix that penalizes the integrated squared second derivative
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1620 </span><span class="sign">{</span>
<span class="line_number">1621 </span>    <span class="comment">#   compute the number of spline components K</span>
<span class="line_number">1622 </span>    nspline <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>knots <span class="sign">&gt;</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1623 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> nspline<span class="sign">,</span> nspline<span class="sign">)</span>
<span class="line_number">1624 </span>    <span class="keyword">for</span><span class="sign">(</span>j1 in 1<span class="sign">:</span>nspline<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1625 </span>        <span class="keyword">for</span><span class="sign">(</span>j2 in j1<span class="sign">:</span>nspline<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1626 </span>            <span class="comment"># compute convolutions of second derivatives for each pair of basis functions</span>
<span class="line_number">1627 </span>            out<span class="sign">[</span>j1<span class="sign">,</span> j2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo190">splinederivint</a><span class="sign">(</span>2<span class="sign">,</span> ord<span class="sign">,</span> j1<span class="sign">,</span> 2<span class="sign">,</span> ord<span class="sign">,</span> j2<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">1628 </span>        <span class="sign">}</span>
<span class="line_number">1629 </span>    <span class="sign">}</span>
<span class="line_number">1630 </span>    <span class="comment"># the matrix is symmetric</span>
<span class="line_number">1631 </span>    <span class="keyword">for</span><span class="sign">(</span>j1 in 2<span class="sign">:</span>nspline<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1632 </span>        <span class="keyword">for</span><span class="sign">(</span>j2 in 1<span class="sign">:</span><span class="sign">(</span>j1 <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span> out<span class="sign">[</span>j1<span class="sign">,</span> j2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> out<span class="sign">[</span>j2<span class="sign">,</span> j1<span class="sign">]</span>
<span class="line_number">1633 </span>    <span class="sign">}</span>
<span class="line_number">1634 </span>    <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">)</span>
<span class="line_number">1635 </span><span class="sign">}</span>
</pre>

<hr />
<a name="initRoutine2fmakePenalty2e2diff"></a>
<a name="robo126"></a><h2>initRoutine/makePenalty.2diff [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo3">initRoutine</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makePenalty.2diff</strong> --- compute a penalty matrix on second differences
</pre>
<p class="item_name">FUNCTION</p>
<p>    This computes a matrix P such that 
</p>
<pre>       x %*% P %*% x
</pre>
<p>    is the sum of squared second differences of x.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1589 </span><strong>makePenalty.2diff</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>K<span class="sign">)</span><span class="sign">{</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    K      the desired size of the matrix
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    P      a K x K matrix that generates squared second differences.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1592 </span>    D <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> K <span class="sign">-</span> 2<span class="sign">,</span> K<span class="sign">)</span>
<span class="line_number">1593 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="sign">(</span>K <span class="sign">-</span> 2<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1594 </span>        D<span class="sign">[</span>i<span class="sign">,</span> i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">1595 </span>        D<span class="sign">[</span>i<span class="sign">,</span> i <span class="sign">+</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>2
<span class="line_number">1596 </span>        D<span class="sign">[</span>i<span class="sign">,</span> i <span class="sign">+</span> 2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">1597 </span>    <span class="sign">}</span>
<span class="line_number">1598 </span>    P <span class="sign">&lt;</span><span class="sign">-</span> t<span class="sign">(</span>D<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>D
<span class="line_number">1599 </span>    <span class="keyword">return</span><span class="sign">(</span>P<span class="sign">)</span>
<span class="line_number">1600 </span><span class="sign">}</span>
</pre>

<hr />
<a name="initRoutine2fnknotsPriorMean"></a>
<a name="robo127"></a><h2>initRoutine/nknotsPriorMean [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo3">initRoutine</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>nknotsPriorMean</strong> --- compute the prior mean of the number of knots of a curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    If adaptive selection is used, the algorithm initializes the number of spline
    knots at the prior mean. This function computes the prior mean number of
    spline knots for different priors
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1077 </span><strong>nknotsPriorMean</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve  an <a href="#robo26">RCurve</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    the prior mean number of knots, for type spline.nknots.prior and parameters
    spline.nknots.hyper
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1080 </span><span class="sign">{</span>
<span class="line_number">1081 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poisson"</span><span class="sign">)</span>
<span class="line_number">1082 </span>        <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span>
<span class="line_number">1083 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"geometric"</span><span class="sign">)</span>
<span class="line_number">1084 </span>        <span class="keyword">return</span><span class="sign">(</span>round<span class="sign">(</span>1 <span class="sign">/</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1085 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poissonmix"</span><span class="sign">)</span>
<span class="line_number">1086 </span>        <span class="keyword">return</span><span class="sign">(</span>round<span class="sign">(</span>mean<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1087 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"negbin"</span><span class="sign">)</span>
<span class="line_number">1088 </span>        <span class="keyword">return</span><span class="sign">(</span>round<span class="sign">(</span>weighted<span class="sign">.</span>mean<span class="sign">(</span>1<span class="sign">:</span>curve<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">,</span> 
<span class="line_number">1089 </span>            <a href="#robo172">dnegbin</a><span class="sign">(</span>1<span class="sign">:</span>curve<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">,</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span>
<span class="line_number">1090 </span>            curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1091 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"power"</span><span class="sign">)</span>
<span class="line_number">1092 </span>        <span class="keyword">return</span><span class="sign">(</span>round<span class="sign">(</span>weighted<span class="sign">.</span>mean<span class="sign">(</span>1<span class="sign">:</span>curve<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">,</span>
<span class="line_number">1093 </span>            <span class="sign">(</span>1<span class="sign">:</span>curve<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">)</span><span class="sign">^</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1094 </span><span class="sign">}</span>
</pre>

<hr />
<a name="initRoutine2fnumHess2epar"></a>
<a name="robo128"></a><h2>initRoutine/numHess.par [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo3">initRoutine</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>numHess.par</strong>  --- compute a numerical Hessian for the parametric component
</pre>
<p class="item_name">FUNCTION</p>
<p>    Since there are so many parametric component specifications and parametrizations,
    it is easiest to compute the Hessian of the parameters numerically. Given a set
    of parameters and a likelihood function, this routine computes the Hessian of
    the function at the given parameters.
</p>

<p>    The method used is basic finite differences
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">812 </span><strong>numHess.par</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">,</span> fun<span class="sign">,</span> eps <span class="sign">=</span> 1e<span class="sign">-</span>5<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    param.par  parameters of the parametric component
    fun        likelihood function for the parametric component
    eps        precision to use for numerical Hessian
</pre>
<p class="item_name">OUTPUTS</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">815 </span><span class="sign">{</span>
<span class="line_number">816 </span>    <span class="comment"># Utility function to compute numerical derivatives</span>
<span class="line_number">817 </span>    numDer<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">,</span> fun<span class="sign">,</span> eps <span class="sign">=</span> 1e<span class="sign">-</span>5<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">818 </span>    <span class="sign">{</span>        
<span class="line_number">819 </span>        lik1 <span class="sign">&lt;</span><span class="sign">-</span> fun<span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">820 </span>        nd <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">821 </span>        <span class="comment">#   take finite differences along the set of parameters</span>
<span class="line_number">822 </span>        <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>nd<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">823 </span>        <span class="sign">{</span>
<span class="line_number">824 </span>            param<span class="sign">.</span>par2 <span class="sign">&lt;</span><span class="sign">-</span> param<span class="sign">.</span>par
<span class="line_number">825 </span>            param<span class="sign">.</span>par2<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> param<span class="sign">.</span>par2<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> eps
<span class="line_number">826 </span>            lik2 <span class="sign">&lt;</span><span class="sign">-</span> fun<span class="sign">(</span>param<span class="sign">.</span>par2<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">827 </span>            nd<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>lik2 <span class="sign">-</span> lik1<span class="sign">)</span> <span class="sign">/</span> eps
<span class="line_number">828 </span>        <span class="sign">}</span>
<span class="line_number">829 </span>        <span class="keyword">return</span><span class="sign">(</span>nd<span class="sign">)</span>
<span class="line_number">830 </span>    <span class="sign">}</span>
<span class="line_number">831 </span>    <span class="comment"># allocate storage for numerical Hessian</span>
<span class="line_number">832 </span>    nh <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">833 </span>    <span class="comment">#   base gradient</span>
<span class="line_number">834 </span>    gr1 <span class="sign">&lt;</span><span class="sign">-</span> numDer<span class="sign">.</span>par<span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">,</span> fun<span class="sign">,</span> eps<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">835 </span>    <span class="comment">#   compute gradients by finite differences</span>
<span class="line_number">836 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">837 </span>    <span class="sign">{</span>
<span class="line_number">838 </span>        param<span class="sign">.</span>par2 <span class="sign">&lt;</span><span class="sign">-</span> param<span class="sign">.</span>par
<span class="line_number">839 </span>        param<span class="sign">.</span>par2<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> param<span class="sign">.</span>par2<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> eps
<span class="line_number">840 </span>        gr2 <span class="sign">&lt;</span><span class="sign">-</span> numDer<span class="sign">.</span>par<span class="sign">(</span>param<span class="sign">.</span>par2<span class="sign">,</span> fun<span class="sign">,</span> eps<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">841 </span>        nh<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>gr2 <span class="sign">-</span> gr1<span class="sign">)</span> <span class="sign">/</span> eps
<span class="line_number">842 </span>    <span class="sign">}</span>
<span class="line_number">843 </span>    <span class="keyword">return</span><span class="sign">(</span>nh<span class="sign">)</span>
<span class="line_number">844 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fmkgr2espline2ehaz"></a>
<a name="robo129"></a><h2>makeLikelihood/mkgr.spline.haz [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mkgr.spline.haz</strong> --- gradient of hazard spline parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the gradient of parameters spline.par for the spline components of a
    hazard curve. This is only called during initialization, to give gradients for
    use by optim().
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2177 </span><strong>mkgr.spline.haz</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    spline.par a vector of parameters for each of the spline basis functions
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    gr    gradient of the loglikelihood of spline.par
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2180 </span><span class="sign">{</span>
<span class="line_number">2181 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2182 </span>    status <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>status
<span class="line_number">2183 </span>    lp <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>lp
<span class="line_number">2184 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>hazard<span class="sign">,</span> spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">2185 </span>    frailrep <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>frailty<span class="sign">$</span>x<span class="sign">,</span> regression<span class="sign">$</span>Ji<span class="sign">)</span>
<span class="line_number">2186 </span>    Det <span class="sign">&lt;</span><span class="sign">-</span> diag<span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2187 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> Det<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>basis<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="sign">(</span>status <span class="sign">/</span> hazard<span class="sign">$</span>y<span class="sign">)</span>
<span class="line_number">2188 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> gr <span class="sign">-</span> Det<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>basiscum<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="sign">(</span>frailrep <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2189 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>weight <span class="sign">*</span> gr
<span class="line_number">2190 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> gr <span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>penaltyfactor <span class="sign">*</span> <a href="#robo140">smoothpen</a><span class="sign">(</span>hazard<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">2191 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> gr <span class="sign">-</span> ifelse<span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">&lt;</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>min<span class="sign">,</span> 2 <span class="sign">*</span> <span class="sign">(</span>spline<span class="sign">.</span>par <span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>min<span class="sign">)</span><span class="sign">,</span> 0<span class="sign">)</span>  
<span class="line_number">2192 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>numeric<span class="sign">(</span>gr<span class="sign">)</span>
<span class="line_number">2193 </span>    <span class="keyword">return</span><span class="sign">(</span>gr<span class="sign">)</span>
<span class="line_number">2194 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fmkhess2ecoef"></a>
<a name="robo130"></a><h2>makeLikelihood/mkhess.coef [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mkhess.coef</strong> --- hessian of regression coefficients
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the hessian of regression coefficients, given everything else.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2081 </span><strong>mkhess.coef</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>coef<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    coef       regression coefficients to be evaluated
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    hess    hessian of coef
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2084 </span><span class="sign">{</span>
<span class="line_number">2085 </span>    status <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>status
<span class="line_number">2086 </span>    regression <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo109">updateregression</a><span class="sign">(</span>regression<span class="sign">,</span> coef<span class="sign">)</span>
<span class="line_number">2087 </span>    lp <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>lp
<span class="line_number">2088 </span>    frailrep <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>frailty<span class="sign">$</span>x<span class="sign">,</span> regression<span class="sign">$</span>Ji<span class="sign">)</span>
<span class="line_number">2089 </span>    Z <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>covariates
<span class="line_number">2090 </span>    hess <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>t<span class="sign">(</span>Z<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>frailrep <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>lp<span class="sign">)</span> <span class="sign">*</span> hazard<span class="sign">$</span>ycum<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>Z<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> Z<span class="sign">)</span>
<span class="line_number">2091 </span>    hess <span class="sign">&lt;</span><span class="sign">-</span> hess <span class="sign">-</span> <a href="#robo157">mdiag</a><span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>1<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>coef<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> regression<span class="sign">$</span>priorvar
<span class="line_number">2092 </span>    <span class="keyword">return</span><span class="sign">(</span>hess<span class="sign">)</span>
<span class="line_number">2093 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fmklik2ecoef"></a>
<a name="robo131"></a><h2>makeLikelihood/mklik.coef [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mklik.coef</strong> --- likelihood of regression coefficients
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the likelihood of regression coefficients, given everything else.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2051 </span><strong>mklik.coef</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>coef<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    coef       regression coefficients to be evaluated
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik    loglikelihood of coef
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2054 </span><span class="sign">{</span>
<span class="line_number">2055 </span>    status <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>status
<span class="line_number">2056 </span>    regression <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo109">updateregression</a><span class="sign">(</span>regression<span class="sign">,</span> coef<span class="sign">)</span>
<span class="line_number">2057 </span>    lp <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>lp
<span class="line_number">2058 </span>    frailrep <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>frailty<span class="sign">$</span>x<span class="sign">,</span> regression<span class="sign">$</span>Ji<span class="sign">)</span>
<span class="line_number">2059 </span>    <span class="comment"># point process likelihood</span>
<span class="line_number">2060 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> status<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>lp
<span class="line_number">2061 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>frailrep <span class="sign">*</span> hazard<span class="sign">$</span>ycum <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2062 </span>    <span class="comment"># prior penalty</span>
<span class="line_number">2063 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>coef<span class="sign">^</span>2<span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>2 <span class="sign">*</span> regression<span class="sign">$</span>priorvar<span class="sign">)</span>
<span class="line_number">2064 </span>    <span class="keyword">return</span><span class="sign">(</span>as<span class="sign">.</span>numeric<span class="sign">(</span>lik<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2065 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fmklik2efrail"></a>
<a name="robo132"></a><h2>makeLikelihood/mklik.frail [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mklik.frail</strong> --- likelihood of frailty for cluster i
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the loglikeilhood of the frailty of cluster i
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2109 </span><strong>mklik.frail</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>i<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    i          index of the frailty. The frailty value is stored in frailty$x[i]
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik    loglikelihood of frailty$x[i]
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2112 </span><span class="sign">{</span>
<span class="line_number">2113 </span>    ind <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">which</span><span class="sign">(</span>regression<span class="sign">$</span>cluster <span class="sign">=</span><span class="sign">=</span> i<span class="sign">)</span>
<span class="line_number">2114 </span>    Ui <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>x<span class="sign">[</span>i<span class="sign">]</span>
<span class="line_number">2115 </span>    status <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>status<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">2116 </span>    lp <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>lp<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">2117 </span>    cumhaz <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>ycum<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">2118 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>frailty<span class="sign">$</span>y<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2119 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">+</span> <span class="keyword">sum</span><span class="sign">(</span>status <span class="sign">*</span> log<span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2120 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>Ui <span class="sign">*</span> cumhaz <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2121 </span>    <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span>   
<span class="line_number">2122 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fmklik2eparam2efrail"></a>
<a name="robo133"></a><h2>makeLikelihood/mklik.param.frail [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mklik.param.frail</strong> --- likelihood of parametric component for frailty
</pre>
<p class="item_name">FUNCTION</p>
<p>   Compute loglikelihood of parametric component parameters for the frailty curve
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2309 </span><strong>mklik.param.frail</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    param.par  a vector of parameters for each of the parametric component
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik        loglikelihood of param.par
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2312 </span><span class="sign">{</span>
<span class="line_number">2313 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>frailty<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">2314 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo108">updateparametric</a><span class="sign">(</span>frailty<span class="sign">,</span> param<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">2315 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>log<span class="sign">(</span>frailty<span class="sign">$</span>y<span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">^</span>2<span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>2 <span class="sign">*</span> frailty<span class="sign">$</span>param<span class="sign">.</span>priorvar<span class="sign">)</span>
<span class="line_number">2316 </span>    <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">2317 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fmklik2eparam2ehaz"></a>
<a name="robo134"></a><h2>makeLikelihood/mklik.param.haz [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mklik.param.haz</strong> --- likelihood of parametric component parameters for hazard
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute loglikelihood of parametric component parameters for the hazard curve
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2279 </span><strong>mklik.param.haz</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    param.par  a vector of parameters for each of the parametric component
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik        loglikelihood of param.par
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2282 </span><span class="sign">{</span>
<span class="line_number">2283 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">2284 </span>    <span class="comment"># update parametric component</span>
<span class="line_number">2285 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo108">updateparametric</a><span class="sign">(</span>hazard<span class="sign">,</span> param<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">2286 </span>    status <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>status
<span class="line_number">2287 </span>    lp <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>lp
<span class="line_number">2288 </span>    frailrep <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>frailty<span class="sign">$</span>x<span class="sign">,</span> regression<span class="sign">$</span>Ji<span class="sign">)</span>
<span class="line_number">2289 </span>    <span class="comment"># likelihood computation</span>
<span class="line_number">2290 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>status <span class="sign">*</span> log<span class="sign">(</span>hazard<span class="sign">$</span>y<span class="sign">)</span> <span class="sign">-</span> frailrep <span class="sign">*</span> hazard<span class="sign">$</span>ycum <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2291 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">^</span>2<span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>2 <span class="sign">*</span> hazard<span class="sign">$</span>param<span class="sign">.</span>priorvar<span class="sign">)</span>
<span class="line_number">2292 </span>    <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">2293 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fmklik2espline2efrail"></a>
<a name="robo135"></a><h2>makeLikelihood/mklik.spline.frail [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mklik.spline.frail</strong> --- likelihood of frailty spline parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute loglikelihood of spline.par for a frailty spline curve.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2248 </span><strong>mklik.spline.frail</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    spline.par a vector of parameters for each of the spline basis functions
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik        loglikelihood of spline.par
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2251 </span><span class="sign">{</span>
<span class="line_number">2252 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">2253 </span>    <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>is<span class="sign">.</span>na<span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">)</span>
<span class="line_number">2254 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>frailty<span class="sign">,</span> spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">2255 </span>    M <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>meanpenalty
<span class="line_number">2256 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>log<span class="sign">(</span>frailty<span class="sign">$</span>y<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2257 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>penaltyfactor <span class="sign">*</span> <a href="#robo140">smoothpen</a><span class="sign">(</span>frailty<span class="sign">,</span> 0<span class="sign">)</span>
<span class="line_number">2258 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>ifelse<span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">&lt;</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>min<span class="sign">,</span>
<span class="line_number">2259 </span>        <span class="sign">(</span>spline<span class="sign">.</span>par <span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>min<span class="sign">)</span><span class="sign">^</span>2<span class="sign">,</span> 0<span class="sign">)</span><span class="sign">)</span>    
<span class="line_number">2260 </span>    <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>spline<span class="sign">.</span>par <span class="sign">&gt;</span> 20<span class="sign">)</span><span class="sign">)</span> lik<span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>Inf <span class="comment">#needed for numerics</span>
<span class="line_number">2261 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>numeric<span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">2262 </span>    <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">2263 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fmklik2espline2efrail2einit"></a>
<a name="robo136"></a><h2>makeLikelihood/mklik.spline.frail.init [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mklik.spline.frail.init</strong> --- likelihood of frailty spline parameters (initialization)
</pre>
<p class="item_name">FUNCTION</p>
<p>    This is a variant of <a href="#robo135">mklik.spline.frail</a> for use during initialization. It differs in
    that spline.par does not contain the fixed index, and hence <a href="#robo158">repairfrailtypar</a> must be
    called to add it back in. Moreover, it produces a frailty mean close to 1 by
    penalizing the distance.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2213 </span><strong>mklik.spline.frail.init</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    spline.par a vector of parameters for each of the spline basis functions
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik    loglikelihood of spline.par
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2216 </span><span class="sign">{</span>
<span class="line_number">2217 </span>    <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>is<span class="sign">.</span>na<span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">)</span>
<span class="line_number">2218 </span>    spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo158">repairfrailtypar</a><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>fixedind<span class="sign">)</span>
<span class="line_number">2219 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>frailty<span class="sign">,</span> spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">2220 </span>    M <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>meanpenalty
<span class="line_number">2221 </span>    <span class="comment"># base likeihood and smoothness penalty</span>
<span class="line_number">2222 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>log<span class="sign">(</span>frailty<span class="sign">$</span>y<span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>penaltyfactor <span class="sign">*</span> <a href="#robo140">smoothpen</a><span class="sign">(</span>frailty<span class="sign">,</span> 0<span class="sign">)</span>
<span class="line_number">2223 </span>    <span class="comment"># penalty for being far from mean 1</span>
<span class="line_number">2224 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> M <span class="sign">*</span> <span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="keyword">exp</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">^</span>2
<span class="line_number">2225 </span>    <span class="comment"># penalty for having too small parameters</span>
<span class="line_number">2226 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>ifelse<span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">&lt;</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>min<span class="sign">,</span> 
<span class="line_number">2227 </span>        <span class="sign">(</span>spline<span class="sign">.</span>par <span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>min<span class="sign">)</span><span class="sign">^</span>2<span class="sign">,</span> 0<span class="sign">)</span><span class="sign">)</span>    
<span class="line_number">2228 </span>    <span class="comment"># do not allow too large parameters</span>
<span class="line_number">2229 </span>    <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>spline<span class="sign">.</span>par <span class="sign">&gt;</span> 20<span class="sign">)</span><span class="sign">)</span> lik<span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>Inf <span class="comment">#needed for numerics</span>
<span class="line_number">2230 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>numeric<span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">2231 </span>    <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">2232 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fmklik2espline2ehaz"></a>
<a name="robo137"></a><h2>makeLikelihood/mklik.spline.haz [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mklik.spline.haz</strong> --- likelihood of hazard spline parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the loglikelihood of parameters spline.par for the spline component of
    the hazard curve.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2139 </span><strong>mklik.spline.haz</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    spline.par a vector of parameters for each of the spline basis functions
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik    loglikelihood of spline.par
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2142 </span><span class="sign">{</span>
<span class="line_number">2143 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">2144 </span>    <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>is<span class="sign">.</span>na<span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span><span class="sign">-</span>Inf<span class="sign">)</span>
<span class="line_number">2145 </span>    status <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>status
<span class="line_number">2146 </span>    lp <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>lp
<span class="line_number">2147 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>hazard<span class="sign">,</span> spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">2148 </span>    frailrep <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>frailty<span class="sign">$</span>x<span class="sign">,</span> regression<span class="sign">$</span>Ji<span class="sign">)</span>
<span class="line_number">2149 </span>    <span class="comment"># point process likelihood</span>
<span class="line_number">2150 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>status <span class="sign">*</span> log<span class="sign">(</span>hazard<span class="sign">$</span>y<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">2151 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>frailrep <span class="sign">*</span> hazard<span class="sign">$</span>ycum <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2152 </span>    <span class="comment"># smoothness penalty</span>
<span class="line_number">2153 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>penaltyfactor <span class="sign">*</span> <a href="#robo140">smoothpen</a><span class="sign">(</span>hazard<span class="sign">,</span> 0<span class="sign">)</span>
<span class="line_number">2154 </span>    <span class="comment"># penalize parameters that are too small</span>
<span class="line_number">2155 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>ifelse<span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">&lt;</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>min<span class="sign">,</span> 
<span class="line_number">2156 </span>        <span class="sign">(</span>spline<span class="sign">.</span>par <span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>min<span class="sign">)</span><span class="sign">^</span>2<span class="sign">,</span> 0<span class="sign">)</span><span class="sign">)</span>    
<span class="line_number">2157 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>numeric<span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">2158 </span>    <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">2159 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fmklik2eweight2efrail"></a>
<a name="robo138"></a><h2>makeLikelihood/mklik.weight.frail [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mklik.weight.frail</strong> --- likelihood of weight of spline component for frailty
</pre>
<p class="item_name">FUNCTION</p>
<p>   Compute loglikelihood of relative weight of spline and parametric components
   if the frailty curve has both.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2366 </span><strong>mklik.weight.frail</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>weight<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    weight     weight of the spline component (0&lt;=weight&lt;=1)
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik        loglikelihood of weight
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2369 </span><span class="sign">{</span>
<span class="line_number">2370 </span>    frailty<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> weight
<span class="line_number">2371 </span>    frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo111">weightcurve</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">2372 </span>    <span class="comment"># base likelihood</span>
<span class="line_number">2373 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>log<span class="sign">(</span>frailty<span class="sign">$</span>y<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2374 </span>    <span class="comment"># prior on the weight</span>
<span class="line_number">2375 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">+</span> <span class="sign">(</span>frailty<span class="sign">$</span>weight<span class="sign">.</span>hyper<span class="sign">[</span>1<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">*</span> log<span class="sign">(</span>frailty<span class="sign">$</span>weight<span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2376 </span>        <span class="sign">(</span>frailty<span class="sign">$</span>weight<span class="sign">.</span>hyper<span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">*</span> log<span class="sign">(</span>1 <span class="sign">-</span> frailty<span class="sign">$</span>weight<span class="sign">)</span>
<span class="line_number">2377 </span>    <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span> 
<span class="line_number">2378 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fmklik2eweight2ehaz"></a>
<a name="robo139"></a><h2>makeLikelihood/mklik.weight.haz [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mklik.weight.haz</strong> --- likelihood of weight of spline component for hazard
</pre>
<p class="item_name">FUNCTION</p>
<p>   Compute loglikelihood of relative weight of spline and parametric components
   if the hazard curve has both.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2334 </span><strong>mklik.weight.haz</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>weight<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    weight     weight of the spline component (0&lt;=weight&lt;=1)
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik        loglikelihood of weight
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2337 </span><span class="sign">{</span>
<span class="line_number">2338 </span>    hazard<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> weight
<span class="line_number">2339 </span>    hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo111">weightcurve</a><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">2340 </span>    status <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>status
<span class="line_number">2341 </span>    lp <span class="sign">&lt;</span><span class="sign">-</span> regression<span class="sign">$</span>lp
<span class="line_number">2342 </span>    frailrep <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>frailty<span class="sign">$</span>x<span class="sign">,</span> regression<span class="sign">$</span>Ji<span class="sign">)</span>
<span class="line_number">2343 </span>    <span class="comment"># point process likelihood</span>
<span class="line_number">2344 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>status <span class="sign">*</span> log<span class="sign">(</span>hazard<span class="sign">$</span>y<span class="sign">)</span> <span class="sign">-</span> frailrep <span class="sign">*</span> hazard<span class="sign">$</span>ycum <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2345 </span>    <span class="comment"># prior on the weight</span>
<span class="line_number">2346 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">+</span> <span class="sign">(</span>hazard<span class="sign">$</span>weight<span class="sign">.</span>hyper<span class="sign">[</span>1<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">*</span> log<span class="sign">(</span>hazard<span class="sign">$</span>weight<span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2347 </span>        <span class="sign">(</span>hazard<span class="sign">$</span>weight<span class="sign">.</span>hyper<span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">*</span> log<span class="sign">(</span>1 <span class="sign">-</span> hazard<span class="sign">$</span>weight<span class="sign">)</span>
<span class="line_number">2348 </span>    <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span> 
<span class="line_number">2349 </span><span class="sign">}</span>
</pre>

<hr />
<a name="makeLikelihood2fsmoothpen"></a>
<a name="robo140"></a><h2>makeLikelihood/smoothpen [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo16">makeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>smoothpen</strong> --- compute the smoothness penalty for a curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    Penalize lack of smoothness of a B-spline curve as part of a likelihood computation
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1649 </span><strong>smoothpen</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> der <span class="sign">=</span> 0<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure
    der        the derivative of the smoothness penalty to compute
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    value of the smoothness penalty
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1652 </span><span class="sign">{</span>
<span class="line_number">1653 </span>    type <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>penalty
<span class="line_number">1654 </span>    name <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>name
<span class="line_number">1655 </span>    theta <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>par
<span class="line_number">1656 </span>    <span class="comment"># extract the penalty matrix</span>
<span class="line_number">1657 </span>    P <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>penaltymatrix
<span class="line_number">1658 </span>    sigma2 <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>priorvar
<span class="line_number">1659 </span>    <span class="keyword">if</span><span class="sign">(</span>der <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"second derivative not implemented"</span><span class="sign">)</span>
<span class="line_number">1660 </span>    <span class="comment"># second difference penalty</span>
<span class="line_number">1661 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"2diff"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1662 </span>        <span class="keyword">if</span><span class="sign">(</span>der <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>max<span class="sign">(</span> t<span class="sign">(</span>theta<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>P<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>theta <span class="sign">/</span> <span class="sign">(</span>2 <span class="sign">*</span> sigma2<span class="sign">)</span><span class="sign">,</span> 0<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1663 </span>        <span class="keyword">if</span><span class="sign">(</span>der <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span> P<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>theta <span class="sign">/</span>sigma2<span class="sign">)</span>
<span class="line_number">1664 </span>    <span class="sign">}</span>
<span class="line_number">1665 </span>    <span class="comment"># second derivative penalty</span>
<span class="line_number">1666 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"2deriv"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1667 </span>        et <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>theta<span class="sign">)</span>
<span class="line_number">1668 </span>        <span class="keyword">if</span><span class="sign">(</span>der <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>max<span class="sign">(</span> t<span class="sign">(</span>et<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>P<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>et <span class="sign">/</span> <span class="sign">(</span>2 <span class="sign">*</span> sigma2<span class="sign">)</span><span class="sign">,</span> 0<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1669 </span>        <span class="keyword">if</span><span class="sign">(</span>der <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span> <a href="#robo157">mdiag</a><span class="sign">(</span>et<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>P<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>et <span class="sign">/</span> sigma2 <span class="sign">)</span>
<span class="line_number">1670 </span>    <span class="sign">}</span>
<span class="line_number">1671 </span>    <span class="comment"># penalty on the log 2nd derivative</span>
<span class="line_number">1672 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"log2deriv"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1673 </span>        et <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>theta<span class="sign">)</span>
<span class="line_number">1674 </span>        ePe <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>numeric<span class="sign">(</span>t<span class="sign">(</span>et<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>P<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>et<span class="sign">)</span> 
<span class="line_number">1675 </span>        <span class="keyword">if</span><span class="sign">(</span>der <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>max<span class="sign">(</span>log<span class="sign">(</span>ePe <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">/</span> <span class="sign">(</span>2 <span class="sign">*</span> sigma2<span class="sign">)</span><span class="sign">,</span> 0<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1676 </span>        <span class="keyword">if</span><span class="sign">(</span>der <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span> <a href="#robo157">mdiag</a><span class="sign">(</span>et<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>P<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>et <span class="sign">/</span> sigma2 <span class="sign">/</span><span class="sign">(</span>ePe <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1677 </span>    <span class="sign">}</span>
<span class="line_number">1678 </span>    <span class="comment"># gaussian "penalty", which isn't really a smoothness penalty at all.</span>
<span class="line_number">1679 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"none"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1680 </span>        <span class="keyword">if</span><span class="sign">(</span>der <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>theta<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>theta <span class="sign">/</span> <span class="sign">(</span>2 <span class="sign">*</span> sigma2<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1681 </span>        <span class="keyword">if</span><span class="sign">(</span>der <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span> theta <span class="sign">/</span> sigma2<span class="sign">)</span>
<span class="line_number">1682 </span>    <span class="sign">}</span>
<span class="line_number">1683 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2facceptreject"></a>
<a name="robo141"></a><h2>MetropolisHastings/acceptreject [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>acceptreject</strong> --- accept of reject a M-H step
</pre>
<p class="item_name">FUNCTION</p>
<p>    Handles accept-reject portion of every Metropolis-Hastings step. Given a
    base likelihood and a candidate loglikelihood, generates a random number and
    decides whether to accept or reject the step.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2402 </span><strong>acceptreject</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> ratio <span class="sign">=</span> 1<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    baselik    loglikelihood of the base model
    candlik    loglikelihood of the candidate model
    ratio      additional multiplier (e.g. prior ratio)
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    acc        boolean, whether to accept or reject the jump
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2405 </span><span class="sign">{</span>
<span class="line_number">2406 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>nan<span class="sign">(</span>candlik<span class="sign">)</span><span class="sign">)</span> candlik <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>Inf
<span class="line_number">2407 </span>    <span class="comment"># compute acceptance probability</span>
<span class="line_number">2408 </span>    r <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>candlik <span class="sign">-</span> baselik<span class="sign">)</span> <span class="sign">*</span> ratio
<span class="line_number">2409 </span>    p<span class="sign">.</span>accept <span class="sign">&lt;</span><span class="sign">-</span> min<span class="sign">(</span>1<span class="sign">,</span> r<span class="sign">)</span>
<span class="line_number">2410 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>nan<span class="sign">(</span>p<span class="sign">.</span>accept<span class="sign">)</span><span class="sign">)</span> p<span class="sign">.</span>accept <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2411 </span>    <span class="comment"># generate uniform and accept or reject</span>
<span class="line_number">2412 </span>    <span class="keyword">if</span><span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">)</span> <span class="sign">&lt;</span> p<span class="sign">.</span>accept<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2413 </span>        <span class="keyword">return</span><span class="sign">(</span>TRUE<span class="sign">)</span>
<span class="line_number">2414 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2415 </span>        <span class="keyword">return</span><span class="sign">(</span>FALSE<span class="sign">)</span>
<span class="line_number">2416 </span>    <span class="sign">}</span>
<span class="line_number">2417 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2fmh"></a>
<a name="robo142"></a><h2>MetropolisHastings/mh [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mh</strong> --- prototype Metropolis-Hastings
</pre>
<p class="item_name">FUNCTION</p>
<p>    Metropolis-Hastings step for general parameters and likelihood functions,
    for which the candidates are generated as multivariate normal.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2435 </span><strong>mh</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>par<span class="sign">,</span> fun<span class="sign">,</span> candcov<span class="sign">,</span> tun<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    par        base model parameters
    fun        likelihood function to use
    candcov    covariance matrix for candidate generation
    tun        tuning parameter for candidate generation
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    par        new parameters after MH step
    acc        boolean, whether the step was accepted
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2438 </span><span class="sign">{</span>
<span class="line_number">2439 </span>    <span class="comment"># base likelihood</span>
<span class="line_number">2440 </span>    baselik <span class="sign">&lt;</span><span class="sign">-</span> fun<span class="sign">(</span>par<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">2441 </span>    <span class="comment"># generate candidate</span>
<span class="line_number">2442 </span>    cand <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo176">MYmvrnorm</a><span class="sign">(</span>1<span class="sign">,</span> par<span class="sign">,</span> candcov <span class="sign">*</span> tun<span class="sign">)</span>
<span class="line_number">2443 </span>    <span class="comment"># candidate likelihood</span>
<span class="line_number">2444 </span>    candlik <span class="sign">&lt;</span><span class="sign">-</span> fun<span class="sign">(</span>cand<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">2445 </span>    <span class="comment"># accept-reject and update parameters</span>
<span class="line_number">2446 </span>    acc <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo141">acceptreject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">)</span>
<span class="line_number">2447 </span>    <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span> out <span class="sign">&lt;</span><span class="sign">-</span> cand <span class="keyword">else</span> out <span class="sign">&lt;</span><span class="sign">-</span> par
<span class="line_number">2448 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>par <span class="sign">=</span> out<span class="sign">,</span> acc <span class="sign">=</span> acc<span class="sign">)</span><span class="sign">)</span>    
<span class="line_number">2449 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2fmh2ebdm"></a>
<a name="robo143"></a><h2>MetropolisHastings/mh.bdm [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mh.bdm</strong> --- RJMCMC for Birth-death-move steps
</pre>
<p class="item_name">FUNCTION</p>
<p>    This function handles the reversible-jump MCMC steps for adding, removing, or moving
    knots in the adaptive knot selection procedure. It can work with either the hazard
    or frailty curve.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2749 </span><strong>mh.bdm</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span><span class="keyword">which</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    which      string, can be either "hazard" or "frailty"
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      updated <a href="#robo26">RCurve</a> for either hazard or frailty
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2752 </span><span class="sign">{</span>
<span class="line_number">2753 </span>    <span class="comment"># get all the needed components</span>
<span class="line_number">2754 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> curve <span class="sign">&lt;</span><span class="sign">-</span> hazard
<span class="line_number">2755 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> curve <span class="sign">&lt;</span><span class="sign">-</span> frailty
<span class="line_number">2756 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>curve<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2757 </span>    knots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>knots
<span class="line_number">2758 </span>    ord <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ord
<span class="line_number">2759 </span>    params <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>par
<span class="line_number">2760 </span>    nknots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots
<span class="line_number">2761 </span>    candknots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>candknots
<span class="line_number">2762 </span>    ncandknots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ncandknots
<span class="line_number">2763 </span>    occ <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span>
<span class="line_number">2764 </span>    occind <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">which</span><span class="sign">(</span>occ <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span>
<span class="line_number">2765 </span>    <span class="comment"># evaluate the prior probability of k knots, k+1 knots, and k-1 knots</span>
<span class="line_number">2766 </span>    pk <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo187">nknotsPrior</a><span class="sign">(</span>nknots<span class="sign">,</span> curve<span class="sign">)</span>
<span class="line_number">2767 </span>    pkp1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>nknots <span class="sign">&lt;</span> curve<span class="sign">$</span>spline<span class="sign">.</span>maxoccknots<span class="sign">)</span> <a href="#robo187">nknotsPrior</a><span class="sign">(</span>nknots <span class="sign">+</span> 1<span class="sign">,</span> curve<span class="sign">)</span> <span class="keyword">else</span> 0
<span class="line_number">2768 </span>    pkm1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>nknots <span class="sign">&gt;</span> 1<span class="sign">)</span> <a href="#robo187">nknotsPrior</a><span class="sign">(</span>nknots <span class="sign">-</span> 1<span class="sign">,</span> curve<span class="sign">)</span> <span class="keyword">else</span> 0
<span class="line_number">2769 </span>    <span class="comment"># compute probability of birth, death and move steps</span>
<span class="line_number">2770 </span>    pb <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>bdmconst <span class="sign">*</span> min<span class="sign">(</span>1<span class="sign">,</span> pkp1 <span class="sign">/</span> pk<span class="sign">)</span> <span class="comment"># P(birth)</span>
<span class="line_number">2771 </span>    pd <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>bdmconst <span class="sign">*</span> min<span class="sign">(</span>1<span class="sign">,</span> pkm1 <span class="sign">/</span> pk<span class="sign">)</span> <span class="comment"># P(death)</span>
<span class="line_number">2772 </span>    pm <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>0<span class="sign">,</span> 1 <span class="sign">-</span> pb <span class="sign">-</span> pd<span class="sign">)</span> <span class="comment"># P(move)</span>
<span class="line_number">2773 </span>    u <span class="sign">&lt;</span><span class="sign">-</span> runif<span class="sign">(</span>1<span class="sign">)</span>
<span class="line_number">2774 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> 
<span class="line_number">2775 </span>        baselik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo137">mklik.spline.haz</a><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2776 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> 
<span class="line_number">2777 </span>        baselik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo135">mklik.spline.frail</a><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2778 </span>    <span class="keyword">if</span><span class="sign">(</span>u <span class="sign">&lt;</span> pd<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2779 </span>        <span class="comment"># Death step</span>
<span class="line_number">2780 </span>        j <span class="sign">&lt;</span><span class="sign">-</span> sample<span class="sign">(</span>1<span class="sign">:</span>nknots<span class="sign">,</span> 1<span class="sign">)</span> <span class="sign">+</span> ord <span class="comment"># index of dying knot</span>
<span class="line_number">2781 </span>        x <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span>j<span class="sign">]</span>
<span class="line_number">2782 </span>            <span class="comment">#cat("Remove knot ", j, " at ", knots[j], "(occ", occ[occind[j - ord]], ")\n")</span>
<span class="line_number">2783 </span>        knots2 <span class="sign">&lt;</span><span class="sign">-</span> knots
<span class="line_number">2784 </span>        params2 <span class="sign">&lt;</span><span class="sign">-</span> params
<span class="line_number">2785 </span>        knots2 <span class="sign">&lt;</span><span class="sign">-</span> knots2<span class="sign">[</span> <span class="sign">-</span> j<span class="sign">]</span> <span class="comment"># remove the knot</span>
<span class="line_number">2786 </span>        <span class="comment"># update parameters symetrically to birth step</span>
<span class="line_number">2787 </span>        params2 <span class="sign">&lt;</span><span class="sign">-</span> params2<span class="sign">[</span> <span class="sign">-</span> <span class="sign">(</span>j <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2788 </span>        <span class="keyword">if</span><span class="sign">(</span>ord <span class="sign">&gt;</span> 2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span>j2 in <span class="sign">(</span>j <span class="sign">-</span> ord <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span>j <span class="sign">-</span> 2<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2789 </span>             r2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>x <span class="sign">-</span> knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>knots2<span class="sign">[</span>j2 <span class="sign">+</span> ord <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">-</span> knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2790 </span>             inner <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">/</span> r2 <span class="sign">*</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> <span class="sign">(</span>1 <span class="sign">-</span> r2<span class="sign">)</span> <span class="sign">/</span> r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2 <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2791 </span>             <span class="keyword">if</span><span class="sign">(</span>inner <span class="sign">&gt;</span> 0<span class="sign">)</span> params2<span class="sign">[</span>j2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>inner<span class="sign">)</span> <span class="keyword">else</span> params2<span class="sign">[</span>j2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>min
<span class="line_number">2792 </span>        <span class="sign">}</span>
<span class="line_number">2793 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"boundary"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"boundary"</span><span class="sign">)</span>
<span class="line_number">2794 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"order"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"order"</span><span class="sign">)</span>
<span class="line_number">2795 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"index"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">:</span><span class="sign">(</span>nknots <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">-</span> ord
<span class="line_number">2796 </span>        <span class="comment"># create a temporary curve that is identical to the original, except for</span>
<span class="line_number">2797 </span>        <span class="comment"># the spline.knots and spline.params components</span>
<span class="line_number">2798 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> curve
<span class="line_number">2799 </span>        temp<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> knots2
<span class="line_number">2800 </span>        temp<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> nknots <span class="sign">-</span> 1
<span class="line_number">2801 </span>        occ2 <span class="sign">&lt;</span><span class="sign">-</span> occ<span class="sign">;</span> occ2<span class="sign">[</span>occind<span class="sign">[</span>j <span class="sign">-</span> ord<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2802 </span>        attr<span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> occ2
<span class="line_number">2803 </span>        <span class="comment"># Compute the spline basis of the temp curve</span>
<span class="line_number">2804 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo184">makesplinebasis</a><span class="sign">(</span>temp<span class="sign">)</span>
<span class="line_number">2805 </span>        <span class="comment"># Jacobian of the transformation</span>
<span class="line_number">2806 </span>        J <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j <span class="sign">-</span> 2<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2807 </span>        <span class="keyword">if</span><span class="sign">(</span>ord <span class="sign">&gt;</span> 2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span>j2 in <span class="sign">(</span>j <span class="sign">-</span> ord <span class="sign">+</span> 2<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span>j <span class="sign">-</span> 2<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2808 </span>            r2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>x <span class="sign">-</span> knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>knots2<span class="sign">[</span>j2 <span class="sign">+</span> ord <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">-</span> knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2809 </span>            J <span class="sign">&lt;</span><span class="sign">-</span> J <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2810 </span>        <span class="sign">}</span>
<span class="line_number">2811 </span>        <span class="comment"># candidate likelihood</span>
<span class="line_number">2812 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2813 </span>            temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>temp<span class="sign">,</span> params2<span class="sign">)</span>
<span class="line_number">2814 </span>            candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo137">mklik.spline.haz</a><span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> temp<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2815 </span>        <span class="sign">}</span>
<span class="line_number">2816 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2817 </span>            <span class="comment"># for the frailty, adjust the mean to make sure it is 1</span>
<span class="line_number">2818 </span>            newmean <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp <span class="sign">-</span>
<span class="line_number">2819 </span>                <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j <span class="sign">-</span> 2<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>j <span class="sign">-</span> 2<span class="sign">]</span>
<span class="line_number">2820 </span>            newinner <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>newmean <span class="sign">/</span> temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>j <span class="sign">-</span> 2<span class="sign">]</span>
<span class="line_number">2821 </span>            <span class="keyword">if</span><span class="sign">(</span>newinner <span class="sign">&lt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2822 </span>                candlik<span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>Inf
<span class="line_number">2823 </span>            <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2824 </span>                params2<span class="sign">[</span>j <span class="sign">-</span> 2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>newinner<span class="sign">)</span>
<span class="line_number">2825 </span>                temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>temp<span class="sign">,</span> params2<span class="sign">)</span>
<span class="line_number">2826 </span>                candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo135">mklik.spline.frail</a><span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> temp<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2827 </span>            <span class="sign">}</span>
<span class="line_number">2828 </span>        <span class="sign">}</span>
<span class="line_number">2829 </span>        <span class="comment"># compute acceptance ratio, and accept-reject</span>
<span class="line_number">2830 </span>        ratio <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sqrt</span><span class="sign">(</span>2 <span class="sign">*</span> pi <span class="sign">*</span> curve<span class="sign">$</span>spline<span class="sign">.</span>priorvar<span class="sign">)</span> <span class="sign">*</span> abs<span class="sign">(</span>J<span class="sign">)</span>
<span class="line_number">2831 </span>        acc <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo141">acceptreject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> ratio<span class="sign">)</span>
<span class="line_number">2832 </span>            <span class="comment">#cat("Lik: ", baselik, candlik, J, ratio, acc, "\n")</span>
<span class="line_number">2833 </span>        <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>knots2<span class="sign">[</span><span class="sign">(</span>ord <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>knots2<span class="sign">)</span> <span class="sign">-</span> ord<span class="sign">)</span><span class="sign">]</span> <span class="sign">!</span><span class="sign">=</span> candknots<span class="sign">[</span>occ2 <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">2834 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>temp<span class="sign">)</span> <span class="keyword">else</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">2835 </span>    <span class="sign">}</span>
<span class="line_number">2836 </span>
<span class="line_number">2837 </span>    <span class="keyword">if</span><span class="sign">(</span>u <span class="sign">&gt;</span> pd <span class="sign">&amp;</span> u <span class="sign">&lt;</span> pd <span class="sign">+</span> pb<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2838 </span>        <span class="comment"># Birth of a knot</span>
<span class="line_number">2839 </span>        params <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>par
<span class="line_number">2840 </span>        <span class="comment"># choose an unoccupied candidate knot location at random</span>
<span class="line_number">2841 </span>        birthind <span class="sign">&lt;</span><span class="sign">-</span> occind<span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">2842 </span>        <span class="keyword">while</span><span class="sign">(</span>occ<span class="sign">[</span>birthind<span class="sign">]</span> <span class="sign">&gt;</span> 0<span class="sign">)</span> birthind <span class="sign">&lt;</span><span class="sign">-</span> floor<span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">,</span> 1<span class="sign">,</span> ncandknots <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">+</span> ord
<span class="line_number">2843 </span>        <span class="comment"># get the position and interval of candidate knot</span>
<span class="line_number">2844 </span>        x <span class="sign">&lt;</span><span class="sign">-</span> candknots<span class="sign">[</span>birthind<span class="sign">]</span>
<span class="line_number">2845 </span>        i <span class="sign">&lt;</span><span class="sign">-</span> findInterval<span class="sign">(</span>x<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">2846 </span>            <span class="comment">#cat("Birth at ", x, " after knot ", i, "\n");</span>
<span class="line_number">2847 </span>        <span class="comment"># Compute new knots and parameters</span>
<span class="line_number">2848 </span>        knots2 <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>knots<span class="sign">[</span>1<span class="sign">:</span>i<span class="sign">]</span><span class="sign">,</span> x<span class="sign">,</span> knots<span class="sign">[</span><span class="sign">(</span>i <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>knots<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2849 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"boundary"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"boundary"</span><span class="sign">)</span>
<span class="line_number">2850 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"order"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"order"</span><span class="sign">)</span>
<span class="line_number">2851 </span>        attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"index"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">:</span><span class="sign">(</span>nknots <span class="sign">+</span> 1<span class="sign">)</span> <span class="sign">-</span> ord
<span class="line_number">2852 </span>        params2 <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>params<span class="sign">[</span>1<span class="sign">:</span><span class="sign">(</span>i <span class="sign">-</span> ord <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> 0<span class="sign">,</span> params<span class="sign">[</span><span class="sign">(</span>i <span class="sign">-</span> ord <span class="sign">+</span> 2<span class="sign">)</span><span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>params<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2853 </span>        <span class="comment"># Even though it is possible to add a knot non-destructively, we need to generate</span>
<span class="line_number">2854 </span>        <span class="comment"># another random number to maintain dimension matching and detailed balance</span>
<span class="line_number">2855 </span>        <span class="keyword">for</span><span class="sign">(</span>i2 in <span class="sign">(</span>i <span class="sign">-</span> ord <span class="sign">+</span> 2<span class="sign">)</span><span class="sign">:</span>i<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2856 </span>            r2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>x <span class="sign">-</span> knots<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>knots<span class="sign">[</span>i2 <span class="sign">+</span> ord <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">-</span> knots<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2857 </span>            <span class="keyword">if</span><span class="sign">(</span>i2 <span class="sign">=</span><span class="sign">=</span> i<span class="sign">)</span> r2 <span class="sign">&lt;</span><span class="sign">-</span> runif<span class="sign">(</span>1<span class="sign">)</span>
<span class="line_number">2858 </span>            params2<span class="sign">[</span>i2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span> <span class="sign">+</span> <span class="sign">(</span>1 <span class="sign">-</span> r2<span class="sign">)</span> <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>i2 <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2859 </span>        <span class="sign">}</span>
<span class="line_number">2860 </span>        <span class="comment"># Create a temp curve with new knots and params</span>
<span class="line_number">2861 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> curve
<span class="line_number">2862 </span>        temp<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> knots2
<span class="line_number">2863 </span>        temp<span class="sign">$</span>spline<span class="sign">.</span>nknots <span class="sign">&lt;</span><span class="sign">-</span> nknots <span class="sign">+</span> 1
<span class="line_number">2864 </span>        occ2 <span class="sign">&lt;</span><span class="sign">-</span> occ<span class="sign">;</span> occ2<span class="sign">[</span>birthind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">2865 </span>        attr<span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> occ2
<span class="line_number">2866 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo184">makesplinebasis</a><span class="sign">(</span>temp<span class="sign">)</span>
<span class="line_number">2867 </span>        <span class="comment"># Jacobian of the transformation</span>
<span class="line_number">2868 </span>        J <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>i <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2869 </span>        <span class="keyword">if</span><span class="sign">(</span>ord <span class="sign">&gt;</span> 2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span>i2 in <span class="sign">(</span>i <span class="sign">-</span> ord <span class="sign">+</span> 2<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span>i <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2870 </span>            r2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>x <span class="sign">-</span> knots<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>knots<span class="sign">[</span>i2 <span class="sign">+</span> ord <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">-</span> knots<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2871 </span>            J <span class="sign">&lt;</span><span class="sign">-</span> J <span class="sign">*</span> r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2872 </span>        <span class="sign">}</span>
<span class="line_number">2873 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2874 </span>            temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>temp<span class="sign">,</span> params2<span class="sign">)</span>
<span class="line_number">2875 </span>            candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo137">mklik.spline.haz</a><span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> temp<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2876 </span>        <span class="sign">}</span>
<span class="line_number">2877 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2878 </span>            <span class="comment"># adjust frailty mean</span>
<span class="line_number">2879 </span>            newmean <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">2880 </span>                temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>i<span class="sign">]</span>
<span class="line_number">2881 </span>            newinner <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>newmean <span class="sign">/</span> temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>i<span class="sign">]</span>
<span class="line_number">2882 </span>            <span class="keyword">if</span><span class="sign">(</span>newinner <span class="sign">&lt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2883 </span>                candlik<span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>Inf
<span class="line_number">2884 </span>            <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2885 </span>                params2<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>newinner<span class="sign">)</span>
<span class="line_number">2886 </span>                temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>temp<span class="sign">,</span> params2<span class="sign">)</span>
<span class="line_number">2887 </span>                candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo135">mklik.spline.frail</a><span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> temp<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2888 </span>            <span class="sign">}</span>
<span class="line_number">2889 </span>        <span class="sign">}</span>
<span class="line_number">2890 </span>        <span class="comment"># acceptance ratio</span>
<span class="line_number">2891 </span>        ratio <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">/</span> <span class="keyword">sqrt</span><span class="sign">(</span>2 <span class="sign">*</span> pi <span class="sign">*</span> curve<span class="sign">$</span>spline<span class="sign">.</span>priorvar<span class="sign">)</span> <span class="sign">*</span> abs<span class="sign">(</span>J<span class="sign">)</span>
<span class="line_number">2892 </span>        acc <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo141">acceptreject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> ratio<span class="sign">)</span>
<span class="line_number">2893 </span>            <span class="comment">#cat("Lik: ", baselik, candlik, J, ratio, acc, "\n")</span>
<span class="line_number">2894 </span>        <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>knots2<span class="sign">[</span><span class="sign">(</span>ord <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>knots2<span class="sign">)</span> <span class="sign">-</span> ord<span class="sign">)</span><span class="sign">]</span> <span class="sign">!</span><span class="sign">=</span> candknots<span class="sign">[</span>occ2 <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">2895 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>temp<span class="sign">)</span> <span class="keyword">else</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">2896 </span>
<span class="line_number">2897 </span>    <span class="sign">}</span>
<span class="line_number">2898 </span>
<span class="line_number">2899 </span>    <span class="keyword">if</span><span class="sign">(</span>u <span class="sign">&gt;</span> pd <span class="sign">+</span> pb<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2900 </span>        <span class="comment"># Move a knot</span>
<span class="line_number">2901 </span>        <span class="comment"># choose a random knot to move</span>
<span class="line_number">2902 </span>        moveind <span class="sign">&lt;</span><span class="sign">-</span> floor<span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">,</span> 1<span class="sign">,</span> nknots <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2903 </span>        <span class="comment"># compute the range of candidate knot indices to which the knot can be moved</span>
<span class="line_number">2904 </span>        leftknotind <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>moveind <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> ord <span class="sign">+</span> 1 <span class="keyword">else</span> occind<span class="sign">[</span>moveind <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> 1
<span class="line_number">2905 </span>        rightknotind <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>moveind <span class="sign">=</span><span class="sign">=</span> nknots<span class="sign">)</span> ncandknots <span class="sign">+</span> ord <span class="keyword">else</span> occind<span class="sign">[</span>moveind <span class="sign">+</span> 1<span class="sign">]</span> <span class="sign">-</span> 1
<span class="line_number">2906 </span>        newknotind <span class="sign">&lt;</span><span class="sign">-</span> floor<span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">,</span> leftknotind<span class="sign">,</span> rightknotind <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2907 </span>        oldknotind <span class="sign">&lt;</span><span class="sign">-</span> occind<span class="sign">[</span>moveind<span class="sign">]</span>
<span class="line_number">2908 </span>        <span class="comment">#cat("Moveind: ", moveind, "\n");</span>
<span class="line_number">2909 </span>        <span class="comment">#cat("Old / New: ", candknots[oldknotind], candknots[newknotind], "\n");</span>
<span class="line_number">2910 </span>        <span class="keyword">if</span><span class="sign">(</span>newknotind <span class="sign">=</span><span class="sign">=</span> oldknotind<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">2911 </span>        <span class="comment"># create new knots and parameters</span>
<span class="line_number">2912 </span>        knots2 <span class="sign">&lt;</span><span class="sign">-</span> knots
<span class="line_number">2913 </span>        params2 <span class="sign">&lt;</span><span class="sign">-</span> params
<span class="line_number">2914 </span>        knots2<span class="sign">[</span>moveind <span class="sign">+</span> ord<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> candknots<span class="sign">[</span>newknotind<span class="sign">]</span>
<span class="line_number">2915 </span>        <span class="comment"># update occupied knot indices</span>
<span class="line_number">2916 </span>        occ2 <span class="sign">&lt;</span><span class="sign">-</span> occ
<span class="line_number">2917 </span>        occ2<span class="sign">[</span>newknotind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">2918 </span>        occ2<span class="sign">[</span>occind<span class="sign">[</span>moveind<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2919 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>occ <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="sign">&lt;</span> nknots<span class="sign">)</span> browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">2920 </span>        <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span><span class="keyword">diff</span><span class="sign">(</span>knots2<span class="sign">)</span> <span class="sign">&lt;</span> 0<span class="sign">)</span><span class="sign">)</span> browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">2921 </span>        <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>knots2<span class="sign">[</span><span class="sign">(</span>ord <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>knots2<span class="sign">)</span> <span class="sign">-</span> ord<span class="sign">)</span><span class="sign">]</span> <span class="sign">!</span><span class="sign">=</span> candknots<span class="sign">[</span>occ2 <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">2922 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> curve
<span class="line_number">2923 </span>        temp<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> knots2
<span class="line_number">2924 </span>        attr<span class="sign">(</span>temp<span class="sign">$</span>spline<span class="sign">.</span>candknots<span class="sign">,</span> <span class="quote">"occupied"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> occ2
<span class="line_number">2925 </span>        <span class="comment"># update the spline basis</span>
<span class="line_number">2926 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo184">makesplinebasis</a><span class="sign">(</span>temp<span class="sign">)</span>
<span class="line_number">2927 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2928 </span>            candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo137">mklik.spline.haz</a><span class="sign">(</span>params2<span class="sign">,</span> temp<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2929 </span>        <span class="sign">}</span>
<span class="line_number">2930 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2931 </span>            <span class="comment"># adjust frailty mean</span>
<span class="line_number">2932 </span>            newmean <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>moveind <span class="sign">+</span> ord<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">2933 </span>                temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>moveind <span class="sign">+</span> ord<span class="sign">]</span>
<span class="line_number">2934 </span>            newinner <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>newmean <span class="sign">/</span> temp<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>moveind <span class="sign">+</span> ord<span class="sign">]</span>
<span class="line_number">2935 </span>            <span class="keyword">if</span><span class="sign">(</span>newinner <span class="sign">&lt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2936 </span>                candlik<span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>Inf
<span class="line_number">2937 </span>            <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2938 </span>                params2<span class="sign">[</span>moveind <span class="sign">+</span> ord<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>newinner<span class="sign">)</span>
<span class="line_number">2939 </span>                temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>temp<span class="sign">,</span> params2<span class="sign">)</span>
<span class="line_number">2940 </span>                candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo135">mklik.spline.frail</a><span class="sign">(</span>params2<span class="sign">,</span> hazard<span class="sign">,</span> temp<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2941 </span>            <span class="sign">}</span>
<span class="line_number">2942 </span>        <span class="sign">}</span>
<span class="line_number">2943 </span>        acc <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo141">acceptreject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">2944 </span>            <span class="comment">#cat("Lik: ", baselik, candlik, acc, "\n")</span>
<span class="line_number">2945 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>temp<span class="sign">)</span> <span class="keyword">else</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">2946 </span>    <span class="sign">}</span>
<span class="line_number">2947 </span>
<span class="line_number">2948 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2fmh2ecoef"></a>
<a name="robo144"></a><h2>MetropolisHastings/mh.coef [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mh.coef</strong> --- MH for regression coefficients
</pre>
<p class="item_name">FUNCTION</p>
<p>    Metropolis-Hastings step for regression coefficients
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2666 </span><strong>mh.coef</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    regression   <a href="#robo28">RRegression</a> with updated coefficients
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2669 </span><span class="sign">{</span>
<span class="line_number">2670 </span>    mhout <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo142">mh</a><span class="sign">(</span>regression<span class="sign">$</span>coefficients<span class="sign">,</span> <a href="#robo131">mklik.coef</a><span class="sign">,</span> regression<span class="sign">$</span>candcov<span class="sign">,</span> regression<span class="sign">$</span>tun<span class="sign">,</span>
<span class="line_number">2671 </span>        hazard <span class="sign">=</span> hazard<span class="sign">,</span> frailty <span class="sign">=</span> frailty<span class="sign">,</span> regression <span class="sign">=</span> regression<span class="sign">)</span>
<span class="line_number">2672 </span>    <span class="keyword">if</span><span class="sign">(</span>mhout<span class="sign">$</span>acc<span class="sign">)</span> regression <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo109">updateregression</a><span class="sign">(</span>regression<span class="sign">,</span> mhout<span class="sign">$</span>par<span class="sign">)</span>
<span class="line_number">2673 </span>    regression<span class="sign">$</span>accept <span class="sign">&lt;</span><span class="sign">-</span> mhout<span class="sign">$</span>acc
<span class="line_number">2674 </span>    <span class="keyword">return</span><span class="sign">(</span>regression<span class="sign">)</span>
<span class="line_number">2675 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2fmh2efrail"></a>
<a name="robo145"></a><h2>MetropolisHastings/mh.frail [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mh.frail</strong> --- MH for frailties
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update the frailty estimates by Metropolis-Hastings
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2464 </span><strong>mh.frail</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    frailty    Rcurve with updated frailty values
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2467 </span><span class="sign">{</span>
<span class="line_number">2468 </span>    acc <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> regression<span class="sign">$</span>m<span class="sign">)</span>
<span class="line_number">2469 </span>    <span class="comment"># update each of the frailties separately</span>
<span class="line_number">2470 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span>regression<span class="sign">$</span>m<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2471 </span>        u <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>x<span class="sign">[</span>i<span class="sign">]</span>
<span class="line_number">2472 </span>        v <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>tun
<span class="line_number">2473 </span>        <span class="comment"># generate candidates from gamma distribution</span>
<span class="line_number">2474 </span>        cand <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rgamma</span><span class="sign">(</span>1<span class="sign">,</span> shape <span class="sign">=</span> u<span class="sign">^</span>2 <span class="sign">/</span> v<span class="sign">,</span> scale <span class="sign">=</span> v <span class="sign">/</span> u<span class="sign">)</span>
<span class="line_number">2475 </span>        <span class="comment"># check if the candidate is out of bounds or NaN</span>
<span class="line_number">2476 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>nan<span class="sign">(</span>cand<span class="sign">)</span> <span class="sign">|</span><span class="sign">|</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&amp;</span><span class="sign">&amp;</span> 
<span class="line_number">2477 </span>          <span class="sign">(</span>cand <span class="sign">&gt;</span> attr<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">|</span> 
<span class="line_number">2478 </span>            cand <span class="sign">&lt;</span> attr<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> next<span class="sign">;</span>
<span class="line_number">2479 </span>        <span class="comment"># choose another fraity to compensate for the change in the mean</span>
<span class="line_number">2480 </span>        j <span class="sign">&lt;</span><span class="sign">-</span> i
<span class="line_number">2481 </span>        <span class="keyword">while</span><span class="sign">(</span>j <span class="sign">=</span><span class="sign">=</span> i<span class="sign">)</span> j <span class="sign">&lt;</span><span class="sign">-</span> floor<span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>frailty<span class="sign">$</span>x<span class="sign">)</span> <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2482 </span>        <span class="comment"># adjust the second candidate to make sure the mean remains 1</span>
<span class="line_number">2483 </span>        candj <span class="sign">&lt;</span><span class="sign">-</span> u <span class="sign">+</span> frailty<span class="sign">$</span>x<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">-</span> cand
<span class="line_number">2484 </span>        <span class="comment"># check that candj is in bounds as well.</span>
<span class="line_number">2485 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>nan<span class="sign">(</span>candj<span class="sign">)</span> <span class="sign">|</span><span class="sign">|</span> <span class="sign">(</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&amp;</span><span class="sign">&amp;</span> 
<span class="line_number">2486 </span>          <span class="sign">(</span>candj <span class="sign">&gt;</span> attr<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">|</span> 
<span class="line_number">2487 </span>            candj <span class="sign">&lt;</span> attr<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> next<span class="sign">;</span>
<span class="line_number">2488 </span>
<span class="line_number">2489 </span>        <span class="comment"># base likelihood</span>
<span class="line_number">2490 </span>        baselik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo132">mklik.frail</a><span class="sign">(</span>i<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2491 </span>            <a href="#robo132">mklik.frail</a><span class="sign">(</span>j<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2492 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> frailty
<span class="line_number">2493 </span>        temp<span class="sign">$</span>x<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> cand
<span class="line_number">2494 </span>        temp<span class="sign">$</span>x<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> candj
<span class="line_number">2495 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo106">updatecurvex</a><span class="sign">(</span>temp<span class="sign">,</span> i<span class="sign">)</span>
<span class="line_number">2496 </span>        temp <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo106">updatecurvex</a><span class="sign">(</span>temp<span class="sign">,</span> j<span class="sign">)</span>
<span class="line_number">2497 </span>        <span class="comment"># candidate likelihoood</span>
<span class="line_number">2498 </span>        candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo132">mklik.frail</a><span class="sign">(</span>i<span class="sign">,</span> hazard<span class="sign">,</span> temp<span class="sign">,</span> regression<span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2499 </span>            <a href="#robo132">mklik.frail</a><span class="sign">(</span>j<span class="sign">,</span> hazard<span class="sign">,</span> temp<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2500 </span>
<span class="line_number">2501 </span>        <span class="comment"># transition u-&gt;cand</span>
<span class="line_number">2502 </span>        puc <span class="sign">&lt;</span><span class="sign">-</span> suppressWarnings<span class="sign">(</span>dgamma<span class="sign">(</span>cand<span class="sign">,</span> shape <span class="sign">=</span> u<span class="sign">^</span>2 <span class="sign">/</span> v<span class="sign">,</span> scale <span class="sign">=</span> v <span class="sign">/</span> u<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">2503 </span>        <span class="comment"># transition cand-&gt;u</span>
<span class="line_number">2504 </span>        pcu <span class="sign">&lt;</span><span class="sign">-</span> suppressWarnings<span class="sign">(</span>dgamma<span class="sign">(</span>u<span class="sign">,</span> shape <span class="sign">=</span> cand<span class="sign">^</span>2 <span class="sign">/</span> v<span class="sign">,</span> scale <span class="sign">=</span> v <span class="sign">/</span> cand<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">2505 </span>
<span class="line_number">2506 </span>        acc<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo141">acceptreject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> pcu <span class="sign">/</span> puc<span class="sign">)</span>
<span class="line_number">2507 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> frailty <span class="sign">&lt;</span><span class="sign">-</span> temp
<span class="line_number">2508 </span>    <span class="sign">}</span>
<span class="line_number">2509 </span>    frailty<span class="sign">$</span>accept <span class="sign">&lt;</span><span class="sign">-</span> mean<span class="sign">(</span>acc<span class="sign">)</span>
<span class="line_number">2510 </span>    <span class="keyword">return</span><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">2511 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2fmh2efrailty2eparam"></a>
<a name="robo146"></a><h2>MetropolisHastings/mh.frailty.param [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mh.frailty.param</strong> --- MH for frailty parametric component parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Metropolis-Hastings steps for parametric component parameters for frailty
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2616 </span><strong>mh.frailty.param</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    frailty     Rcurve with updated frailty parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2619 </span><span class="sign">{</span>
<span class="line_number">2620 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>frailty<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">2621 </span>    mhout <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo142">mh</a><span class="sign">(</span>frailty<span class="sign">$</span>param<span class="sign">.</span>par<span class="sign">,</span> <a href="#robo133">mklik.param.frail</a><span class="sign">,</span> frailty<span class="sign">$</span>param<span class="sign">.</span>candcov<span class="sign">,</span>
<span class="line_number">2622 </span>        frailty<span class="sign">$</span>param<span class="sign">.</span>tun<span class="sign">,</span> hazard <span class="sign">=</span> hazard<span class="sign">,</span> frailty <span class="sign">=</span> frailty<span class="sign">,</span> regression <span class="sign">=</span> regression<span class="sign">)</span>
<span class="line_number">2623 </span>    <span class="keyword">if</span><span class="sign">(</span>mhout<span class="sign">$</span>acc<span class="sign">)</span> frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo108">updateparametric</a><span class="sign">(</span>frailty<span class="sign">,</span> mhout<span class="sign">$</span>par<span class="sign">)</span>
<span class="line_number">2624 </span>    frailty<span class="sign">$</span>param<span class="sign">.</span>accept <span class="sign">&lt;</span><span class="sign">-</span> mhout<span class="sign">$</span>acc
<span class="line_number">2625 </span>    <span class="keyword">return</span><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">2626 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2fmh2efrailty2espline"></a>
<a name="robo147"></a><h2>MetropolisHastings/mh.frailty.spline [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mh.frailty.spline</strong> --- MH for frailty spline parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Metropolis-Hastings steps for spline parameters for frailty
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2526 </span><strong>mh.frailty.spline</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    frailty    Rcurve with updated frailty parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2529 </span><span class="sign">{</span>
<span class="line_number">2530 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>frailty<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">2531 </span>    sumacc <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2532 </span>    nj <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">2533 </span>    ord2 <span class="sign">&lt;</span><span class="sign">-</span> round<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span> <span class="sign">/</span> 2
<span class="line_number">2534 </span>    <span class="comment"># base likelihood</span>
<span class="line_number">2535 </span>    baselik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo135">mklik.spline.frail</a><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2536 </span>    <span class="comment"># update each parameter separately</span>
<span class="line_number">2537 </span>    <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span>nj<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2538 </span>        <span class="comment"># get position j and position k which will be used to keep the mean at 1</span>
<span class="line_number">2539 </span>        cand <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>par
<span class="line_number">2540 </span>        k <span class="sign">&lt;</span><span class="sign">-</span> j
<span class="line_number">2541 </span>        Ej <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>j<span class="sign">]</span>
<span class="line_number">2542 </span>        <span class="keyword">while</span><span class="sign">(</span>j <span class="sign">=</span><span class="sign">=</span> k <span class="sign">|</span> k <span class="sign">&lt;</span> ord2 <span class="sign">|</span> k <span class="sign">&gt;</span> nj <span class="sign">-</span> ord2<span class="sign">)</span> k <span class="sign">&lt;</span><span class="sign">-</span> floor<span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">,</span> 1<span class="sign">,</span> nj <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2543 </span>        Ek <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>basisexp<span class="sign">[</span>k<span class="sign">]</span>
<span class="line_number">2544 </span>        cand<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> cand<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">+</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>tun <span class="sign">*</span> <span class="keyword">rnorm</span><span class="sign">(</span>1<span class="sign">,</span> 0<span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>candsd<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2545 </span>        newmean <span class="sign">&lt;</span><span class="sign">-</span> Ej <span class="sign">*</span> <span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>cand<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2546 </span>        newinner <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">[</span>k<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> newmean <span class="sign">/</span> Ek
<span class="line_number">2547 </span>        <span class="keyword">if</span><span class="sign">(</span>newinner <span class="sign">&lt;</span><span class="sign">=</span> 0<span class="sign">)</span> next
<span class="line_number">2548 </span>        candk <span class="sign">=</span> log<span class="sign">(</span>newinner<span class="sign">)</span>
<span class="line_number">2549 </span>        cand<span class="sign">[</span>k<span class="sign">]</span> <span class="sign">=</span> candk
<span class="line_number">2550 </span>        <span class="comment"># candidate likelihood</span>
<span class="line_number">2551 </span>        candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo135">mklik.spline.frail</a><span class="sign">(</span>cand<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2552 </span>        thisacc <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo141">acceptreject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">2553 </span>        <span class="keyword">if</span><span class="sign">(</span>thisacc<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2554 </span>            baselik <span class="sign">&lt;</span><span class="sign">-</span> candlik
<span class="line_number">2555 </span>            frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>frailty<span class="sign">,</span> cand<span class="sign">)</span>
<span class="line_number">2556 </span>            frailty<span class="sign">$</span>spline<span class="sign">.</span>fvar <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo182">frailtysplinefvar</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">2557 </span>        <span class="sign">}</span>
<span class="line_number">2558 </span>        sumacc <span class="sign">&lt;</span><span class="sign">-</span> sumacc <span class="sign">+</span> thisacc
<span class="line_number">2559 </span>    <span class="sign">}</span>
<span class="line_number">2560 </span>    frailty<span class="sign">$</span>spline<span class="sign">.</span>accept <span class="sign">&lt;</span><span class="sign">-</span> sumacc <span class="sign">/</span> nj
<span class="line_number">2561 </span>    <span class="keyword">return</span><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">2562 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2fmh2ehazard2eparam"></a>
<a name="robo148"></a><h2>MetropolisHastings/mh.hazard.param [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mh.hazard.param</strong> --- MH for hazard parametric component parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Metropolis-Hastings steps for parametric component parameters for hazard
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2641 </span><strong>mh.hazard.param</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    hazard     Rcurve with updated hazard parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2644 </span><span class="sign">{</span>
<span class="line_number">2645 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>hazard<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">2646 </span>    mhout <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo142">mh</a><span class="sign">(</span>hazard<span class="sign">$</span>param<span class="sign">.</span>par<span class="sign">,</span> <a href="#robo134">mklik.param.haz</a><span class="sign">,</span> hazard<span class="sign">$</span>param<span class="sign">.</span>candcov<span class="sign">,</span> hazard<span class="sign">$</span>param<span class="sign">.</span>tun<span class="sign">,</span>
<span class="line_number">2647 </span>        hazard <span class="sign">=</span> hazard<span class="sign">,</span> frailty <span class="sign">=</span> frailty<span class="sign">,</span> regression <span class="sign">=</span> regression<span class="sign">)</span>
<span class="line_number">2648 </span>    <span class="keyword">if</span><span class="sign">(</span>mhout<span class="sign">$</span>acc<span class="sign">)</span> hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo108">updateparametric</a><span class="sign">(</span>hazard<span class="sign">,</span> mhout<span class="sign">$</span>par<span class="sign">)</span>
<span class="line_number">2649 </span>    hazard<span class="sign">$</span>param<span class="sign">.</span>accept <span class="sign">&lt;</span><span class="sign">-</span> mhout<span class="sign">$</span>acc
<span class="line_number">2650 </span>    <span class="keyword">return</span><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">2651 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2fmh2ehazard2espline"></a>
<a name="robo149"></a><h2>MetropolisHastings/mh.hazard.spline [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mh.hazard.spline</strong> --- MH for hazard spline parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Metropolis-Hastings steps for spline parameters for hazard
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2577 </span><strong>mh.hazard.spline</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    hazard     Rcurve with updated hazard parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2580 </span><span class="sign">{</span>
<span class="line_number">2581 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>hazard<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">2582 </span>    sumacc <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2583 </span>    nj <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">2584 </span>    cand <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> nj<span class="sign">)</span>
<span class="line_number">2585 </span>    <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span>nj<span class="sign">)</span> cand<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">+</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>tun <span class="sign">*</span>
<span class="line_number">2586 </span>        <span class="keyword">rnorm</span><span class="sign">(</span>1<span class="sign">,</span> 0<span class="sign">,</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>candsd<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2587 </span>    baselik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo137">mklik.spline.haz</a><span class="sign">(</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2588 </span>    <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span>nj<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2589 </span>        thiscand <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>par
<span class="line_number">2590 </span>        thiscand<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> cand<span class="sign">[</span>j<span class="sign">]</span>
<span class="line_number">2591 </span>        candlik <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo137">mklik.spline.haz</a><span class="sign">(</span>thiscand<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2592 </span>        thisacc <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo141">acceptreject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">2593 </span>        <span class="keyword">if</span><span class="sign">(</span>thisacc<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2594 </span>            baselik <span class="sign">&lt;</span><span class="sign">-</span> candlik
<span class="line_number">2595 </span>            hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo110">updatespline</a><span class="sign">(</span>hazard<span class="sign">,</span> thiscand<span class="sign">)</span>
<span class="line_number">2596 </span>        <span class="sign">}</span>
<span class="line_number">2597 </span>        sumacc <span class="sign">&lt;</span><span class="sign">-</span> sumacc <span class="sign">+</span> thisacc
<span class="line_number">2598 </span>    <span class="sign">}</span>
<span class="line_number">2599 </span>    hazard<span class="sign">$</span>spline<span class="sign">.</span>accept <span class="sign">&lt;</span><span class="sign">-</span> sumacc <span class="sign">/</span> nj
<span class="line_number">2600 </span>    <span class="keyword">return</span><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">2601 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2fmh2eweight"></a>
<a name="robo150"></a><h2>MetropolisHastings/mh.weight [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mh.weight</strong> --- MH for spline component weight for either hazard or frailty
</pre>
<p class="item_name">FUNCTION</p>
<p>    Metropolis-Hastings step for relative weight of spline and parametric components.
    Works for either hazard or frailty curve, depending on the setting of "which".
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2692 </span><strong>mh.weight</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span><span class="keyword">which</span><span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    which      string, can be either "hazard" or "frailty"
    hazard     <a href="#robo26">RCurve</a> for hazard
    frailty    <a href="#robo26">RCurve</a> for frailty
    regression <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      updated <a href="#robo26">RCurve</a> for either hazard or frailty
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2695 </span><span class="sign">{</span>
<span class="line_number">2696 </span>    <span class="comment"># get the curve and likelihood function for the value of "which"</span>
<span class="line_number">2697 </span>    <span class="keyword">which</span> <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span><span class="keyword">which</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"hazard"</span><span class="sign">,</span> <span class="quote">"frailty"</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2698 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2699 </span>        curve <span class="sign">&lt;</span><span class="sign">-</span> frailty
<span class="line_number">2700 </span>        fun <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo138">mklik.weight.frail</a>
<span class="line_number">2701 </span>    <span class="sign">}</span>
<span class="line_number">2702 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2703 </span>        curve <span class="sign">&lt;</span><span class="sign">-</span> hazard
<span class="line_number">2704 </span>        fun <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo139">mklik.weight.haz</a>
<span class="line_number">2705 </span>    <span class="sign">}</span>
<span class="line_number">2706 </span>    <span class="comment"># generate candidate weight as beta</span>
<span class="line_number">2707 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>curve<span class="sign">$</span><a href="#robo154">haspar</a> <span class="sign">|</span> <span class="sign">!</span>curve<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">2708 </span>    w <span class="sign">&lt;</span><span class="sign">-</span> min<span class="sign">(</span>max<span class="sign">(</span>curve<span class="sign">$</span>weight<span class="sign">,</span> <span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span> <span class="sign">.</span>99<span class="sign">)</span>
<span class="line_number">2709 </span>    v <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>weight<span class="sign">.</span>tun
<span class="line_number">2710 </span>    alpha <span class="sign">&lt;</span><span class="sign">-</span> w <span class="sign">*</span> <span class="sign">(</span>w <span class="sign">*</span> <span class="sign">(</span>1 <span class="sign">-</span> w<span class="sign">)</span> <span class="sign">/</span> v <span class="sign">-</span> 1<span class="sign">)</span>
<span class="line_number">2711 </span>    beta <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>1 <span class="sign">-</span> w<span class="sign">)</span> <span class="sign">/</span> w <span class="sign">*</span> alpha
<span class="line_number">2712 </span>    cand <span class="sign">&lt;</span><span class="sign">-</span> rbeta<span class="sign">(</span>1<span class="sign">,</span> alpha<span class="sign">,</span> beta<span class="sign">)</span>
<span class="line_number">2713 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>nan<span class="sign">(</span>cand<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2714 </span>        curve<span class="sign">$</span>weight<span class="sign">.</span>accept <span class="sign">&lt;</span><span class="sign">-</span> FALSE<span class="sign">;</span>
<span class="line_number">2715 </span>        <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">2716 </span>    <span class="sign">}</span>
<span class="line_number">2717 </span>    <span class="comment"># compute transition ratio</span>
<span class="line_number">2718 </span>    alphac <span class="sign">&lt;</span><span class="sign">-</span> cand <span class="sign">*</span> <span class="sign">(</span>cand <span class="sign">*</span> <span class="sign">(</span>1 <span class="sign">-</span> cand<span class="sign">)</span> <span class="sign">/</span> v <span class="sign">-</span> 1<span class="sign">)</span>
<span class="line_number">2719 </span>    betac <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>1 <span class="sign">-</span> cand<span class="sign">)</span> <span class="sign">/</span> cand <span class="sign">*</span> alphac
<span class="line_number">2720 </span>    baselik <span class="sign">&lt;</span><span class="sign">-</span> fun<span class="sign">(</span>w<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2721 </span>    candlik <span class="sign">&lt;</span><span class="sign">-</span> fun<span class="sign">(</span>cand<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">2722 </span>    puc <span class="sign">&lt;</span><span class="sign">-</span> suppressWarnings<span class="sign">(</span>dbeta<span class="sign">(</span>cand<span class="sign">,</span> alpha<span class="sign">,</span> beta<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2723 </span>    pcu <span class="sign">&lt;</span><span class="sign">-</span> suppressWarnings<span class="sign">(</span>dbeta<span class="sign">(</span>w<span class="sign">,</span> alphac<span class="sign">,</span> betac<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2724 </span>    acc <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo141">acceptreject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> pcu <span class="sign">/</span> puc<span class="sign">)</span>
<span class="line_number">2725 </span>    <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2726 </span>        curve<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> cand
<span class="line_number">2727 </span>        curve <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo111">weightcurve</a><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">2728 </span>    <span class="sign">}</span>
<span class="line_number">2729 </span>    curve<span class="sign">$</span>weight<span class="sign">.</span>accept <span class="sign">&lt;</span><span class="sign">-</span> acc
<span class="line_number">2730 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">2731 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2fupdatepostvar2ecoef"></a>
<a name="robo151"></a><h2>MetropolisHastings/updatepostvar.coef [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>updatepostvar.coef</strong> --- update prior variance for regression coefficients
</pre>
<p class="item_name">FUNCTION</p>
<p>    Updates prior variance of regression coefficients using inverse-gamma prior and
    given hyperparameters.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2986 </span><strong>updatepostvar.coef</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    regression     an <a href="#robo28">RRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    regression    updated regression
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2989 </span><span class="sign">{</span>
<span class="line_number">2990 </span>    regression<span class="sign">$</span>priorvar <span class="sign">&lt;</span><span class="sign">-</span> <a href="../src/mainloop_c.html#robo92">rinvgamma</a><span class="sign">(</span>1<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>regression<span class="sign">$</span>coefficients<span class="sign">)</span> <span class="sign">/</span> 2 <span class="sign">+</span>
<span class="line_number">2991 </span>        regression<span class="sign">$</span>hyper<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> scale <span class="sign">=</span> <span class="keyword">sum</span><span class="sign">(</span>regression<span class="sign">$</span>coefficients<span class="sign">^</span>2<span class="sign">)</span> <span class="sign">/</span> 2 <span class="sign">+</span> regression<span class="sign">$</span>hyper<span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2992 </span>    <span class="keyword">return</span><span class="sign">(</span>regression<span class="sign">)</span>
<span class="line_number">2993 </span><span class="sign">}</span>
</pre>

<hr />
<a name="MetropolisHastings2fupdatepostvar2ecurve"></a>
<a name="robo152"></a><h2>MetropolisHastings/updatepostvar.curve [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo17">MetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>updatepostvar.curve</strong> --- update the prior variance for a curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    Updates the prior variance for the spline parameters of either the hazard or
    frailty curve, with an inverse-gamma prior and given hyperparameters.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2962 </span><strong>updatepostvar.curve</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      the updated curve
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2965 </span><span class="sign">{</span>
<span class="line_number">2966 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> curve<span class="sign">$</span>spline<span class="sign">.</span>priorvar <span class="sign">&lt;</span><span class="sign">-</span> <a href="../src/mainloop_c.html#robo92">rinvgamma</a><span class="sign">(</span>1<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">)</span> <span class="sign">/</span>
<span class="line_number">2967 </span>        2 <span class="sign">+</span> curve<span class="sign">$</span>spline<span class="sign">.</span>hyper<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> scale <span class="sign">=</span> curve<span class="sign">$</span>spline<span class="sign">.</span>penaltyfactor <span class="sign">*</span> <a href="#robo140">smoothpen</a><span class="sign">(</span>curve<span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">2968 </span>        curve<span class="sign">$</span>spline<span class="sign">.</span>priorvar <span class="sign">+</span> curve<span class="sign">$</span>spline<span class="sign">.</span>hyper<span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2969 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span><a href="#robo154">haspar</a><span class="sign">)</span> curve<span class="sign">$</span>param<span class="sign">.</span>priorvar <span class="sign">&lt;</span><span class="sign">-</span> <a href="../src/mainloop_c.html#robo92">rinvgamma</a><span class="sign">(</span>1<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>curve<span class="sign">$</span>param<span class="sign">.</span>par<span class="sign">)</span> <span class="sign">/</span>
<span class="line_number">2970 </span>        2 <span class="sign">+</span> curve<span class="sign">$</span>param<span class="sign">.</span>hyper<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> scale <span class="sign">=</span> <span class="keyword">sum</span><span class="sign">(</span>curve<span class="sign">$</span>param<span class="sign">.</span>par<span class="sign">^</span>2<span class="sign">)</span> <span class="sign">/</span> 2 <span class="sign">+</span> curve<span class="sign">$</span>param<span class="sign">.</span>hyper<span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2971 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">2972 </span><span class="sign">}</span>
</pre>

<hr />
<a name="miscUtils2faccrate2epredict2elm"></a>
<a name="robo153"></a><h2>miscUtils/accrate.predict.lm [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo18">miscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>accrate.predict.lm</strong> --- predicted acceptance rate distance from 25%
</pre>
<p class="item_name">FUNCTION</p>
<p>   This function is used to automatically select the tuning parameters.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1010 </span><strong>accrate.predict.lm</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> m<span class="sign">)</span> <span class="sign">(</span>predict<span class="sign">(</span>m<span class="sign">,</span> data<span class="sign">.</span>frame<span class="sign">(</span>x <span class="sign">=</span> x<span class="sign">)</span><span class="sign">)</span><span class="sign">-</span><span class="sign">.</span>25<span class="sign">)</span><span class="sign">^</span>2
</pre>
<p class="item_name">INPUTS</p>
<pre>    m      a model returned by lm()
    x      a tuning parameter
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    the predicted squared difference between the model m evaluated at x
    and 25%
</pre>

<hr />
<a name="miscUtils2fhaspar"></a>
<a name="robo154"></a><h2>miscUtils/haspar [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo18">miscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>haspar</strong> --- check if a curve has a parametric component
</pre>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">719 </span><strong>haspar</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"parametric"</span> <span class="sign">|</span> curve<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> object
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    boolean indicating whether the curve has a parametric component
</pre>

<hr />
<a name="miscUtils2fhasspline"></a>
<a name="robo155"></a><h2>miscUtils/hasspline [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo18">miscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>hasspline</strong> --- check if a curve has a spline component
</pre>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">708 </span><strong>hasspline</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"spline"</span> <span class="sign">|</span> curve<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> object
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    boolean indicating whether the curve has a spline component
</pre>

<hr />
<a name="miscUtils2fmakeoutputcurve"></a>
<a name="robo156"></a><h2>miscUtils/makeoutputcurve [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo18">miscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makeoutputcurve</strong> --- construct the curve to be returned in the output
</pre>
<p class="item_name">FUNCTION</p>
<p>    The <a href="#robo26">RCurve</a> construct contains many values that change with each iteration.
    This function cleans the Rcurve and retains only a subset for output.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1047 </span><strong>makeoutputcurve</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a>, either hazard or frailty
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    outcurve   a structure containing only a subset of the components of the input
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1050 </span><span class="sign">{</span>
<span class="line_number">1051 </span>    outcurve <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>name <span class="sign">=</span> curve<span class="sign">$</span>name<span class="sign">,</span>
<span class="line_number">1052 </span>                    type <span class="sign">=</span> curve<span class="sign">$</span>type<span class="sign">,</span>
<span class="line_number">1053 </span>                    spline<span class="sign">.</span>nknots <span class="sign">=</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">,</span>
<span class="line_number">1054 </span>                    spline<span class="sign">.</span>knotspacing <span class="sign">=</span> curve<span class="sign">$</span>spline<span class="sign">.</span>knotspacing<span class="sign">,</span>
<span class="line_number">1055 </span>                    spline<span class="sign">.</span>ord <span class="sign">=</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">,</span>
<span class="line_number">1056 </span>                    spline<span class="sign">.</span>norm <span class="sign">=</span> curve<span class="sign">$</span>spline<span class="sign">.</span>norm<span class="sign">,</span>
<span class="line_number">1057 </span>                    spline<span class="sign">.</span>penalty <span class="sign">=</span> curve<span class="sign">$</span>spline<span class="sign">.</span>penalty<span class="sign">,</span>
<span class="line_number">1058 </span>                    param<span class="sign">.</span>dist <span class="sign">=</span> curve<span class="sign">$</span>param<span class="sign">.</span>dist
<span class="line_number">1059 </span>                <span class="sign">)</span>
<span class="line_number">1060 </span>    <span class="keyword">return</span><span class="sign">(</span>outcurve<span class="sign">)</span>   
<span class="line_number">1061 </span><span class="sign">}</span>
</pre>

<hr />
<a name="miscUtils2fmdiag"></a>
<a name="robo157"></a><h2>miscUtils/mdiag [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo18">miscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mdiag</strong>  --- replacement for diag()
</pre>
<p class="item_name">FUNCTION</p>
<p>    works like diag(), except for length 1 vector inputs, in which case it
    returns a 1x1 matrix
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">734 </span><strong>mdiag</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">)</span> 
</pre>
<p class="item_name">INPUTS</p>
<pre>    x      a vector or matrix
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    if x is a vector, a matrix with x as its diagonal
    if x is a matrix, a vector containing its diagonal
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">737 </span><span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>vector<span class="sign">(</span>x<span class="sign">)</span> <span class="sign">&amp;</span><span class="sign">&amp;</span> <span class="keyword">length</span><span class="sign">(</span>x<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">&amp;</span><span class="sign">&amp;</span> x <span class="sign">&lt;</span> 1<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>matrix<span class="sign">(</span>x<span class="sign">,</span> 1<span class="sign">,</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="keyword">else</span> <span class="keyword">return</span><span class="sign">(</span>diag<span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span>
</pre>

<hr />
<a name="miscUtils2frepairfrailtypar"></a>
<a name="robo158"></a><h2>miscUtils/repairfrailtypar [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo18">miscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>repairfrailtypar</strong> --- fix frailty parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>   For identifiability, it is necessary to fix one of the frailty spline
   parameters at 0, and not include it in optimization and estimation
   routines. This function adds a 0 to a vector at a specified index.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">753 </span><strong>repairfrailtypar</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>par<span class="sign">,</span> ind<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>   par     a vector
   ind     integer index
</pre>
<p class="item_name">OUTPUTS</p>
<pre>   The input vector par, with a 0 inserted at its ind entry
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">756 </span><span class="sign">{</span>
<span class="line_number">757 </span>    <span class="keyword">if</span><span class="sign">(</span>ind <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>c<span class="sign">(</span>0<span class="sign">,</span> par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">758 </span>    <span class="keyword">if</span><span class="sign">(</span>ind <span class="sign">=</span><span class="sign">=</span> <span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>c<span class="sign">(</span>par<span class="sign">,</span> 0<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">759 </span>    <span class="keyword">return</span><span class="sign">(</span>c<span class="sign">(</span>par<span class="sign">[</span>1<span class="sign">:</span><span class="sign">(</span>ind <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> 0<span class="sign">,</span> par<span class="sign">[</span>ind<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>par<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">760 </span><span class="sign">}</span>
</pre>

<hr />
<a name="miscUtils2fsubmean"></a>
<a name="robo159"></a><h2>miscUtils/submean [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo18">miscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>submean</strong> --- compute the mean of a subset of a vector
</pre>
<p class="item_name">FUNCTION</p>
<p>    For a vector or matrix x and a subset, compute the mean of the subset of values
    of x.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1026 </span><strong>submean</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> subset<span class="sign">,</span> f <span class="sign">=</span> mean<span class="sign">)</span> 
</pre>
<p class="item_name">INPUTS</p>
<pre>    x          a vector or matrix
    subset     a subset, either as a range or as logical
    f          a function to be applied (mean by default)
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    The function f applied to a subset of x
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1029 </span><span class="sign">{</span>
<span class="line_number">1030 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>NULL<span class="sign">)</span>
<span class="line_number">1031 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span><span class="keyword">apply</span><span class="sign">(</span>x<span class="sign">[</span>subset<span class="sign">,</span> <span class="sign">,</span>drop <span class="sign">=</span> F<span class="sign">]</span><span class="sign">,</span> 2<span class="sign">,</span> f<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1032 </span>    <span class="keyword">else</span> <span class="keyword">return</span><span class="sign">(</span>f<span class="sign">(</span>x<span class="sign">[</span>subset<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1033 </span><span class="sign">}</span>
</pre>

<hr />
<a name="S3Methods2fplot2esplinesurv"></a>
<a name="robo160"></a><h2>S3Methods/plot.splinesurv [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo5">S3Methods</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>plot.splinesurv</strong> --- plot method for <a href="#robo166">splinesurv</a> objects
</pre>
<p class="item_name">FUNCTION</p>
<p>    Plots either a hazard, frailty, survival curve estimate, or coefficient density.
    There are a large number of options and settings, consult the package documentation
    for details on the options.
</p>

<p>    This function mainly works by calling the predict function to construct the
    curve fits. Most of the rest is just handling inputs and keeping track of the
    various parameters needed by different plotting routines.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3625 </span><strong>plot.splinesurv</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> <span class="keyword">which</span> <span class="sign">=</span> c<span class="sign">(</span><span class="quote">"hazard"</span><span class="sign">,</span> <span class="quote">"survival"</span><span class="sign">,</span> <span class="quote">"frailty"</span><span class="sign">,</span> <span class="quote">"coef"</span><span class="sign">,</span> <span class="quote">"all"</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3626 </span>    newdata <span class="sign">=</span> NULL<span class="sign">,</span> iter <span class="sign">=</span> NULL<span class="sign">,</span> fn <span class="sign">=</span> mean<span class="sign">,</span> plotknots <span class="sign">=</span> TRUE<span class="sign">,</span> npoints <span class="sign">=</span> 100<span class="sign">,</span> npost <span class="sign">=</span> 100<span class="sign">,</span>
<span class="line_number">3627 </span>    alpha<span class="sign">=</span><span class="sign">.</span>05<span class="sign">,</span> legend <span class="sign">=</span> NULL<span class="sign">,</span> lty <span class="sign">=</span> 1<span class="sign">,</span> col <span class="sign">=</span> 2<span class="sign">,</span> lwd <span class="sign">=</span> 2<span class="sign">,</span> lty<span class="sign">.</span>knots <span class="sign">=</span> 1<span class="sign">,</span> col<span class="sign">.</span>knots <span class="sign">=</span> 8<span class="sign">,</span>
<span class="line_number">3628 </span>    lwd<span class="sign">.</span>knots <span class="sign">=</span> 1<span class="sign">,</span> xlab <span class="sign">=</span> NULL<span class="sign">,</span> ylab <span class="sign">=</span> NULL<span class="sign">,</span> main <span class="sign">=</span> NULL<span class="sign">,</span> xlim <span class="sign">=</span> NULL<span class="sign">,</span> ylim <span class="sign">=</span> NULL<span class="sign">,</span>
<span class="line_number">3629 </span>    tk <span class="sign">=</span> FALSE<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3632 </span><span class="sign">{</span>
<span class="line_number">3633 </span>    
<span class="line_number">3634 </span>    <span class="keyword">if</span><span class="sign">(</span>tk<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3635 </span>        <span class="comment"># call the routine that uses tcltk via the tkrplot to plot an interactive</span>
<span class="line_number">3636 </span>        <span class="comment"># curve viewer</span>
<span class="line_number">3637 </span>        <a href="#robo169">splinesurvtkplot</a><span class="sign">(</span>x<span class="sign">,</span> newdata <span class="sign">=</span> newdata<span class="sign">,</span> plotknots <span class="sign">=</span> plotknots<span class="sign">,</span> npoints <span class="sign">=</span> npoints<span class="sign">,</span>
<span class="line_number">3638 </span>            legend <span class="sign">=</span> legend<span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">,</span> lwd <span class="sign">=</span> lwd<span class="sign">,</span> lty<span class="sign">.</span>knots <span class="sign">=</span> lty<span class="sign">.</span>knots<span class="sign">,</span>
<span class="line_number">3639 </span>            col<span class="sign">.</span>knots <span class="sign">=</span> col<span class="sign">.</span>knots<span class="sign">,</span> lwd<span class="sign">.</span>knots <span class="sign">=</span> lwd<span class="sign">.</span>knots<span class="sign">,</span> xlab <span class="sign">=</span> xlab<span class="sign">,</span> ylab <span class="sign">=</span> ylab<span class="sign">,</span>
<span class="line_number">3640 </span>            main <span class="sign">=</span> main<span class="sign">,</span> xlim <span class="sign">=</span> xlim<span class="sign">,</span> ylim <span class="sign">=</span> ylim<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3641 </span>        <span class="keyword">return</span><span class="sign">(</span>invisible<span class="sign">(</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">3642 </span>    <span class="sign">}</span>
<span class="line_number">3643 </span>    <span class="comment"># save old parameters</span>
<span class="line_number">3644 </span>    oldask <span class="sign">&lt;</span><span class="sign">-</span> par<span class="sign">(</span><span class="quote">"ask"</span><span class="sign">)</span>
<span class="line_number">3645 </span>    <span class="keyword">which</span> <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span><span class="keyword">which</span><span class="sign">)</span>
<span class="line_number">3646 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"all"</span><span class="sign">)</span> par<span class="sign">(</span>ask <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">3647 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>iter<span class="sign">)</span> <span class="sign">&amp;</span><span class="sign">&amp;</span> iter <span class="sign">&lt;</span><span class="sign">=</span> 0<span class="sign">)</span> iter <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3648 </span>    <span class="comment"># Hazard and survival curve plotting</span>
<span class="line_number">3649 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span> <span class="sign">|</span> <span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"survival"</span> <span class="sign">|</span> <span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"all"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3650 </span>        type <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"all"</span><span class="sign">)</span> <span class="quote">"hazard"</span> <span class="keyword">else</span> <span class="keyword">which</span>
<span class="line_number">3651 </span>        <span class="comment"># get the set of knots to use. If an iteration is given, use knots for</span>
<span class="line_number">3652 </span>        <span class="comment"># that iteration, otherwise use only boundary knots</span>
<span class="line_number">3653 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>x<span class="sign">$</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3654 </span>            knots <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3655 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">3656 </span>            <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>iter<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3657 </span>                knots <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>1<span class="sign">,</span> <span class="sign">]</span><span class="sign">;</span>knots <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span>knots<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">]</span>
<span class="line_number">3658 </span>                knots <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>min<span class="sign">(</span>knots<span class="sign">)</span><span class="sign">,</span> max<span class="sign">(</span>knots<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3659 </span>            <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> 
<span class="line_number">3660 </span>                knots <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span><span class="sign">;</span>knots <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span>knots<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">]</span>
<span class="line_number">3661 </span>            <span class="sign">}</span>
<span class="line_number">3662 </span>        <span class="sign">}</span>
<span class="line_number">3663 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>knots<span class="sign">)</span><span class="sign">)</span> knots <span class="sign">&lt;</span><span class="sign">-</span> range<span class="sign">(</span>x<span class="sign">$</span>data<span class="sign">$</span>time<span class="sign">)</span>
<span class="line_number">3664 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>xlim<span class="sign">)</span><span class="sign">)</span> xlim1 <span class="sign">=</span> range<span class="sign">(</span>x<span class="sign">$</span>data<span class="sign">$</span>time<span class="sign">)</span> <span class="keyword">else</span> xlim1 <span class="sign">&lt;</span><span class="sign">-</span> xlim
<span class="line_number">3665 </span>        <span class="comment"># set the points at which the curve should be predicted</span>
<span class="line_number">3666 </span>        times <span class="sign">=</span> seq<span class="sign">(</span>from <span class="sign">=</span> max<span class="sign">(</span>xlim1<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> min<span class="sign">(</span>knots<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> to <span class="sign">=</span> min<span class="sign">(</span>xlim1<span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> max<span class="sign">(</span>knots<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3667 </span>            <span class="keyword">length</span> <span class="sign">=</span> npoints<span class="sign">)</span>
<span class="line_number">3668 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>xlab<span class="sign">)</span><span class="sign">)</span> xlab1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"Time"</span> <span class="keyword">else</span> xlab1 <span class="sign">&lt;</span><span class="sign">-</span> xlab
<span class="line_number">3669 </span>        <span class="comment"># set axis labels</span>
<span class="line_number">3670 </span>        <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3671 </span>            <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>ylab<span class="sign">)</span><span class="sign">)</span> ylab1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"Hazard"</span> <span class="keyword">else</span> ylab1 <span class="sign">&lt;</span><span class="sign">-</span> ylab
<span class="line_number">3672 </span>            <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>main<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3673 </span>                <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">)</span> main1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"Baseline hazard"</span> 
<span class="line_number">3674 </span>                <span class="keyword">else</span> main1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"Hazard"</span>
<span class="line_number">3675 </span>            <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> main1 <span class="sign">&lt;</span><span class="sign">-</span> main <span class="sign">}</span>
<span class="line_number">3676 </span>        <span class="sign">}</span>
<span class="line_number">3677 </span>        <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"survival"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3678 </span>            <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>ylab<span class="sign">)</span><span class="sign">)</span> ylab1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"Survival"</span> <span class="keyword">else</span> ylab1 <span class="sign">&lt;</span><span class="sign">-</span> ylab
<span class="line_number">3679 </span>            <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>main<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3680 </span>                <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">)</span> main1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"Baseline survival"</span> 
<span class="line_number">3681 </span>                <span class="keyword">else</span> main1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"Survival"</span>
<span class="line_number">3682 </span>            <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> main1 <span class="sign">&lt;</span><span class="sign">-</span> main <span class="sign">}</span>
<span class="line_number">3683 </span>        <span class="sign">}</span>
<span class="line_number">3684 </span>        <span class="comment"># a single curve is plotted if either no newdata is given, or newdata has only one row</span>
<span class="line_number">3685 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>newdata<span class="sign">)</span> <span class="sign">|</span> <span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>newdata<span class="sign">)</span> <span class="sign">&amp;</span><span class="sign">&amp;</span> <span class="keyword">dim</span><span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span> <span class="sign">&lt;</span> 2<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3686 </span>            <span class="comment"># estimate the hazard curve</span>
<span class="line_number">3687 </span>            haz <span class="sign">&lt;</span><span class="sign">-</span> predict<span class="sign">(</span>x<span class="sign">,</span> type <span class="sign">=</span> type<span class="sign">,</span> x <span class="sign">=</span> times<span class="sign">,</span> newdata <span class="sign">=</span> newdata<span class="sign">,</span> iter <span class="sign">=</span> iter<span class="sign">,</span> fn <span class="sign">=</span> fn<span class="sign">,</span>
<span class="line_number">3688 </span>                npost <span class="sign">=</span> npost<span class="sign">,</span> alpha <span class="sign">=</span> alpha<span class="sign">)</span>
<span class="line_number">3689 </span>            plot<span class="sign">(</span>haz<span class="sign">[</span><span class="sign">,</span> 1<span class="sign">:</span>2<span class="sign">]</span><span class="sign">,</span> type <span class="sign">=</span> <span class="quote">"l"</span><span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">,</span> lwd <span class="sign">=</span> lwd<span class="sign">,</span> main <span class="sign">=</span> main1<span class="sign">,</span>
<span class="line_number">3690 </span>                xlab <span class="sign">=</span> xlab1<span class="sign">,</span> ylab <span class="sign">=</span> ylab1<span class="sign">,</span> xlim <span class="sign">=</span> xlim1<span class="sign">,</span> ylim <span class="sign">=</span> ylim<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3691 </span>            <span class="comment"># plot knots as vertical lines</span>
<span class="line_number">3692 </span>            <span class="keyword">if</span><span class="sign">(</span>plotknots<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3693 </span>                abline<span class="sign">(</span>v <span class="sign">=</span> knots<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">.</span>knots<span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">.</span>knots<span class="sign">,</span> lwd <span class="sign">=</span> lwd<span class="sign">.</span>knots<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3694 </span>                lines<span class="sign">(</span>haz<span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">,</span> lwd <span class="sign">=</span> lwd<span class="sign">)</span>
<span class="line_number">3695 </span>            <span class="sign">}</span>
<span class="line_number">3696 </span>            <span class="comment"># plot confidence intervals</span>
<span class="line_number">3697 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>alpha<span class="sign">)</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>iter<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3698 </span>                lines<span class="sign">(</span>haz<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span>1<span class="sign">,</span> 3<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> lty <span class="sign">=</span> 2<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">)</span>
<span class="line_number">3699 </span>                lines<span class="sign">(</span>haz<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span>1<span class="sign">,</span> 4<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> lty <span class="sign">=</span> 2<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">)</span>
<span class="line_number">3700 </span>            <span class="sign">}</span>
<span class="line_number">3701 </span>        <span class="comment"># if newdata has more than one row, multiple lines have to be predicted and plotted</span>
<span class="line_number">3702 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">3703 </span>            haz <span class="sign">&lt;</span><span class="sign">-</span> times
<span class="line_number">3704 </span>            <span class="comment"># predict a curve for each row of newdata</span>
<span class="line_number">3705 </span>            <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span> haz <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>haz<span class="sign">,</span> predict<span class="sign">(</span>x<span class="sign">,</span> type <span class="sign">=</span> type<span class="sign">,</span> x <span class="sign">=</span> times<span class="sign">,</span>
<span class="line_number">3706 </span>                newdata <span class="sign">=</span> newdata<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">,</span>drop <span class="sign">=</span> FALSE<span class="sign">]</span><span class="sign">,</span> iter <span class="sign">=</span> iter<span class="sign">,</span> fn <span class="sign">=</span> fn<span class="sign">,</span> npost <span class="sign">=</span> npost<span class="sign">)</span><span class="sign">[</span><span class="sign">,</span> 2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">3707 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>col<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">&amp;</span> <span class="keyword">length</span><span class="sign">(</span>lty<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">&amp;</span> <span class="keyword">length</span><span class="sign">(</span>lwd<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> col <span class="sign">=</span> 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">3708 </span>            <span class="comment"># plot all the new lines</span>
<span class="line_number">3709 </span>            matplot<span class="sign">(</span>haz<span class="sign">[</span><span class="sign">,</span> 1<span class="sign">]</span><span class="sign">,</span> haz<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>1<span class="sign">]</span><span class="sign">,</span> type <span class="sign">=</span> <span class="quote">"l"</span><span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">,</span> lwd <span class="sign">=</span> lwd<span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">,</span>
<span class="line_number">3710 </span>                main <span class="sign">=</span> main1<span class="sign">,</span> xlab <span class="sign">=</span> xlab1<span class="sign">,</span> ylab <span class="sign">=</span> ylab1<span class="sign">,</span> xlim <span class="sign">=</span> xlim1<span class="sign">,</span> ylim <span class="sign">=</span> ylim<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3711 </span>            <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>legend<span class="sign">)</span><span class="sign">)</span> legend <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rownames</span><span class="sign">(</span>newdata<span class="sign">)</span>
<span class="line_number">3712 </span>            <span class="comment"># plot knots as vertical lines</span>
<span class="line_number">3713 </span>            <span class="keyword">if</span><span class="sign">(</span>plotknots<span class="sign">)</span> abline<span class="sign">(</span>v <span class="sign">=</span> knots<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">.</span>knots<span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">.</span>knots<span class="sign">,</span>
<span class="line_number">3714 </span>                lwd <span class="sign">=</span> lwd<span class="sign">.</span>knots<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3715 </span>            <span class="comment"># add a legend</span>
<span class="line_number">3716 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>na<span class="sign">(</span>legend<span class="sign">)</span><span class="sign">)</span> legend<span class="sign">(</span><span class="quote">"topright"</span><span class="sign">,</span> legend <span class="sign">=</span> legend<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">,</span>
<span class="line_number">3717 </span>                lwd <span class="sign">=</span> lwd<span class="sign">)</span>
<span class="line_number">3718 </span>        <span class="sign">}</span>
<span class="line_number">3719 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"all"</span><span class="sign">)</span> plot<span class="sign">(</span>x<span class="sign">,</span> <span class="keyword">which</span> <span class="sign">=</span> <span class="quote">"survival"</span><span class="sign">,</span> newdata <span class="sign">=</span> newdata<span class="sign">,</span> iter <span class="sign">=</span> iter<span class="sign">,</span>
<span class="line_number">3720 </span>            plotknots <span class="sign">=</span> plotknots<span class="sign">,</span> npoints <span class="sign">=</span> npoints<span class="sign">,</span> npost <span class="sign">=</span> npost<span class="sign">,</span> alpha <span class="sign">=</span> alpha<span class="sign">,</span>
<span class="line_number">3721 </span>            legend <span class="sign">=</span> legend<span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">,</span> lwd <span class="sign">=</span> lwd<span class="sign">,</span> lty<span class="sign">.</span>knots <span class="sign">=</span> lty<span class="sign">.</span>knots<span class="sign">,</span>
<span class="line_number">3722 </span>            col<span class="sign">.</span>knots <span class="sign">=</span> col<span class="sign">.</span>knots<span class="sign">,</span> xlab <span class="sign">=</span> xlab<span class="sign">,</span> ylab <span class="sign">=</span> ylab<span class="sign">,</span> main <span class="sign">=</span> main<span class="sign">,</span> xlim <span class="sign">=</span> xlim<span class="sign">,</span>
<span class="line_number">3723 </span>            ylim <span class="sign">=</span> ylim<span class="sign">,</span> tk <span class="sign">=</span> tk<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3724 </span>    <span class="sign">}</span>
<span class="line_number">3725 </span>    <span class="comment"># Frailty density plotting</span>
<span class="line_number">3726 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span> <span class="sign">|</span> <span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"all"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3727 </span>        knots <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knots
<span class="line_number">3728 </span>        <span class="comment"># construct knots to use</span>
<span class="line_number">3729 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>iter<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span> 
<span class="line_number">3730 </span>                knots <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>1<span class="sign">,</span> <span class="sign">]</span><span class="sign">;</span>knots <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span>knots<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">]</span>
<span class="line_number">3731 </span>                knots <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>min<span class="sign">(</span>knots<span class="sign">)</span><span class="sign">,</span> max<span class="sign">(</span>knots<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3732 </span>        <span class="sign">}</span> <span class="keyword">else</span><span class="sign">{</span> 
<span class="line_number">3733 </span>            knots <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span><span class="sign">;</span>knots <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span>knots<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">]</span>
<span class="line_number">3734 </span>        <span class="sign">}</span>
<span class="line_number">3735 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>knots<span class="sign">)</span><span class="sign">)</span> knots <span class="sign">&lt;</span><span class="sign">-</span> range<span class="sign">(</span>x<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">)</span>
<span class="line_number">3736 </span>        <span class="comment"># limits on the graph</span>
<span class="line_number">3737 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>xlim<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3738 </span>               <span class="keyword">if</span><span class="sign">(</span><a href="#robo155">hasspline</a><span class="sign">(</span>x<span class="sign">$</span>frailty<span class="sign">)</span><span class="sign">)</span> xlim1 <span class="sign">=</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span> 
<span class="line_number">3739 </span>               <span class="keyword">else</span> xlim1 <span class="sign">&lt;</span><span class="sign">-</span> range<span class="sign">(</span>x<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">)</span>
<span class="line_number">3740 </span>       <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>xlim1 <span class="sign">&lt;</span><span class="sign">-</span> xlim<span class="sign">}</span>
<span class="line_number">3741 </span>        <span class="comment"># construct the set of values at which the curve shoult be estimated</span>
<span class="line_number">3742 </span>        Ui <span class="sign">=</span> seq<span class="sign">(</span>from <span class="sign">=</span> max<span class="sign">(</span>xlim1<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> min<span class="sign">(</span>knots<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> to <span class="sign">=</span> min<span class="sign">(</span>xlim1<span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> max<span class="sign">(</span>knots<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3743 </span>            <span class="keyword">length</span> <span class="sign">=</span> npoints<span class="sign">)</span>
<span class="line_number">3744 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>xlab<span class="sign">)</span><span class="sign">)</span> xlab1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"x"</span> <span class="keyword">else</span> xlab1 <span class="sign">&lt;</span><span class="sign">-</span> xlab
<span class="line_number">3745 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>ylab<span class="sign">)</span><span class="sign">)</span> ylab1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"Density"</span> <span class="keyword">else</span> ylab1 <span class="sign">&lt;</span><span class="sign">-</span> ylab
<span class="line_number">3746 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>main<span class="sign">)</span><span class="sign">)</span> main1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"Frailty density"</span> <span class="keyword">else</span> main1 <span class="sign">&lt;</span><span class="sign">-</span> main
<span class="line_number">3747 </span>        <span class="comment"># comput the curve</span>
<span class="line_number">3748 </span>        dens <span class="sign">&lt;</span><span class="sign">-</span> predict<span class="sign">(</span>x<span class="sign">,</span> type <span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">,</span> x <span class="sign">=</span> Ui<span class="sign">,</span> iter <span class="sign">=</span> iter<span class="sign">,</span> fn <span class="sign">=</span> fn<span class="sign">,</span> npost <span class="sign">=</span> npost<span class="sign">,</span>
<span class="line_number">3749 </span>            alpha <span class="sign">=</span> alpha<span class="sign">)</span>
<span class="line_number">3750 </span>        <span class="comment"># plot the density curve</span>
<span class="line_number">3751 </span>        plot<span class="sign">(</span>dens<span class="sign">[</span><span class="sign">,</span> 1<span class="sign">:</span>2<span class="sign">]</span><span class="sign">,</span> type <span class="sign">=</span> <span class="quote">"l"</span><span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">,</span> lwd <span class="sign">=</span> lwd<span class="sign">,</span> main <span class="sign">=</span> main1<span class="sign">,</span>
<span class="line_number">3752 </span>            xlab <span class="sign">=</span> xlab1<span class="sign">,</span> ylab <span class="sign">=</span> ylab1<span class="sign">,</span> xlim <span class="sign">=</span> xlim1<span class="sign">,</span> ylim <span class="sign">=</span> ylim<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3753 </span>        <span class="comment"># plot knots as vertical lines</span>
<span class="line_number">3754 </span>        <span class="keyword">if</span><span class="sign">(</span>plotknots<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3755 </span>            abline<span class="sign">(</span>v <span class="sign">=</span> knots<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">.</span>knots<span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">.</span>knots<span class="sign">,</span> lwd <span class="sign">=</span> lwd<span class="sign">.</span>knots<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3756 </span>            lines<span class="sign">(</span>dens<span class="sign">,</span> type <span class="sign">=</span> <span class="quote">"l"</span><span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">,</span> lwd <span class="sign">=</span> lwd<span class="sign">)</span>
<span class="line_number">3757 </span>        <span class="sign">}</span>
<span class="line_number">3758 </span>        <span class="comment"># plot CIs</span>
<span class="line_number">3759 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>alpha<span class="sign">)</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>iter<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3760 </span>            lines<span class="sign">(</span>dens<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span>1<span class="sign">,</span> 3<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> lty <span class="sign">=</span> 2<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">)</span>
<span class="line_number">3761 </span>            lines<span class="sign">(</span>dens<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span>1<span class="sign">,</span> 4<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> lty <span class="sign">=</span> 2<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">)</span>
<span class="line_number">3762 </span>        <span class="sign">}</span>
<span class="line_number">3763 </span>    <span class="sign">}</span>
<span class="line_number">3764 </span>    <span class="comment"># plot coefficient density</span>
<span class="line_number">3765 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"coef"</span> <span class="sign">|</span> <span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="quote">"all"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3766 </span>        burnin <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>control<span class="sign">$</span>burnin
<span class="line_number">3767 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>burnin<span class="sign">)</span><span class="sign">)</span> burnin <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span><span class="keyword">call</span><span class="sign">$</span>control<span class="sign">$</span>burnin
<span class="line_number">3768 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>burnin<span class="sign">)</span><span class="sign">)</span> burnin <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>x<span class="sign">$</span>history<span class="sign">$</span>coefficients<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">3769 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>xlab<span class="sign">)</span><span class="sign">)</span> xlab1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"x"</span> <span class="keyword">else</span> xlab1 <span class="sign">&lt;</span><span class="sign">-</span> xlab
<span class="line_number">3770 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>ylab<span class="sign">)</span><span class="sign">)</span> ylab1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"Posterior density"</span> <span class="keyword">else</span> ylab1 <span class="sign">&lt;</span><span class="sign">-</span> ylab
<span class="line_number">3771 </span>        coefs <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>history<span class="sign">$</span>coefficients
<span class="line_number">3772 </span>        coefnames <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">colnames</span><span class="sign">(</span>coefs<span class="sign">)</span>
<span class="line_number">3773 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>coefnames<span class="sign">)</span> <span class="sign">&gt;</span> 1<span class="sign">)</span> par<span class="sign">(</span>ask <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">3774 </span>        <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>coefs<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3775 </span>            <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>main<span class="sign">)</span><span class="sign">)</span> main1 <span class="sign">&lt;</span><span class="sign">-</span> paste<span class="sign">(</span><span class="quote">"Coefficient of"</span><span class="sign">,</span> coefnames<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="keyword">else</span> main1 <span class="sign">&lt;</span><span class="sign">-</span> main
<span class="line_number">3776 </span>            betai <span class="sign">&lt;</span><span class="sign">-</span> coefs<span class="sign">[</span>burnin<span class="sign">:</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>coefs<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span> i<span class="sign">]</span>
<span class="line_number">3777 </span>            plot<span class="sign">(</span>density<span class="sign">(</span>betai<span class="sign">)</span><span class="sign">,</span> lty <span class="sign">=</span> lty<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">,</span> lwd <span class="sign">=</span> lwd<span class="sign">,</span> main <span class="sign">=</span> main1<span class="sign">,</span> xlab <span class="sign">=</span> xlab1<span class="sign">,</span> ylab <span class="sign">=</span> ylab1<span class="sign">,</span> xlim <span class="sign">=</span> xlim<span class="sign">,</span> ylim <span class="sign">=</span> ylim<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3778 </span>        <span class="sign">}</span>     
<span class="line_number">3779 </span>    <span class="sign">}</span>
<span class="line_number">3780 </span>    par<span class="sign">(</span>ask <span class="sign">=</span> oldask<span class="sign">)</span>
<span class="line_number">3781 </span><span class="sign">}</span>
</pre>

<hr />
<a name="S3Methods2fpost2efvar"></a>
<a name="robo161"></a><h2>S3Methods/post.fvar [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo5">S3Methods</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>post.fvar</strong> --- compute posterior frailty variance
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the posterior mean frailty variance and its quantiles by weighing posterior
    spline and parametric component frailty variances together. The former is computed
    at each iteration as the variance of the density defined by the current set of knots
    and parameters for the frailty spline.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3492 </span><strong>post.fvar</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> quantiles <span class="sign">=</span> c<span class="sign">(</span><span class="sign">.</span>025<span class="sign">,</span> <span class="sign">.</span>975<span class="sign">)</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    x      an object of class <a href="#robo166">splinesurv</a>
    quantiles  a list of quantiles at which to compute
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    means  a vector containing the overall frailty variance, the variance of the spline
           component, and the variance of the parametric component
    quantiles  a matrix containing the same for each given quantile
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3495 </span><span class="sign">{</span>
<span class="line_number">3496 </span>    goodind <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>x<span class="sign">$</span>control<span class="sign">$</span>burnin <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span>x<span class="sign">$</span>control<span class="sign">$</span>iter<span class="sign">)</span>
<span class="line_number">3497 </span>    <span class="comment"># spline component</span>
<span class="line_number">3498 </span>    <span class="keyword">if</span><span class="sign">(</span><a href="#robo155">hasspline</a><span class="sign">(</span>x<span class="sign">$</span>frailty<span class="sign">)</span><span class="sign">)</span> spline<span class="sign">.</span>fvars <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>fvar<span class="sign">[</span>goodind<span class="sign">]</span> <span class="keyword">else</span> 
<span class="line_number">3499 </span>        spline<span class="sign">.</span>fvars <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3500 </span>    <span class="comment"># parametric component</span>
<span class="line_number">3501 </span>    <span class="keyword">if</span><span class="sign">(</span><a href="#robo154">haspar</a><span class="sign">(</span>x<span class="sign">$</span>frailty<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">3502 </span>        param<span class="sign">.</span>fvars <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>x<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">[</span>goodind<span class="sign">,</span> <span class="sign">,</span>drop <span class="sign">=</span> FALSE<span class="sign">]</span><span class="sign">)</span> <span class="keyword">else</span> 
<span class="line_number">3503 </span>            param<span class="sign">.</span>fvars <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3504 </span>    <span class="comment"># weigh the two components</span>
<span class="line_number">3505 </span>    <span class="keyword">if</span><span class="sign">(</span><a href="#robo154">haspar</a><span class="sign">(</span>x<span class="sign">$</span>frailty<span class="sign">)</span> <span class="sign">&amp;</span> <a href="#robo155">hasspline</a><span class="sign">(</span>x<span class="sign">$</span>frailty<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3506 </span>        weights <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">.</span>weight<span class="sign">[</span>goodind<span class="sign">,</span> <span class="sign">,</span>drop <span class="sign">=</span> F<span class="sign">]</span>
<span class="line_number">3507 </span>        fvars <span class="sign">&lt;</span><span class="sign">-</span> weights <span class="sign">*</span> spline<span class="sign">.</span>fvars <span class="sign">+</span> <span class="sign">(</span>1 <span class="sign">-</span> weights<span class="sign">)</span> <span class="sign">*</span> param<span class="sign">.</span>fvars
<span class="line_number">3508 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">3509 </span>        <span class="keyword">if</span><span class="sign">(</span><a href="#robo154">haspar</a><span class="sign">(</span>x<span class="sign">$</span>frailty<span class="sign">)</span><span class="sign">)</span> fvars <span class="sign">&lt;</span><span class="sign">-</span> param<span class="sign">.</span>fvars <span class="keyword">else</span> fvars <span class="sign">&lt;</span><span class="sign">-</span> spline<span class="sign">.</span>fvars
<span class="line_number">3510 </span>    <span class="sign">}</span>
<span class="line_number">3511 </span>    <span class="comment"># compute means</span>
<span class="line_number">3512 </span>    fvar<span class="sign">.</span>means <span class="sign">&lt;</span><span class="sign">-</span> suppressWarnings<span class="sign">(</span><span class="keyword">rbind</span><span class="sign">(</span>mean<span class="sign">(</span>fvars<span class="sign">)</span><span class="sign">,</span> mean<span class="sign">(</span>spline<span class="sign">.</span>fvars<span class="sign">)</span><span class="sign">,</span> mean<span class="sign">(</span>param<span class="sign">.</span>fvars<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3513 </span>    <span class="comment"># compute quantiles</span>
<span class="line_number">3514 </span>    fvar<span class="sign">.</span>quantiles <span class="sign">&lt;</span><span class="sign">-</span> suppressWarnings<span class="sign">(</span><span class="keyword">rbind</span><span class="sign">(</span><span class="keyword">quantile</span><span class="sign">(</span>fvars<span class="sign">,</span> quantiles<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3515 </span>        <span class="keyword">quantile</span><span class="sign">(</span>spline<span class="sign">.</span>fvars<span class="sign">,</span> quantiles<span class="sign">)</span><span class="sign">,</span> <span class="keyword">quantile</span><span class="sign">(</span>param<span class="sign">.</span>fvars<span class="sign">,</span> quantiles<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3516 </span>    <span class="keyword">rownames</span><span class="sign">(</span>fvar<span class="sign">.</span>means<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rownames</span><span class="sign">(</span>fvar<span class="sign">.</span>quantiles<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="quote">"fvar"</span><span class="sign">,</span> <span class="quote">"spline.fvar"</span><span class="sign">,</span> <span class="quote">"param.fvar"</span><span class="sign">)</span>
<span class="line_number">3517 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>mean <span class="sign">=</span> fvar<span class="sign">.</span>means<span class="sign">,</span> quantiles <span class="sign">=</span> fvar<span class="sign">.</span>quantiles<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3518 </span><span class="sign">}</span>
</pre>

<hr />
<a name="S3Methods2fpredict2esplinesurv"></a>
<a name="robo162"></a><h2>S3Methods/predict.splinesurv [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo5">S3Methods</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>predict.splinesurv</strong> --- prediction method for <a href="#robo166">splinesurv</a> objects
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute curve estimates, or linear predictor/risk estimates for <a href="#robo166">splinesurv</a>.
</p>
 
<p>    This routine mainly works recursively. If called with iter=NULL, it calls itself
    with a subset of iterations multiple times and aggregates the results.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3886 </span><strong>predict.splinesurv</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>object<span class="sign">,</span> type <span class="sign">=</span> c<span class="sign">(</span><span class="quote">"hazard"</span><span class="sign">,</span> <span class="quote">"survival"</span><span class="sign">,</span> <span class="quote">"lp"</span><span class="sign">,</span> <span class="quote">"risk"</span><span class="sign">,</span> <span class="quote">"frailty"</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3887 </span>    x <span class="sign">=</span> NULL<span class="sign">,</span> newdata <span class="sign">=</span> NULL<span class="sign">,</span> iter <span class="sign">=</span> NULL<span class="sign">,</span> fn <span class="sign">=</span> mean<span class="sign">,</span> alpha <span class="sign">=</span> NULL<span class="sign">,</span> npost <span class="sign">=</span> 100<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    See package documentation
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3890 </span><span class="sign">{</span>
<span class="line_number">3891 </span>    type <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span>arg<span class="sign">(</span>type<span class="sign">)</span>
<span class="line_number">3892 </span>    fit <span class="sign">&lt;</span><span class="sign">-</span> object<span class="sign">;</span> haz <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">3893 </span>    ntimes <span class="sign">&lt;</span><span class="sign">-</span> 100
<span class="line_number">3894 </span>    <span class="comment"># check for valid newdata</span>
<span class="line_number">3895 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span> <span class="sign">|</span> type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"survival"</span><span class="sign">)</span> <span class="sign">&amp;</span> <span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">)</span> <span class="keyword">if</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span> <span class="sign">&gt;</span> 1<span class="sign">)</span> 
<span class="line_number">3896 </span>        stop<span class="sign">(</span><span class="quote">"newdata may only have one row"</span><span class="sign">)</span>
<span class="line_number">3897 </span>    <span class="comment"># if iter=NULL and a curve is required, call the routine again with a subset of iters</span>
<span class="line_number">3898 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span> <span class="sign">|</span> type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span> <span class="sign">|</span> type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"survival"</span><span class="sign">)</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>iter<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3899 </span>        <span class="comment"># get the set of "x" values at which the curve will be predicted</span>
<span class="line_number">3900 </span>        <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span> <span class="sign">|</span> type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"survival"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3901 </span>            <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>x<span class="sign">)</span> <span class="sign">|</span> is<span class="sign">.</span>character<span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span>   
<span class="line_number">3902 </span>                x <span class="sign">&lt;</span><span class="sign">-</span> seq<span class="sign">(</span>from <span class="sign">=</span> min<span class="sign">(</span>fit<span class="sign">$</span>data<span class="sign">$</span>time<span class="sign">)</span><span class="sign">,</span> to <span class="sign">=</span> max<span class="sign">(</span>fit<span class="sign">$</span>data<span class="sign">$</span>time<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span> <span class="sign">=</span> ntimes<span class="sign">)</span> 
<span class="line_number">3903 </span>        <span class="sign">}</span>
<span class="line_number">3904 </span>        <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3905 </span>            knots <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>1<span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">3906 </span>            knots <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span>knots<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">]</span>
<span class="line_number">3907 </span>            bounds <span class="sign">&lt;</span><span class="sign">-</span> range<span class="sign">(</span>knots<span class="sign">)</span>
<span class="line_number">3908 </span>            x <span class="sign">&lt;</span><span class="sign">-</span> seq<span class="sign">(</span>from <span class="sign">=</span> bounds<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> to <span class="sign">=</span> bounds<span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> <span class="keyword">length</span> <span class="sign">=</span> ntimes<span class="sign">)</span> 
<span class="line_number">3909 </span>        <span class="sign">}</span>
<span class="line_number">3910 </span>        <span class="comment"># get the set of iterations that will be used</span>
<span class="line_number">3911 </span>        ngooditer <span class="sign">&lt;</span><span class="sign">-</span> min<span class="sign">(</span>fit<span class="sign">$</span>control<span class="sign">$</span>maxiter <span class="sign">-</span> fit<span class="sign">$</span>control<span class="sign">$</span>burnin<span class="sign">,</span> npost<span class="sign">)</span>
<span class="line_number">3912 </span>        iters <span class="sign">&lt;</span><span class="sign">-</span> round<span class="sign">(</span>seq<span class="sign">(</span>from <span class="sign">=</span> fit<span class="sign">$</span>control<span class="sign">$</span>burnin <span class="sign">+</span> 1<span class="sign">,</span> to <span class="sign">=</span> fit<span class="sign">$</span>control<span class="sign">$</span>maxiter<span class="sign">,</span>
<span class="line_number">3913 </span>            <span class="keyword">length</span> <span class="sign">=</span> ngooditer<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3914 </span>        <span class="comment"># matrix for storage of predictions</span>
<span class="line_number">3915 </span>        preds <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>x<span class="sign">)</span><span class="sign">,</span> ngooditer<span class="sign">)</span>
<span class="line_number">3916 </span>        i <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">3917 </span>        <span class="comment"># call predict for a single iteration (after this if statement)</span>
<span class="line_number">3918 </span>        <span class="keyword">for</span><span class="sign">(</span>iter in iters<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3919 </span>            thispred <span class="sign">&lt;</span><span class="sign">-</span> predict<span class="sign">(</span>fit<span class="sign">,</span> type<span class="sign">,</span> x<span class="sign">,</span> newdata<span class="sign">,</span> iter<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3920 </span>            preds<span class="sign">[</span><span class="sign">,</span> i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> thispred<span class="sign">[</span><span class="sign">,</span> 2<span class="sign">]</span>
<span class="line_number">3921 </span>            i <span class="sign">&lt;</span><span class="sign">-</span> i <span class="sign">+</span> 1
<span class="line_number">3922 </span>        <span class="sign">}</span>
<span class="line_number">3923 </span>        <span class="comment"># aggregate the set of predictions</span>
<span class="line_number">3924 </span>        pred <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>preds<span class="sign">,</span> 1<span class="sign">,</span> fn<span class="sign">,</span> na<span class="sign">.</span>rm <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">3925 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>alpha<span class="sign">)</span><span class="sign">)</span> quantiles <span class="sign">&lt;</span><span class="sign">-</span> t<span class="sign">(</span><span class="keyword">apply</span><span class="sign">(</span>preds<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">quantile</span><span class="sign">,</span>
<span class="line_number">3926 </span>            probs <span class="sign">=</span> c<span class="sign">(</span>alpha <span class="sign">/</span> 2<span class="sign">,</span> 1 <span class="sign">-</span> alpha <span class="sign">/</span> 2<span class="sign">)</span><span class="sign">,</span> na<span class="sign">.</span>rm <span class="sign">=</span> TRUE<span class="sign">)</span><span class="sign">)</span> <span class="keyword">else</span> quantiles <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3927 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>x<span class="sign">,</span> pred<span class="sign">,</span> quantiles<span class="sign">)</span>
<span class="line_number">3928 </span>        <span class="keyword">colnames</span><span class="sign">(</span>out<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">colnames</span><span class="sign">(</span>thispred<span class="sign">)</span><span class="sign">,</span> <span class="keyword">colnames</span><span class="sign">(</span>quantiles<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3929 </span>        <span class="keyword">return</span><span class="sign">(</span>as<span class="sign">.</span>data<span class="sign">.</span>frame<span class="sign">(</span>out<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3930 </span>    <span class="sign">}</span>
<span class="line_number">3931 </span>
<span class="line_number">3932 </span>    <span class="comment"># similar to above, but handles "risk" as well</span>
<span class="line_number">3933 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span> <span class="sign">|</span> type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"survival"</span> <span class="sign">|</span> <span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"risk"</span> <span class="sign">&amp;</span> <span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3934 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>x<span class="sign">)</span> <span class="sign">|</span> is<span class="sign">.</span>character<span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span>   times <span class="sign">&lt;</span><span class="sign">-</span> seq<span class="sign">(</span>from <span class="sign">=</span> min<span class="sign">(</span>fit<span class="sign">$</span>data<span class="sign">$</span>time<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3935 </span>            to <span class="sign">=</span> max<span class="sign">(</span>fit<span class="sign">$</span>data<span class="sign">$</span>time<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span> <span class="sign">=</span> ntimes<span class="sign">)</span> <span class="keyword">else</span> times <span class="sign">&lt;</span><span class="sign">-</span> x
<span class="line_number">3936 </span>        <span class="comment"># construct a temp hazard curve</span>
<span class="line_number">3937 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>hazard
<span class="line_number">3938 </span>        hazard<span class="sign">$</span>x <span class="sign">&lt;</span><span class="sign">-</span> times<span class="sign">;</span> hazard<span class="sign">$</span><a href="#robo154">haspar</a> <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo154">haspar</a><span class="sign">(</span>hazard<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">3939 </span>        hazard<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo155">hasspline</a><span class="sign">(</span>hazard<span class="sign">)</span><span class="sign">;</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>norm <span class="sign">&lt;</span><span class="sign">-</span> FALSE
<span class="line_number">3940 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>iter<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3941 </span>            <span class="comment"># if iter=NULL, call the routine for a subset of iters as above</span>
<span class="line_number">3942 </span>            ngooditer <span class="sign">&lt;</span><span class="sign">-</span> min<span class="sign">(</span>fit<span class="sign">$</span>control<span class="sign">$</span>maxiter <span class="sign">-</span> fit<span class="sign">$</span>control<span class="sign">$</span>burnin<span class="sign">,</span> npost<span class="sign">)</span>
<span class="line_number">3943 </span>            iters <span class="sign">&lt;</span><span class="sign">-</span> round<span class="sign">(</span>seq<span class="sign">(</span>from <span class="sign">=</span> fit<span class="sign">$</span>control<span class="sign">$</span>burnin<span class="sign">,</span> to <span class="sign">=</span> fit<span class="sign">$</span>control<span class="sign">$</span>maxiter<span class="sign">,</span>
<span class="line_number">3944 </span>                <span class="keyword">length</span> <span class="sign">=</span> ngooditer<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3945 </span>            preds <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>times<span class="sign">)</span><span class="sign">,</span> ngooditer<span class="sign">)</span>
<span class="line_number">3946 </span>            i <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">3947 </span>            <span class="keyword">for</span><span class="sign">(</span>iter in iters<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3948 </span>                thispred <span class="sign">&lt;</span><span class="sign">-</span> predict<span class="sign">(</span>fit<span class="sign">,</span> type<span class="sign">,</span> times<span class="sign">,</span> newdata<span class="sign">,</span> iter<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3949 </span>                preds<span class="sign">[</span><span class="sign">,</span> i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> thispred<span class="sign">[</span><span class="sign">,</span> 2<span class="sign">]</span>
<span class="line_number">3950 </span>                i <span class="sign">&lt;</span><span class="sign">-</span> i <span class="sign">+</span> 1
<span class="line_number">3951 </span>            <span class="sign">}</span>
<span class="line_number">3952 </span>            pred <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>preds<span class="sign">,</span> 1<span class="sign">,</span> fn<span class="sign">,</span> na<span class="sign">.</span>rm <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">3953 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>alpha<span class="sign">)</span><span class="sign">)</span> quantiles <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>preds<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">quantile</span><span class="sign">,</span> 
<span class="line_number">3954 </span>                probs <span class="sign">=</span> c<span class="sign">(</span>alpha <span class="sign">/</span> 2<span class="sign">,</span> 1 <span class="sign">-</span> alpha <span class="sign">/</span> 2<span class="sign">)</span><span class="sign">,</span> na<span class="sign">.</span>rm <span class="sign">=</span> TRUE<span class="sign">)</span> <span class="keyword">else</span> quantiles <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3955 </span>            out <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>times<span class="sign">,</span> pred<span class="sign">,</span> t<span class="sign">(</span>quantiles<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3956 </span>            <span class="keyword">colnames</span><span class="sign">(</span>out<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">colnames</span><span class="sign">(</span>thispred<span class="sign">)</span><span class="sign">,</span> <span class="keyword">rownames</span><span class="sign">(</span>quantiles<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3957 </span>            <span class="keyword">return</span><span class="sign">(</span>as<span class="sign">.</span>data<span class="sign">.</span>frame<span class="sign">(</span>out<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3958 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">3959 </span>            <span class="comment"># continue constructing a temporary hazard <a href="#robo26">RCurve</a></span>
<span class="line_number">3960 </span>            hazard<span class="sign">$</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">3961 </span>            hazard<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>history<span class="sign">$</span>hazard<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">3962 </span>            hazard<span class="sign">$</span>param<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>history<span class="sign">$</span>hazard<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">3963 </span>            hazard<span class="sign">$</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">[</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">]</span>
<span class="line_number">3964 </span>            hazard<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">[</span>hazard<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">]</span>
<span class="line_number">3965 </span>            hazard<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>history<span class="sign">$</span>hazard<span class="sign">.</span>weight<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">3966 </span>        <span class="sign">}</span>
<span class="line_number">3967 </span>        <span class="comment"># set up the basis and evaluate the parametric and spline components</span>
<span class="line_number">3968 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo184">makesplinebasis</a><span class="sign">(</span>hazard<span class="sign">,</span> quick <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">3969 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo104">evalparametric</a><span class="sign">(</span>hazard<span class="sign">)</span>
<span class="line_number">3970 </span>        hazard <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo105">evalspline</a><span class="sign">(</span>hazard<span class="sign">,</span> quick <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">3971 </span>        haz <span class="sign">&lt;</span><span class="sign">-</span> hazard<span class="sign">$</span>y
<span class="line_number">3972 </span>        <span class="comment"># if newdata is nonzero, compute the frailty and covariate multiplier for each row</span>
<span class="line_number">3973 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3974 </span>            risk <span class="sign">&lt;</span><span class="sign">-</span> predict<span class="sign">(</span>fit<span class="sign">,</span> <span class="quote">"risk"</span><span class="sign">,</span> NULL<span class="sign">,</span> newdata<span class="sign">,</span> iter<span class="sign">)</span><span class="sign">$</span>risk<span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">3975 </span>            haz <span class="sign">&lt;</span><span class="sign">-</span> haz <span class="sign">*</span> risk
<span class="line_number">3976 </span>            clusterind <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>fit<span class="sign">$</span>terms<span class="sign">,</span> <span class="quote">"special"</span><span class="sign">)</span><span class="sign">$</span>cluster
<span class="line_number">3977 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>clusterind<span class="sign">)</span><span class="sign">)</span> cluster <span class="sign">&lt;</span><span class="sign">-</span> newdata<span class="sign">[</span><span class="sign">[</span>clusterind<span class="sign">]</span><span class="sign">]</span> <span class="keyword">else</span> cluster <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3978 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>cluster<span class="sign">)</span> <span class="sign">&amp;</span><span class="sign">&amp;</span> <span class="sign">!</span>is<span class="sign">.</span>na<span class="sign">(</span>cluster<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">3979 </span>                frail <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">[</span>iter<span class="sign">,</span> cluster<span class="sign">]</span> <span class="keyword">else</span> frail <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">3980 </span>            haz <span class="sign">&lt;</span><span class="sign">-</span> haz <span class="sign">*</span> frail
<span class="line_number">3981 </span>        <span class="sign">}</span>
<span class="line_number">3982 </span>        <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>data<span class="sign">.</span>frame<span class="sign">(</span>time <span class="sign">=</span> times<span class="sign">,</span> hazard <span class="sign">=</span> haz<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3983 </span>        <span class="comment"># compute survival curve by cumulative summing</span>
<span class="line_number">3984 </span>        <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"survival"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3985 </span>            dx <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="keyword">diff</span><span class="sign">(</span>times<span class="sign">)</span><span class="sign">,</span> 0<span class="sign">)</span>
<span class="line_number">3986 </span>            surv <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span><span class="sign">-</span><span class="keyword">cumsum</span><span class="sign">(</span>haz <span class="sign">*</span> dx<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3987 </span>            <span class="keyword">return</span><span class="sign">(</span>data<span class="sign">.</span>frame<span class="sign">(</span>time <span class="sign">=</span> times<span class="sign">,</span> survival <span class="sign">=</span> surv<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3988 </span>        <span class="sign">}</span>
<span class="line_number">3989 </span>    <span class="sign">}</span> 
<span class="line_number">3990 </span>    <span class="comment"># for lp and risk, evaluate the model terms and do the prediction</span>
<span class="line_number">3991 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"lp"</span> <span class="sign">|</span> type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"risk"</span><span class="sign">)</span>
<span class="line_number">3992 </span>    <span class="sign">{</span>
<span class="line_number">3993 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3994 </span>            vars <span class="sign">&lt;</span><span class="sign">-</span> model<span class="sign">.</span>matrix<span class="sign">(</span>fit<span class="sign">$</span>terms<span class="sign">,</span> model<span class="sign">.</span>frame<span class="sign">(</span>fit<span class="sign">)</span><span class="sign">)</span><span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>1<span class="sign">,</span> drop <span class="sign">=</span> FALSE<span class="sign">]</span>
<span class="line_number">3995 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">3996 </span>            temp <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>data<span class="sign">.</span>frame<span class="sign">(</span>i <span class="sign">=</span> 0<span class="sign">,</span> j <span class="sign">=</span> 0<span class="sign">,</span> time <span class="sign">=</span> 0<span class="sign">,</span> delta <span class="sign">=</span> 0<span class="sign">,</span> newdata<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3997 </span>            vars <span class="sign">&lt;</span><span class="sign">-</span> model<span class="sign">.</span>matrix<span class="sign">(</span>fit<span class="sign">$</span>terms<span class="sign">,</span> model<span class="sign">.</span>frame<span class="sign">(</span>fit<span class="sign">,</span> data <span class="sign">=</span> temp<span class="sign">)</span><span class="sign">)</span><span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>1<span class="sign">,</span> drop <span class="sign">=</span> FALSE<span class="sign">]</span>
<span class="line_number">3998 </span>        <span class="sign">}</span>
<span class="line_number">3999 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>iter<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4000 </span>            coef <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>coefficients
<span class="line_number">4001 </span>        <span class="keyword">else</span>
<span class="line_number">4002 </span>            coef <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>history<span class="sign">$</span>coefficients<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">4003 </span>        <span class="comment"># compute lp</span>
<span class="line_number">4004 </span>        lp <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>numeric<span class="sign">(</span>vars<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>coef<span class="sign">)</span>
<span class="line_number">4005 </span>        <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"lp"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">4006 </span>            lp <span class="sign">&lt;</span><span class="sign">-</span> data<span class="sign">.</span>frame<span class="sign">(</span>lp<span class="sign">)</span>
<span class="line_number">4007 </span>            <span class="keyword">try</span><span class="sign">(</span><span class="keyword">rownames</span><span class="sign">(</span>lp<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">)</span> <span class="keyword">rownames</span><span class="sign">(</span>fit<span class="sign">$</span>data<span class="sign">)</span> <span class="keyword">else</span> 
<span class="line_number">4008 </span>                <span class="keyword">rownames</span><span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">,</span> silent <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4009 </span>            <span class="keyword">return</span><span class="sign">(</span>lp<span class="sign">)</span>
<span class="line_number">4010 </span>        <span class="sign">}</span>
<span class="line_number">4011 </span>    <span class="sign">}</span>
<span class="line_number">4012 </span>    <span class="comment"># for risk, given lp and hazard, multiply additionally by the frailty</span>
<span class="line_number">4013 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"risk"</span><span class="sign">)</span>
<span class="line_number">4014 </span>    <span class="sign">{</span>
<span class="line_number">4015 </span>        pred <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>lp<span class="sign">)</span>
<span class="line_number">4016 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">4017 </span>            Ji <span class="sign">&lt;</span><span class="sign">-</span> table<span class="sign">(</span>fit<span class="sign">$</span>data<span class="sign">$</span>i<span class="sign">)</span>
<span class="line_number">4018 </span>            <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>iter<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4019 </span>                frailty <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>fit<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">,</span> Ji<span class="sign">)</span>
<span class="line_number">4020 </span>            <span class="keyword">else</span>
<span class="line_number">4021 </span>                frailty <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>fit<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span><span class="sign">,</span> Ji<span class="sign">)</span>
<span class="line_number">4022 </span>            pred <span class="sign">&lt;</span><span class="sign">-</span> frailty <span class="sign">*</span> pred
<span class="line_number">4023 </span>        <span class="sign">}</span>
<span class="line_number">4024 </span>        risk <span class="sign">&lt;</span><span class="sign">-</span> outer<span class="sign">(</span>haz<span class="sign">,</span> pred<span class="sign">,</span> <span class="quote">"*"</span><span class="sign">)</span>
<span class="line_number">4025 </span>        <span class="keyword">try</span><span class="sign">(</span><span class="keyword">colnames</span><span class="sign">(</span>risk<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">)</span> <span class="keyword">rownames</span><span class="sign">(</span>fit<span class="sign">$</span>data<span class="sign">)</span> <span class="keyword">else</span> 
<span class="line_number">4026 </span>            <span class="keyword">rownames</span><span class="sign">(</span>newdata<span class="sign">)</span><span class="sign">,</span> silent <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4027 </span>        <span class="keyword">if</span><span class="sign">(</span>any<span class="sign">(</span>duplicated<span class="sign">(</span><span class="keyword">colnames</span><span class="sign">(</span>risk<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="keyword">colnames</span><span class="sign">(</span>risk<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">4028 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>risk<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span> <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4029 </span>             risk <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>data<span class="sign">.</span>frame<span class="sign">(</span>t<span class="sign">(</span>risk<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4030 </span>             <span class="keyword">colnames</span><span class="sign">(</span>risk<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"risk"</span>
<span class="line_number">4031 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">4032 </span>            risk <span class="sign">&lt;</span><span class="sign">-</span> data<span class="sign">.</span>frame<span class="sign">(</span>time <span class="sign">=</span> times<span class="sign">,</span> risk<span class="sign">)</span>
<span class="line_number">4033 </span>        <span class="sign">}</span>
<span class="line_number">4034 </span>        <span class="keyword">return</span><span class="sign">(</span>risk<span class="sign">)</span>
<span class="line_number">4035 </span>    <span class="sign">}</span>
<span class="line_number">4036 </span>    <span class="comment"># for frailty curve</span>
<span class="line_number">4037 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span>
<span class="line_number">4038 </span>    <span class="sign">{</span>
<span class="line_number">4039 </span>        <span class="comment"># construct a temp frailty curve that can be evaluated</span>
<span class="line_number">4040 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>frailty
<span class="line_number">4041 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span> x <span class="sign">&lt;</span><span class="sign">-</span> seq<span class="sign">(</span>from <span class="sign">=</span> max<span class="sign">(</span>0<span class="sign">,</span> min<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">4042 </span>            to <span class="sign">=</span> max<span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span> <span class="sign">=</span> ntimes<span class="sign">)</span>
<span class="line_number">4043 </span>        frailty<span class="sign">$</span>x <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">;</span> frailty<span class="sign">$</span><a href="#robo154">haspar</a> <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo154">haspar</a><span class="sign">(</span>frailty<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">4044 </span>        frailty<span class="sign">$</span><a href="#robo155">hasspline</a> <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo155">hasspline</a><span class="sign">(</span>frailty<span class="sign">)</span><span class="sign">;</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>norm <span class="sign">&lt;</span><span class="sign">-</span> TRUE
<span class="line_number">4045 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>iter<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">4046 </span>            frailty<span class="sign">$</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par
<span class="line_number">4047 </span>            frailty<span class="sign">$</span>param<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">.</span>param<span class="sign">.</span>par
<span class="line_number">4048 </span>            frailty<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">.</span>weight
<span class="line_number">4049 </span>            <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>data<span class="sign">.</span>frame<span class="sign">(</span>x <span class="sign">=</span> x<span class="sign">,</span> density <span class="sign">=</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4050 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">4051 </span>            frailty<span class="sign">$</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>par<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">4052 </span>            frailty<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">.</span>spline<span class="sign">.</span>knots<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">4053 </span>            frailty<span class="sign">$</span>param<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">4054 </span>            frailty<span class="sign">$</span>spline<span class="sign">.</span>par <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">[</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">]</span>
<span class="line_number">4055 </span>            frailty<span class="sign">$</span>spline<span class="sign">.</span>knots <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">[</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">]</span>
<span class="line_number">4056 </span>            frailty<span class="sign">$</span>weight <span class="sign">&lt;</span><span class="sign">-</span> fit<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">.</span>weight<span class="sign">[</span>iter<span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">4057 </span>        <span class="sign">}</span>
<span class="line_number">4058 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo184">makesplinebasis</a><span class="sign">(</span>frailty<span class="sign">,</span> quick <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4059 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo104">evalparametric</a><span class="sign">(</span>frailty<span class="sign">)</span>
<span class="line_number">4060 </span>        frailty <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo105">evalspline</a><span class="sign">(</span>frailty<span class="sign">,</span> quick <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">4061 </span>        density <span class="sign">&lt;</span><span class="sign">-</span> frailty<span class="sign">$</span>y        
<span class="line_number">4062 </span>        <span class="keyword">return</span><span class="sign">(</span>data<span class="sign">.</span>frame<span class="sign">(</span>x <span class="sign">=</span> x<span class="sign">,</span> density <span class="sign">=</span> density<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">4063 </span>    <span class="sign">}</span>
<span class="line_number">4064 </span><span class="sign">}</span>
</pre>

<hr />
<a name="S3Methods2fprint2esplinesurv"></a>
<a name="robo163"></a><h2>S3Methods/print.splinesurv [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo5">S3Methods</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>print.splinesurv</strong> --- print a <a href="#robo166">splinesurv</a> object
</pre>
<p class="item_name">FUNCTION</p>
<p>   Prints the posterior mean of <a href="#robo166">splinesurv</a> fit coefficients.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3412 </span><strong>print.splinesurv</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3415 </span><span class="sign">{</span>
<span class="line_number">3416 </span>    coef <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>matrix<span class="sign">(</span>x<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>coef<span class="sign">,</span> ncol <span class="sign">=</span> 1<span class="sign">)</span>
<span class="line_number">3417 </span>    <span class="keyword">colnames</span><span class="sign">(</span>coef<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"coef"</span>
<span class="line_number">3418 </span>    print<span class="sign">(</span>coef<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3419 </span>    invisible<span class="sign">(</span>x<span class="sign">)</span>
<span class="line_number">3420 </span><span class="sign">}</span>
</pre>

<hr />
<a name="S3Methods2fprint2esummary2esplinesurv"></a>
<a name="robo164"></a><h2>S3Methods/print.summary.splinesurv [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo5">S3Methods</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>print.summary.splinesurv</strong> --- print <a href="#robo170">summary.splinesurv</a> object
</pre>
<p class="item_name">FUNCTION</p>
<p>    Pretty-print the output of <a href="#robo170">summary.splinesurv</a>
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3530 </span><strong>print.summary.splinesurv</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>   
</pre>
<p class="item_name">INPUTS</p>
<pre>    x      an object of class <a href="#robo170">summary.splinesurv</a>
    ...    additional parameters passed to formatC
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3533 </span><span class="sign">{</span> 
<span class="line_number">3534 </span>    <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Call: \n"</span><span class="sign">)</span>
<span class="line_number">3535 </span>    print<span class="sign">(</span>x<span class="sign">$</span><span class="keyword">call</span><span class="sign">)</span>
<span class="line_number">3536 </span>    <span class="comment"># print basic info</span>
<span class="line_number">3537 </span>    <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\nIterations: "</span><span class="sign">,</span> x<span class="sign">$</span>iter<span class="sign">,</span> <span class="quote">" ("</span><span class="sign">,</span> x<span class="sign">$</span>burnin<span class="sign">,</span> <span class="quote">" discarded as burn - in)\n"</span><span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span>
<span class="line_number">3538 </span>    printpars <span class="sign">&lt;</span><span class="sign">-</span> paste<span class="sign">(</span>names<span class="sign">(</span>x<span class="sign">$</span>dots<span class="sign">)</span><span class="sign">,</span> unlist<span class="sign">(</span>x<span class="sign">$</span>dots<span class="sign">)</span><span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">" = "</span><span class="sign">,</span> collapse <span class="sign">=</span> <span class="quote">", "</span><span class="sign">)</span>
<span class="line_number">3539 </span>    <span class="keyword">if</span><span class="sign">(</span>nchar<span class="sign">(</span>printpars<span class="sign">)</span><span class="sign">)</span> printpars <span class="sign">&lt;</span><span class="sign">-</span> paste<span class="sign">(</span><span class="quote">", "</span><span class="sign">,</span> printpars<span class="sign">)</span>
<span class="line_number">3540 </span>    <span class="comment"># print regression coefficients and quantiles</span>
<span class="line_number">3541 </span>    <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\nRegression parameter posterior:\n"</span><span class="sign">)</span>
<span class="line_number">3542 </span>    eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"print(cbind(x$coef, x$quantiles.coef)"</span><span class="sign">,</span> printpars<span class="sign">,</span> <span class="quote">")"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3543 </span>    <span class="comment"># print frailty variances</span>
<span class="line_number">3544 </span>    <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\nFrailty variance:\n"</span><span class="sign">)</span>
<span class="line_number">3545 </span>    fvarout <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rbind</span><span class="sign">(</span><span class="keyword">cbind</span><span class="sign">(</span>x<span class="sign">$</span>frailty<span class="sign">$</span>fvar<span class="sign">,</span> x<span class="sign">$</span>quantiles<span class="sign">.</span>fvar<span class="sign">[</span>1<span class="sign">,</span> <span class="sign">,</span>drop <span class="sign">=</span> F<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">3546 </span>        c<span class="sign">(</span>x<span class="sign">$</span>frailty<span class="sign">$</span>fvar2<span class="sign">,</span> x<span class="sign">$</span>quantiles<span class="sign">.</span>fvar2<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3547 </span>    <span class="keyword">rownames</span><span class="sign">(</span>fvarout<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="quote">"fvar"</span><span class="sign">,</span> <span class="quote">"fvar2"</span><span class="sign">)</span><span class="sign">;</span> <span class="keyword">colnames</span><span class="sign">(</span>fvarout<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"mean"</span>
<span class="line_number">3548 </span>    eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"print(fvarout"</span><span class="sign">,</span> printpars<span class="sign">,</span> <span class="quote">")"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3549 </span>    <span class="comment"># print summaries of each of the curves</span>
<span class="line_number">3550 </span>    <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\nBaseline hazard:"</span><span class="sign">)</span>
<span class="line_number">3551 </span>    <a href="#robo165">printcurvesummary</a><span class="sign">(</span>x<span class="sign">$</span>hazard<span class="sign">,</span> x<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>hazard<span class="sign">.</span>weight<span class="sign">,</span>
<span class="line_number">3552 </span>        x<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>hazard<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">3553 </span>    <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\nFrailty density:"</span><span class="sign">)</span>
<span class="line_number">3554 </span>    <a href="#robo165">printcurvesummary</a><span class="sign">(</span>x<span class="sign">$</span>frailty<span class="sign">,</span> x<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">.</span>weight<span class="sign">,</span>
<span class="line_number">3555 </span>        x<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">.</span>param<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">3556 </span>    invisible<span class="sign">(</span>x<span class="sign">)</span>
<span class="line_number">3557 </span><span class="sign">}</span>
</pre>

<hr />
<a name="S3Methods2fprintcurvesummary"></a>
<a name="robo165"></a><h2>S3Methods/printcurvesummary [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo5">S3Methods</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>printcurvesummary</strong> --- summarize a curve for <a href="#robo170">summary.splinesurv</a>
</pre>
<p class="item_name">FUNCTION</p>
<p>    Routine called by <a href="#robo170">summary.splinesurv</a> to print a nice summary of a curve structure
    including mean number of knots, boundaries, parametric/spline components and weights, etc.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3573 </span><strong>printcurvesummary</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> w <span class="sign">=</span> NULL<span class="sign">,</span> param<span class="sign">.</span>par <span class="sign">=</span> NULL<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve  an <a href="#robo26">RCurve</a> structure, possibly with portions missing
    w      weight of splines component
    param.par  parametric component parameters to use
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    none, screen output only
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3576 </span><span class="sign">{</span>
<span class="line_number">3577 </span>    <a href="#robo154">haspar</a> <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span> <span class="sign">|</span><span class="sign">|</span> curve<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"parametric"</span>
<span class="line_number">3578 </span>    <a href="#robo155">hasspline</a> <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"both"</span> <span class="sign">|</span><span class="sign">|</span> curve<span class="sign">$</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"spline"</span>
<span class="line_number">3579 </span>    <span class="comment"># print spline component</span>
<span class="line_number">3580 </span>    <span class="keyword">if</span><span class="sign">(</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3581 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n\tSpline"</span><span class="sign">)</span>
<span class="line_number">3582 </span>        <span class="keyword">if</span><span class="sign">(</span><a href="#robo154">haspar</a><span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">" ( weight ="</span><span class="sign">,</span> format<span class="sign">(</span>w<span class="sign">,</span> digits <span class="sign">=</span> 3<span class="sign">)</span><span class="sign">,</span> <span class="quote">"):"</span><span class="sign">)</span> <span class="keyword">else</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">":"</span><span class="sign">)</span>
<span class="line_number">3583 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n\t\tOrder:"</span><span class="sign">,</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">)</span>
<span class="line_number">3584 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n\t\tMean Interior knots:"</span><span class="sign">,</span> format<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">,</span> digits <span class="sign">=</span> 2<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3585 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n\t\tVariance: "</span><span class="sign">,</span> format<span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>fvar<span class="sign">,</span>
<span class="line_number">3586 </span>            digits <span class="sign">=</span> 3<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3587 </span>    <span class="sign">}</span>
<span class="line_number">3588 </span>    <span class="comment"># print parametric component</span>
<span class="line_number">3589 </span>    <span class="keyword">if</span><span class="sign">(</span><a href="#robo154">haspar</a><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3590 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n\tParametric"</span><span class="sign">)</span>
<span class="line_number">3591 </span>        <span class="keyword">if</span><span class="sign">(</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">" ( weight ="</span><span class="sign">,</span> format<span class="sign">(</span>1 <span class="sign">-</span> w<span class="sign">,</span> digits <span class="sign">=</span> 3<span class="sign">)</span><span class="sign">,</span> <span class="quote">"):"</span><span class="sign">)</span> <span class="keyword">else</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">":"</span><span class="sign">)</span>
<span class="line_number">3592 </span>        dist <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>param<span class="sign">.</span>dist
<span class="line_number">3593 </span>        <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n\t\tDistribution:"</span><span class="sign">,</span> curve<span class="sign">$</span>param<span class="sign">.</span>dist<span class="sign">)</span>
<span class="line_number">3594 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span> <span class="sign">&amp;</span> dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"exponential"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3595 </span>            <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n\t\tRate:"</span><span class="sign">,</span> format<span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">)</span><span class="sign">,</span> digits <span class="sign">=</span> 3<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3596 </span>        <span class="sign">}</span>
<span class="line_number">3597 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span> <span class="sign">&amp;</span> dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"weibull"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3598 </span>            <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n\t\tRate:"</span><span class="sign">,</span> format<span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span> digits <span class="sign">=</span> 3<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3599 </span>            <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n\t\tScale:"</span><span class="sign">,</span> format<span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span> digits <span class="sign">=</span> 3<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">3600 </span>        <span class="sign">}</span>
<span class="line_number">3601 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span> <span class="sign">&amp;</span> <span class="sign">(</span>dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"gamma"</span> <span class="sign">|</span> dist <span class="sign">=</span><span class="sign">=</span> <span class="quote">"lognormal"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3602 </span>            <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\n\t\tVariance:"</span><span class="sign">,</span> format<span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>param<span class="sign">.</span>par<span class="sign">)</span><span class="sign">,</span> digits <span class="sign">=</span> 3<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3603 </span>        <span class="sign">}</span>
<span class="line_number">3604 </span>        
<span class="line_number">3605 </span>    <span class="sign">}</span>
<span class="line_number">3606 </span><span class="sign">}</span>
</pre>

<hr />
<a name="S3Methods2fsplinesurv"></a>
<a name="robo166"></a><h2>S3Methods/splinesurv [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo5">S3Methods</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>splinesurv</strong> --- method dispatch for <strong>splinesurv</strong>
</pre>
<p class="item_name">FUNCTION</p>
<p>    This is the main user-callable function that handles method dispatch
    to <a href="#robo21">splinesurv.agdata</a>, <a href="#robo168">splinesurv.formula</a> and <a href="#robo167">splinesurv.data.frame</a>.
    See the package documentation for usage instructions.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3296 </span><strong>splinesurv</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3299 </span><span class="sign">{</span>
<span class="line_number">3300 </span>    UseMethod<span class="sign">(</span><span class="quote">"<strong>splinesurv</strong>"</span><span class="sign">)</span>
<span class="line_number">3301 </span><span class="sign">}</span>
</pre>

<hr />
<a name="S3Methods2fsplinesurv2edata2eframe"></a>
<a name="robo167"></a><h2>S3Methods/splinesurv.data.frame [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo5">S3Methods</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>splinesurv.data.frame</strong> --- <a href="#robo166">splinesurv</a> method for data frames
</pre>
<p class="item_name">FUNCTION</p>
<p>    This function takes in a data frame in the format required by <a href="#robo21">splinesurv.agdata</a>
    except for the sorting order. It simply makes sure that the data frame has the
    required format and passes it on.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3314 </span><strong>splinesurv.data.frame</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    x  a data frame with columns i, j, time, delta, followed by covariates
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3317 </span><span class="sign">{</span>
<span class="line_number">3318 </span>    <span class="keyword">call</span> <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span><span class="keyword">call</span><span class="sign">(</span><span class="sign">)</span>
<span class="line_number">3319 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>x<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">&gt;</span> 4 <span class="sign">&amp;</span><span class="sign">&amp;</span> all<span class="sign">(</span><span class="keyword">colnames</span><span class="sign">(</span>x<span class="sign">)</span><span class="sign">[</span>1<span class="sign">:</span>4<span class="sign">]</span> <span class="sign">=</span><span class="sign">=</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3320 </span>        x <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">[</span>order<span class="sign">(</span>x<span class="sign">$</span>i<span class="sign">)</span><span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">3321 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo21">splinesurv.agdata</a><span class="sign">(</span>x<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3322 </span>        out<span class="sign">$</span><span class="keyword">call</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">call</span>
<span class="line_number">3323 </span>        <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">)</span>
<span class="line_number">3324 </span>    <span class="sign">}</span> <span class="keyword">else</span> <span class="sign">{</span>
<span class="line_number">3325 </span>        stop<span class="sign">(</span><span class="quote">"input data frame needs to have colnames i, j, time, delta"</span><span class="sign">)</span>
<span class="line_number">3326 </span>    <span class="sign">}</span>
<span class="line_number">3327 </span><span class="sign">}</span>
</pre>

<hr />
<a name="S3Methods2fsplinesurv2eformula"></a>
<a name="robo168"></a><h2>S3Methods/splinesurv.formula [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo5">S3Methods</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>splinesurv.formula</strong> --- formula interface for <a href="#robo166">splinesurv</a>
</pre>
<p class="item_name">FUNCTION</p>
<p>    This is the main user-facing interface function. It takes a formula and additional
    parameters, conducts basic input checking and builds a data frame in the format
    required by <a href="#robo21">splinesurv.agdata</a>. After fitting is done, it constructs the <a href="#robo166">splinesurv</a>
    output object.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3343 </span><strong>splinesurv.formula</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>formula<span class="sign">,</span> data <span class="sign">=</span> parent<span class="sign">.</span>frame<span class="sign">(</span><span class="sign">)</span><span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    See package documentation
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    See package documentation for <a href="#robo166">splinesurv</a> object
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3346 </span><span class="sign">{</span>
<span class="line_number">3347 </span>    <span class="comment"># in part based on coxph function</span>
<span class="line_number">3348 </span>    <span class="keyword">call</span> <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span><span class="keyword">call</span><span class="sign">(</span><span class="sign">)</span>
<span class="line_number">3349 </span>    m <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span><span class="keyword">call</span><span class="sign">(</span>expand<span class="sign">.</span>dots <span class="sign">=</span> FALSE<span class="sign">)</span>
<span class="line_number">3350 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>matrix<span class="sign">(</span>eval<span class="sign">(</span>m<span class="sign">$</span>data<span class="sign">,</span> sys<span class="sign">.</span>parent<span class="sign">(</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> m<span class="sign">$</span>data <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>data<span class="sign">.</span>frame<span class="sign">(</span>data<span class="sign">)</span>
<span class="line_number">3351 </span>    m<span class="sign">$</span><span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">&lt;</span><span class="sign">-</span>NULL
<span class="line_number">3352 </span>    m<span class="sign">[</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>name<span class="sign">(</span><span class="quote">"model.frame"</span><span class="sign">)</span>
<span class="line_number">3353 </span>    special <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"cluster"</span>
<span class="line_number">3354 </span>    Terms <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span> <span class="sign">(</span>missing<span class="sign">(</span>data<span class="sign">)</span><span class="sign">)</span> terms<span class="sign">(</span>formula<span class="sign">,</span> special<span class="sign">)</span> <span class="keyword">else</span> 
<span class="line_number">3355 </span>        terms<span class="sign">(</span>formula<span class="sign">,</span> special<span class="sign">,</span> data <span class="sign">=</span> data<span class="sign">)</span>    
<span class="line_number">3356 </span>    m<span class="sign">$</span>formula <span class="sign">&lt;</span><span class="sign">-</span> Terms
<span class="line_number">3357 </span>    m <span class="sign">&lt;</span><span class="sign">-</span> eval<span class="sign">(</span>m<span class="sign">,</span> sys<span class="sign">.</span>parent<span class="sign">(</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3358 </span>    n <span class="sign">&lt;</span><span class="sign">-</span> nrow<span class="sign">(</span>m<span class="sign">)</span>
<span class="line_number">3359 </span>    <span class="comment"># Check response</span>
<span class="line_number">3360 </span>    resp <span class="sign">&lt;</span><span class="sign">-</span> model<span class="sign">.</span>extract<span class="sign">(</span>m<span class="sign">,</span> <span class="quote">"response"</span><span class="sign">)</span>
<span class="line_number">3361 </span>    <span class="keyword">if</span> <span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>Surv<span class="sign">(</span>resp<span class="sign">)</span><span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"model response must be a Surv object"</span><span class="sign">)</span>
<span class="line_number">3362 </span>    <span class="keyword">if</span><span class="sign">(</span>attr<span class="sign">(</span>resp<span class="sign">,</span> <span class="quote">"type"</span><span class="sign">)</span> <span class="sign">!</span><span class="sign">=</span> <span class="quote">"right"</span><span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"right - censored survival data only"</span><span class="sign">)</span>
<span class="line_number">3363 </span>    time <span class="sign">&lt;</span><span class="sign">-</span> resp<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">3364 </span>    delta <span class="sign">&lt;</span><span class="sign">-</span> resp<span class="sign">[</span><span class="sign">,</span> <span class="quote">"status"</span><span class="sign">]</span>
<span class="line_number">3365 </span>    clusterind <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>Terms<span class="sign">,</span> <span class="quote">"specials"</span><span class="sign">)</span><span class="sign">$</span>cluster
<span class="line_number">3366 </span>    clusterind0 <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3367 </span>    dropx <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3368 </span>    <span class="comment"># handle cluster special terms</span>
<span class="line_number">3369 </span>    clusternames <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3370 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>clusterind<span class="sign">)</span> <span class="sign">&gt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3371 </span>        cluster <span class="sign">&lt;</span><span class="sign">-</span> m<span class="sign">[</span><span class="sign">,</span> clusterind<span class="sign">]</span>
<span class="line_number">3372 </span>        <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>data<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span> <span class="keyword">if</span><span class="sign">(</span>isTRUE<span class="sign">(</span>all<span class="sign">.</span>equal<span class="sign">(</span>data<span class="sign">[</span><span class="sign">,</span> j<span class="sign">]</span><span class="sign">,</span> cluster<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> clusterind0 <span class="sign">&lt;</span><span class="sign">-</span> j
<span class="line_number">3373 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>factor<span class="sign">(</span>cluster<span class="sign">)</span><span class="sign">)</span> clusternames <span class="sign">&lt;</span><span class="sign">-</span> levels<span class="sign">(</span>cluster<span class="sign">)</span>
<span class="line_number">3374 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>numeric<span class="sign">(</span>cluster<span class="sign">)</span><span class="sign">)</span> clusternames <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>character<span class="sign">(</span><span class="keyword">unique</span><span class="sign">(</span>cluster<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3375 </span>        i <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>numeric<span class="sign">(</span>as<span class="sign">.</span>factor<span class="sign">(</span>cluster<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3376 </span>        tempc <span class="sign">&lt;</span><span class="sign">-</span> untangle<span class="sign">.</span>specials<span class="sign">(</span>Terms<span class="sign">,</span> <span class="quote">"cluster"</span><span class="sign">,</span> 1<span class="sign">:</span>10<span class="sign">)</span>
<span class="line_number">3377 </span>        ord <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>Terms<span class="sign">,</span> <span class="quote">"order"</span><span class="sign">)</span><span class="sign">[</span>tempc<span class="sign">$</span>terms<span class="sign">]</span>
<span class="line_number">3378 </span>        <span class="keyword">if</span> <span class="sign">(</span>any<span class="sign">(</span>ord <span class="sign">&gt;</span> 1<span class="sign">)</span><span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"Cluster can not be used in an interaction"</span><span class="sign">)</span>
<span class="line_number">3379 </span>        dropx <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>dropx<span class="sign">,</span> tempc<span class="sign">$</span>terms<span class="sign">)</span>
<span class="line_number">3380 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">3381 </span>        i <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>1<span class="sign">,</span> n<span class="sign">)</span>
<span class="line_number">3382 </span>    <span class="sign">}</span>
<span class="line_number">3383 </span>    Ji <span class="sign">&lt;</span><span class="sign">-</span> drop<span class="sign">(</span>table<span class="sign">(</span>i<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3384 </span>    j <span class="sign">&lt;</span><span class="sign">-</span> unlist<span class="sign">(</span>as<span class="sign">.</span>vector<span class="sign">(</span>sapply<span class="sign">(</span>Ji<span class="sign">,</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">)</span> 1<span class="sign">:</span>x<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3385 </span>    newTerms <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>dropx<span class="sign">)</span><span class="sign">)</span>  Terms<span class="sign">[</span> <span class="sign">-</span> dropx<span class="sign">]</span> <span class="keyword">else</span> Terms
<span class="line_number">3386 </span>    <span class="comment"># construct data frame for <a href="#robo21">splinesurv.agdata</a></span>
<span class="line_number">3387 </span>    X <span class="sign">&lt;</span><span class="sign">-</span> model<span class="sign">.</span>matrix<span class="sign">(</span>newTerms<span class="sign">,</span> m<span class="sign">)</span>
<span class="line_number">3388 </span>    X <span class="sign">&lt;</span><span class="sign">-</span> X<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>1<span class="sign">,</span> drop <span class="sign">=</span> FALSE<span class="sign">]</span>
<span class="line_number">3389 </span>    agdata <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>data<span class="sign">.</span>frame<span class="sign">(</span><span class="keyword">cbind</span><span class="sign">(</span>i<span class="sign">,</span> j<span class="sign">,</span> time<span class="sign">,</span> delta<span class="sign">,</span> X<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3390 </span>    agdata<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>2<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">[</span>order<span class="sign">(</span>agdata<span class="sign">$</span>i<span class="sign">)</span><span class="sign">,</span> <span class="sign">-</span>2<span class="sign">]</span>
<span class="line_number">3391 </span>    class<span class="sign">(</span>agdata<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="quote">"agdata"</span><span class="sign">,</span> <span class="quote">"data.frame"</span><span class="sign">)</span>
<span class="line_number">3392 </span>    fit <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo21">splinesurv.agdata</a><span class="sign">(</span>agdata<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">3393 </span>    gcout <span class="sign">&lt;</span><span class="sign">-</span> gc<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">3394 </span>    <span class="comment"># clean up output object</span>
<span class="line_number">3395 </span>    fit<span class="sign">$</span><span class="keyword">call</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">call</span>
<span class="line_number">3396 </span>    <span class="keyword">colnames</span><span class="sign">(</span>fit<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> clusternames
<span class="line_number">3397 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>fit<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">)</span><span class="sign">)</span> names<span class="sign">(</span>fit<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>frailty<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> clusternames
<span class="line_number">3398 </span>    fit<span class="sign">$</span>terms <span class="sign">&lt;</span><span class="sign">-</span> newTerms
<span class="line_number">3399 </span>    attr<span class="sign">(</span>fit<span class="sign">$</span>terms<span class="sign">,</span> <span class="quote">"special"</span><span class="sign">)</span><span class="sign">$</span>cluster <span class="sign">&lt;</span><span class="sign">-</span> clusterind0
<span class="line_number">3400 </span>    <span class="keyword">return</span><span class="sign">(</span>fit<span class="sign">)</span>
<span class="line_number">3401 </span><span class="sign">}</span>
</pre>

<hr />
<a name="S3Methods2fsplinesurvtkplot"></a>
<a name="robo169"></a><h2>S3Methods/splinesurvtkplot [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo5">S3Methods</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>splinesurvtkplot</strong> --- plot the curve using tcltk
</pre>
<p class="item_name">FUNCTION</p>
<p>    Uses tcltk and the tkrplot package to plot the curve, with a slider to select
    the iteration.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3794 </span><strong>splinesurvtkplot</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    x      a <a href="#robo166">splinesurv</a> object
    ...    plotting parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3797 </span><span class="sign">{</span>
<span class="line_number">3798 </span>    library<span class="sign">(</span>tkrplot<span class="sign">)</span>
<span class="line_number">3799 </span>        <span class="keyword">which</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"h"</span>
<span class="line_number">3800 </span>    <span class="comment"># tk canvas</span>
<span class="line_number">3801 </span>        tt <span class="sign">&lt;</span><span class="sign">-</span> tktoplevel<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">3802 </span>        tktitle<span class="sign">(</span>tt<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"SplineSurv"</span>
<span class="line_number">3803 </span>        iter <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">3804 </span>    <span class="comment"># tcl variables, to hold the selected iteration and plot type</span>
<span class="line_number">3805 </span>        tcliter <span class="sign">&lt;</span><span class="sign">-</span> tclVar<span class="sign">(</span>iter<span class="sign">)</span>
<span class="line_number">3806 </span>        tclwhich <span class="sign">&lt;</span><span class="sign">-</span> tclVar<span class="sign">(</span><span class="keyword">which</span><span class="sign">)</span>
<span class="line_number">3807 </span>        maxiter <span class="sign">=</span> x<span class="sign">$</span>control<span class="sign">$</span>maxiter
<span class="line_number">3808 </span>        res <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>1<span class="sign">,</span> round<span class="sign">(</span>maxiter <span class="sign">/</span> 100<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3809 </span>    <span class="comment"># plotting canvas</span>
<span class="line_number">3810 </span>        img <span class="sign">&lt;</span><span class="sign">-</span> tkrplot<span class="sign">(</span>tt<span class="sign">,</span> <span class="keyword">function</span><span class="sign">(</span><span class="sign">)</span> plot<span class="sign">(</span>x <span class="sign">=</span> x<span class="sign">,</span> <span class="keyword">which</span> <span class="sign">=</span> <span class="keyword">which</span><span class="sign">,</span> iter <span class="sign">=</span> iter<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span><span class="sign">)</span>     
<span class="line_number">3811 </span>    
<span class="line_number">3812 </span>    <span class="comment"># an inner function to set the iteration</span>
<span class="line_number">3813 </span>        setiter <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span><span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3814 </span>        <span class="comment"># get the iteration from the tcliter variable</span>
<span class="line_number">3815 </span>                thisiter <span class="sign">&lt;</span><span class="sign">-</span> round<span class="sign">(</span>as<span class="sign">.</span>numeric<span class="sign">(</span>tclvalue<span class="sign">(</span>tcliter<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3816 </span>                <span class="keyword">if</span><span class="sign">(</span>iter <span class="sign">!</span><span class="sign">=</span> thisiter<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3817 </span>                        assign<span class="sign">(</span><span class="quote">"iter"</span><span class="sign">,</span> thisiter<span class="sign">,</span> inherits <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">3818 </span>            <span class="comment">#replot if the iteration has changed</span>
<span class="line_number">3819 </span>                        tkrreplot<span class="sign">(</span>img<span class="sign">)</span>
<span class="line_number">3820 </span>                <span class="sign">}</span>       
<span class="line_number">3821 </span>        <span class="sign">}</span>
<span class="line_number">3822 </span>    
<span class="line_number">3823 </span>    <span class="comment"># an inner function to set the type of plot to "hazard"</span>
<span class="line_number">3824 </span>        setwhich_h <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span><span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3825 </span>                assign<span class="sign">(</span><span class="quote">"which"</span><span class="sign">,</span> <span class="quote">"h"</span><span class="sign">,</span> inherits <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">3826 </span>                tkrreplot<span class="sign">(</span>img<span class="sign">)</span>
<span class="line_number">3827 </span>        <span class="sign">}</span>
<span class="line_number">3828 </span>    <span class="comment"># an inner function to set the type of plot to "survival"</span>
<span class="line_number">3829 </span>        setwhich_s <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span><span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">3830 </span>                assign<span class="sign">(</span><span class="quote">"which"</span><span class="sign">,</span> <span class="quote">"s"</span><span class="sign">,</span> inherits <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">3831 </span>                tkrreplot<span class="sign">(</span>img<span class="sign">)</span>
<span class="line_number">3832 </span>        <span class="sign">}</span>
<span class="line_number">3833 </span>    <span class="comment"># an inner function to set the type of plot to "frailty"</span>
<span class="line_number">3834 </span>        setwhich_f <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span><span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3835 </span>                assign<span class="sign">(</span><span class="quote">"which"</span><span class="sign">,</span> <span class="quote">"f"</span><span class="sign">,</span> inherits <span class="sign">=</span> TRUE<span class="sign">)</span>           
<span class="line_number">3836 </span>                tkrreplot<span class="sign">(</span>img<span class="sign">)</span>
<span class="line_number">3837 </span>        <span class="sign">}</span>
<span class="line_number">3838 </span>    <span class="comment"># an inner function to set the current iteration to 0, corresponding to</span>
<span class="line_number">3839 </span>    <span class="comment"># plotting the posterior mean.</span>
<span class="line_number">3840 </span>        setpost <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span><span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3841 </span>                assign<span class="sign">(</span><span class="quote">"iter"</span><span class="sign">,</span> 0<span class="sign">,</span> inherits <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">3842 </span>                tclvalue<span class="sign">(</span>tcliter<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">3843 </span>                tkrreplot<span class="sign">(</span>img<span class="sign">)</span>
<span class="line_number">3844 </span>        <span class="sign">}</span>
<span class="line_number">3845 </span>
<span class="line_number">3846 </span>    <span class="comment"># a TK scale control, used to select the iteration to plot</span>
<span class="line_number">3847 </span>        iter_scale <span class="sign">&lt;</span><span class="sign">-</span> tkscale<span class="sign">(</span>tt<span class="sign">,</span> command <span class="sign">=</span> setiter<span class="sign">,</span> from <span class="sign">=</span> 0<span class="sign">,</span> to <span class="sign">=</span> maxiter<span class="sign">,</span> resolution <span class="sign">=</span> res<span class="sign">,</span>
<span class="line_number">3848 </span>        showvalue <span class="sign">=</span> T<span class="sign">,</span> orient <span class="sign">=</span> <span class="quote">"horiz"</span><span class="sign">,</span> variable <span class="sign">=</span> tcliter<span class="sign">,</span> <span class="keyword">length</span> <span class="sign">=</span> 400<span class="sign">)</span>
<span class="line_number">3849 </span>    <span class="comment"># a frame containing the plot type buttons</span>
<span class="line_number">3850 </span>        ff <span class="sign">&lt;</span><span class="sign">-</span> tkframe<span class="sign">(</span>tt<span class="sign">,</span> relief <span class="sign">=</span> <span class="quote">"ridge"</span><span class="sign">,</span> borderwidth <span class="sign">=</span> 2<span class="sign">,</span> width <span class="sign">=</span> 150<span class="sign">,</span> height <span class="sign">=</span> 100<span class="sign">)</span>
<span class="line_number">3851 </span>    <span class="comment"># buttons to select the type of plot desired</span>
<span class="line_number">3852 </span>        which_b_h <span class="sign">&lt;</span><span class="sign">-</span> tkradiobutton<span class="sign">(</span>ff<span class="sign">,</span> command <span class="sign">=</span> setwhich_h<span class="sign">,</span> text <span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">,</span>
<span class="line_number">3853 </span>        variable <span class="sign">=</span> tclwhich<span class="sign">,</span> value <span class="sign">=</span> <span class="quote">"h"</span> <span class="sign">)</span>
<span class="line_number">3854 </span>        which_b_s <span class="sign">&lt;</span><span class="sign">-</span> tkradiobutton<span class="sign">(</span>ff<span class="sign">,</span> command <span class="sign">=</span> setwhich_s<span class="sign">,</span> text <span class="sign">=</span> <span class="quote">"survival"</span><span class="sign">,</span>
<span class="line_number">3855 </span>        variable <span class="sign">=</span> tclwhich<span class="sign">,</span> value <span class="sign">=</span> <span class="quote">"s"</span> <span class="sign">)</span>
<span class="line_number">3856 </span>        which_b_f <span class="sign">&lt;</span><span class="sign">-</span> tkradiobutton<span class="sign">(</span>ff<span class="sign">,</span> command <span class="sign">=</span> setwhich_f<span class="sign">,</span> text <span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">,</span>
<span class="line_number">3857 </span>        variable <span class="sign">=</span> tclwhich<span class="sign">,</span> value <span class="sign">=</span> <span class="quote">"f"</span> <span class="sign">)</span>
<span class="line_number">3858 </span>    <span class="comment"># button to plot the posterior mean of the curve</span>
<span class="line_number">3859 </span>        post_b <span class="sign">&lt;</span><span class="sign">-</span> tkbutton<span class="sign">(</span>tt<span class="sign">,</span> command <span class="sign">=</span> setpost<span class="sign">,</span> text <span class="sign">=</span> <span class="quote">"Posterior"</span> <span class="sign">)</span>
<span class="line_number">3860 </span>    <span class="comment"># layout on the grid</span>
<span class="line_number">3861 </span>        tkgrid<span class="sign">(</span>img<span class="sign">,</span> columnspan <span class="sign">=</span> 2<span class="sign">)</span>
<span class="line_number">3862 </span>        tkgrid<span class="sign">(</span>which_b_h<span class="sign">,</span> which_b_s<span class="sign">,</span> which_b_f<span class="sign">)</span>
<span class="line_number">3863 </span>        tkgrid<span class="sign">(</span>ff<span class="sign">,</span> columnspan <span class="sign">=</span> 2<span class="sign">)</span>
<span class="line_number">3864 </span>        tkgrid<span class="sign">(</span>post_b<span class="sign">,</span> iter_scale<span class="sign">)</span>
<span class="line_number">3865 </span>        tkgrid<span class="sign">.</span>configure<span class="sign">(</span>iter_scale<span class="sign">,</span> sticky <span class="sign">=</span> <span class="quote">"e"</span><span class="sign">)</span>
<span class="line_number">3866 </span>        tkgrid<span class="sign">.</span>configure<span class="sign">(</span>post_b<span class="sign">,</span> sticky <span class="sign">=</span> <span class="quote">"sw"</span><span class="sign">)</span>
<span class="line_number">3867 </span>
<span class="line_number">3868 </span><span class="sign">}</span>
</pre>

<hr />
<a name="S3Methods2fsummary2esplinesurv"></a>
<a name="robo170"></a><h2>S3Methods/summary.splinesurv [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo5">S3Methods</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>summary.splinesurv</strong> --- creates an object of class <strong>summary.splinesurv</strong>
</pre>
<p class="item_name">FUNCTION</p>
<p>    Summarizes a <a href="#robo166">splinesurv</a> fit. See package documentation for details.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3429 </span><strong>summary.splinesurv</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>object<span class="sign">,</span> quantiles <span class="sign">=</span> c<span class="sign">(</span><span class="sign">.</span>025<span class="sign">,</span> <span class="sign">.</span>975<span class="sign">)</span><span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3432 </span><span class="sign">{</span>
<span class="line_number">3433 </span>    x <span class="sign">&lt;</span><span class="sign">-</span> object
<span class="line_number">3434 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3435 </span>    <span class="comment">#  Extract components of the fit that should be included in the summary</span>
<span class="line_number">3436 </span>    out<span class="sign">$</span><span class="keyword">call</span> <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span><span class="keyword">call</span>
<span class="line_number">3437 </span>    out<span class="sign">$</span>coef <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>matrix<span class="sign">(</span>x<span class="sign">$</span>posterior<span class="sign">.</span>mean<span class="sign">$</span>coefficients<span class="sign">,</span> ncol <span class="sign">=</span> 1<span class="sign">)</span>
<span class="line_number">3438 </span>    <span class="keyword">colnames</span><span class="sign">(</span>out<span class="sign">$</span>coef<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"mean"</span>
<span class="line_number">3439 </span>    out<span class="sign">$</span>iter <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>control<span class="sign">$</span>iter
<span class="line_number">3440 </span>    out<span class="sign">$</span>burnin <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>control<span class="sign">$</span>burnin
<span class="line_number">3441 </span>    out<span class="sign">$</span>hazard <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>hazard
<span class="line_number">3442 </span>    out<span class="sign">$</span>frailty <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>frailty
<span class="line_number">3443 </span>    <span class="comment"># compute frailty variance using two estimators:</span>
<span class="line_number">3444 </span>    <span class="comment"># as the mean of the variances of the posterior densities</span>
<span class="line_number">3445 </span>    fvar <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo161">post.fvar</a><span class="sign">(</span>x<span class="sign">,</span> quantiles<span class="sign">)</span>
<span class="line_number">3446 </span>    <span class="comment"># or as the variance of the posterior frailty samples</span>
<span class="line_number">3447 </span>    fvar2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>x<span class="sign">$</span>history<span class="sign">$</span>frailty<span class="sign">[</span><span class="sign">(</span>out<span class="sign">$</span>burnin <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span>out<span class="sign">$</span>iter<span class="sign">,</span> <span class="sign">]</span><span class="sign">,</span> 1<span class="sign">,</span> var<span class="sign">)</span>
<span class="line_number">3448 </span>    out<span class="sign">$</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>fvar <span class="sign">&lt;</span><span class="sign">-</span> fvar<span class="sign">$</span>mean<span class="sign">[</span><span class="quote">"spline.fvar"</span><span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">3449 </span>    out<span class="sign">$</span>frailty<span class="sign">$</span>param<span class="sign">.</span>fvar <span class="sign">&lt;</span><span class="sign">-</span> fvar<span class="sign">$</span>mean<span class="sign">[</span><span class="quote">"param.fvar"</span><span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">3450 </span>    out<span class="sign">$</span>frailty<span class="sign">$</span>fvar <span class="sign">&lt;</span><span class="sign">-</span> fvar<span class="sign">$</span>mean<span class="sign">[</span><span class="quote">"fvar"</span><span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">3451 </span>    out<span class="sign">$</span>frailty<span class="sign">$</span>fvar2 <span class="sign">&lt;</span><span class="sign">-</span> mean<span class="sign">(</span>fvar2<span class="sign">)</span>
<span class="line_number">3452 </span>    out<span class="sign">$</span>posterior<span class="sign">.</span>mean <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>posterior<span class="sign">.</span>mean
<span class="line_number">3453 </span>    out<span class="sign">$</span>quantiles<span class="sign">.</span>coef <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">3454 </span>    <span class="keyword">if</span><span class="sign">(</span>out<span class="sign">$</span>iter <span class="sign">&lt;</span> out<span class="sign">$</span>burnin<span class="sign">)</span> out<span class="sign">$</span>burnin <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">3455 </span>    <span class="comment"># Compute posterior quantiles of regression coefficients</span>
<span class="line_number">3456 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>quantiles<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3457 </span>        goodind <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>out<span class="sign">$</span>burnin <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span>out<span class="sign">$</span>iter<span class="sign">)</span>
<span class="line_number">3458 </span>        goodcoef <span class="sign">&lt;</span><span class="sign">-</span> x<span class="sign">$</span>history<span class="sign">$</span>coefficients<span class="sign">[</span>goodind<span class="sign">,</span> <span class="sign">,</span>drop <span class="sign">=</span> FALSE<span class="sign">]</span>
<span class="line_number">3459 </span>        <span class="keyword">for</span><span class="sign">(</span>q in quantiles<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">3460 </span>            out<span class="sign">$</span>quantiles<span class="sign">.</span>coef <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>out<span class="sign">$</span>quantiles<span class="sign">.</span>coef<span class="sign">,</span> 
<span class="line_number">3461 </span>                <span class="keyword">apply</span><span class="sign">(</span>goodcoef<span class="sign">,</span> 2<span class="sign">,</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">)</span> <span class="keyword">quantile</span><span class="sign">(</span>x<span class="sign">,</span> q<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3462 </span>        <span class="sign">}</span>
<span class="line_number">3463 </span>        <span class="comment"># For presentation, make sure the colnames and rownames are nice</span>
<span class="line_number">3464 </span>        <span class="keyword">colnames</span><span class="sign">(</span>out<span class="sign">$</span>quantiles<span class="sign">.</span>coef<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> paste<span class="sign">(</span>quantiles <span class="sign">*</span> 100<span class="sign">,</span> <span class="quote">"%"</span><span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span>
<span class="line_number">3465 </span>        <span class="keyword">rownames</span><span class="sign">(</span>out<span class="sign">$</span>quantiles<span class="sign">.</span>coef<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rownames</span><span class="sign">(</span>out<span class="sign">$</span>coef<span class="sign">)</span>
<span class="line_number">3466 </span>        out<span class="sign">$</span>quantiles<span class="sign">.</span>fvar <span class="sign">&lt;</span><span class="sign">-</span> fvar<span class="sign">$</span>quantiles
<span class="line_number">3467 </span>        out<span class="sign">$</span>quantiles<span class="sign">.</span>fvar2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">quantile</span><span class="sign">(</span>fvar2<span class="sign">,</span> quantiles<span class="sign">)</span>
<span class="line_number">3468 </span>    <span class="sign">}</span>
<span class="line_number">3469 </span>    <span class="comment"># save the dots for printing parameters</span>
<span class="line_number">3470 </span>    out<span class="sign">$</span>dots <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">list</span><span class="sign">(</span>substitute<span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span><span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">[</span> <span class="sign">-</span> 1<span class="sign">]</span>
<span class="line_number">3471 </span>    class<span class="sign">(</span>out<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"<strong>summary.splinesurv</strong>"</span>   
<span class="line_number">3472 </span>    <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">)</span>
<span class="line_number">3473 </span><span class="sign">}</span>
</pre>

<hr />
<a name="simSurvival2fbs2esurvfn"></a>
<a name="robo171"></a><h2>simSurvival/bs.survfn [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">simSurvival</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>bs.survfn</strong> --- compute survivor function for B-spline hazard
</pre>
<p class="item_name">FUNCTION</p>
<p>   Given a B-spline baseline hazard, either compute the survivor
   function at a set of times, or at a single time.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">563 </span><strong>bs.survfn</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>b<span class="sign">,</span> w<span class="sign">,</span> n<span class="sign">,</span> t <span class="sign">=</span> NULL<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>   b       B-spline basis in the form of bs() output
   w       weights of each basis function
   n       number of intervals to use
   t       time at which to compute survival (whole function if NULL)
</pre>
<p class="item_name">OUTPUTS</p>
<pre>   If t = NULL, the survivor function at n times, else at time t.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">566 </span><span class="sign">{</span>
<span class="line_number">567 </span>    rbound <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>b<span class="sign">,</span> <span class="quote">"Boundary.knots"</span><span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">568 </span>    x <span class="sign">&lt;</span><span class="sign">-</span> seq<span class="sign">(</span>from <span class="sign">=</span> 0<span class="sign">,</span> to <span class="sign">=</span> rbound<span class="sign">,</span> <span class="keyword">length</span> <span class="sign">=</span> n<span class="sign">)</span>
<span class="line_number">569 </span>    h <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>predict<span class="sign">(</span>b<span class="sign">,</span> x<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>w<span class="sign">)</span>
<span class="line_number">570 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>t<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">571 </span>        H <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cumsum</span><span class="sign">(</span>h <span class="sign">*</span> rbound <span class="sign">/</span> n<span class="sign">)</span>
<span class="line_number">572 </span>        S <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span><span class="sign">-</span>H<span class="sign">)</span>
<span class="line_number">573 </span>        <span class="keyword">return</span><span class="sign">(</span>S<span class="sign">)</span>
<span class="line_number">574 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">575 </span>        Ht <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>h<span class="sign">[</span>x <span class="sign">&lt;</span> t<span class="sign">]</span> <span class="sign">*</span> rbound <span class="sign">/</span> n<span class="sign">)</span>
<span class="line_number">576 </span>        St <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span><span class="sign">-</span>Ht<span class="sign">)</span>
<span class="line_number">577 </span>        <span class="keyword">return</span><span class="sign">(</span>St<span class="sign">)</span>
<span class="line_number">578 </span>    <span class="sign">}</span>
<span class="line_number">579 </span><span class="sign">}</span>
</pre>

<hr />
<a name="simSurvival2fdnegbin"></a>
<a name="robo172"></a><h2>simSurvival/dnegbin [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">simSurvival</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>dnegbin</strong> --- negative binomial distribution
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the negative binomial distribution function. This is
    for use as a prior on the number of knots for adaptive selection.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">988 </span><strong>dnegbin</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> r<span class="sign">,</span> p<span class="sign">)</span> 
</pre>
<p class="item_name">INPUTS</p>
<pre>    x  the values at which the distribution should be computed
    r  number of trials
    p  probability of success
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    The NB(r,p) distribution evaluated at x
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">991 </span><span class="sign">{</span>
<span class="line_number">992 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> gamma<span class="sign">(</span>x <span class="sign">+</span> r<span class="sign">)</span> <span class="sign">/</span> factorial<span class="sign">(</span>x<span class="sign">)</span> <span class="sign">/</span> gamma<span class="sign">(</span>r<span class="sign">)</span> <span class="sign">*</span> p<span class="sign">^</span>r <span class="sign">*</span> <span class="sign">(</span>1 <span class="sign">-</span> p<span class="sign">)</span><span class="sign">^</span>x
<span class="line_number">993 </span>    out
<span class="line_number">994 </span><span class="sign">}</span>
</pre>

<hr />
<a name="simSurvival2fgenerateevents"></a>
<a name="robo173"></a><h2>simSurvival/generateevents [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">simSurvival</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>generateevents</strong> --- Generate random event times
</pre>
<p class="item_name">FUNCTION</p>
<p>    Generate a set of random event times for a sample, given its size,
    a single covariate, frailties and regression coefficients.
    Many baseline hazard specifications are supported, see code comments.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">482 </span><strong>generateevents</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> beta<span class="sign">,</span> Ui<span class="sign">,</span> Zij<span class="sign">,</span> type<span class="sign">,</span> params<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m      number of clusters
    Ji     vector of cluster sizes
    beta   a single true regression coefficient
    Ui     length m vector of "true" frailties
    Zij    length sum(Ji) vector of covariates
    type   type of baseline hazard specification
    params parameters for the baseline hazard
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    Tij    length sum(Ji) vector of event times
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">485 </span><span class="sign">{</span>
<span class="line_number">486 </span>    Tij <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">487 </span>    Uij <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>Ui<span class="sign">,</span> Ji<span class="sign">)</span>
<span class="line_number">488 </span>    <span class="comment">#  Weibull baseline hazard, baseline params$lambda0 and shape params$gamweib</span>
<span class="line_number">489 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"weibull"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">490 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>all<span class="sign">(</span>c<span class="sign">(</span><span class="quote">"lambda0"</span><span class="sign">,</span> <span class="quote">"gamweib"</span><span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>names<span class="sign">(</span>params<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"Parameters lambda0, gamweib, w not specified for type weibull"</span><span class="sign">)</span>
<span class="line_number">491 </span>        lambda0 <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>lambda0
<span class="line_number">492 </span>        gamweib <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>gamweib
<span class="line_number">493 </span>        <span class="keyword">for</span><span class="sign">(</span>ind in 1<span class="sign">:</span><span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">494 </span>            Tij<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><span class="sign">(</span><span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span><span class="sign">-</span>beta <span class="sign">*</span> Zij<span class="sign">[</span>ind<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> log<span class="sign">(</span>1 <span class="sign">-</span> runif<span class="sign">(</span>1<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> 
<span class="line_number">495 </span>                <span class="sign">(</span>lambda0 <span class="sign">*</span> Uij<span class="sign">[</span>ind<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">^</span><span class="sign">(</span>1 <span class="sign">/</span> gamweib<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">496 </span>        <span class="sign">}</span>
<span class="line_number">497 </span>    <span class="sign">}</span>
<span class="line_number">498 </span>    <span class="comment">#  stepfunction baseline hazard, with breakpoints at params$breaks and hazards</span>
<span class="line_number">499 </span>    <span class="comment">#  at params$haz</span>
<span class="line_number">500 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"stepfunction"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">501 </span>        breaks <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>breaks
<span class="line_number">502 </span>        haz <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>haz
<span class="line_number">503 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>haz<span class="sign">)</span> <span class="sign">!</span><span class="sign">=</span> <span class="keyword">length</span><span class="sign">(</span>breaks<span class="sign">)</span> <span class="sign">+</span> 1<span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"Step function params: haz should be one longer than breaks"</span><span class="sign">)</span>
<span class="line_number">504 </span>        <span class="keyword">for</span><span class="sign">(</span>ind in 1<span class="sign">:</span><span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">505 </span>            accept <span class="sign">&lt;</span><span class="sign">-</span> FALSE
<span class="line_number">506 </span>            Tijprop <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">507 </span>            maxhaz <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>haz<span class="sign">)</span> <span class="sign">*</span> Uij<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>beta <span class="sign">*</span> Zij<span class="sign">[</span>ind<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">508 </span>            <span class="comment">#  Use accept-reject sampling</span>
<span class="line_number">509 </span>            <span class="keyword">while</span><span class="sign">(</span><span class="sign">!</span>accept<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">510 </span>                Tijprop <span class="sign">&lt;</span><span class="sign">-</span> Tijprop <span class="sign">-</span>1 <span class="sign">/</span> maxhaz <span class="sign">*</span> log<span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">511 </span>                thishaz <span class="sign">&lt;</span><span class="sign">-</span> haz<span class="sign">[</span>findInterval<span class="sign">(</span>Tijprop<span class="sign">,</span> breaks<span class="sign">)</span> <span class="sign">+</span> 1<span class="sign">]</span> <span class="sign">*</span> Uij<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">*</span> 
<span class="line_number">512 </span>                    <span class="keyword">exp</span><span class="sign">(</span>beta <span class="sign">*</span> Zij<span class="sign">[</span>ind<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">513 </span>                <span class="keyword">if</span><span class="sign">(</span>maxhaz <span class="sign">*</span> runif<span class="sign">(</span>1<span class="sign">)</span> <span class="sign">&lt;</span> thishaz<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">514 </span>                    Tij<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Tijprop
<span class="line_number">515 </span>                    accept <span class="sign">&lt;</span><span class="sign">-</span> TRUE
<span class="line_number">516 </span>                <span class="sign">}</span>
<span class="line_number">517 </span>            <span class="sign">}</span>
<span class="line_number">518 </span>        <span class="sign">}</span>
<span class="line_number">519 </span>    <span class="sign">}</span>
<span class="line_number">520 </span>    <span class="comment">#  B-spline baseline hazard. params$b is an object returned by bs(),</span>
<span class="line_number">521 </span>    <span class="comment">#  and params$w is a set of weights</span>
<span class="line_number">522 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"bspline"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">523 </span>        b <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>b
<span class="line_number">524 </span>        w <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>w
<span class="line_number">525 </span>        rbound <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>b<span class="sign">,</span> <span class="quote">"Boundary.knots"</span><span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">526 </span>        survfn <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo171">bs.survfn</a><span class="sign">(</span>b<span class="sign">,</span> w<span class="sign">,</span> 1000<span class="sign">,</span> rbound<span class="sign">)</span>
<span class="line_number">527 </span>        <span class="keyword">if</span><span class="sign">(</span>survfn<span class="sign">&gt;</span><span class="sign">.</span>25<span class="sign">)</span> warning<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"Baseline survival over B - spline support is high:"</span><span class="sign">,</span> 
<span class="line_number">528 </span>            format<span class="sign">(</span>survfn<span class="sign">,</span> digits <span class="sign">=</span> 3<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">529 </span>        <span class="keyword">for</span><span class="sign">(</span>ind in 1<span class="sign">:</span><span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">530 </span>            accept <span class="sign">&lt;</span><span class="sign">-</span> FALSE
<span class="line_number">531 </span>            Tijprop <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">532 </span>            <span class="comment"># Accept-reject sampling</span>
<span class="line_number">533 </span>            <span class="keyword">while</span><span class="sign">(</span><span class="sign">!</span>accept<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">534 </span>                maxhaz <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>w<span class="sign">)</span> <span class="sign">*</span> Uij<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>beta <span class="sign">*</span> Zij<span class="sign">[</span>ind<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">535 </span>                Tijprop <span class="sign">&lt;</span><span class="sign">-</span> Tijprop <span class="sign">-</span>1 <span class="sign">/</span> maxhaz <span class="sign">*</span> log<span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">536 </span>                thishaz <span class="sign">&lt;</span><span class="sign">-</span> predict<span class="sign">(</span>b<span class="sign">,</span> min<span class="sign">(</span>Tijprop<span class="sign">,</span> rbound <span class="sign">-</span> 1e<span class="sign">-</span>5<span class="sign">)</span><span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>w <span class="sign">*</span> Uij<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">*</span> 
<span class="line_number">537 </span>                    <span class="keyword">exp</span><span class="sign">(</span>beta <span class="sign">*</span> Zij<span class="sign">[</span>ind<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">538 </span>                <span class="keyword">if</span><span class="sign">(</span>maxhaz <span class="sign">*</span> runif<span class="sign">(</span>1<span class="sign">)</span> <span class="sign">&lt;</span> thishaz<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">539 </span>                    Tij<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Tijprop
<span class="line_number">540 </span>                    accept <span class="sign">&lt;</span><span class="sign">-</span> TRUE
<span class="line_number">541 </span>                <span class="sign">}</span>
<span class="line_number">542 </span>            <span class="sign">}</span>
<span class="line_number">543 </span>        <span class="sign">}</span>
<span class="line_number">544 </span>    <span class="sign">}</span>
<span class="line_number">545 </span>    <span class="keyword">return</span><span class="sign">(</span>Tij<span class="sign">)</span>
<span class="line_number">546 </span><span class="sign">}</span>
</pre>

<hr />
<a name="simSurvival2fgeneraterandom"></a>
<a name="robo174"></a><h2>simSurvival/generaterandom [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">simSurvival</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>generaterandom</strong> --- Generate random numbers
</pre>
<p class="item_name">FUNCTION</p>
<p>    Generate random numbers from any of the following distributions:
</p>
<pre>     fixed         not random, fixed at a certain value
     weibull       Weibull, parametrized by rate and shape
     gamma         Gamma, parametrized by mean and variance
     normal        Normal, parametrized by mean and variance
     lognormal     Lognormal, parametrized by mean and variance
     normmix       Mixture of normals, parametrized by means, variances and weights
     lognormmix    Mixture of lognormals, parametrized by means, variances and weights
     unifmix       Mixture of uniforms, parametrized by weights and bounds
</pre>
<p></p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">375 </span><strong>generaterandom</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>n<span class="sign">,</span> type<span class="sign">,</span> params<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>     n         number of variates to generate 
     type      string, one of the types above
     params    a list with parameters, which are different for each type. See the code
               for each type
</pre>
<p class="item_name">OUTPUTS</p>
<pre>     out       n random numbers with the specified distribution
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">378 </span><span class="sign">{</span>
<span class="line_number">379 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span><span class="sign">(</span>type<span class="sign">%</span>in<span class="sign">%</span>c<span class="sign">(</span><span class="quote">"fixed"</span><span class="sign">,</span> <span class="quote">"weibull"</span><span class="sign">,</span> <span class="quote">"gamma"</span><span class="sign">,</span> <span class="quote">"normal"</span><span class="sign">,</span> <span class="quote">"lognormal"</span><span class="sign">,</span> <span class="quote">"normmix"</span><span class="sign">,</span>
<span class="line_number">380 </span>            <span class="quote">"lognormmix"</span><span class="sign">,</span> <span class="quote">"unifmix"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"Invalid distribution type"</span><span class="sign">)</span>
<span class="line_number">381 </span>    <span class="comment"># fixed at params$value</span>
<span class="line_number">382 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"fixed"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">383 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span><span class="sign">(</span><span class="quote">"value"</span><span class="sign">%</span>in<span class="sign">%</span>names<span class="sign">(</span>params<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"Parameter value not specified for type fixed"</span><span class="sign">)</span>
<span class="line_number">384 </span>        <span class="keyword">return</span><span class="sign">(</span><span class="keyword">rep</span><span class="sign">(</span>params<span class="sign">$</span>value<span class="sign">,</span> n<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">385 </span>    <span class="sign">}</span>
<span class="line_number">386 </span>    <span class="comment"># weibull with rate params$lambda0 and shape params$gamweib</span>
<span class="line_number">387 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"weibull"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">388 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>all<span class="sign">(</span>c<span class="sign">(</span><span class="quote">"lambda0"</span><span class="sign">,</span> <span class="quote">"gamweib"</span><span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>names<span class="sign">(</span>params<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">389 </span>                stop<span class="sign">(</span><span class="quote">"Parameters lambda0, gamweib not specified for type weibull"</span><span class="sign">)</span>
<span class="line_number">390 </span>        lambda0 <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>lambda0
<span class="line_number">391 </span>        gamweib <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>gamweib
<span class="line_number">392 </span>        <span class="keyword">return</span><span class="sign">(</span>rweibull<span class="sign">(</span>n<span class="sign">,</span> shape <span class="sign">=</span> gamweib<span class="sign">,</span> scale <span class="sign">=</span> lambda0<span class="sign">^</span><span class="sign">(</span><span class="sign">-</span>1 <span class="sign">/</span> gamweib<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">393 </span>    <span class="sign">}</span>
<span class="line_number">394 </span>    <span class="comment"># gamma with mean params$mu and variance params$sigma2</span>
<span class="line_number">395 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"gamma"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">396 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>all<span class="sign">(</span>c<span class="sign">(</span><span class="quote">"mu"</span><span class="sign">,</span> <span class="quote">"sigma2"</span><span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>names<span class="sign">(</span>params<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">397 </span>                stop<span class="sign">(</span><span class="quote">"Parameters mu, sigma2 not specified for type gamma"</span><span class="sign">)</span>
<span class="line_number">398 </span>        mu <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>mu
<span class="line_number">399 </span>        sigma2 <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>sigma2
<span class="line_number">400 </span>        <span class="keyword">return</span><span class="sign">(</span><span class="keyword">rgamma</span><span class="sign">(</span>n<span class="sign">,</span> shape <span class="sign">=</span> mu<span class="sign">^</span>2 <span class="sign">/</span> sigma2<span class="sign">,</span> scale <span class="sign">=</span> sigma2 <span class="sign">/</span> mu<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">401 </span>    <span class="sign">}</span>
<span class="line_number">402 </span>    <span class="comment"># normal with mean params$mu and variance params$sigma2</span>
<span class="line_number">403 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"normal"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">404 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>all<span class="sign">(</span>c<span class="sign">(</span><span class="quote">"mu"</span><span class="sign">,</span> <span class="quote">"sigma2"</span><span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>names<span class="sign">(</span>params<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">405 </span>                stop<span class="sign">(</span><span class="quote">"Parameters mu, sigma2 not specified for type normal"</span><span class="sign">)</span>
<span class="line_number">406 </span>        mu <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>mu
<span class="line_number">407 </span>        sigma2 <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>sigma2
<span class="line_number">408 </span>        <span class="keyword">return</span><span class="sign">(</span><span class="keyword">rnorm</span><span class="sign">(</span>n<span class="sign">,</span> mean <span class="sign">=</span> mu<span class="sign">,</span> sd <span class="sign">=</span> <span class="keyword">sqrt</span><span class="sign">(</span>sigma2<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">409 </span>    <span class="sign">}</span>
<span class="line_number">410 </span>    <span class="comment"># lognormal with mean params$mu and variance params$sigma2</span>
<span class="line_number">411 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"lognormal"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">412 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>all<span class="sign">(</span>c<span class="sign">(</span><span class="quote">"mu"</span><span class="sign">,</span> <span class="quote">"sigma2"</span><span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>names<span class="sign">(</span>params<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">413 </span>                stop<span class="sign">(</span><span class="quote">"Parameters mu, sigma2 not specified for type lognormal"</span><span class="sign">)</span>
<span class="line_number">414 </span>        mu <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>mu
<span class="line_number">415 </span>        sigma2 <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>sigma2
<span class="line_number">416 </span>        sigma2prime <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>1 <span class="sign">+</span> sigma2 <span class="sign">/</span> mu<span class="sign">^</span>2<span class="sign">)</span>        
<span class="line_number">417 </span>        muprime <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>mu<span class="sign">)</span> <span class="sign">-</span> 1 <span class="sign">/</span> 2 <span class="sign">*</span> sigma2prime
<span class="line_number">418 </span>        <span class="keyword">return</span><span class="sign">(</span>rlnorm<span class="sign">(</span>n<span class="sign">,</span> meanlog <span class="sign">=</span> muprime<span class="sign">,</span> sdlog <span class="sign">=</span> <span class="keyword">sqrt</span><span class="sign">(</span>sigma2prime<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">419 </span>    <span class="sign">}</span>
<span class="line_number">420 </span>    <span class="comment"># normal mixture with weights params$w, means params$mu and variances params$sigma2</span>
<span class="line_number">421 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"normmix"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">422 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>all<span class="sign">(</span>c<span class="sign">(</span><span class="quote">"mu"</span><span class="sign">,</span> <span class="quote">"sigma2"</span><span class="sign">,</span> <span class="quote">"w"</span><span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>names<span class="sign">(</span>params<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">423 </span>                stop<span class="sign">(</span><span class="quote">"Parameters mu, sigma2, w not specified for type normmix"</span><span class="sign">)</span>
<span class="line_number">424 </span>        mu <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>mu
<span class="line_number">425 </span>        sigma2 <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>sigma2
<span class="line_number">426 </span>        w <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>w <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span>params<span class="sign">$</span>w<span class="sign">)</span>
<span class="line_number">427 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>w<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> w <span class="sign">=</span> <span class="keyword">rep</span><span class="sign">(</span>w<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>mu<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">428 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>mu<span class="sign">)</span> <span class="sign">!</span><span class="sign">=</span> <span class="keyword">length</span><span class="sign">(</span>sigma2<span class="sign">)</span> <span class="sign">|</span> <span class="keyword">length</span><span class="sign">(</span>mu<span class="sign">)</span> <span class="sign">!</span><span class="sign">=</span> <span class="keyword">length</span><span class="sign">(</span>w<span class="sign">)</span> <span class="sign">|</span>
<span class="line_number">429 </span>                <span class="keyword">length</span><span class="sign">(</span>mu<span class="sign">)</span> <span class="sign">&lt;</span> 2<span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"Bad parameter lengths for type normmix"</span><span class="sign">)</span>
<span class="line_number">430 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo176">MYmvrnorm</a><span class="sign">(</span>n<span class="sign">,</span> mu<span class="sign">,</span> <a href="#robo157">mdiag</a><span class="sign">(</span>sigma2<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">431 </span>        <span class="keyword">return</span><span class="sign">(</span>t<span class="sign">(</span>out<span class="sign">)</span><span class="sign">[</span>findInterval<span class="sign">(</span>runif<span class="sign">(</span>n<span class="sign">)</span><span class="sign">,</span> <span class="keyword">cumsum</span><span class="sign">(</span>w<span class="sign">)</span><span class="sign">)</span> <span class="sign">+</span> 1 <span class="sign">+</span> 0<span class="sign">:</span><span class="sign">(</span>n <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">*</span> <span class="keyword">length</span><span class="sign">(</span>w<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">432 </span>    <span class="sign">}</span>
<span class="line_number">433 </span>    <span class="comment"># lognormal mixture with weights params$w, means params$mu and variances params$sigma2</span>
<span class="line_number">434 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"lognormmix"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">435 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>all<span class="sign">(</span>c<span class="sign">(</span><span class="quote">"mu"</span><span class="sign">,</span> <span class="quote">"sigma2"</span><span class="sign">,</span> <span class="quote">"w"</span><span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>names<span class="sign">(</span>params<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">436 </span>                stop<span class="sign">(</span><span class="quote">"Parameters mu, sigma2, w not specified for type lognormmix"</span><span class="sign">)</span>
<span class="line_number">437 </span>        mu <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>mu
<span class="line_number">438 </span>        sigma2 <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>sigma2
<span class="line_number">439 </span>        w <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>w <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span>params<span class="sign">$</span>w<span class="sign">)</span>
<span class="line_number">440 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>w<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> w <span class="sign">=</span> <span class="keyword">rep</span><span class="sign">(</span>w<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>mu<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">441 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>mu<span class="sign">)</span> <span class="sign">!</span><span class="sign">=</span> <span class="keyword">length</span><span class="sign">(</span>sigma2<span class="sign">)</span> <span class="sign">|</span> <span class="keyword">length</span><span class="sign">(</span>mu<span class="sign">)</span> <span class="sign">!</span><span class="sign">=</span> <span class="keyword">length</span><span class="sign">(</span>w<span class="sign">)</span> <span class="sign">|</span>
<span class="line_number">442 </span>                <span class="keyword">length</span><span class="sign">(</span>mu<span class="sign">)</span> <span class="sign">&lt;</span> 2<span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"Bad parameter lengths for type lognormmix"</span><span class="sign">)</span>
<span class="line_number">443 </span>        sigma2prime <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>1 <span class="sign">+</span> sigma2 <span class="sign">/</span> mu<span class="sign">^</span>2<span class="sign">)</span>        
<span class="line_number">444 </span>        muprime <span class="sign">&lt;</span><span class="sign">-</span> log<span class="sign">(</span>mu<span class="sign">)</span> <span class="sign">-</span> 1 <span class="sign">/</span> 2 <span class="sign">*</span> sigma2prime
<span class="line_number">445 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo176">MYmvrnorm</a><span class="sign">(</span>n<span class="sign">,</span> muprime<span class="sign">,</span> <a href="#robo157">mdiag</a><span class="sign">(</span>sigma2prime<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">446 </span>        <span class="keyword">return</span><span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>t<span class="sign">(</span>out<span class="sign">)</span><span class="sign">[</span>findInterval<span class="sign">(</span>runif<span class="sign">(</span>n<span class="sign">)</span><span class="sign">,</span> <span class="keyword">cumsum</span><span class="sign">(</span>w<span class="sign">)</span><span class="sign">)</span> <span class="sign">+</span> 1 <span class="sign">+</span> 0<span class="sign">:</span><span class="sign">(</span>n <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">*</span> <span class="keyword">length</span><span class="sign">(</span>w<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>   
<span class="line_number">447 </span>    <span class="sign">}</span>
<span class="line_number">448 </span>    <span class="comment"># uniform mixture with weights params$w, bounds params$bounds</span>
<span class="line_number">449 </span>    <span class="keyword">if</span><span class="sign">(</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"unifmix"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">450 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>all<span class="sign">(</span>c<span class="sign">(</span><span class="quote">"w"</span><span class="sign">,</span> <span class="quote">"bounds"</span><span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>names<span class="sign">(</span>params<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">451 </span>                stop<span class="sign">(</span><span class="quote">"Parameters w, bounds not specified for type unifmix"</span><span class="sign">)</span>
<span class="line_number">452 </span>        w <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>w <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span>params<span class="sign">$</span>w<span class="sign">)</span>
<span class="line_number">453 </span>        bounds <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>params<span class="sign">$</span>bounds<span class="sign">,</span> ncol <span class="sign">=</span> 2<span class="sign">,</span> byrow <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">454 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> n<span class="sign">)</span>
<span class="line_number">455 </span>        <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span>n<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">456 </span>            <span class="keyword">which</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>runif<span class="sign">(</span>1<span class="sign">)</span> <span class="sign">&gt;</span> <span class="keyword">cumsum</span><span class="sign">(</span>w<span class="sign">)</span><span class="sign">)</span> <span class="sign">+</span> 1
<span class="line_number">457 </span>            out<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> runif<span class="sign">(</span>1<span class="sign">,</span> bounds<span class="sign">[</span><span class="keyword">which</span><span class="sign">,</span> 1<span class="sign">]</span><span class="sign">,</span> bounds<span class="sign">[</span><span class="keyword">which</span><span class="sign">,</span> 2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">458 </span>        <span class="sign">}</span>
<span class="line_number">459 </span>        <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">)</span>
<span class="line_number">460 </span>    <span class="sign">}</span>
<span class="line_number">461 </span><span class="sign">}</span>
</pre>

<hr />
<a name="simSurvival2fmakeagdata"></a>
<a name="robo175"></a><h2>simSurvival/makeagdata [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">simSurvival</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makeagdata</strong> --- convert simulated data into Anderson-Gill format
</pre>
<p class="item_name">FUNCTION</p>
<p>    Create an Anderson-Gill formatted data frame given a set of
    event times and covariates.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">602 </span><strong>makeagdata</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> Tij<span class="sign">,</span> deltaij<span class="sign">,</span> Zij<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m      number of clusters
    Ji     cluster size
    Tij    event times simulated by <a href="#robo173">generateevents</a>
    deltaij censoring indicators
    Zij    covariates
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    agdata Data frame with columns
       i       cluster indicator
       j       subject ID
       time    event time
       delta   event indicator
       ...     covariate columns
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">605 </span><span class="sign">{</span>
<span class="line_number">606 </span>    agdata <span class="sign">&lt;</span><span class="sign">-</span> data<span class="sign">.</span>frame<span class="sign">(</span>
<span class="line_number">607 </span>        i <span class="sign">=</span> <span class="keyword">rep</span><span class="sign">(</span>1<span class="sign">:</span>m<span class="sign">,</span> Ji<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">608 </span>        j <span class="sign">=</span> c<span class="sign">(</span>sapply<span class="sign">(</span>Ji<span class="sign">,</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>1<span class="sign">:</span>x<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> recursive <span class="sign">=</span> TRUE<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">609 </span>        time <span class="sign">=</span> Tij<span class="sign">,</span>
<span class="line_number">610 </span>        delta <span class="sign">=</span> deltaij
<span class="line_number">611 </span>    <span class="sign">)</span>
<span class="line_number">612 </span>    agdata <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>agdata<span class="sign">,</span> Zij<span class="sign">)</span>
<span class="line_number">613 </span>    <span class="keyword">return</span><span class="sign">(</span>agdata<span class="sign">)</span>  
<span class="line_number">614 </span><span class="sign">}</span>
</pre>

<hr />
<a name="simSurvival2fMYmvrnorm"></a>
<a name="robo176"></a><h2>simSurvival/MYmvrnorm [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">simSurvival</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>MYmvrnorm</strong>  --- multivariate normal random variates
</pre>
<p class="item_name">FUNCTION</p>
<p>    Generate multivariate normal variables. This is a plug-in replacement
    for <a href="../src/mainloop_c.html#robo91">mvrnorm</a> from MASS, but it uses the Cholesky factorization method,
    so that the numbers from the equivalent C routine are identical.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">341 </span><strong>MYmvrnorm</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span> <span class="sign">(</span>n <span class="sign">=</span> 1<span class="sign">,</span> mu<span class="sign">,</span> Sigma<span class="sign">)</span> 
</pre>
<p class="item_name">INPUTS</p>
<pre>    n      number of variables to generate
    mu     mean vector
    Signma covariance matrix
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    A matrix (or vector) of multivariate normal numbers.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">344 </span><span class="sign">{</span>
<span class="line_number">345 </span>    l <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>mu<span class="sign">)</span>
<span class="line_number">346 </span>    candnorm <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span><span class="keyword">rnorm</span><span class="sign">(</span>n <span class="sign">*</span> l<span class="sign">)</span><span class="sign">,</span> nrow <span class="sign">=</span> n<span class="sign">)</span>
<span class="line_number">347 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> candnorm<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>chol<span class="sign">(</span>Sigma<span class="sign">,</span> pivot <span class="sign">=</span> TRUE<span class="sign">)</span>
<span class="line_number">348 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> out <span class="sign">+</span> <span class="keyword">rep</span><span class="sign">(</span>mu<span class="sign">,</span> <span class="keyword">rep</span><span class="sign">(</span>n<span class="sign">,</span> l<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">349 </span>    <span class="keyword">if</span><span class="sign">(</span>n <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> out <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>numeric<span class="sign">(</span>out<span class="sign">)</span>
<span class="line_number">350 </span>    out
<span class="line_number">351 </span><span class="sign">}</span>
</pre>

<hr />
<a name="simSurvival2frinvgamma"></a>
<a name="robo177"></a><h2>simSurvival/rinvgamma [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">simSurvival</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>rinvgamma</strong> --- generate inverse-gamma random variates
</pre>
<p class="item_name">FUNCTION</p>
<p>    Generate inverse-gamma random numbers
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">966 </span><strong>rinvgamma</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>n<span class="sign">,</span> shape<span class="sign">,</span> scale <span class="sign">=</span> 1<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    n      number of variates to generate
    shape  shape parameter
    scale  scale parameter
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    n inverse-gamma random numbers
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">969 </span><span class="sign">{</span>
<span class="line_number">970 </span>
<span class="line_number">971 </span>    <span class="keyword">return</span><span class="sign">(</span>1 <span class="sign">/</span> <span class="keyword">rgamma</span><span class="sign">(</span>n<span class="sign">,</span> shape<span class="sign">,</span> rate <span class="sign">=</span> scale<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">972 </span><span class="sign">}</span> 
</pre>

<hr />
<a name="simSurvival2fsim2esample"></a>
<a name="robo178"></a><h2>simSurvival/sim.sample [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">simSurvival</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>sim.sample</strong> --- main simulation function
</pre>
<p class="item_name">FUNCTION</p>
<p>    Generate a simulated sample of survival data
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">641 </span><strong>sim.sample</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m <span class="sign">=</span> 10<span class="sign">,</span> Ji <span class="sign">=</span> <span class="keyword">rep</span><span class="sign">(</span>5<span class="sign">,</span> 10<span class="sign">)</span><span class="sign">,</span> params <span class="sign">=</span> NULL<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m      number of clusters
    Ji     cluster size
    params a list with multiple optional components. If any
           of these is not given, defaults are used.
       beta        "true" regression coefficient
       haz.type    type of baseline hazard (see <a href="#robo173">generateevents</a>)
       haz.params  parameters for baseline hazard
       frail.type  type of frailty distribution (see <a href="#robo174">generaterandom</a>)
       frail.params    parameters for frailty
       Z.type      type of covariate
       Z.params    params for covariate
       C.type      type of censoring process
       C.params    params for censoring
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    agdata     An A-G data frame containing a simulated sample
    Ui         "true" frailties for the sample
    params     parameters used to generate the sample
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">644 </span><span class="sign">{</span>
<span class="line_number">645 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>Ji<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> Ji <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>Ji<span class="sign">,</span> m<span class="sign">)</span>
<span class="line_number">646 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>Ji<span class="sign">)</span> <span class="sign">!</span><span class="sign">=</span> m<span class="sign">)</span> stop<span class="sign">(</span><span class="quote">"Length of Ji does not match m"</span><span class="sign">)</span>
<span class="line_number">647 </span>    params<span class="sign">.</span>in <span class="sign">&lt;</span><span class="sign">-</span> params
<span class="line_number">648 </span>    <span class="comment">#   Default parameters</span>
<span class="line_number">649 </span>    params<span class="sign">.</span>default <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>
<span class="line_number">650 </span>        beta <span class="sign">=</span> 1<span class="sign">,</span>
<span class="line_number">651 </span>        haz<span class="sign">.</span>type <span class="sign">=</span> <span class="quote">"weibull"</span><span class="sign">,</span>
<span class="line_number">652 </span>        haz<span class="sign">.</span>params <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>lambda0 <span class="sign">=</span> 1<span class="sign">,</span> gamweib <span class="sign">=</span> 1<span class="sign">.</span>8<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">653 </span>        frail<span class="sign">.</span>type <span class="sign">=</span> <span class="quote">"lognormal"</span><span class="sign">,</span>
<span class="line_number">654 </span>        frail<span class="sign">.</span>params <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>mu <span class="sign">=</span> 1<span class="sign">,</span> sigma2<span class="sign">=</span><span class="sign">.</span>25<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">655 </span>        Z<span class="sign">.</span>type <span class="sign">=</span> <span class="quote">"normal"</span><span class="sign">,</span>
<span class="line_number">656 </span>        Z<span class="sign">.</span>params <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>mu <span class="sign">=</span> 0<span class="sign">,</span> sigma2 <span class="sign">=</span> 1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">657 </span>        C<span class="sign">.</span>type <span class="sign">=</span> <span class="quote">"weibull"</span><span class="sign">,</span>
<span class="line_number">658 </span>        C<span class="sign">.</span>params <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>lambda0 <span class="sign">=</span> 1<span class="sign">,</span> gamweib <span class="sign">=</span> 1<span class="sign">.</span>8<span class="sign">)</span>
<span class="line_number">659 </span>    <span class="sign">)</span>
<span class="line_number">660 </span>    params <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">.</span>default
<span class="line_number">661 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>params<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">662 </span>        <span class="keyword">for</span><span class="sign">(</span>n in names<span class="sign">(</span>params<span class="sign">.</span>in<span class="sign">)</span><span class="sign">)</span> eval<span class="sign">(</span>parse<span class="sign">(</span>text <span class="sign">=</span> paste<span class="sign">(</span><span class="quote">"params$"</span><span class="sign">,</span> n<span class="sign">,</span> <span class="quote">" &lt;- params.in$"</span><span class="sign">,</span> 
<span class="line_number">663 </span>            n<span class="sign">,</span> sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">664 </span>        <span class="keyword">if</span><span class="sign">(</span>params<span class="sign">.</span>in<span class="sign">$</span>haz<span class="sign">.</span>type <span class="sign">=</span><span class="sign">=</span> <span class="quote">"bspline"</span> <span class="sign">&amp;</span> is<span class="sign">.</span>null<span class="sign">(</span>params<span class="sign">.</span>in<span class="sign">$</span>haz<span class="sign">.</span>params<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">665 </span>            tmax <span class="sign">=</span> 3<span class="sign">;</span>
<span class="line_number">666 </span>            N <span class="sign">=</span> 4
<span class="line_number">667 </span>            b <span class="sign">&lt;</span><span class="sign">-</span> bs<span class="sign">(</span>0<span class="sign">,</span> knots <span class="sign">=</span> seq<span class="sign">(</span>from <span class="sign">=</span> 0<span class="sign">,</span> to <span class="sign">=</span> tmax<span class="sign">,</span> <span class="keyword">length</span> <span class="sign">=</span> N <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">[</span> <span class="sign">-</span> <span class="sign">(</span>N <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> 
<span class="line_number">668 </span>                Boundary<span class="sign">.</span>knots <span class="sign">=</span> c<span class="sign">(</span>0<span class="sign">,</span> 2<span class="sign">)</span><span class="sign">,</span> degree <span class="sign">=</span> 3<span class="sign">)</span>
<span class="line_number">669 </span>            w <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="sign">.</span>3<span class="sign">,</span> <span class="sign">.</span>2<span class="sign">,</span> <span class="sign">.</span>4<span class="sign">,</span> <span class="sign">.</span>2<span class="sign">,</span> <span class="sign">.</span>6<span class="sign">,</span> <span class="sign">.</span>8<span class="sign">,</span> 1<span class="sign">)</span> <span class="sign">*</span> 4
<span class="line_number">670 </span>            params<span class="sign">$</span>haz<span class="sign">.</span>params <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>b <span class="sign">=</span> b<span class="sign">,</span> w <span class="sign">=</span> w<span class="sign">)</span>
<span class="line_number">671 </span>        <span class="sign">}</span>
<span class="line_number">672 </span>    <span class="sign">}</span>
<span class="line_number">673 </span>    <span class="comment"># Make covariates</span>
<span class="line_number">674 </span>    Zij <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo174">generaterandom</a><span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">,</span> params<span class="sign">$</span>Z<span class="sign">.</span>type<span class="sign">,</span> params<span class="sign">$</span>Z<span class="sign">.</span>params<span class="sign">)</span>
<span class="line_number">675 </span>    <span class="comment"># Make censoring</span>
<span class="line_number">676 </span>    Cij <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo174">generaterandom</a><span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">,</span> params<span class="sign">$</span>C<span class="sign">.</span>type<span class="sign">,</span> params<span class="sign">$</span>C<span class="sign">.</span>params<span class="sign">)</span>
<span class="line_number">677 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>is<span class="sign">.</span>null<span class="sign">(</span>params<span class="sign">$</span>C<span class="sign">.</span>max<span class="sign">)</span><span class="sign">)</span> Cij<span class="sign">[</span>Cij <span class="sign">&gt;</span> params<span class="sign">$</span>C<span class="sign">.</span>max<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> params<span class="sign">$</span>C<span class="sign">.</span>max
<span class="line_number">678 </span>    <span class="comment"># Make frailties</span>
<span class="line_number">679 </span>    Ui <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo174">generaterandom</a><span class="sign">(</span>m<span class="sign">,</span> params<span class="sign">$</span>frail<span class="sign">.</span>type<span class="sign">,</span> params<span class="sign">$</span>frail<span class="sign">.</span>params<span class="sign">)</span>
<span class="line_number">680 </span>    <span class="comment"># Make event times</span>
<span class="line_number">681 </span>    Tij <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo173">generateevents</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> params<span class="sign">$</span>beta<span class="sign">,</span> Ui<span class="sign">,</span> Zij<span class="sign">,</span> params<span class="sign">$</span>haz<span class="sign">.</span>type<span class="sign">,</span> params<span class="sign">$</span>haz<span class="sign">.</span>params<span class="sign">)</span>
<span class="line_number">682 </span>    <span class="comment"># Make event indicators</span>
<span class="line_number">683 </span>    deltaij <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>numeric<span class="sign">(</span>Tij <span class="sign">&lt;</span> Cij<span class="sign">)</span>
<span class="line_number">684 </span>    <span class="comment"># apply censoring</span>
<span class="line_number">685 </span>    Tij<span class="sign">[</span>deltaij <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Cij<span class="sign">[</span>deltaij <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">]</span>
<span class="line_number">686 </span>    
<span class="line_number">687 </span>    <span class="comment"># make output data frame</span>
<span class="line_number">688 </span>    agdata <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo175">makeagdata</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> Tij<span class="sign">,</span> deltaij<span class="sign">,</span> data<span class="sign">.</span>frame<span class="sign">(</span>Z <span class="sign">=</span> Zij<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">689 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>agdata <span class="sign">=</span> agdata<span class="sign">,</span> Ui <span class="sign">=</span> Ui<span class="sign">,</span> params <span class="sign">=</span> params<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">690 </span><span class="sign">}</span>
</pre>

<hr />
<a name="splineUtils2fevalBinte"></a>
<a name="robo179"></a><h2>splineUtils/evalBinte [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>evalBinte</strong> --- compute the integrals of each spline basis function
</pre>
<p class="item_name">FUNCTION</p>
<p>    The set of spline basis functions are defined entirely by the set of knots
    and the order of the spline. This function computes the integral of each of 
    those basis functions, which is used for normalizing the frailty basis splines
    and for computing cumulative integrals for the hazard.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1293 </span><strong>evalBinte</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    knots  a set of spline knots as produced by <a href="#robo123">makeknots</a>
    ord    integer order of the spline
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    a vector containing the integral over each spline basis function
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1296 </span><span class="sign">{</span>
<span class="line_number">1297 </span>    K <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>knots <span class="sign">&gt;</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span> <span class="sign">&amp;</span> knots <span class="sign">&lt;</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1298 </span>    Binte <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">)</span>
<span class="line_number">1299 </span>    <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span><span class="sign">(</span>K <span class="sign">+</span> ord<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1300 </span>        Binte<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j<span class="sign">)</span><span class="sign">]</span> <span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j <span class="sign">-</span> ord<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> ord
<span class="line_number">1301 </span>    <span class="sign">}</span>
<span class="line_number">1302 </span>    <span class="keyword">return</span><span class="sign">(</span>Binte<span class="sign">)</span>
<span class="line_number">1303 </span><span class="sign">}</span>
</pre>

<hr />
<a name="splineUtils2fevalCinte"></a>
<a name="robo180"></a><h2>splineUtils/evalCinte [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>evalCinte</strong> --- compute partial integrals over the spline basis
</pre>
<p class="item_name">FUNCTION</p>
<p>    In order to compute the cumulative baseline hazard, the integral of each spline
    basis function from 0 to each observation must be computed.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1321 </span><strong>evalCinte</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">,</span> obs<span class="sign">,</span> Binte<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    knots      a set of spline knots as output by <a href="#robo123">makeknots</a>
    ord        integer spline order
    obs        vector of observations at which the integrals should be evaluated
    Binte      basis function integrals produced by <a href="#robo179">evalBinte</a>
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    a matrix of size length(obs) x N (where N is the number of basis functions)
    containing in entry (i,j) the integral of basis function j from 0 to obs[i]
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1324 </span><span class="sign">{</span>
<span class="line_number">1325 </span>    K <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>knots <span class="sign">&gt;</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span> <span class="sign">&amp;</span> knots <span class="sign">&lt;</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1326 </span>    Cinte <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>obs<span class="sign">)</span><span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">)</span>
<span class="line_number">1327 </span>    <span class="comment"># Compute a spline basis of order ord+1</span>
<span class="line_number">1328 </span>    knots2 <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> knots<span class="sign">,</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1329 </span>    attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"i"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>min<span class="sign">(</span>attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"i"</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> 1<span class="sign">,</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"i"</span><span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">1330 </span>        max<span class="sign">(</span>attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"i"</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">+</span> 1<span class="sign">)</span>
<span class="line_number">1331 </span>    attr<span class="sign">(</span>knots2<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span>
<span class="line_number">1332 </span>    Bordp1 <span class="sign">&lt;</span><span class="sign">-</span> splineDesign<span class="sign">(</span>knots2<span class="sign">,</span> x <span class="sign">=</span> obs<span class="sign">,</span> outer<span class="sign">.</span>ok <span class="sign">=</span> TRUE<span class="sign">,</span> ord <span class="sign">=</span> ord <span class="sign">+</span> 1<span class="sign">)</span>
<span class="line_number">1333 </span>    <span class="comment"># compute the integrals</span>
<span class="line_number">1334 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>obs<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1335 </span>        <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span><span class="sign">(</span>K <span class="sign">+</span> ord<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1336 </span>            <span class="comment"># If obs is greater than the rightmost support point, return the full integral</span>
<span class="line_number">1337 </span>            <span class="keyword">if</span><span class="sign">(</span>obs<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&gt;</span><span class="sign">=</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span> Cinte<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Binte<span class="sign">[</span>j<span class="sign">]</span>
<span class="line_number">1338 </span>            <span class="comment"># otherwise use the formula for the partial integral</span>
<span class="line_number">1339 </span>            <span class="keyword">if</span><span class="sign">(</span>obs<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j<span class="sign">)</span><span class="sign">]</span> <span class="sign">&amp;</span> obs<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&gt;</span><span class="sign">=</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j <span class="sign">-</span> ord<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span> 
<span class="line_number">1340 </span>                Cinte<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Binte<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">*</span> <span class="keyword">sum</span><span class="sign">(</span>Bordp1<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">(</span>j <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span>K <span class="sign">+</span> ord <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1341 </span>        <span class="sign">}</span>
<span class="line_number">1342 </span>    <span class="sign">}</span>
<span class="line_number">1343 </span>    <span class="keyword">return</span><span class="sign">(</span>Cinte<span class="sign">)</span>
<span class="line_number">1344 </span><span class="sign">}</span>
</pre>

<hr />
<a name="splineUtils2fevalEinte"></a>
<a name="robo181"></a><h2>splineUtils/evalEinte [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>evalEinte</strong> --- compute the expected distance from 1 of a B-spline
</pre>
<p class="item_name">FUNCTION</p>
<p>    Since the frailty density must have mean 1, it is important to be able to 
    compute the difference between 1 and the frailty density mean. This function
    calculates the expected values of a set of normalized B-spline basis functions
    and subtracts them from 1. The difference between 1 and the frailty mean is then
</p>
<pre>       curve$spline.basisexp%*%exp(curve$spline.par)
</pre>
<p>    where the former is the output of this function and the latter is the set of
    spline weights.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1364 </span><strong>evalEinte</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    knots      a set of spline knots as output by <a href="#robo123">makeknots</a>
    ord        integer spline order
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    a vector containing one minus the expectation of each of the normalized basis functions
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1367 </span><span class="sign">{</span>
<span class="line_number">1368 </span>    K <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>knots <span class="sign">&gt;</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span> <span class="sign">&amp;</span> knots <span class="sign">&lt;</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"b"</span><span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1369 </span>    Einte <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> K <span class="sign">+</span> ord<span class="sign">)</span>
<span class="line_number">1370 </span>    <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span><span class="sign">(</span>K <span class="sign">+</span> ord<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1371 </span>        <span class="comment"># Einte[j] contains the 1st moment of the j-th spline of order ord defined</span>
<span class="line_number">1372 </span>        <span class="comment"># on a given set of knots</span>
<span class="line_number">1373 </span>        Einte<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo186">nBsmom</a><span class="sign">(</span>1<span class="sign">,</span> ord<span class="sign">,</span> j<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">1374 </span>    <span class="sign">}</span>
<span class="line_number">1375 </span>    <span class="keyword">return</span><span class="sign">(</span>1 <span class="sign">-</span> Einte<span class="sign">)</span>
<span class="line_number">1376 </span><span class="sign">}</span>
</pre>

<hr />
<a name="splineUtils2ffrailtysplinefvar"></a>
<a name="robo182"></a><h2>splineUtils/frailtysplinefvar [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>frailtysplinefvar</strong> --- compute the spline component frailty variance
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the variance of the frailty density specified by a curve's spline component.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1885 </span><strong>frailtysplinefvar</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>frailty<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    frailty    an <a href="#robo26">RCurve</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    fvar       variance of the distribution specified by the frailty curve    
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1888 </span><span class="sign">{</span>
<span class="line_number">1889 </span>    <span class="comment"># compute the second moment of the frailty</span>
<span class="line_number">1890 </span>    moment2 <span class="sign">=</span> 1 <span class="sign">-</span> <a href="../src/init_c.html#robo98">cevalEinte</a><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">,</span> frailty<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">,</span> 2<span class="sign">)</span>
<span class="line_number">1891 </span>    moment2 <span class="sign">&lt;</span><span class="sign">-</span> drop<span class="sign">(</span>moment2<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>drop<span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1892 </span>    <span class="comment"># normalize</span>
<span class="line_number">1893 </span>    moment2 <span class="sign">&lt;</span><span class="sign">-</span> moment2 <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>frailty<span class="sign">$</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1894 </span>    <span class="comment"># subtract the mean</span>
<span class="line_number">1895 </span>    fvar <span class="sign">&lt;</span><span class="sign">-</span> moment2 <span class="sign">-</span> 1
<span class="line_number">1896 </span>    <span class="keyword">return</span><span class="sign">(</span>fvar<span class="sign">)</span>
<span class="line_number">1897 </span><span class="sign">}</span>
</pre>

<hr />
<a name="splineUtils2fki"></a>
<a name="robo183"></a><h2>splineUtils/ki [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>ki</strong> --- addressing of spline indices
</pre>
<p class="item_name">FUNCTION</p>
<p>    allows addressing spline parameters by their "true" indices (which can be negative)
    rather than by their vector indices
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1276 </span><strong>ki</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>knots<span class="sign">,</span> j<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>j <span class="sign">+</span> attr<span class="sign">(</span>knots<span class="sign">,</span> <span class="quote">"ord"</span><span class="sign">)</span><span class="sign">)</span>
</pre>

<hr />
<a name="splineUtils2fmakesplinebasis"></a>
<a name="robo184"></a><h2>splineUtils/makesplinebasis [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makesplinebasis</strong> --- construct B-spline basis functions
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the spline.basis, spline.basiscum and spline.basisexp components of an
    <a href="#robo26">RCurve</a> with a spline component.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1235 </span><strong>makesplinebasis</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>curve<span class="sign">,</span> quick <span class="sign">=</span> FALSE<span class="sign">,</span> usec <span class="sign">=</span> TRUE<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> structure
    quick      if TRUE, only the basis itself is computed, not the other two components
    usec       boolean, whether to use C code for fast computation
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    curve      an <a href="#robo26">RCurve</a> with updated spline.basis, spline.basisint,
               spline.basiscum and spline.basisexp components
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1238 </span><span class="sign">{</span>
<span class="line_number">1239 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>curve<span class="sign">$</span><a href="#robo155">hasspline</a><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1240 </span>    knots <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>knots<span class="sign">;</span> ord <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>spline<span class="sign">.</span>ord<span class="sign">;</span> x <span class="sign">&lt;</span><span class="sign">-</span> curve<span class="sign">$</span>x
<span class="line_number">1241 </span>    <span class="comment"># Evaluate the spline basis at the set of x values of the curve</span>
<span class="line_number">1242 </span>    <span class="keyword">if</span><span class="sign">(</span>usec<span class="sign">)</span> B <span class="sign">&lt;</span><span class="sign">-</span> <a href="../src/init_c.html#robo102">csplinedesign</a><span class="sign">(</span>knots<span class="sign">,</span> x <span class="sign">=</span> x<span class="sign">,</span> ord <span class="sign">=</span> ord<span class="sign">)</span> <span class="keyword">else</span> 
<span class="line_number">1243 </span>        B <span class="sign">&lt;</span><span class="sign">-</span> splineDesign<span class="sign">(</span>knots<span class="sign">,</span> x <span class="sign">=</span> x<span class="sign">,</span> ord <span class="sign">=</span> ord<span class="sign">)</span>
<span class="line_number">1244 </span>    <span class="comment"># Compute the integral of each of the basis functions</span>
<span class="line_number">1245 </span>    <span class="keyword">if</span><span class="sign">(</span>usec<span class="sign">)</span> Bint <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo112">cevalBinte</a><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">)</span> <span class="keyword">else</span> Bint <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo179">evalBinte</a><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">)</span>
<span class="line_number">1246 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>norm<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>B<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span> B<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> B<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">/</span> Bint
<span class="line_number">1247 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>quick<span class="sign">)</span> <span class="sign">{</span> 
<span class="line_number">1248 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"hazard"</span><span class="sign">)</span>  <span class="sign">{</span>
<span class="line_number">1249 </span>            <span class="comment">#  compute cumulative integrals of each basis function to the x values</span>
<span class="line_number">1250 </span>            <span class="keyword">if</span> <span class="sign">(</span>usec<span class="sign">)</span> C <span class="sign">&lt;</span><span class="sign">-</span> <a href="../src/init_c.html#robo95">cevalCinte</a><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">,</span> x<span class="sign">,</span> Bint<span class="sign">)</span>
<span class="line_number">1251 </span>            <span class="keyword">else</span> C <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo180">evalCinte</a><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">,</span> x<span class="sign">,</span> Bint<span class="sign">)</span>
<span class="line_number">1252 </span>        <span class="sign">}</span>
<span class="line_number">1253 </span>        <span class="keyword">else</span> C <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">1254 </span>        <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>name <span class="sign">=</span><span class="sign">=</span> <span class="quote">"frailty"</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">1255 </span>            <span class="comment"># compute one minus the expectation over each of the basis functions</span>
<span class="line_number">1256 </span>            <span class="keyword">if</span><span class="sign">(</span>usec<span class="sign">)</span> E <span class="sign">&lt;</span><span class="sign">-</span> <a href="../src/init_c.html#robo98">cevalEinte</a><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">)</span>
<span class="line_number">1257 </span>            <span class="keyword">else</span> E <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo181">evalEinte</a><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">)</span>
<span class="line_number">1258 </span>        <span class="sign">}</span>
<span class="line_number">1259 </span>        <span class="keyword">else</span> E <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">1260 </span>        curve<span class="sign">$</span>spline<span class="sign">.</span>basiscum <span class="sign">&lt;</span><span class="sign">-</span> C
<span class="line_number">1261 </span>        curve<span class="sign">$</span>spline<span class="sign">.</span>basisexp <span class="sign">&lt;</span><span class="sign">-</span> E
<span class="line_number">1262 </span>    <span class="sign">}</span>
<span class="line_number">1263 </span>    curve<span class="sign">$</span>spline<span class="sign">.</span>basisint <span class="sign">&lt;</span><span class="sign">-</span> Bint
<span class="line_number">1264 </span>    curve<span class="sign">$</span>spline<span class="sign">.</span>basis <span class="sign">&lt;</span><span class="sign">-</span> B
<span class="line_number">1265 </span>    <span class="keyword">return</span><span class="sign">(</span>curve<span class="sign">)</span>
<span class="line_number">1266 </span><span class="sign">}</span>
</pre>

<hr />
<a name="splineUtils2fmysplineDesign"></a>
<a name="robo185"></a><h2>splineUtils/mysplineDesign [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mysplineDesign</strong> --- works like splineDesign()
</pre>
<p class="item_name">FUNCTION</p>
<p>    a plug-in replacement for splineDesign() in the splines package. It calls the
    same internal code, but skips the input error checking and reformatting. This should
    only be called with known-good input.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1521 </span><strong>mysplineDesign</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span> <span class="sign">(</span>knots<span class="sign">,</span> x<span class="sign">,</span> ord <span class="sign">=</span> 4<span class="sign">)</span> 
</pre>
<p class="item_name">INPUTS</p>
<pre>    knots  knots in the format required by splineDesign
    x      set of observations at which the basis should be evaluated
    ord    spline order
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    a spline basis matrix in which entry (i,j) contains the j-th basis function
    evaluated at x[i]
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1524 </span><span class="sign">{</span>
<span class="line_number">1525 </span>    nk <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>knots<span class="sign">)</span>
<span class="line_number">1526 </span>    x <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>numeric<span class="sign">(</span>x<span class="sign">)</span>
<span class="line_number">1527 </span>    derivs <span class="sign">&lt;</span><span class="sign">-</span> integer<span class="sign">(</span>1<span class="sign">)</span>
<span class="line_number">1528 </span>    <span class="comment"># call the internal function used by splineDesign()</span>
<span class="line_number">1529 </span>    temp <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span><span class="keyword">Call</span><span class="sign">(</span><span class="quote">"spline_basis"</span><span class="sign">,</span> knots<span class="sign">,</span> ord<span class="sign">,</span> x<span class="sign">,</span> derivs<span class="sign">,</span> PACKAGE <span class="sign">=</span> <span class="quote">"splines"</span><span class="sign">)</span>
<span class="line_number">1530 </span>    ncoef <span class="sign">&lt;</span><span class="sign">-</span> nk <span class="sign">-</span> ord
<span class="line_number">1531 </span>    design <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> ncoef<span class="sign">)</span>
<span class="line_number">1532 </span>    jj <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">:</span>ord <span class="sign">+</span> attr<span class="sign">(</span>temp<span class="sign">,</span> <span class="quote">"Offsets"</span><span class="sign">)</span>
<span class="line_number">1533 </span>    design<span class="sign">[</span>jj<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> temp
<span class="line_number">1534 </span>    <span class="keyword">dim</span><span class="sign">(</span>design<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>1<span class="sign">,</span> ncoef<span class="sign">)</span>
<span class="line_number">1535 </span>    design
<span class="line_number">1536 </span><span class="sign">}</span>
</pre>

<hr />
<a name="splineUtils2fnBsmom"></a>
<a name="robo186"></a><h2>splineUtils/nBsmom [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>nBsmom</strong> --- compute the N-th moment of a B-spline basis function
</pre>
<p class="item_name">FUNCTION</p>
<p>    Computes the N-th moment of the j-th B-spline basis function of order ord defined
    on the given set of knots.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1393 </span><strong>nBsmom</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>N<span class="sign">,</span> ord<span class="sign">,</span> j<span class="sign">,</span> knots<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    N       moment to compute
    ord     order of the spline
    j       which basis function to compute the moment for
    knots   set of knots to use
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    double, containing the N-th B-spline moment
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1396 </span><span class="sign">{</span>
<span class="line_number">1397 </span>    lknot <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j <span class="sign">-</span> ord<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1398 </span>    rknot <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1399 </span>    <span class="keyword">if</span><span class="sign">(</span>lknot <span class="sign">=</span><span class="sign">=</span> rknot<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>rknot<span class="sign">^</span>N<span class="sign">)</span>
<span class="line_number">1400 </span>    <span class="comment"># This is a magic recursive formula that can be computed easily using integration</span>
<span class="line_number">1401 </span>    <span class="comment"># by parts</span>
<span class="line_number">1402 </span>    <span class="keyword">return</span><span class="sign">(</span>ord <span class="sign">/</span> <span class="sign">(</span>rknot <span class="sign">-</span> lknot<span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>N <span class="sign">+</span> 1<span class="sign">)</span> <span class="sign">*</span> <span class="sign">(</span><span class="sign">-</span><strong>nBsmom</strong><span class="sign">(</span>N <span class="sign">+</span> 1<span class="sign">,</span> ord <span class="sign">-</span> 1<span class="sign">,</span> j <span class="sign">-</span> 1<span class="sign">,</span> knots<span class="sign">)</span> <span class="sign">+</span> 
<span class="line_number">1403 </span>        <strong>nBsmom</strong><span class="sign">(</span>N <span class="sign">+</span> 1<span class="sign">,</span> ord <span class="sign">-</span> 1<span class="sign">,</span> j<span class="sign">,</span> knots<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1404 </span><span class="sign">}</span>
</pre>

<hr />
<a name="splineUtils2fnknotsPrior"></a>
<a name="robo187"></a><h2>splineUtils/nknotsPrior [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>nknotsPrior</strong> --- evaluate the prior on the number of knots
</pre>
<p class="item_name">FUNCTION</p>
<p>    In the course of RJMCMC for selecting the number of knots, the prior probability
    of a given number of knots must be evaluated.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1108 </span><strong>nknotsPrior</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> curve<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    x      number of knots at which to evaluate the prior
    curve  an <a href="#robo26">RCurve</a> structure, with spline.nknots.prior and spline.nknots.hyper components
</pre>
<p class="item_name">OUTPUTS</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1111 </span><span class="sign">{</span>
<span class="line_number">1112 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poisson"</span><span class="sign">)</span>
<span class="line_number">1113 </span>        <span class="keyword">return</span><span class="sign">(</span>dpois<span class="sign">(</span>x<span class="sign">,</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1114 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"geometric"</span><span class="sign">)</span>
<span class="line_number">1115 </span>        <span class="keyword">return</span><span class="sign">(</span>dgeom<span class="sign">(</span>x<span class="sign">,</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1116 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"poissonmix"</span><span class="sign">)</span>
<span class="line_number">1117 </span>        <span class="keyword">return</span><span class="sign">(</span>mean<span class="sign">(</span>dpois<span class="sign">(</span>x<span class="sign">,</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1118 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"negbin"</span><span class="sign">)</span>
<span class="line_number">1119 </span>        <span class="keyword">return</span><span class="sign">(</span><a href="#robo172">dnegbin</a><span class="sign">(</span>x<span class="sign">,</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1120 </span>    <span class="keyword">if</span><span class="sign">(</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>prior <span class="sign">=</span><span class="sign">=</span> <span class="quote">"power"</span><span class="sign">)</span>
<span class="line_number">1121 </span>        <span class="keyword">return</span><span class="sign">(</span>x<span class="sign">^</span>curve<span class="sign">$</span>spline<span class="sign">.</span>nknots<span class="sign">.</span>hyper<span class="sign">)</span>
<span class="line_number">1122 </span><span class="sign">}</span>
</pre>

<hr />
<a name="splineUtils2fplotspline"></a>
<a name="robo188"></a><h2>splineUtils/plotspline [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>plotspline</strong> --- plot a spline given a set of knots and parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Create a plot of a spline curve, optionally plotting knots and component
    splines
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">281 </span><strong>plotspline</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>knots<span class="sign">,</span> theta<span class="sign">,</span> ord<span class="sign">,</span> npoints <span class="sign">=</span> 1000<span class="sign">,</span> plotknots <span class="sign">=</span> T<span class="sign">,</span> plotmean <span class="sign">=</span> F<span class="sign">,</span>
<span class="line_number">282 </span>        plotsplines <span class="sign">=</span> F<span class="sign">,</span> norm <span class="sign">=</span> F<span class="sign">,</span> xlim <span class="sign">=</span> NULL<span class="sign">,</span> ylim <span class="sign">=</span> NULL<span class="sign">,</span> col <span class="sign">=</span> <span class="quote">"red"</span><span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    knots          vector of length K+Q containing a set of knot positions, with
                   the Q border knots repeated at each end.
    theta          vector of length K with spline parameters
    ord            spline order Q
    npoints        number of points at which to evaluate the spline
    plotknots      whether to plot the knots as vertical lines
    plotmean       whether to plot the spline mean as a vertical line
    plotsplines    whether to plot the component spline basis functions
    norm           whether to normalize the spline (as for the frailty)
    ...            other parameters for plot
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    none
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">285 </span><span class="sign">{</span>
<span class="line_number">286 </span>    knots <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span>knots<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">]</span>
<span class="line_number">287 </span>    theta <span class="sign">&lt;</span><span class="sign">-</span> theta<span class="sign">[</span>theta<span class="sign">&gt;</span><span class="sign">-</span>Inf<span class="sign">]</span>
<span class="line_number">288 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>xlim<span class="sign">)</span><span class="sign">)</span> xlim <span class="sign">=</span> range<span class="sign">(</span>knots<span class="sign">)</span>
<span class="line_number">289 </span>    <span class="comment"># Generate point set for evaluation</span>
<span class="line_number">290 </span>    x <span class="sign">=</span> seq<span class="sign">(</span>from <span class="sign">=</span> xlim<span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> to <span class="sign">=</span> xlim<span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> <span class="keyword">length</span> <span class="sign">=</span> npoints<span class="sign">)</span>
<span class="line_number">291 </span>    dx <span class="sign">=</span> <span class="keyword">diff</span><span class="sign">(</span>xlim<span class="sign">)</span> <span class="sign">/</span> npoints
<span class="line_number">292 </span>    <span class="comment">#   Compute spline basis</span>
<span class="line_number">293 </span>    spl <span class="sign">&lt;</span><span class="sign">-</span> <a href="../src/init_c.html#robo102">csplinedesign</a><span class="sign">(</span>knots<span class="sign">,</span> x <span class="sign">=</span> x<span class="sign">,</span> ord <span class="sign">=</span> ord<span class="sign">)</span>
<span class="line_number">294 </span>    <span class="keyword">if</span><span class="sign">(</span>norm<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">295 </span>        Bint <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo112">cevalBinte</a><span class="sign">(</span>knots<span class="sign">,</span> ord<span class="sign">)</span>
<span class="line_number">296 </span>        <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>spl<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span> spl<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> spl<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">/</span> Bint
<span class="line_number">297 </span>    <span class="sign">}</span>
<span class="line_number">298 </span>    <span class="comment">#   Evaluate the spline at the set of points x</span>
<span class="line_number">299 </span>    splsum <span class="sign">&lt;</span><span class="sign">-</span> spl<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="keyword">exp</span><span class="sign">(</span>theta<span class="sign">)</span> 
<span class="line_number">300 </span>    <span class="keyword">if</span><span class="sign">(</span>norm<span class="sign">)</span> splsum <span class="sign">&lt;</span><span class="sign">-</span> splsum <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>theta<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">301 </span>    ymax <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>splsum<span class="sign">)</span>
<span class="line_number">302 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>ylim<span class="sign">)</span><span class="sign">)</span> ylim <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>0<span class="sign">,</span> ymax<span class="sign">)</span>
<span class="line_number">303 </span>    <span class="comment">#   Plot basis functions</span>
<span class="line_number">304 </span>    <span class="keyword">if</span><span class="sign">(</span>plotsplines<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">305 </span>        matplot<span class="sign">(</span>x<span class="sign">,</span> spl <span class="sign">/</span> max<span class="sign">(</span>spl<span class="sign">)</span> <span class="sign">*</span> ylim<span class="sign">[</span>2<span class="sign">]</span> <span class="sign">/</span> 2<span class="sign">,</span> type <span class="sign">=</span> <span class="quote">"l"</span><span class="sign">,</span> lty <span class="sign">=</span> 2<span class="sign">,</span> xlim <span class="sign">=</span> xlim<span class="sign">,</span>
<span class="line_number">306 </span>                ylim <span class="sign">=</span> ylim<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">307 </span>        lines<span class="sign">(</span>x<span class="sign">,</span> splsum<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">,</span> lwd <span class="sign">=</span> 2<span class="sign">,</span> lty <span class="sign">=</span> 1<span class="sign">)</span>
<span class="line_number">308 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">309 </span>        plot<span class="sign">(</span>x<span class="sign">,</span> splsum<span class="sign">,</span> col <span class="sign">=</span> col<span class="sign">,</span> type <span class="sign">=</span> <span class="quote">"l"</span><span class="sign">,</span> lwd <span class="sign">=</span> 2<span class="sign">,</span> lty <span class="sign">=</span> 1<span class="sign">,</span> xlim <span class="sign">=</span> xlim<span class="sign">,</span>
<span class="line_number">310 </span>                ylim <span class="sign">=</span> ylim<span class="sign">,</span> <span class="sign">.</span><span class="sign">.</span><span class="sign">.</span><span class="sign">)</span>
<span class="line_number">311 </span>    <span class="sign">}</span>
<span class="line_number">312 </span>    <span class="keyword">if</span><span class="sign">(</span>plotknots<span class="sign">)</span> abline<span class="sign">(</span>v <span class="sign">=</span> knots<span class="sign">,</span> col <span class="sign">=</span> <span class="quote">"grey"</span><span class="sign">)</span>
<span class="line_number">313 </span>    <span class="comment"># Compute and plot the mean</span>
<span class="line_number">314 </span>    <span class="keyword">if</span><span class="sign">(</span>plotmean<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">315 </span>        Bint <span class="sign">&lt;</span><span class="sign">-</span> colSums<span class="sign">(</span>spl<span class="sign">)</span> <span class="sign">/</span> dx
<span class="line_number">316 </span>        spl<span class="sign">.</span>norm <span class="sign">&lt;</span><span class="sign">-</span> spl<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><a href="#robo157">mdiag</a><span class="sign">(</span>1 <span class="sign">/</span> Bint<span class="sign">)</span>
<span class="line_number">317 </span>        Eint <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>spl<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">318 </span>        <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>spl<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span> Eint<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>spl<span class="sign">.</span>norm<span class="sign">[</span><span class="sign">,</span> i<span class="sign">]</span> <span class="sign">*</span> x<span class="sign">)</span> <span class="sign">/</span> dx
<span class="line_number">319 </span>        E <span class="sign">&lt;</span><span class="sign">-</span> Eint<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="keyword">exp</span><span class="sign">(</span>theta<span class="sign">)</span> <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>theta<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">320 </span>        abline<span class="sign">(</span>v <span class="sign">=</span> E<span class="sign">,</span> col <span class="sign">=</span> <span class="quote">"grey"</span><span class="sign">,</span> lwd <span class="sign">=</span> 2<span class="sign">)</span>
<span class="line_number">321 </span>    <span class="sign">}</span>
<span class="line_number">322 </span><span class="sign">}</span>
</pre>

<hr />
<a name="splineUtils2fsplineconv"></a>
<a name="robo189"></a><h2>splineUtils/splineconv [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>splineconv</strong> --- compute the convolution of two splines
</pre>
<p class="item_name">FUNCTION</p>
<p>    This is needed to construct a penalty on the integrated squared second derivative.
    This function computes the convolution of two spline basis functions, that is,
</p>
<pre>       int_0^infty ( x^k B_1(x) * B_2(x) ) dx
</pre>
<p>    where the splines may be of different orders, but are defined on the same set of knots.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1425 </span><strong>splineconv</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>k<span class="sign">,</span> n1<span class="sign">,</span> j1<span class="sign">,</span> n2<span class="sign">,</span> j2<span class="sign">,</span> knots<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    k      the power of x used in the convolution
    n1     order of the first spline
    j1     largest knot of the first spline
    n2     order of the second spline
    j2     largest knot of the second spline
    knots  set of knots on which the splines are defined
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    The k-th order convolution of the splines defined by the input parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1428 </span><span class="sign">{</span>
<span class="line_number">1429 </span>    <span class="comment"># if the splines don't overlap, the convolution is 0</span>
<span class="line_number">1430 </span>    <span class="keyword">if</span><span class="sign">(</span>j1 <span class="sign">-</span> n1 <span class="sign">&gt;</span><span class="sign">=</span> j2 <span class="sign">|</span> j2 <span class="sign">-</span> n2 <span class="sign">&gt;</span><span class="sign">=</span> j1<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">1431 </span>    <span class="comment"># if both splines are first-order, the convolution is trivial</span>
<span class="line_number">1432 </span>    <span class="keyword">if</span><span class="sign">(</span>n1 <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">&amp;</span> n2 <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1433 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">/</span> <span class="sign">(</span>k <span class="sign">+</span> 1<span class="sign">)</span> <span class="sign">*</span> <span class="sign">(</span>knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1<span class="sign">)</span><span class="sign">]</span><span class="sign">^</span><span class="sign">(</span>k <span class="sign">+</span> 1<span class="sign">)</span> <span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1 <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">]</span><span class="sign">^</span><span class="sign">(</span>k <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1434 </span>        <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">)</span>
<span class="line_number">1435 </span>    <span class="sign">}</span>
<span class="line_number">1436 </span>    <span class="comment"># By symmetry, we can assume that n1&gt;n2 wlog. If this is not the case, switch them around</span>
<span class="line_number">1437 </span>    <span class="keyword">if</span><span class="sign">(</span>n2 <span class="sign">&gt;</span> n1<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1438 </span>        n3 <span class="sign">&lt;</span><span class="sign">-</span> n1<span class="sign">;</span> n1 <span class="sign">&lt;</span><span class="sign">-</span> n2<span class="sign">;</span> n2 <span class="sign">&lt;</span><span class="sign">-</span> n3
<span class="line_number">1439 </span>        j3 <span class="sign">&lt;</span><span class="sign">-</span> j1<span class="sign">;</span> j1 <span class="sign">&lt;</span><span class="sign">-</span> j2<span class="sign">;</span> j2 <span class="sign">&lt;</span><span class="sign">-</span> j3
<span class="line_number">1440 </span>    <span class="sign">}</span>
<span class="line_number">1441 </span>    <span class="comment"># use a magic formula that can be derived by integration by parts</span>
<span class="line_number">1442 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1443 </span>    denom1 <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1 <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">]</span> <span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1 <span class="sign">-</span> n1<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1444 </span>    denom2 <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1<span class="sign">)</span><span class="sign">]</span> <span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1 <span class="sign">-</span> n1 <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1445 </span>    <span class="keyword">if</span><span class="sign">(</span>denom1 <span class="sign">&gt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1446 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> out <span class="sign">+</span> 1 <span class="sign">/</span> denom1 <span class="sign">*</span> <strong>splineconv</strong><span class="sign">(</span>k <span class="sign">+</span> 1<span class="sign">,</span> n1 <span class="sign">-</span> 1<span class="sign">,</span> j1 <span class="sign">-</span> 1<span class="sign">,</span> n2<span class="sign">,</span> j2<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">1447 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> out <span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1 <span class="sign">-</span> n1<span class="sign">)</span><span class="sign">]</span> <span class="sign">/</span> denom1 <span class="sign">*</span> 
<span class="line_number">1448 </span>            <strong>splineconv</strong><span class="sign">(</span>k<span class="sign">,</span> n1 <span class="sign">-</span> 1<span class="sign">,</span> j1 <span class="sign">-</span> 1<span class="sign">,</span> n2<span class="sign">,</span> j2<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">1449 </span>    <span class="sign">}</span>
<span class="line_number">1450 </span>    <span class="keyword">if</span><span class="sign">(</span>denom2 <span class="sign">&gt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1451 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> out <span class="sign">+</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1<span class="sign">)</span><span class="sign">]</span> <span class="sign">/</span> denom2 <span class="sign">*</span> 
<span class="line_number">1452 </span>            <strong>splineconv</strong><span class="sign">(</span>k<span class="sign">,</span> n1 <span class="sign">-</span> 1<span class="sign">,</span> j1<span class="sign">,</span> n2<span class="sign">,</span> j2<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">1453 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> out <span class="sign">-</span> 1 <span class="sign">/</span> denom2 <span class="sign">*</span> <strong>splineconv</strong><span class="sign">(</span>k <span class="sign">+</span> 1<span class="sign">,</span> n1 <span class="sign">-</span> 1<span class="sign">,</span> j1<span class="sign">,</span> n2<span class="sign">,</span> j2<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">1454 </span>    <span class="sign">}</span>
<span class="line_number">1455 </span>    <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">)</span>
<span class="line_number">1456 </span><span class="sign">}</span>
</pre>

<hr />
<a name="splineUtils2fsplinederivint"></a>
<a name="robo190"></a><h2>splineUtils/splinederivint [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo19">splineUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>splinederivint</strong> --- compute the convolution of the derivatives of two spline bases
</pre>
<p class="item_name">FUNCTION</p>
<p>    Used to compute the penalty matrix for the integrated squared second derivative. This
    routine computes the integral from 0 to infinity of the l1 derivative and the l2
    derivative of the j1 and j2-th splines of order n1 and n2 defined on a set of knots.
    For instance, in order to compute the [j1,j2] entry of the penalty matrix,
    the function <a href="#robo125">makePenalty.2deriv</a> calls
</p>
<pre>       out[j1, j2] &lt;- <strong>splinederivint</strong>(2, ord, j1, 2, ord, j2, knots)
</pre>
<p></p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1480 </span><strong>splinederivint</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>l1<span class="sign">,</span> n1<span class="sign">,</span> j1<span class="sign">,</span> l2<span class="sign">,</span> n2<span class="sign">,</span> j2<span class="sign">,</span> knots<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    l1     derivative of the first spline
    n1     order of the first spline
    j1     index of the first spline
    l2     derivative of the second spline
    n2     order of the second spline
    j2     index of the second spline
    knots  set of knots on which the splines are defined
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    a double containing the convolution of the derivatives of two basis functions
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1483 </span><span class="sign">{</span>
<span class="line_number">1484 </span>    <span class="comment"># if they don't overlap, the integral is 0</span>
<span class="line_number">1485 </span>    <span class="keyword">if</span><span class="sign">(</span>j1 <span class="sign">-</span> n1 <span class="sign">&gt;</span><span class="sign">=</span> j2 <span class="sign">|</span> j2 <span class="sign">-</span> n2 <span class="sign">&gt;</span><span class="sign">=</span> j1<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">1486 </span>    <span class="comment"># For the 0th derivatives, use the regular convolution method</span>
<span class="line_number">1487 </span>    <span class="keyword">if</span><span class="sign">(</span>l1 <span class="sign">=</span><span class="sign">=</span> 0 <span class="sign">&amp;</span> l2 <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span><a href="#robo189">splineconv</a><span class="sign">(</span>0<span class="sign">,</span> n2<span class="sign">,</span> j1<span class="sign">,</span> n2<span class="sign">,</span> j2<span class="sign">,</span> knots<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1488 </span>    <span class="comment"># symmetry</span>
<span class="line_number">1489 </span>    <span class="keyword">if</span><span class="sign">(</span>l2 <span class="sign">&gt;</span> l1<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1490 </span>        l3 <span class="sign">&lt;</span><span class="sign">-</span> l1<span class="sign">;</span> l1 <span class="sign">&lt;</span><span class="sign">-</span> l2<span class="sign">;</span> l2 <span class="sign">&lt;</span><span class="sign">-</span> l3
<span class="line_number">1491 </span>        n3 <span class="sign">&lt;</span><span class="sign">-</span> n1<span class="sign">;</span> n1 <span class="sign">&lt;</span><span class="sign">-</span> n2<span class="sign">;</span> n2 <span class="sign">&lt;</span><span class="sign">-</span> n3
<span class="line_number">1492 </span>        j3 <span class="sign">&lt;</span><span class="sign">-</span> j1<span class="sign">;</span> j1 <span class="sign">&lt;</span><span class="sign">-</span> j2<span class="sign">;</span> j2 <span class="sign">&lt;</span><span class="sign">-</span> j3
<span class="line_number">1493 </span>    <span class="sign">}</span>
<span class="line_number">1494 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1495 </span>    <span class="comment"># recursive method to step-by-step reduce this problem to a regular convolution problem</span>
<span class="line_number">1496 </span>    denom1 <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1 <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">]</span> <span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1 <span class="sign">-</span> n1<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1497 </span>    denom2 <span class="sign">&lt;</span><span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1<span class="sign">)</span><span class="sign">]</span> <span class="sign">-</span> knots<span class="sign">[</span><a href="#robo183">ki</a><span class="sign">(</span>knots<span class="sign">,</span> j1 <span class="sign">-</span> n1 <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1498 </span>    <span class="keyword">if</span><span class="sign">(</span>denom1 <span class="sign">&gt;</span> 0<span class="sign">)</span> out <span class="sign">&lt;</span><span class="sign">-</span> out <span class="sign">+</span> <span class="sign">(</span>n1 <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">/</span> denom1 <span class="sign">*</span>
<span class="line_number">1499 </span>        <strong>splinederivint</strong><span class="sign">(</span>l1 <span class="sign">-</span> 1<span class="sign">,</span> n1 <span class="sign">-</span> 1<span class="sign">,</span> j1 <span class="sign">-</span> 1<span class="sign">,</span> l2<span class="sign">,</span> n2<span class="sign">,</span> j2<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">1500 </span>    <span class="keyword">if</span><span class="sign">(</span>denom2 <span class="sign">&gt;</span> 0<span class="sign">)</span> out <span class="sign">&lt;</span><span class="sign">-</span> out <span class="sign">-</span> <span class="sign">(</span>n1 <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">/</span> denom2 <span class="sign">*</span>
<span class="line_number">1501 </span>        <strong>splinederivint</strong><span class="sign">(</span>l1 <span class="sign">-</span> 1<span class="sign">,</span> n1 <span class="sign">-</span> 1<span class="sign">,</span> j1<span class="sign">,</span> l2<span class="sign">,</span> n2<span class="sign">,</span> j2<span class="sign">,</span> knots<span class="sign">)</span>
<span class="line_number">1502 </span>    <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">)</span>
<span class="line_number">1503 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2frmkgr2espline2ehaz"></a>
<a name="robo191"></a><h2>ZZdebug/rmkgr.spline.haz [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo20">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>rmkgr.spline.haz</strong> --- R reimplementation of <a href="../src/init_c.html#robo52">cInitGrHazSpline</a>
</pre>
<p class="item_name">FUNCTION</p>
<p>    For debugging only, works like <a href="../src/init_c.html#robo52">cInitGrHazSpline</a>
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3197 </span><strong>rmkgr.spline.haz</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">,</span> status<span class="sign">,</span> lp<span class="sign">,</span> frailrep<span class="sign">,</span> hazParY<span class="sign">,</span> hazParYcum<span class="sign">,</span>
<span class="line_number">3198 </span>    weight<span class="sign">,</span> B<span class="sign">,</span> C<span class="sign">,</span> P<span class="sign">,</span> penaltyType<span class="sign">,</span> sigma2<span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3201 </span><span class="sign">{</span>
<span class="line_number">3202 </span>    B <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>B<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3203 </span>    C <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>C<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3204 </span>    hazSplineY <span class="sign">&lt;</span><span class="sign">-</span> B<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="keyword">exp</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">3205 </span>    hazY <span class="sign">&lt;</span><span class="sign">-</span> weight <span class="sign">*</span> hazSplineY <span class="sign">+</span> <span class="sign">(</span>1 <span class="sign">-</span> weight<span class="sign">)</span> <span class="sign">*</span> hazParY
<span class="line_number">3206 </span>    hazSplineYcum <span class="sign">&lt;</span><span class="sign">-</span> C<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="keyword">exp</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">3207 </span>    hazYcum <span class="sign">&lt;</span><span class="sign">-</span> weight <span class="sign">*</span> hazSplineYcum <span class="sign">+</span> <span class="sign">(</span>1 <span class="sign">-</span> weight<span class="sign">)</span> <span class="sign">*</span> hazParYcum
<span class="line_number">3208 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3209 </span>    status <span class="sign">=</span> status <span class="sign">/</span> hazY
<span class="line_number">3210 </span>    lp <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>lp<span class="sign">)</span> <span class="sign">*</span> frailrep
<span class="line_number">3211 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> gr <span class="sign">+</span> t<span class="sign">(</span>B<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>status
<span class="line_number">3212 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> gr <span class="sign">-</span> t<span class="sign">(</span>C<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>lp
<span class="line_number">3213 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> gr <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">3214 </span>    <span class="keyword">return</span><span class="sign">(</span>gr<span class="sign">)</span>
<span class="line_number">3215 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2frmklik2espline2ehaz"></a>
<a name="robo192"></a><h2>ZZdebug/rmklik.spline.haz [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo20">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>rmklik.spline.haz</strong> --- R re-implementation of the likelihood function in C
</pre>
<p class="item_name">FUNCTION</p>
<p>    For debugging only, works like <a href="../src/init_c.html#robo54">cInitLikHazSpline</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">3135 </span><strong>rmklik.spline.haz</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">,</span> status<span class="sign">,</span> lp<span class="sign">,</span> frailrep<span class="sign">,</span> hazParY<span class="sign">,</span> 
<span class="line_number">3136 </span>    hazParYcum<span class="sign">,</span> weight<span class="sign">,</span> B<span class="sign">,</span> C<span class="sign">,</span> P<span class="sign">,</span> penaltyType<span class="sign">,</span> sigma2<span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">3139 </span><span class="sign">{</span>
<span class="line_number">3140 </span>    hazSplineY <span class="sign">&lt;</span><span class="sign">-</span> B<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="keyword">exp</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">3141 </span>    hazY <span class="sign">&lt;</span><span class="sign">-</span> weight <span class="sign">*</span> hazSplineY <span class="sign">+</span> <span class="sign">(</span>1 <span class="sign">-</span> weight<span class="sign">)</span> <span class="sign">*</span> hazParY
<span class="line_number">3142 </span>    hazSplineYcum <span class="sign">&lt;</span><span class="sign">-</span> C<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="keyword">exp</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span>
<span class="line_number">3143 </span>    hazYcum <span class="sign">&lt;</span><span class="sign">-</span> weight <span class="sign">*</span> hazSplineYcum <span class="sign">+</span> <span class="sign">(</span>1 <span class="sign">-</span> weight<span class="sign">)</span> <span class="sign">*</span> hazParYcum
<span class="line_number">3144 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>status <span class="sign">*</span> log<span class="sign">(</span>hazY<span class="sign">)</span> <span class="sign">-</span> frailrep <span class="sign">*</span> hazYcum <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>lp<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">3145 </span>    lik <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>numeric<span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">3146 </span>    <span class="keyword">if</span><span class="sign">(</span>penaltyType <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> t<span class="sign">(</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>P<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>2 <span class="sign">*</span> sigma2<span class="sign">)</span>
<span class="line_number">3147 </span>    <span class="keyword">if</span><span class="sign">(</span>penaltyType <span class="sign">=</span><span class="sign">=</span> 2<span class="sign">)</span> lik <span class="sign">&lt;</span><span class="sign">-</span> lik <span class="sign">-</span> t<span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span><span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>P<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span><span class="keyword">exp</span><span class="sign">(</span>spline<span class="sign">.</span>par<span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>2 <span class="sign">*</span> sigma2<span class="sign">)</span>
<span class="line_number">3148 </span>    <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span>
<span class="line_number">3149 </span><span class="sign">}</span>
</pre>

</div> <!-- content -->
<div id="footer">
<p>Generated from ./splinesurv/R/splinefrailty.r with <a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> V4.99.36 on Fri Jun 27 2008 18:25:39
</p>
</div> <!-- footer -->
</body>
</html>
