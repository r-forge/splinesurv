<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
 
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="../robodoc.css" type="text/css" />
<title>./splinesurv/src/mainloop.c</title>
<!-- Source: ./splinesurv/src/mainloop.c -->
<!-- Generated with ROBODoc Version 4.99.36 (Jun 17 2008) -->
</head>
<body>
<div id="logo">

<a name="robo_top_of_doc" href="http://splinesurv.r-forge.r-project.org/">splinesurv</a>
</div> <!-- logo -->
<div id="navigation">
<a class="menuitem" href="./mainloop_cCFitting2FCMetropolisHastings.html#robo10">CMetropolisHastings</a><a class="menuitem" href="../robo_functions.html#robo_top_of_doc">Functions</a></div> <!-- navigation -->
<div id="content">
<h3>TABLE OF CONTENTS</h3>
<ul>
<li>1. <a href="#robo70">CMetropolisHastings/MH_BDM</a></li>
</ul>
<hr />
<a name="CMetropolisHastings2fMH5fBDM"></a>
<a name="robo70"></a><h2>CMetropolisHastings/MH_BDM [ Functions ]</h2>

<p class="item_name">NAME</p>
<pre>    <strong>MH_BDM</strong> --- birth-death-move steps for spline knots
</pre>
<p class="item_name">FUNCTION</p>
<p>    Reversible-Jump MCMC steps for adding, deleting, or moving knots as part of the
    adaptive knot selection procedure. Can work with either the hazard or frailty
    curve, see also <a href="../R/splinefrailty_rMetropolisHastings2Fmh2Ebdm.html#robo143">mh.bdm</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2371 </span><span class="keyword">void</span> <strong>MH_BDM</strong><span class="sign">(</span>char <span class="keyword">which</span><span class="sign">,</span> curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    which         character, can be either 'h' or 'f', for hazard or frailty respectively
    hazard        <a href="./mainloop_c01structures2FCCurve.html#robo23">CCurve</a> for the hazard
    frailty       <a href="./mainloop_c01structures2FCCurve.html#robo23">CCurve</a> for the frailty
    regression    <a href="./mainloop_c01structures2FCRegression.html#robo25">CRegression</a> structure
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2375 </span><span class="sign">{</span>
<span class="line_number">2376 </span>    curveP theCurve<span class="sign">;</span>
<span class="line_number">2377 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="squote">'h'</span><span class="sign">)</span> theCurve <span class="sign">=</span> hazard<span class="sign">;</span>
<span class="line_number">2378 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="squote">'f'</span><span class="sign">)</span> theCurve <span class="sign">=</span> frailty<span class="sign">;</span>
<span class="line_number">2379 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">2380 </span>    <span class="comment">// Pointers to useful components</span>
<span class="line_number">2381 </span>    <span class="keyword">int</span> ord <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">;</span>
<span class="line_number">2382 </span>    <span class="keyword">int</span> nknots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">;</span>
<span class="line_number">2383 </span>    <span class="keyword">double</span> <span class="sign">*</span> candknots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineCandKnots<span class="sign">;</span>
<span class="line_number">2384 </span>    <span class="keyword">int</span> ncandknots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNCandKnots<span class="sign">;</span>
<span class="line_number">2385 </span>    <span class="keyword">double</span> <span class="sign">*</span> occ <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineCandOcc<span class="sign">;</span> <span class="comment">// occupied candidate knots</span>
<span class="line_number">2386 </span>    <span class="keyword">int</span> <span class="sign">*</span> occind <span class="sign">=</span> <span class="keyword">malloc</span><span class="sign">(</span>nknots <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2387 </span>    <span class="comment">// allocate temporary storage</span>
<span class="line_number">2388 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldKnots <span class="sign">=</span> <span class="keyword">calloc</span><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2389 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldPar <span class="sign">=</span> <span class="keyword">calloc</span><span class="sign">(</span>nknots<span class="sign">+</span>ord<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2390 </span>    <span class="keyword">double</span> <span class="sign">*</span> knots2 <span class="sign">=</span> <span class="keyword">calloc</span><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">+</span>1<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2391 </span>    <span class="keyword">double</span> <span class="sign">*</span> params2 <span class="sign">=</span> <span class="keyword">calloc</span><span class="sign">(</span>nknots<span class="sign">+</span>ord<span class="sign">+</span>1<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2392 </span>    <span class="keyword">double</span> <span class="sign">*</span> knots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">;</span>
<span class="line_number">2393 </span>    <span class="keyword">double</span> <span class="sign">*</span> params <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">;</span>
<span class="line_number">2394 </span>    <a href="./mainloop_cCmiscUtils2FdcopyWrapper.html#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">,</span>oldKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2395 </span>    <a href="./mainloop_cCmiscUtils2FdcopyWrapper.html#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>ord<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">,</span>oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2396 </span>    <a href="./mainloop_cCmiscUtils2FdcopyWrapper.html#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">,</span>knots2<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2397 </span>    <a href="./mainloop_cCmiscUtils2FdcopyWrapper.html#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>ord<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">,</span>params2<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2398 </span>
<span class="line_number">2399 </span>    <span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">2400 </span>    <span class="comment">// compute probability of birth-death and move steps</span>
<span class="line_number">2401 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>ord<span class="sign">;</span>j<span class="sign">&lt;</span>ncandknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">;</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> <span class="keyword">if</span><span class="sign">(</span>occ<span class="sign">[</span>j<span class="sign">]</span><span class="sign">=</span><span class="sign">=</span>1<span class="sign">)</span> occind<span class="sign">[</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">]</span><span class="sign">=</span>j<span class="sign">;</span>
<span class="line_number">2402 </span>    <span class="keyword">double</span> pk <span class="sign">=</span> <a href="./mainloop_cCmiscUtils2FEvalNknotsPrior.html#robo87">EvalNknotsPrior</a><span class="sign">(</span> nknots<span class="sign">,</span> theCurve <span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2403 </span>    <span class="keyword">double</span> pkp1 <span class="sign">=</span> <span class="sign">(</span>nknots <span class="sign">&lt;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsMax<span class="sign">)</span> <span class="sign">?</span> <a href="./mainloop_cCmiscUtils2FEvalNknotsPrior.html#robo87">EvalNknotsPrior</a><span class="sign">(</span>nknots<span class="sign">+</span>1<span class="sign">,</span> theCurve<span class="sign">)</span> <span class="sign">:</span> 0<span class="sign">;</span>
<span class="line_number">2404 </span>    <span class="keyword">double</span> pkm1 <span class="sign">=</span> <span class="sign">(</span>nknots <span class="sign">&gt;</span> 1<span class="sign">)</span> <span class="sign">?</span> <a href="./mainloop_cCmiscUtils2FEvalNknotsPrior.html#robo87">EvalNknotsPrior</a><span class="sign">(</span>nknots<span class="sign">-</span>1<span class="sign">,</span> theCurve<span class="sign">)</span> <span class="sign">:</span> 0<span class="sign">;</span>
<span class="line_number">2405 </span>    <span class="keyword">double</span> pb <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBDMConst<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">*</span> <a href="./mainloop_cCmiscUtils2Fdmin.html#robo85">dmin</a><span class="sign">(</span>1<span class="sign">.</span>0<span class="sign">,</span>pkp1<span class="sign">/</span>pk<span class="sign">)</span><span class="sign">;</span> <span class="comment">// P(birth)</span>
<span class="line_number">2406 </span>    <span class="keyword">double</span> pd <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBDMConst<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">*</span> <a href="./mainloop_cCmiscUtils2Fdmin.html#robo85">dmin</a><span class="sign">(</span>1<span class="sign">.</span>0<span class="sign">,</span>pkm1<span class="sign">/</span>pk<span class="sign">)</span><span class="sign">;</span> <span class="comment">// P(death)</span>
<span class="line_number">2407 </span>    <span class="keyword">double</span> pm <span class="sign">=</span> <a href="./mainloop_cCmiscUtils2Fdmax.html#robo84">dmax</a><span class="sign">(</span>0<span class="sign">.</span>0<span class="sign">,</span>1<span class="sign">.</span>0<span class="sign">-</span>pb<span class="sign">-</span>pd<span class="sign">)</span><span class="sign">;</span> <span class="comment">// P(move)</span>
<span class="line_number">2408 </span>    <span class="keyword">double</span> u <span class="sign">=</span> runif<span class="sign">(</span>0<span class="sign">,</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2409 </span>    <span class="keyword">double</span> baselik<span class="sign">,</span>candlik<span class="sign">;</span>
<span class="line_number">2410 </span>    <span class="comment">// base likelihood</span>
<span class="line_number">2411 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> baselik <span class="sign">=</span> <a href="./mainloop_cCmakeLikelihood2FLikelihoodSplineHazard.html#robo65">LikelihoodSplineHazard</a><span class="sign">(</span>theCurve<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2412 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> baselik <span class="sign">=</span> <a href="./mainloop_cCmakeLikelihood2FLikelihoodSplineFrailty.html#robo64">LikelihoodSplineFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>theCurve<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2413 </span>    <span class="keyword">if</span><span class="sign">(</span>u<span class="sign">&lt;</span>pd<span class="sign">)</span><span class="sign">{</span> <span class="comment">// death step</span>
<span class="line_number">2414 </span>        <span class="keyword">int</span> j  <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> floor<span class="sign">(</span>runif<span class="sign">(</span>0<span class="sign">,</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> nknots<span class="sign">)</span><span class="sign">)</span><span class="sign">+</span>ord<span class="sign">;</span> <span class="comment">// index of dying knot</span>
<span class="line_number">2415 </span>        <span class="keyword">double</span> x <span class="sign">=</span> knots<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>  <span class="comment">// value of dying knot</span>
<span class="line_number">2416 </span>            <span class="comment">//Rprintf("Remove knot %d at %f (occ: %d)\n",j,knots[j],(int) occ[occind[j-ord]]);</span>
<span class="line_number">2417 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>nknots<span class="sign">+</span>ord<span class="sign">;</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> <span class="keyword">if</span><span class="sign">(</span>i<span class="sign">&gt;</span><span class="sign">=</span>j<span class="sign">-</span>1<span class="sign">)</span> params2<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> params2<span class="sign">[</span>i<span class="sign">+</span>1<span class="sign">]</span><span class="sign">;</span> <span class="comment">//remove params2[j];</span>
<span class="line_number">2418 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>nknots<span class="sign">+</span>ord<span class="sign">;</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> <span class="keyword">if</span><span class="sign">(</span>i<span class="sign">&gt;</span><span class="sign">=</span>j<span class="sign">)</span> knots2<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> knots2<span class="sign">[</span>i<span class="sign">+</span>1<span class="sign">]</span><span class="sign">;</span> <span class="comment">//remove knots2[j2];</span>
<span class="line_number">2419 </span>        <span class="comment">// update spline parameters for knot deletion</span>
<span class="line_number">2420 </span>        <span class="keyword">if</span><span class="sign">(</span>ord<span class="sign">&gt;</span>2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j2<span class="sign">=</span>j<span class="sign">-</span>ord<span class="sign">+</span>1<span class="sign">;</span> j2<span class="sign">&lt;</span>j<span class="sign">-</span>1<span class="sign">;</span> j2<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2421 </span>            <span class="keyword">double</span> r2 <span class="sign">=</span> <span class="sign">(</span>x<span class="sign">-</span>knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>knots2<span class="sign">[</span>j2<span class="sign">+</span>ord<span class="sign">-</span>1<span class="sign">]</span><span class="sign">-</span>knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2422 </span>            <span class="keyword">double</span> inner <span class="sign">=</span> 1<span class="sign">/</span>r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">-</span><span class="sign">(</span>1<span class="sign">-</span>r2<span class="sign">)</span><span class="sign">/</span>r2<span class="sign">*</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">-</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2423 </span>            <span class="keyword">if</span><span class="sign">(</span>inner<span class="sign">&gt;</span>0<span class="sign">)</span> params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">=</span>log<span class="sign">(</span>inner<span class="sign">)</span><span class="sign">;</span> <span class="keyword">else</span> params2<span class="sign">[</span>j2<span class="sign">]</span> <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineMin<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2424 </span>        <span class="sign">}</span>
<span class="line_number">2425 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">-</span><span class="sign">-</span><span class="sign">;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">-</span><span class="sign">-</span><span class="sign">;</span>
<span class="line_number">2426 </span>        <span class="comment">// Jacobian for the transformation</span>
<span class="line_number">2427 </span>        <span class="keyword">double</span> J <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j<span class="sign">-</span>1<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j<span class="sign">-</span>1<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j<span class="sign">-</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2428 </span>        <span class="keyword">if</span><span class="sign">(</span>ord<span class="sign">&gt;</span>2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j2 <span class="sign">=</span> j<span class="sign">-</span>ord<span class="sign">+</span>2<span class="sign">;</span> j2<span class="sign">&lt;</span>j<span class="sign">-</span>1<span class="sign">;</span> j2<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2429 </span>            <span class="keyword">double</span> r2 <span class="sign">=</span> <span class="sign">(</span>x<span class="sign">-</span>knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>knots2<span class="sign">[</span>j2<span class="sign">+</span>ord<span class="sign">-</span>1<span class="sign">]</span><span class="sign">-</span>knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2430 </span>            J <span class="sign">=</span> J <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>r2<span class="sign">*</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2431 </span>        <span class="sign">}</span>
<span class="line_number">2432 </span>        <span class="comment">// update the curve with the new knot set</span>
<span class="line_number">2433 </span>        <a href="./mainloop_cCmiscUtils2FdcopyWrapper.html#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span> knots2<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2434 </span>        <a href="./mainloop_cCcurveUpdate2FRemakeSplineBasis.html#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'d'</span><span class="sign">,</span>j<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2435 </span>        <span class="comment">// update curve with new parameters</span>
<span class="line_number">2436 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2437 </span>            <a href="./mainloop_cCcurveUpdate2FUpdateSplinePar.html#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>params2<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2438 </span>            candlik <span class="sign">=</span> <a href="./mainloop_cCmakeLikelihood2FLikelihoodSplineHazard.html#robo65">LikelihoodSplineHazard</a><span class="sign">(</span>theCurve<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2439 </span>        <span class="sign">}</span>
<span class="line_number">2440 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2441 </span>            <span class="comment">// for the frailty curve, make sure that the mean is 1</span>
<span class="line_number">2442 </span>            <span class="keyword">double</span> newmean <span class="sign">=</span> <span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j<span class="sign">-</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>j<span class="sign">-</span>2<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2443 </span>            <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>nknots<span class="sign">+</span>ord<span class="sign">-</span>1<span class="sign">;</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> newmean <span class="sign">+</span><span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2444 </span>            <span class="keyword">double</span> newinner <span class="sign">=</span> <span class="sign">-</span>newmean<span class="sign">/</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>j<span class="sign">-</span>2<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2445 </span>            <span class="keyword">if</span><span class="sign">(</span>newinner<span class="sign">&lt;</span>0<span class="sign">)</span> candlik <span class="sign">=</span> <span class="sign">-</span>INFINITY<span class="sign">;</span>
<span class="line_number">2446 </span>            <span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2447 </span>                params2<span class="sign">[</span>j<span class="sign">-</span>2<span class="sign">]</span> <span class="sign">=</span> log<span class="sign">(</span>newinner<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2448 </span>                <a href="./mainloop_cCcurveUpdate2FUpdateSplinePar.html#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>params2<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2449 </span>                candlik <span class="sign">=</span> <a href="./mainloop_cCmakeLikelihood2FLikelihoodSplineFrailty.html#robo64">LikelihoodSplineFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>theCurve<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2450 </span>            <span class="sign">}</span>
<span class="line_number">2451 </span>        <span class="sign">}</span>
<span class="line_number">2452 </span>        <span class="comment">// prior ratio * Jacobian</span>
<span class="line_number">2453 </span>        <span class="keyword">double</span> ratio <span class="sign">=</span> <span class="keyword">sqrt</span><span class="sign">(</span>2<span class="sign">*</span>M_PI<span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>fabs<span class="sign">(</span>J<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2454 </span>        <span class="keyword">int</span> acc <span class="sign">=</span> <a href="./mainloop_cCMetropolisHastings2FAcceptReject.html#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> ratio<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2455 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2456 </span>            <span class="comment">// Update occupied index and candsd</span>
<span class="line_number">2457 </span>            occ<span class="sign">[</span>occind<span class="sign">[</span>j<span class="sign">-</span>ord<span class="sign">]</span><span class="sign">]</span> <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">2458 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> <span class="comment">//undo damage</span>
<span class="line_number">2459 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span>
<span class="line_number">2460 </span>            <a href="./mainloop_cCmiscUtils2FdcopyWrapper.html#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span> oldKnots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2461 </span>            <a href="./mainloop_cCcurveUpdate2FRemakeSplineBasis.html#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'b'</span><span class="sign">,</span>j<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2462 </span>            <a href="./mainloop_cCcurveUpdate2FUpdateSplinePar.html#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>oldPar<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2463 </span>        <span class="sign">}</span>
<span class="line_number">2464 </span>    <span class="sign">}</span>
<span class="line_number">2465 </span>    <span class="keyword">if</span><span class="sign">(</span>u<span class="sign">&gt;</span>pd <span class="sign">&amp;</span> u<span class="sign">&lt;</span>pd<span class="sign">+</span>pb<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2466 </span>        <span class="comment">// Birth</span>
<span class="line_number">2467 </span>        <span class="keyword">int</span> birthind <span class="sign">=</span> occind<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2468 </span>        <span class="comment">// choose a random unoccupied location for the knot to be born</span>
<span class="line_number">2469 </span>        <span class="keyword">while</span><span class="sign">(</span>occ<span class="sign">[</span>birthind<span class="sign">]</span><span class="sign">)</span> birthind <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> floor<span class="sign">(</span>runif<span class="sign">(</span>0<span class="sign">,</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> ncandknots<span class="sign">)</span><span class="sign">)</span><span class="sign">+</span>ord<span class="sign">;</span>
<span class="line_number">2470 </span>        <span class="keyword">double</span> x <span class="sign">=</span> candknots<span class="sign">[</span>birthind<span class="sign">]</span><span class="sign">;</span> <span class="comment">// value of the new knot</span>
<span class="line_number">2471 </span>        <span class="keyword">int</span> j <span class="sign">=</span> 0<span class="sign">;</span> <span class="keyword">while</span><span class="sign">(</span>knots<span class="sign">[</span>j<span class="sign">]</span><span class="sign">&lt;</span>x<span class="sign">)</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span> j<span class="sign">-</span><span class="sign">-</span><span class="sign">;</span> <span class="comment">// find the interval in which x lies</span>
<span class="line_number">2472 </span>            <span class="comment">//Rprintf("Birth at %f after knot %d\n",x,j);</span>
<span class="line_number">2473 </span>        <span class="comment">// update knot set and spline parameters</span>
<span class="line_number">2474 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">;</span>i<span class="sign">&gt;</span>j<span class="sign">;</span>i<span class="sign">-</span><span class="sign">-</span><span class="sign">)</span> knots2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">=</span>knots2<span class="sign">[</span>i<span class="sign">-</span>1<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2475 </span>        knots2<span class="sign">[</span>j<span class="sign">+</span>1<span class="sign">]</span><span class="sign">=</span>x<span class="sign">;</span>
<span class="line_number">2476 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>nknots<span class="sign">+</span>ord<span class="sign">;</span>i<span class="sign">&gt;</span>j<span class="sign">-</span>ord<span class="sign">+</span>1<span class="sign">;</span>i<span class="sign">-</span><span class="sign">-</span><span class="sign">)</span> params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">=</span>params2<span class="sign">[</span>i<span class="sign">-</span>1<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2477 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j2 <span class="sign">=</span> j<span class="sign">-</span>ord<span class="sign">+</span>2<span class="sign">;</span> j2<span class="sign">&lt;</span>j<span class="sign">+</span>1<span class="sign">;</span> j2<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2478 </span>            <span class="keyword">double</span> r2 <span class="sign">=</span> <span class="sign">(</span>x<span class="sign">-</span>knots<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>knots<span class="sign">[</span>j2<span class="sign">+</span>ord<span class="sign">-</span>1<span class="sign">]</span><span class="sign">-</span>knots<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2479 </span>            <span class="keyword">if</span><span class="sign">(</span>j2<span class="sign">=</span><span class="sign">=</span>j<span class="sign">)</span> r2 <span class="sign">=</span> runif<span class="sign">(</span>0<span class="sign">,</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2480 </span>            params2<span class="sign">[</span>j2<span class="sign">]</span> <span class="sign">=</span> log<span class="sign">(</span>r2<span class="sign">*</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">+</span><span class="sign">(</span>1<span class="sign">-</span>r2<span class="sign">)</span><span class="sign">*</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j2<span class="sign">-</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2481 </span>        <span class="sign">}</span>
<span class="line_number">2482 </span>            <span class="comment">//Rprintf("Birthind,x,j: %d %f %d\n",birthind,x,j);</span>
<span class="line_number">2483 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span>
<span class="line_number">2484 </span>        <span class="comment">// Jacobian of the transformation</span>
<span class="line_number">2485 </span>        <span class="keyword">double</span> J <span class="sign">=</span> <span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j<span class="sign">-</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">/</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2486 </span>        <span class="keyword">if</span><span class="sign">(</span>ord<span class="sign">&gt;</span>2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j2 <span class="sign">=</span> j<span class="sign">-</span>ord<span class="sign">+</span>2<span class="sign">;</span> j2<span class="sign">&lt;</span>j<span class="sign">;</span> j2<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2487 </span>            <span class="keyword">double</span> r2 <span class="sign">=</span> <span class="sign">(</span>x<span class="sign">-</span>knots<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>knots<span class="sign">[</span>j2<span class="sign">+</span>ord<span class="sign">-</span>1<span class="sign">]</span><span class="sign">-</span>knots<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2488 </span>            J <span class="sign">=</span> J <span class="sign">*</span> r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2489 </span>        <span class="sign">}</span>
<span class="line_number">2490 </span>        <span class="comment">// update curve with new knots and parameters</span>
<span class="line_number">2491 </span>        <a href="./mainloop_cCmiscUtils2FdcopyWrapper.html#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">+</span>1<span class="sign">,</span> knots2<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2492 </span>        <a href="./mainloop_cCcurveUpdate2FRemakeSplineBasis.html#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'b'</span><span class="sign">,</span>j<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2493 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2494 </span>            <a href="./mainloop_cCcurveUpdate2FUpdateSplinePar.html#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>params2<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2495 </span>            candlik <span class="sign">=</span> <a href="./mainloop_cCmakeLikelihood2FLikelihoodSplineHazard.html#robo65">LikelihoodSplineHazard</a><span class="sign">(</span>theCurve<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2496 </span>        <span class="sign">}</span>
<span class="line_number">2497 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2498 </span>            <span class="comment">// for frailty, make sure the mean is 1</span>
<span class="line_number">2499 </span>            <span class="keyword">double</span> newmean <span class="sign">=</span> <span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2500 </span>            <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>nknots<span class="sign">+</span>ord<span class="sign">+</span>1<span class="sign">;</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> newmean <span class="sign">+</span><span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2501 </span>            <span class="keyword">double</span> newinner <span class="sign">=</span> <span class="sign">-</span>newmean<span class="sign">/</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2502 </span>            <span class="keyword">if</span><span class="sign">(</span>newinner<span class="sign">&lt;</span>0<span class="sign">)</span> candlik <span class="sign">=</span> <span class="sign">-</span>INFINITY<span class="sign">;</span>
<span class="line_number">2503 </span>            <span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2504 </span>                params2<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> log<span class="sign">(</span>newinner<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2505 </span>                <a href="./mainloop_cCcurveUpdate2FUpdateSplinePar.html#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>params2<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2506 </span>                candlik <span class="sign">=</span> <a href="./mainloop_cCmakeLikelihood2FLikelihoodSplineFrailty.html#robo64">LikelihoodSplineFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>theCurve<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2507 </span>            <span class="sign">}</span>
<span class="line_number">2508 </span>        <span class="sign">}</span>
<span class="line_number">2509 </span>        <span class="comment">// prior ratio * Jacobian</span>
<span class="line_number">2510 </span>        <span class="keyword">double</span> ratio <span class="sign">=</span> 1<span class="sign">/</span><span class="keyword">sqrt</span><span class="sign">(</span>2<span class="sign">*</span>M_PI<span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> fabs<span class="sign">(</span>J<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2511 </span>        <span class="keyword">int</span> acc <span class="sign">=</span> <a href="./mainloop_cCMetropolisHastings2FAcceptReject.html#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> ratio<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2512 </span>            <span class="comment">//Rprintf("Lik: %f %f %f %f %d\n",baselik,candlik, J, ratio,acc);</span>
<span class="line_number">2513 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2514 </span>            <span class="comment">// Update set of occupied candidate knots</span>
<span class="line_number">2515 </span>            occ<span class="sign">[</span>birthind<span class="sign">]</span> <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">2516 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> <span class="comment">//undo damage</span>
<span class="line_number">2517 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">-</span><span class="sign">-</span><span class="sign">;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">-</span><span class="sign">-</span><span class="sign">;</span>
<span class="line_number">2518 </span>            <a href="./mainloop_cCmiscUtils2FdcopyWrapper.html#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span> oldKnots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2519 </span>            <a href="./mainloop_cCcurveUpdate2FRemakeSplineBasis.html#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'d'</span><span class="sign">,</span>j<span class="sign">+</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2520 </span>            <a href="./mainloop_cCcurveUpdate2FUpdateSplinePar.html#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>oldPar<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2521 </span>        <span class="sign">}</span>
<span class="line_number">2522 </span>    <span class="sign">}</span>
<span class="line_number">2523 </span>    <span class="keyword">if</span><span class="sign">(</span>u<span class="sign">&gt;</span>pb<span class="sign">+</span>pd<span class="sign">)</span> <span class="sign">{</span> <span class="comment">// Move a knot</span>
<span class="line_number">2524 </span>        <span class="comment">// choose a random knot to move</span>
<span class="line_number">2525 </span>        <span class="keyword">int</span> moveind<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">2526 </span>        moveind  <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> floor<span class="sign">(</span>runif<span class="sign">(</span>0<span class="sign">,</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> nknots<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2527 </span>        <span class="comment">// find range of movement</span>
<span class="line_number">2528 </span>        <span class="keyword">int</span> leftknotind <span class="sign">=</span> <span class="sign">(</span>moveind <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="sign">?</span> ord <span class="sign">:</span> occind<span class="sign">[</span>moveind<span class="sign">-</span>1<span class="sign">]</span><span class="sign">+</span>1<span class="sign">;</span>
<span class="line_number">2529 </span>        <span class="keyword">int</span> rightknotind <span class="sign">=</span> <span class="sign">(</span>moveind <span class="sign">=</span><span class="sign">=</span> nknots<span class="sign">-</span>1<span class="sign">)</span> <span class="sign">?</span> ncandknots <span class="sign">+</span> ord <span class="sign">-</span> 1 <span class="sign">:</span> occind<span class="sign">[</span>moveind<span class="sign">+</span>1<span class="sign">]</span><span class="sign">-</span>1<span class="sign">;</span>
<span class="line_number">2530 </span>        <span class="comment">// choose a candidate knot to place the new knot in</span>
<span class="line_number">2531 </span>        <span class="keyword">int</span> newknotind <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> floor<span class="sign">(</span>runif<span class="sign">(</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> leftknotind<span class="sign">,</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> rightknotind<span class="sign">+</span>1<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2532 </span>        <span class="comment">// if the knot doesn't stay the same, update the curve</span>
<span class="line_number">2533 </span>        <span class="keyword">if</span><span class="sign">(</span>candknots<span class="sign">[</span>newknotind<span class="sign">]</span> <span class="sign">!</span><span class="sign">=</span> oldKnots<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span> 
<span class="line_number">2534 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span> <span class="sign">=</span> candknots<span class="sign">[</span>newknotind<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2535 </span>            <span class="comment">// update spline basis with new knot position</span>
<span class="line_number">2536 </span>            <a href="./mainloop_cCcurveUpdate2FRemakeSplineBasis.html#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'m'</span><span class="sign">,</span>moveind<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2537 </span>            <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span> <span class="comment">//hazard</span>
<span class="line_number">2538 </span>                <a href="./mainloop_cCcurveUpdate2FEvalSpline.html#robo32">EvalSpline</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2539 </span>                candlik <span class="sign">=</span> <a href="./mainloop_cCmakeLikelihood2FLikelihoodSplineHazard.html#robo65">LikelihoodSplineHazard</a><span class="sign">(</span>theCurve<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2540 </span>            <span class="sign">}</span>
<span class="line_number">2541 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span> <span class="comment">//frailty</span>
<span class="line_number">2542 </span>                <span class="comment">// frailty needs to ensure the mean is 1</span>
<span class="line_number">2543 </span>                <span class="keyword">double</span> newmean <span class="sign">=</span> <span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2544 </span>                <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>nknots<span class="sign">+</span>ord<span class="sign">;</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> newmean <span class="sign">+</span><span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2545 </span>                <span class="keyword">double</span> newinner <span class="sign">=</span> <span class="sign">-</span>newmean<span class="sign">/</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2546 </span>                <span class="keyword">if</span><span class="sign">(</span>newinner<span class="sign">&lt;</span>0<span class="sign">)</span> candlik <span class="sign">=</span> <span class="sign">-</span>INFINITY<span class="sign">;</span>
<span class="line_number">2547 </span>                <span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2548 </span>                    params2<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span> <span class="sign">=</span> log<span class="sign">(</span>newinner<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2549 </span>                    <a href="./mainloop_cCcurveUpdate2FUpdateSplinePar.html#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>params2<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2550 </span>                    candlik <span class="sign">=</span> <a href="./mainloop_cCmakeLikelihood2FLikelihoodSplineFrailty.html#robo64">LikelihoodSplineFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>theCurve<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2551 </span>                <span class="sign">}</span>
<span class="line_number">2552 </span>            <span class="sign">}</span>
<span class="line_number">2553 </span>            <span class="keyword">int</span> acc <span class="sign">=</span> <a href="./mainloop_cCMetropolisHastings2FAcceptReject.html#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span>candlik<span class="sign">,</span>1<span class="sign">.</span>0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2554 </span>            <span class="comment">//Rprintf("Lik: %f %f %d\n",baselik,candlik,acc);</span>
<span class="line_number">2555 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>acc<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2556 </span>                <span class="comment">// not accepted, undo the damage</span>
<span class="line_number">2557 </span>                theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span> <span class="sign">=</span> oldKnots<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2558 </span>                <a href="./mainloop_cCcurveUpdate2FRemakeSplineBasis.html#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'m'</span><span class="sign">,</span>moveind<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2559 </span>                <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span> <span class="comment">// hazard</span>
<span class="line_number">2560 </span>                    <a href="./mainloop_cCcurveUpdate2FEvalSpline.html#robo32">EvalSpline</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2561 </span>                <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>      <span class="comment">// frailty</span>
<span class="line_number">2562 </span>                    <a href="./mainloop_cCcurveUpdate2FUpdateSplinePar.html#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>oldPar<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2563 </span>                <span class="sign">}</span>
<span class="line_number">2564 </span>            <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> <span class="comment">// update occupied index</span>
<span class="line_number">2565 </span>                occ<span class="sign">[</span>occind<span class="sign">[</span>moveind<span class="sign">]</span><span class="sign">]</span><span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">2566 </span>                occ<span class="sign">[</span>newknotind<span class="sign">]</span> <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">2567 </span>            <span class="sign">}</span>
<span class="line_number">2568 </span>        <span class="sign">}</span>
<span class="line_number">2569 </span>    <span class="sign">}</span>
<span class="line_number">2570 </span>
<span class="line_number">2571 </span>    <span class="keyword">free</span><span class="sign">(</span>oldKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2572 </span>    <span class="keyword">free</span><span class="sign">(</span>oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2573 </span>    <span class="keyword">free</span><span class="sign">(</span>knots2<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2574 </span>    <span class="keyword">free</span><span class="sign">(</span>params2<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2575 </span>    <span class="keyword">free</span><span class="sign">(</span>occind<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2576 </span><span class="sign">}</span>
</pre>

</div> <!-- content -->
<div id="footer">
<p>Generated from ./splinesurv/src/mainloop.c with <a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> V4.99.36 on Wed Jul 16 2008 11:21:32
</p>
</div> <!-- footer -->

<!-- Start of StatCounter Code -->
<script type="text/javascript">
var sc_project=3825578; 
var sc_invisible=1; 
var sc_partition=34; 
var sc_click_stat=1; 
var sc_security="6730661a"; 
</script>

<script type="text/javascript" src="http://www.statcounter.com/counter/counter_xhtml.js"></script><noscript><div class="statcounter"><a href="http://www.statcounter.com/" target="_blank"><img class="statcounter" src="http://c.statcounter.com/3825578/0/6730661a/1/" alt="free hit counter script" ></a></div></noscript>
<!-- End of StatCounter Code -->
</body>

</html>
