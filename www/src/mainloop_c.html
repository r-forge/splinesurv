<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
 
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="../robodoc.css" type="text/css" />
<title>./splinesurv/src/mainloop.c</title>
<!-- Source: ./splinesurv/src/mainloop.c -->
<!-- Generated with ROBODoc Version 4.99.36 (Jun 17 2008) -->
</head>
<body>
<div id="logo">
<a name="robo_top_of_doc">splinesurv</a>
</div> <!-- logo -->
<div id="navigation">
<a class="menuitem" href="../toc_index.html#top">Table of Contents</a>
<a class="menuitem" href="../robo_sourcefiles.html#top">Sourcefiles</a>
<a class="menuitem" href="../masterindex.html#top">Index</a>
<a class="menuitem" href="../robo_definitions.html#top">Definitions</a>
<a class="menuitem" href="../robo_functions.html#top">Functions</a>
<a class="menuitem" href="../robo_modules.html#top">Modules</a>
</div> <!-- navigation -->
<div id="content">
<h3>TABLE OF CONTENTS</h3>
<ul>
<li>1. <a href="#robo2">/CFitting</a></li>
<ul>
<li>1.1. <a href="#robo7">CFitting/CcurveUpdate</a></li>
<ul>
<li>1.1.1. <a href="#robo29">CcurveUpdate/EvalCurveAtOnePoint</a></li>
<li>1.1.2. <a href="#robo30">CcurveUpdate/EvalParamAtOnePoint</a></li>
<li>1.1.3. <a href="#robo31">CcurveUpdate/EvalParametric</a></li>
<li>1.1.4. <a href="#robo32">CcurveUpdate/EvalSpline</a></li>
<li>1.1.5. <a href="#robo33">CcurveUpdate/EvalSplineAtOnePoint</a></li>
<li>1.1.6. <a href="#robo34">CcurveUpdate/FrailtySplineVar</a></li>
<li>1.1.7. <a href="#robo35">CcurveUpdate/MakeSplineBasis</a></li>
<li>1.1.8. <a href="#robo36">CcurveUpdate/PopulateLocalCurve</a></li>
<li>1.1.9. <a href="#robo37">CcurveUpdate/PopulateLocalHistory</a></li>
<li>1.1.10. <a href="#robo38">CcurveUpdate/PopulateLocalRegression</a></li>
<li>1.1.11. <a href="#robo39">CcurveUpdate/RemakeSplineBasis</a></li>
<li>1.1.12. <a href="#robo40">CcurveUpdate/ReweightCurve</a></li>
<li>1.1.13. <a href="#robo41">CcurveUpdate/UpdateCurveX</a></li>
<li>1.1.14. <a href="#robo42">CcurveUpdate/UpdateParamPar</a></li>
<li>1.1.15. <a href="#robo43">CcurveUpdate/UpdateSplineBasis</a></li>
<li>1.1.16. <a href="#robo44">CcurveUpdate/UpdateSplinePar</a></li>
</ul>
<li>1.2. <a href="#robo8">CFitting/CDefines</a></li>
<ul>
<li>1.2.1. <a href="#robo45">CDefines/DEBUG</a></li>
<li>1.2.2. <a href="#robo46">CDefines/enumDistribution</a></li>
<li>1.2.3. <a href="#robo47">CDefines/enumNknotsPrior</a></li>
<li>1.2.4. <a href="#robo48">CDefines/enumPenalty</a></li>
<li>1.2.5. <a href="#robo49">CDefines/LIK_MOD</a></li>
<li>1.2.6. <a href="#robo50">CDefines/MAX_PAR</a></li>
</ul>
<li>1.3. <a href="#robo9">CFitting/CmakeLikelihood</a></li>
<ul>
<li>1.3.1. <a href="#robo58">CmakeLikelihood/LikelihoodFrailty</a></li>
<li>1.3.2. <a href="#robo59">CmakeLikelihood/LikelihoodFrailtyLogSum</a></li>
<li>1.3.3. <a href="#robo60">CmakeLikelihood/LikelihoodHazardLogSum</a></li>
<li>1.3.4. <a href="#robo61">CmakeLikelihood/LikelihoodParamFrailty</a></li>
<li>1.3.5. <a href="#robo62">CmakeLikelihood/LikelihoodParamHazard</a></li>
<li>1.3.6. <a href="#robo63">CmakeLikelihood/LikelihoodRegression</a></li>
<li>1.3.7. <a href="#robo64">CmakeLikelihood/LikelihoodSplineFrailty</a></li>
<li>1.3.8. <a href="#robo65">CmakeLikelihood/LikelihoodSplineHazard</a></li>
<li>1.3.9. <a href="#robo66">CmakeLikelihood/LikelihoodWeightFrailty</a></li>
<li>1.3.10. <a href="#robo67">CmakeLikelihood/LikelihoodWeightHazard</a></li>
<li>1.3.11. <a href="#robo68">CmakeLikelihood/SmoothnessPenalty</a></li>
</ul>
<li>1.4. <a href="#robo10">CFitting/CMetropolisHastings</a></li>
<ul>
<li>1.4.1. <a href="#robo69">CMetropolisHastings/AcceptReject</a></li>
<li>1.4.2. <a href="#robo70">CMetropolisHastings/MH_BDM</a></li>
<li>1.4.3. <a href="#robo71">CMetropolisHastings/MH_Frail</a></li>
<li>1.4.4. <a href="#robo72">CMetropolisHastings/MH_ParamFrailty</a></li>
<li>1.4.5. <a href="#robo73">CMetropolisHastings/MH_ParamHazard</a></li>
<li>1.4.6. <a href="#robo74">CMetropolisHastings/MH_Regression</a></li>
<li>1.4.7. <a href="#robo75">CMetropolisHastings/MH_SplineFrailty</a></li>
<li>1.4.8. <a href="#robo76">CMetropolisHastings/MH_SplineHazard</a></li>
<li>1.4.9. <a href="#robo77">CMetropolisHastings/MH_Weight</a></li>
<li>1.4.10. <a href="#robo78">CMetropolisHastings/UpdatePostvarCurve</a></li>
<li>1.4.11. <a href="#robo79">CMetropolisHastings/UpdatePostvarRegression</a></li>
</ul>
<li>1.5. <a href="#robo11">CFitting/CmiscUtils</a></li>
<ul>
<li>1.5.1. <a href="#robo80">CmiscUtils/dcopyWrapper</a></li>
<li>1.5.2. <a href="#robo81">CmiscUtils/ddotWrapper</a></li>
<li>1.5.3. <a href="#robo82">CmiscUtils/dfactorial</a></li>
<li>1.5.4. <a href="#robo83">CmiscUtils/diagmvWrapper</a></li>
<li>1.5.5. <a href="#robo84">CmiscUtils/dmax</a></li>
<li>1.5.6. <a href="#robo85">CmiscUtils/dmin</a></li>
<li>1.5.7. <a href="#robo86">CmiscUtils/dnegbin</a></li>
<li>1.5.8. <a href="#robo87">CmiscUtils/EvalNknotsPrior</a></li>
<li>1.5.9. <a href="#robo88">CmiscUtils/getListElement</a></li>
<li>1.5.10. <a href="#robo89">CmiscUtils/imax</a></li>
<li>1.5.11. <a href="#robo90">CmiscUtils/imin</a></li>
<li>1.5.12. <a href="#robo91">CmiscUtils/mvrnorm</a></li>
<li>1.5.13. <a href="#robo92">CmiscUtils/rinvgamma</a></li>
<li>1.5.14. <a href="#robo93">CmiscUtils/UpdateHistory</a></li>
</ul>
<li>1.6. <a href="#robo12">CFitting/CsplineUtils</a></li>
<ul>
<li>1.6.1. <a href="./init_c.html#robo94">CsplineUtils/cevalBinte</a></li>
<li>1.6.2. <a href="./init_c.html#robo95">CsplineUtils/cevalCinte</a></li>
<li>1.6.3. <a href="./init_c.html#robo96">CsplineUtils/cevalCinte2</a></li>
<li>1.6.4. <a href="./init_c.html#robo97">CsplineUtils/cevalCinteOld</a></li>
<li>1.6.5. <a href="./init_c.html#robo98">CsplineUtils/cevalEinte</a></li>
<li>1.6.6. <a href="./init_c.html#robo99">CsplineUtils/cnBsmom</a></li>
<li>1.6.7. <a href="./init_c.html#robo100">CsplineUtils/cSplineConvolution</a></li>
<li>1.6.8. <a href="./init_c.html#robo101">CsplineUtils/cSplineDerivInt</a></li>
<li>1.6.9. <a href="./init_c.html#robo102">CsplineUtils/csplinedesign</a></li>
<li>1.6.10. <a href="./init_c.html#robo103">CsplineUtils/csplineeval</a></li>
</ul>
</ul>
<li>2. <a href="#robo22">00main/SplineSurvMainLoop</a></li>
<li>3. <a href="#robo23">01structures/CCurve</a></li>
<li>4. <a href="#robo24">01structures/CHistory</a></li>
<li>5. <a href="#robo25">01structures/CRegression</a></li>
</ul>
<hr />
<a name="2fCFitting"></a>
<a name="robo2"></a><h2>/CFitting [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>  <strong>CFitting</strong> --- model fitting routines in C
</pre>
<p class="item_name">FUNCTION</p>
<p>  These routines are C implementations of the ones described in <a href="../R/splinefrailty_r.html#robo4">RFitting</a>, and 
  work approximately in the same way, adjusting for C's memory management and
  direct BLAS access.
</p>
  
<p>  The main function is <a href="#robo22">SplineSurvMainLoop</a>, which calls several Metropolis-Hastings
  functions in the <a href="#robo10">CMetropolisHastings</a> module, which in turn rely on likelihood
  functions in the <a href="#robo9">CmakeLikelihood</a> module.
</p>

<hr />
<a name="CFitting2fCcurveUpdate"></a>
<a name="robo7"></a><h2>CFitting/CcurveUpdate [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo2">CFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>  <strong>CcurveUpdate</strong> --- update curves
</pre>
<p class="item_name">FUNCTION</p>
<p>  Functions to re-estimate and update curves in the course of estimation.
</p>

<hr />
<a name="CFitting2fCDefines"></a>
<a name="robo8"></a><h2>CFitting/CDefines [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo2">CFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>CDefines</strong> --- control parameter definitions
</pre>

<hr />
<a name="CFitting2fCmakeLikelihood"></a>
<a name="robo9"></a><h2>CFitting/CmakeLikelihood [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo2">CFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>  <strong>CmakeLikelihood</strong> --- likelihood functions in C
</pre>
<p class="item_name">FUNCTION</p>
<p>  Functions to compute the loglikelihood required by the MCMC steps, in C
</p>

<hr />
<a name="CFitting2fCMetropolisHastings"></a>
<a name="robo10"></a><h2>CFitting/CMetropolisHastings [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo2">CFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>CMetropolisHastings</strong> --- MH steps in C
  DESCRIPTION
    Functions to successively update each of the parameter sets by Metropolis-Hastings
    or reversible jump M-H.
</pre>

<hr />
<a name="CFitting2fCmiscUtils"></a>
<a name="robo11"></a><h2>CFitting/CmiscUtils [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo2">CFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>  <strong>CmiscUtils</strong> --- miscellaneous utilities in C
</pre>
<p class="item_name">FUNCTION</p>
<p>  Various useful small utilities, including random number generators.
</p>

<hr />
<a name="CFitting2fCsplineUtils"></a>
<a name="robo12"></a><h2>CFitting/CsplineUtils [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo2">CFitting</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>  <strong>CsplineUtils</strong> --- spline utilities in C
</pre>
<p class="item_name">FUNCTION</p>
<p>  Tools to manage and evaluate B-splines and related integrals
</p>

<hr />
<a name="00main2fSplineSurvMainLoop"></a>
<a name="robo22"></a><h2>00main/SplineSurvMainLoop [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../R/splinefrailty_r.html#robo0">00main</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>SplineSurvMainLoop</strong> --- main loop in C
</pre>
<p class="item_name">FUNCTION</p>
<p>    This is the main fitting loop in C, which is called by <a href="../R/splinefrailty_r.html#robo21">splinesurv.agdata</a> if it
    is called with usec=TRUE (default). Everything in the set of <a href="#robo2">CFitting</a> routines is
    implemented to match the <a href="../R/splinefrailty_r.html#robo4">RFitting</a> routines, with the caveat of C's memory management.
</p>

<p>    See also the call graph linked from <a href="../R/splinefrailty_r.html#robo0">00main</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2647 </span>SEXP <strong>SplineSurvMainLoop</strong><span class="sign">(</span> SEXP Rhazard<span class="sign">,</span> SEXP Rfrailty<span class="sign">,</span> SEXP Rregression<span class="sign">,</span> 
<span class="line_number">2648 </span>        SEXP Rhistory<span class="sign">,</span> SEXP Rstartiter<span class="sign">,</span> SEXP Renditer<span class="sign">,</span> SEXP Rthin<span class="sign">,</span> 
<span class="line_number">2649 </span>        SEXP Rverbose<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    Rhazard       <a href="../R/splinefrailty_r.html#robo26">RCurve</a> structure for the hazard
    Rfrailty      <a href="../R/splinefrailty_r.html#robo26">RCurve</a> structure for the frailty
    Rregression   <a href="../R/splinefrailty_r.html#robo28">RRegression</a> structure for the regression information
    Rhistory      <a href="../R/splinefrailty_r.html#robo27">RHistory</a> structure for the history of the parameters
    Rstartiter    integer, for the starting iteration from which the loop should begin
    Renditer      integer, for the iteration until which the loop should run
    Rthin         integer, for the number of iterations that should be discarded each time
    Rverbose      integer, containing the amount of output that should be printed to the
                  screen. This is not as well-behaved as the verbose option within R.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2653 </span><span class="sign">{</span>
<span class="line_number">2654 </span>    
<span class="line_number">2655 </span>    <span class="comment">// initialize random number generator.</span>
<span class="line_number">2656 </span>    GetRNGstate<span class="sign">(</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2657 </span>    <span class="comment">// Create local curve and regression structures, as <a href="#robo23">CCurve</a>, <a href="#robo25">CRegression</a> </span>
<span class="line_number">2658 </span>    <span class="comment">// and <a href="#robo24">CHistory</a> structures. These consist primarily of pointers to the memory</span>
<span class="line_number">2659 </span>    <span class="comment">// allocated by R, but they make the addressing easier.</span>
<span class="line_number">2660 </span>    curveP hazard <span class="sign">=</span> <span class="sign">(</span><span class="keyword">struct</span> curve <span class="sign">*</span><span class="sign">)</span> R_alloc<span class="sign">(</span>1<span class="sign">,</span>sizeof<span class="sign">(</span><span class="keyword">struct</span> curve<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2661 </span>    curveP frailty <span class="sign">=</span> <span class="sign">(</span><span class="keyword">struct</span> curve <span class="sign">*</span><span class="sign">)</span> R_alloc<span class="sign">(</span>1<span class="sign">,</span>sizeof<span class="sign">(</span><span class="keyword">struct</span> curve<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2662 </span>    regressionP regression <span class="sign">=</span> <span class="sign">(</span><span class="keyword">struct</span> regress <span class="sign">*</span><span class="sign">)</span> R_alloc<span class="sign">(</span>1<span class="sign">,</span>sizeof<span class="sign">(</span><span class="keyword">struct</span> regress<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2663 </span>    historyP history <span class="sign">=</span> <span class="sign">(</span><span class="keyword">struct</span> hist <span class="sign">*</span><span class="sign">)</span> R_alloc<span class="sign">(</span>1<span class="sign">,</span>sizeof<span class="sign">(</span><span class="keyword">struct</span> hist<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2664 </span>    hazard<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">=</span>1<span class="sign">;</span>
<span class="line_number">2665 </span>    frailty<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">2666 </span>    <a href="#robo36">PopulateLocalCurve</a><span class="sign">(</span>hazard<span class="sign">,</span> Rhazard<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2667 </span>    <a href="#robo36">PopulateLocalCurve</a><span class="sign">(</span>frailty<span class="sign">,</span> Rfrailty<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2668 </span>    <a href="#robo38">PopulateLocalRegression</a><span class="sign">(</span>regression<span class="sign">,</span> Rregression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2669 </span>    <a href="#robo37">PopulateLocalHistory</a><span class="sign">(</span>history<span class="sign">,</span>Rhistory<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2670 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>0<span class="sign">;</span> j<span class="sign">&lt;</span>regression<span class="sign">-</span><span class="sign">&gt;</span>m<span class="sign">;</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> 
<span class="line_number">2671 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>regression<span class="sign">-</span><span class="sign">&gt;</span>Jicum<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span> i<span class="sign">&lt;</span>regression<span class="sign">-</span><span class="sign">&gt;</span>Jicum<span class="sign">[</span>j<span class="sign">+</span>1<span class="sign">]</span><span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span>
<span class="line_number">2672 </span>            regression<span class="sign">-</span><span class="sign">&gt;</span>frailrep<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2673 </span>    <span class="comment">// compute the value of the frailty*lp vector</span>
<span class="line_number">2674 </span>    <a href="#robo83">diagmvWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>frailrep<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>elp<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>frailelp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2675 </span>
<span class="line_number">2676 </span>    <span class="comment">// Begin main loop</span>
<span class="line_number">2677 </span>    <span class="keyword">int</span> iter <span class="sign">=</span> asInteger<span class="sign">(</span>Rstartiter<span class="sign">)</span><span class="sign">;</span> <span class="comment">// iteration counter</span>
<span class="line_number">2678 </span>    <span class="keyword">int</span> enditer <span class="sign">=</span> asInteger<span class="sign">(</span>Renditer<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2679 </span>    <span class="keyword">int</span> thin <span class="sign">=</span> asInteger<span class="sign">(</span>Rthin<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2680 </span>    <span class="keyword">int</span> verbose <span class="sign">=</span> asInteger<span class="sign">(</span>Rverbose<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2681 </span>    <span class="keyword">int</span> iterEl <span class="sign">=</span> 0<span class="sign">;</span> <span class="comment">// counts the elapsed iterations between history updates</span>
<span class="line_number">2682 </span>    <span class="keyword">while</span><span class="sign">(</span>iter <span class="sign">&lt;</span> enditer<span class="sign">)</span>
<span class="line_number">2683 </span>    <span class="sign">{</span>
<span class="line_number">2684 </span>        R_CheckUserInterrupt<span class="sign">(</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2685 </span>        iterEl<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span>
<span class="line_number">2686 </span>        <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 4<span class="sign">)</span> Rprintf<span class="sign">(</span><span class="quote">"%d"</span><span class="sign">,</span> iterEl<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2687 </span>        
<span class="line_number">2688 </span>        <span class="comment">// Metropolis-Hastings steps</span>
<span class="line_number">2689 </span>        <a href="#robo71">MH_Frail</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2690 </span>
<span class="line_number">2691 </span>        <a href="#robo74">MH_Regression</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2692 </span>        
<span class="line_number">2693 </span>        <a href="#robo76">MH_SplineHazard</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2694 </span>
<span class="line_number">2695 </span>        <a href="#robo75">MH_SplineFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2696 </span>        
<span class="line_number">2697 </span>        <a href="#robo73">MH_ParamHazard</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2698 </span>
<span class="line_number">2699 </span>        <a href="#robo72">MH_ParamFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2700 </span>
<span class="line_number">2701 </span>        <a href="#robo77">MH_Weight</a><span class="sign">(</span>hazard<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2702 </span>        <a href="#robo77">MH_Weight</a><span class="sign">(</span>frailty<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2703 </span>
<span class="line_number">2704 </span>        <a href="#robo78">UpdatePostvarCurve</a><span class="sign">(</span>hazard<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2705 </span>        <a href="#robo78">UpdatePostvarCurve</a><span class="sign">(</span>frailty<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2706 </span>        <a href="#robo79">UpdatePostvarRegression</a><span class="sign">(</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2707 </span>
<span class="line_number">2708 </span>        <span class="comment">// RJMCMC steps for adaptive knot selection</span>
<span class="line_number">2709 </span>        <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineAdaptive<span class="sign">)</span> <a href="#robo70">MH_BDM</a><span class="sign">(</span><span class="squote">'h'</span><span class="sign">,</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2710 </span>        <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineAdaptive<span class="sign">)</span> <a href="#robo70">MH_BDM</a><span class="sign">(</span><span class="squote">'f'</span><span class="sign">,</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2711 </span>        
<span class="line_number">2712 </span>        <span class="comment">// store current state in <a href="#robo24">CHistory</a></span>
<span class="line_number">2713 </span>        <span class="keyword">if</span><span class="sign">(</span>iterEl <span class="sign">=</span><span class="sign">=</span> thin<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2714 </span>            iter<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span>
<span class="line_number">2715 </span>            <a href="#robo93">UpdateHistory</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">,</span> history<span class="sign">,</span> iter<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2716 </span>            iterEl <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">2717 </span>            <span class="keyword">if</span><span class="sign">(</span>verbose<span class="sign">&gt;</span><span class="sign">=</span>3<span class="sign">)</span> Rprintf<span class="sign">(</span><span class="quote">" %d "</span><span class="sign">,</span>iter<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2718 </span>        <span class="sign">}</span>
<span class="line_number">2719 </span>        
<span class="line_number">2720 </span>    <span class="sign">}</span>
<span class="line_number">2721 </span>    REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rhazard<span class="sign">,</span><span class="quote">"spline.nknots"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">;</span>
<span class="line_number">2722 </span>    REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rfrailty<span class="sign">,</span><span class="quote">"spline.nknots"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">;</span>
<span class="line_number">2723 </span>    SEXP returnval <span class="sign">=</span> R_NilValue<span class="sign">;</span>
<span class="line_number">2724 </span>    PutRNGstate<span class="sign">(</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2725 </span>    <span class="keyword">return</span> returnval<span class="sign">;</span>
<span class="line_number">2726 </span><span class="sign">}</span>
</pre>

<hr />
<a name="01structures2fCCurve"></a>
<a name="robo23"></a><h2>01structures/CCurve [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../R/splinefrailty_r.html#robo1">01structures</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>CCurve</strong> --- structure to store a curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    This structure contains all the information about a curve, either the hazard
    or the frailty. This includes all parameters for spline components, parametric
    components, weights, and knot positions, as well as spline basis functions,
    tuning parameters, etc. It is the C analogoue of the <a href="../R/splinefrailty_r.html#robo26">RCurve</a> structure.
</p>

<p>    Note that many of the elements of the structure are pointers. This allows
    the memory allocated by R to be used directly, rather than having to re-allocate
    memory within C.
</p>

<p>    The components are described by commments in the source.
</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">167 </span><span class="keyword">typedef</span> <span class="keyword">struct</span> curve <span class="sign">{</span>
<span class="line_number">168 </span>    <span class="keyword">int</span> hasSpline<span class="sign">,</span> <span class="comment">//has a spline component</span>
<span class="line_number">169 </span>         hasPar<span class="sign">,</span> <span class="comment">//has a parametric component</span>
<span class="line_number">170 </span>         isHazard<span class="sign">,</span> <span class="comment">//whether the curve represents hazard or frailty</span>
<span class="line_number">171 </span>         SplineOrd<span class="sign">,</span> <span class="comment">// order of the spline</span>
<span class="line_number">172 </span>         SplineAdaptive<span class="sign">,</span> <span class="comment">// whether the knots should birth/death/move</span>
<span class="line_number">173 </span>         SplineNknots<span class="sign">,</span> <span class="comment">//spline number of interior knots</span>
<span class="line_number">174 </span>         SplineNknotsMax<span class="sign">,</span> <span class="comment">// max number of knots</span>
<span class="line_number">175 </span>         SplineNCandKnots<span class="sign">,</span> <span class="comment">// number of candidate knots</span>
<span class="line_number">176 </span>         nx<span class="sign">,</span> <span class="comment">//number of observations</span>
<span class="line_number">177 </span>         nj<span class="sign">,</span> <span class="comment">//number of basis functions (spline)</span>
<span class="line_number">178 </span>         njmax<span class="sign">,</span> <span class="comment">// max value of nj</span>
<span class="line_number">179 </span>         np<span class="sign">,</span> <span class="comment">// number of parameters (parametric)</span>
<span class="line_number">180 </span>         SplineFixedInd<span class="sign">;</span> <span class="comment">// fixed index for frailty spline</span>
<span class="line_number">181 </span>    <span class="keyword">double</span> SplineFvar<span class="sign">,</span> <span class="comment">// frailty variance</span>
<span class="line_number">182 </span>           SplineEParSum<span class="sign">;</span> <span class="comment">// sum of exponentials of spline parameters</span>
<span class="line_number">183 </span>    penalty SplinePenaltyType<span class="sign">;</span> <span class="comment">// (0=none, 1=diff, 2=2deriv, 3=log2der)</span>
<span class="line_number">184 </span>    distribution ParDist<span class="sign">;</span> <span class="comment">// Parametric distribution function</span>
<span class="line_number">185 </span>    nknotsprior SplineNknotsPrior<span class="sign">;</span>
<span class="line_number">186 </span>    <span class="keyword">double</span> <span class="sign">*</span>SplineKnots<span class="sign">,</span> <span class="comment">//Knots of the spline</span>
<span class="line_number">187 </span>           <span class="sign">*</span>SplineCandKnots<span class="sign">,</span> <span class="comment">// Candidate knots for adaptive spline</span>
<span class="line_number">188 </span>           <span class="sign">*</span>SplineCandOcc<span class="sign">,</span> <span class="comment">// occupied indices for the spline candidate knots</span>
<span class="line_number">189 </span>           <span class="sign">*</span>SplineNknotsHyper<span class="sign">,</span> <span class="comment">// parameter for prior on the number of knots</span>
<span class="line_number">190 </span>           <span class="sign">*</span>SplineBDMConst<span class="sign">,</span> <span class="comment">//Tuning parameter for birth-death-move</span>
<span class="line_number">191 </span>           <span class="sign">*</span>SplineBasis<span class="sign">,</span> <span class="comment">//Basis of the spline</span>
<span class="line_number">192 </span>           <span class="sign">*</span>SplineBasisCum<span class="sign">,</span> <span class="comment">//Cumulative basis</span>
<span class="line_number">193 </span>           <span class="sign">*</span>SplineBasisInt<span class="sign">,</span> <span class="comment">//Integral over the basis functions</span>
<span class="line_number">194 </span>           <span class="sign">*</span>SplineBasisExp<span class="sign">,</span> <span class="comment">//Expectation of each spline component</span>
<span class="line_number">195 </span>           <span class="sign">*</span>SplinePar<span class="sign">,</span> <span class="comment">//Spline parameters (theta)</span>
<span class="line_number">196 </span>           <span class="sign">*</span>SplineEPar<span class="sign">,</span> <span class="comment">// exponential of Spline parameters (theta)</span>
<span class="line_number">197 </span>           <span class="sign">*</span>SplineMin<span class="sign">,</span> <span class="comment">// minimum recommended parameter value</span>
<span class="line_number">198 </span>           <span class="sign">*</span>SplinePenaltyMatrix<span class="sign">,</span> <span class="comment">// Penalty matrix on spline parameters</span>
<span class="line_number">199 </span>           <span class="sign">*</span>SplinePenaltyFactor<span class="sign">,</span> <span class="comment">// Weight factor for smoothness penalty</span>
<span class="line_number">200 </span>           <span class="sign">*</span>SplineMeanPenalty<span class="sign">,</span> <span class="comment">// penalty on the mean (frailty only)</span>
<span class="line_number">201 </span>           <span class="sign">*</span>SplinePriorvar<span class="sign">,</span> <span class="comment">//prior variance</span>
<span class="line_number">202 </span>           <span class="sign">*</span>SplineHyper<span class="sign">,</span> <span class="comment">//Spline Hyperparameters</span>
<span class="line_number">203 </span>           <span class="sign">*</span>SplineCandCov<span class="sign">,</span> <span class="comment">// Covariance matrix of candidates</span>
<span class="line_number">204 </span>           <span class="sign">*</span>SplineCandSD<span class="sign">,</span> <span class="comment">// standard deviations of candidates</span>
<span class="line_number">205 </span>           <span class="sign">*</span>SplineCholCov<span class="sign">,</span> <span class="comment">//Covariance matrix Cholesky decomposition</span>
<span class="line_number">206 </span>           <span class="sign">*</span>SplineTun<span class="sign">,</span> <span class="comment">// Tuning parameter for spline parameters</span>
<span class="line_number">207 </span>           <span class="sign">*</span>SplineAccept<span class="sign">,</span> <span class="comment">// Acceptance indicator for spline parameters</span>
<span class="line_number">208 </span>           <span class="sign">*</span>ParamPar<span class="sign">,</span> <span class="comment">//Parametric component parameters</span>
<span class="line_number">209 </span>           <span class="sign">*</span>ParamPriorvar<span class="sign">,</span> <span class="comment">// Parametric Prior variance</span>
<span class="line_number">210 </span>           <span class="sign">*</span>ParamCandCov<span class="sign">,</span> <span class="comment">// Candidate covariance</span>
<span class="line_number">211 </span>           <span class="sign">*</span>ParamCholCov<span class="sign">,</span> <span class="comment">// Candidate covariance Cholesky</span>
<span class="line_number">212 </span>           <span class="sign">*</span>ParamTun<span class="sign">,</span> <span class="comment">// Parametric tuning parameter</span>
<span class="line_number">213 </span>           <span class="sign">*</span>ParamHyper<span class="sign">,</span> <span class="comment">//Parametric hyperparameters</span>
<span class="line_number">214 </span>           <span class="sign">*</span>ParamAccept<span class="sign">,</span> <span class="comment">// Acceptance indicator for parametric parameters</span>
<span class="line_number">215 </span>           <span class="sign">*</span>Weight<span class="sign">,</span> <span class="comment">// Weight of spline component</span>
<span class="line_number">216 </span>           <span class="sign">*</span>WeightPriorvar<span class="sign">,</span> <span class="comment">//Prior variance of weight</span>
<span class="line_number">217 </span>           <span class="sign">*</span>WeightTun<span class="sign">,</span> <span class="comment">//Tuning parameter for weight</span>
<span class="line_number">218 </span>           <span class="sign">*</span>WeightHyper<span class="sign">,</span> <span class="comment">//Hyperparameters for weight</span>
<span class="line_number">219 </span>           <span class="sign">*</span>WeightAccept<span class="sign">,</span> <span class="comment">// Acceptance for weight</span>
<span class="line_number">220 </span>           <span class="sign">*</span>Accept<span class="sign">,</span> <span class="comment">// Acceptance indicator for x (only used by frailty)</span>
<span class="line_number">221 </span>           <span class="sign">*</span>tun<span class="sign">,</span> <span class="comment">// Tuning parameter (general)</span>
<span class="line_number">222 </span>           <span class="sign">*</span>X<span class="sign">,</span> <span class="comment">// Observations</span>
<span class="line_number">223 </span>           <span class="sign">*</span>SplineY<span class="sign">,</span> <span class="comment">// Spline estimates</span>
<span class="line_number">224 </span>           <span class="sign">*</span>ParamY<span class="sign">,</span> <span class="comment">// Parametric estimates</span>
<span class="line_number">225 </span>           <span class="sign">*</span>Y<span class="sign">,</span> <span class="comment">// estimates</span>
<span class="line_number">226 </span>           <span class="sign">*</span>SplineYcum<span class="sign">,</span> <span class="comment">// Spline cumulative</span>
<span class="line_number">227 </span>           <span class="sign">*</span>ParamYcum<span class="sign">,</span> <span class="comment">// parametric cumulative</span>
<span class="line_number">228 </span>           <span class="sign">*</span>Ycum<span class="sign">;</span> <span class="comment">// Cumulative</span>
<span class="line_number">229 </span><span class="sign">}</span> <span class="sign">*</span>curveP<span class="sign">;</span>
</pre>

<hr />
<a name="01structures2fCHistory"></a>
<a name="robo24"></a><h2>01structures/CHistory [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../R/splinefrailty_r.html#robo1">01structures</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>CHistory</strong> --- structure to store MCMC history
</pre>
<p class="item_name">FUNCTION</p>
<p>    This structure contains the state of the chain after every stored iteration.
</p>

<p>    The components are described by commments in the source.
</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">276 </span><span class="keyword">typedef</span> <span class="keyword">struct</span> hist <span class="sign">{</span>
<span class="line_number">277 </span>    <span class="keyword">int</span> ny<span class="sign">;</span> <span class="comment">// number of iterations</span>
<span class="line_number">278 </span>    <span class="keyword">double</span> <span class="sign">*</span>frailty<span class="sign">,</span> <span class="comment">// values of the frailties</span>
<span class="line_number">279 </span>           <span class="sign">*</span>coefficients<span class="sign">,</span> <span class="comment">// regression coefficients</span>
<span class="line_number">280 </span>           <span class="sign">*</span>HazardSplinePar<span class="sign">,</span> <span class="comment">// spline parameters for the hazard</span>
<span class="line_number">281 </span>           <span class="sign">*</span>HazardSplineKnots<span class="sign">,</span> <span class="comment">// knots for the hazard spline</span>
<span class="line_number">282 </span>           <span class="sign">*</span>FrailtySplinePar<span class="sign">,</span> <span class="comment">// parameters for the frailty spline</span>
<span class="line_number">283 </span>           <span class="sign">*</span>FrailtySplineKnots<span class="sign">,</span> <span class="comment">// knots for the frailty spline</span>
<span class="line_number">284 </span>           <span class="sign">*</span>FrailtySplineFvar<span class="sign">,</span> <span class="comment">// variance of the frailty spline</span>
<span class="line_number">285 </span>           <span class="sign">*</span>HazardParamPar<span class="sign">,</span> <span class="comment">// parametric component parameters for the hazard</span>
<span class="line_number">286 </span>           <span class="sign">*</span>FrailtyParamPar<span class="sign">,</span> <span class="comment">// parametric component parameters for the frailty</span>
<span class="line_number">287 </span>           <span class="sign">*</span>HazardWeight<span class="sign">,</span> <span class="comment">// weight of the spline component for the hazard</span>
<span class="line_number">288 </span>           <span class="sign">*</span>FrailtyWeight<span class="sign">,</span> <span class="comment">// weight of the spline component for the frailty</span>
<span class="line_number">289 </span>           <span class="sign">*</span>priorvar<span class="sign">,</span> <span class="comment">// prior error variances</span>
<span class="line_number">290 </span>           <span class="sign">*</span>accept<span class="sign">;</span> <span class="comment">// acceptance rates for each of the components</span>
<span class="line_number">291 </span><span class="sign">}</span> <span class="sign">*</span>historyP<span class="sign">;</span>
</pre>

<hr />
<a name="01structures2fCRegression"></a>
<a name="robo25"></a><h2>01structures/CRegression [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../R/splinefrailty_r.html#robo1">01structures</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>CRegression</strong> --- structure to store regression information
</pre>
<p class="item_name">FUNCTION</p>
<p>    This structure contains all the information about the regression components
    of the problem, including covariates, regression coefficients, status
    indicators, etc.
</p>

<p>    The components are described by commments in the source.
</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">243 </span><span class="keyword">typedef</span> <span class="keyword">struct</span> regress <span class="sign">{</span>
<span class="line_number">244 </span>    <span class="keyword">int</span> m<span class="sign">,</span>  <span class="comment">// # of clusters</span>
<span class="line_number">245 </span>        n<span class="sign">,</span>  <span class="comment">// # of observations</span>
<span class="line_number">246 </span>        p<span class="sign">,</span>  <span class="comment">// # of regression parameters</span>
<span class="line_number">247 </span>        <span class="sign">*</span>Ji<span class="sign">,</span> <span class="comment">// subjects per cluster (length m)</span>
<span class="line_number">248 </span>        <span class="sign">*</span>Jicum<span class="sign">,</span> <span class="comment">// cumsum of Ji (length m+1)</span>
<span class="line_number">249 </span>        <span class="sign">*</span>cluster<span class="sign">;</span> <span class="comment">// Cluster ID</span>
<span class="line_number">250 </span>    <span class="keyword">double</span> <span class="sign">*</span>coefficients<span class="sign">,</span> <span class="comment">// coefficient estimates</span>
<span class="line_number">251 </span>           <span class="sign">*</span>covariates<span class="sign">,</span> <span class="comment">// covariate estimates</span>
<span class="line_number">252 </span>           <span class="sign">*</span>lp<span class="sign">,</span> <span class="comment">// linear predictor</span>
<span class="line_number">253 </span>           <span class="sign">*</span>elp<span class="sign">,</span> <span class="comment">// exponential of linear predictor</span>
<span class="line_number">254 </span>           <span class="sign">*</span>status<span class="sign">,</span> <span class="comment">// event status indicators (note: double)</span>
<span class="line_number">255 </span>           <span class="sign">*</span>time<span class="sign">,</span> <span class="comment">// event time</span>
<span class="line_number">256 </span>           <span class="sign">*</span>frailrep<span class="sign">,</span> <span class="comment">// repeated frailties</span>
<span class="line_number">257 </span>           <span class="sign">*</span>frailelp<span class="sign">,</span> <span class="comment">// frailty * elp</span>
<span class="line_number">258 </span>           <span class="sign">*</span>CandCov<span class="sign">,</span>  <span class="comment">// covariance matrix of candidates</span>
<span class="line_number">259 </span>           <span class="sign">*</span>CholCov<span class="sign">,</span> <span class="comment">// Cholesky factor of covariance</span>
<span class="line_number">260 </span>           <span class="sign">*</span>priorvar<span class="sign">,</span> <span class="comment">// variance of prior</span>
<span class="line_number">261 </span>           <span class="sign">*</span>hyper<span class="sign">,</span>   <span class="comment">// hyperparameters of prior</span>
<span class="line_number">262 </span>           <span class="sign">*</span>Accept<span class="sign">,</span> <span class="comment">// Acceptance indicator</span>
<span class="line_number">263 </span>           <span class="sign">*</span>tun<span class="sign">;</span>    <span class="comment">// tuning parameter</span>
<span class="line_number">264 </span><span class="sign">}</span> <span class="sign">*</span>regressionP<span class="sign">;</span>
</pre>

<hr />
<a name="CcurveUpdate2fEvalCurveAtOnePoint"></a>
<a name="robo29"></a><h2>CcurveUpdate/EvalCurveAtOnePoint [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>EvalCurveAtOnePoint</strong> --- evaluate a <a href="#robo23">CCurve</a> at a single point
</pre>
<p class="item_name">FUNCTION</p>
<p>    Given a point x, compute the value of the curve at that point, even if it is
    not included in the curve's set of observations.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1395 </span><span class="keyword">double</span> <strong>EvalCurveAtOnePoint</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> <span class="keyword">double</span> x<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      <a href="#robo23">CCurve</a> to be evaluated
    x             double, point at which to evaluate it.
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    y             <a href="#robo23">CCurve</a> evaluated at x
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1399 </span><span class="sign">{</span>
<span class="line_number">1400 </span>    <span class="comment">// this would actually work on frailties, I think, but it never gets called</span>
<span class="line_number">1401 </span>    <span class="comment">// for frailties, so I just put this in as a safeguard.</span>
<span class="line_number">1402 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> Rprintf<span class="sign">(</span><span class="quote">"Error: using <strong>EvalCurveAtOnePoint</strong> on hazard"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1403 </span>    <span class="comment">// evaluate spline component</span>
<span class="line_number">1404 </span>    <span class="keyword">double</span> splY<span class="sign">=</span><a href="#robo33">EvalSplineAtOnePoint</a><span class="sign">(</span>theCurve<span class="sign">,</span>x<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1405 </span>    <span class="comment">// evaluate parametric component</span>
<span class="line_number">1406 </span>    <span class="keyword">double</span> parY<span class="sign">=</span><a href="#robo30">EvalParamAtOnePoint</a><span class="sign">(</span>theCurve<span class="sign">,</span>x<span class="sign">,</span>0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1407 </span>    <span class="comment">// weight the two components</span>
<span class="line_number">1408 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasPar <span class="sign">&amp;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span>
<span class="line_number">1409 </span>        <span class="keyword">return</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">*</span> splY <span class="sign">+</span> <span class="sign">(</span>1<span class="sign">-</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>parY<span class="sign">;</span>
<span class="line_number">1410 </span>    <span class="keyword">else</span> <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasPar<span class="sign">)</span>
<span class="line_number">1411 </span>        <span class="keyword">return</span> parY<span class="sign">;</span>
<span class="line_number">1412 </span>    <span class="keyword">else</span> <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span>
<span class="line_number">1413 </span>        <span class="keyword">return</span> splY<span class="sign">;</span>
<span class="line_number">1414 </span>    <span class="keyword">else</span> <span class="keyword">return</span> 0<span class="sign">;</span>
<span class="line_number">1415 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fEvalParamAtOnePoint"></a>
<a name="robo30"></a><h2>CcurveUpdate/EvalParamAtOnePoint [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>EvalParamAtOnePoint</strong> --- evaluate parametric component at a single point
</pre>
<p class="item_name">FUNCTION</p>
<p>    Called as part of <a href="#robo29">EvalCurveAtOnePoint</a>, evaluates the parametric component of
    a <a href="#robo23">CCurve</a> given a point x.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1283 </span><span class="keyword">double</span> <strong>EvalParamAtOnePoint</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> <span class="keyword">double</span> x<span class="sign">,</span> <span class="keyword">int</span> cum<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      <a href="#robo23">CCurve</a> structure
    x             double, point at which the curve should be evaluated
    cum           integer, if &gt;0, the cumulative integral of the curve is returned
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    y             the value of the parametric component at point x
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1287 </span><span class="sign">{</span>
<span class="line_number">1288 </span>    <span class="keyword">double</span> parY <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">1289 </span>    <span class="keyword">double</span> parYcum <span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">1290 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasPar<span class="sign">)</span> <span class="keyword">return</span> parY<span class="sign">;</span>
<span class="line_number">1291 </span>    <span class="comment">// parametric hazard types</span>
<span class="line_number">1292 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1293 </span>        <span class="comment">// exponential hazard</span>
<span class="line_number">1294 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParDist <span class="sign">=</span><span class="sign">=</span> Dexponential<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1295 </span>            <span class="keyword">double</span> lambda <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1296 </span>            parY <span class="sign">=</span> lambda<span class="sign">;</span>
<span class="line_number">1297 </span>            parYcum <span class="sign">=</span> lambda<span class="sign">*</span>x<span class="sign">;</span>
<span class="line_number">1298 </span>        <span class="comment">// weibull hazard</span>
<span class="line_number">1299 </span>        <span class="sign">}</span><span class="keyword">else</span> <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParDist <span class="sign">=</span><span class="sign">=</span> Dweibull<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1300 </span>            <span class="keyword">double</span> lambda <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1301 </span>            <span class="keyword">double</span> alpha <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1302 </span>            parY <span class="sign">=</span> alpha<span class="sign">*</span>lambda<span class="sign">*</span><span class="keyword">pow</span><span class="sign">(</span>x<span class="sign">,</span>alpha<span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1303 </span>            parYcum <span class="sign">=</span> lambda <span class="sign">*</span> <span class="keyword">pow</span><span class="sign">(</span>x<span class="sign">,</span>alpha<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1304 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1305 </span>            Rprintf<span class="sign">(</span><span class="quote">"distribution not implemented"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1306 </span>        <span class="sign">}</span>
<span class="line_number">1307 </span>    <span class="comment">// parametric frailty distributions</span>
<span class="line_number">1308 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1309 </span>        <span class="comment">// gamma distribution</span>
<span class="line_number">1310 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParDist <span class="sign">=</span><span class="sign">=</span> Dgamma<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1311 </span>            <span class="keyword">double</span> alpha <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span><span class="sign">-</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1312 </span>            parY <span class="sign">=</span> dgamma<span class="sign">(</span>x<span class="sign">,</span> alpha<span class="sign">,</span> 1<span class="sign">/</span>alpha<span class="sign">,</span>0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1313 </span>        <span class="comment">// lognormal distribution</span>
<span class="line_number">1314 </span>        <span class="sign">}</span><span class="keyword">else</span> <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParDist <span class="sign">=</span><span class="sign">=</span> Dlognormal<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1315 </span>            <span class="keyword">double</span> alpha <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1316 </span>            parY <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span><span class="sign">-</span><span class="keyword">pow</span><span class="sign">(</span>log<span class="sign">(</span>x<span class="sign">)</span><span class="sign">+</span>alpha<span class="sign">/</span>2<span class="sign">,</span>2<span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>2<span class="sign">*</span>alpha<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>x<span class="sign">*</span><span class="keyword">sqrt</span><span class="sign">(</span>2<span class="sign">*</span>M_PI<span class="sign">*</span>alpha<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1317 </span>        <span class="sign">}</span>
<span class="line_number">1318 </span>    <span class="sign">}</span>
<span class="line_number">1319 </span>    <span class="keyword">return</span> <span class="sign">(</span>cum <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="sign">?</span> parY <span class="sign">:</span> parYcum<span class="sign">;</span>
<span class="line_number">1320 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fEvalParametric"></a>
<a name="robo31"></a><h2>CcurveUpdate/EvalParametric [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>EvalParametric</strong> --- evaluate the parametric component of a curve with new parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Re-evaluate the parametric component of a curve if the parametric component parameters
    have changed.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1336 </span><span class="keyword">void</span> <strong>EvalParametric</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> <span class="keyword">int</span> i<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      <a href="#robo23">CCurve</a> structure
    i             index of the observation that should be evaluated
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    theCurve      <a href="#robo23">CCurve</a>, with Y and Ycum updated
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1340 </span><span class="sign">{</span>
<span class="line_number">1341 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasPar<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">1342 </span>    <span class="keyword">if</span><span class="sign">(</span>i<span class="sign">&lt;</span>0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1343 </span>        <span class="comment">// if all observations should be updated, updated them one by one</span>
<span class="line_number">1344 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> ind<span class="sign">=</span>0<span class="sign">;</span> ind<span class="sign">&lt;</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">;</span> ind<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> <strong>EvalParametric</strong><span class="sign">(</span>theCurve<span class="sign">,</span> ind<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1345 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1346 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamY<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> <a href="#robo30">EvalParamAtOnePoint</a><span class="sign">(</span>theCurve<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>i<span class="sign">]</span><span class="sign">,</span> 0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1347 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span>
<span class="line_number">1348 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamYcum<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> <a href="#robo30">EvalParamAtOnePoint</a><span class="sign">(</span>theCurve<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>i<span class="sign">]</span><span class="sign">,</span> 1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1349 </span>    <span class="sign">}</span>
<span class="line_number">1350 </span>    <a href="#robo40">ReweightCurve</a><span class="sign">(</span>theCurve<span class="sign">,</span> i<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1351 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fEvalSpline"></a>
<a name="robo32"></a><h2>CcurveUpdate/EvalSpline [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>EvalSpline</strong> --- evaluate spline component
</pre>
<p class="item_name">FUNCTION</p>
<p>    Evaluate the spline component if the spline parameters have been changed. This function
    assumes the basis is correctly specified, and only the spline parameters (theta) have changed.
</p>

<p>    The only components of the curve that are changed are SplineY and SplineYcum; The function
    <a href="#robo40">ReweightCurve</a> is called at the end to update Y and Ycum.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1141 </span><span class="keyword">void</span> <strong>EvalSpline</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> <span class="keyword">int</span> i<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      <a href="#robo23">CCurve</a> structure whose SplinePar and SplineEPar have changed
    i             index of observation to update, or -1 for all
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    theCurve      <a href="#robo23">CCurve</a> with Y and Ycum updated
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1145 </span><span class="sign">{</span>
<span class="line_number">1146 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">1147 </span>    <span class="keyword">if</span><span class="sign">(</span>i<span class="sign">&gt;</span><span class="sign">=</span>0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1148 </span>        <span class="comment">// evaluate a single observation</span>
<span class="line_number">1149 </span>        <span class="keyword">int</span> c1<span class="sign">=</span>1<span class="sign">;</span>
<span class="line_number">1150 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> F77_CALL<span class="sign">(</span>ddot<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasis <span class="sign">+</span> i<span class="sign">,</span>
<span class="line_number">1151 </span>                <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">)</span><span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1152 </span>        <span class="comment">// normalize frailty density</span>
<span class="line_number">1153 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">/</span><span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum<span class="sign">;</span>
<span class="line_number">1154 </span>        <span class="comment">// compute cumulative hazard</span>
<span class="line_number">1155 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span>
<span class="line_number">1156 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineYcum<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> F77_CALL<span class="sign">(</span>ddot<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisCum <span class="sign">+</span> i<span class="sign">,</span>
<span class="line_number">1157 </span>                <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">)</span><span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1158 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1159 </span>        <span class="comment">// evaluate entire curve</span>
<span class="line_number">1160 </span>        <span class="keyword">int</span> c1 <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1161 </span>        <span class="keyword">double</span> c0 <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">1162 </span>        char trans <span class="sign">=</span> <span class="squote">'N'</span><span class="sign">;</span>
<span class="line_number">1163 </span>        <span class="keyword">double</span> scaler <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard <span class="sign">?</span> 1<span class="sign">.</span>0 <span class="sign">:</span> 1<span class="sign">.</span>0<span class="sign">/</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum<span class="sign">;</span>
<span class="line_number">1164 </span>        <span class="comment">// set splineY = basis * splinepar + 0*splineY</span>
<span class="line_number">1165 </span>        F77_CALL<span class="sign">(</span>dgemv<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>trans<span class="sign">,</span> <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">)</span><span class="sign">,</span> <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">,</span> <span class="sign">&amp;</span>scaler<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasis<span class="sign">,</span>
<span class="line_number">1166 </span>                <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">)</span><span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> <span class="sign">&amp;</span>c0<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1167 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span>
<span class="line_number">1168 </span>            F77_CALL<span class="sign">(</span>dgemv<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>trans<span class="sign">,</span> <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">)</span><span class="sign">,</span> <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">,</span> <span class="sign">&amp;</span>scaler<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisCum<span class="sign">,</span>
<span class="line_number">1169 </span>                    <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">)</span><span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> <span class="sign">&amp;</span>c0<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineYcum<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1170 </span>    <span class="sign">}</span>
<span class="line_number">1171 </span>    <a href="#robo40">ReweightCurve</a><span class="sign">(</span>theCurve<span class="sign">,</span> i<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1172 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fEvalSplineAtOnePoint"></a>
<a name="robo33"></a><h2>CcurveUpdate/EvalSplineAtOnePoint [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>EvalSplineAtOnePoint</strong> --- evaluate spline at a given value of x
</pre>
<p class="item_name">FUNCTION</p>
<p>    Evaluate a spline curve at a given point, even if that point is not stored in its
    X component and has not been included in its basis. This differs from <a href="#robo32">EvalSpline</a> in that
    the latter must already have a fully computed basis stored. This one does a full curve
    evaluation -- in that sense it acts as a wrapper to <a href="./init_c.html#robo103">csplineeval</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1189 </span><span class="keyword">double</span> <strong>EvalSplineAtOnePoint</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> <span class="keyword">double</span> x<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      a <a href="#robo23">CCurve</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    x             value at which to evaluate the spline
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1193 </span><span class="sign">{</span>
<span class="line_number">1194 </span>    <span class="keyword">double</span> splY<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">1195 </span>    <span class="keyword">int</span> c1<span class="sign">=</span>1<span class="sign">;</span>
<span class="line_number">1196 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1197 </span>        <span class="comment">// compute the basis at x</span>
<span class="line_number">1198 </span>        <span class="keyword">double</span> <span class="sign">*</span> tempBasis <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1199 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>0<span class="sign">;</span> j<span class="sign">&lt;</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> tempBasis<span class="sign">[</span>j<span class="sign">]</span><span class="sign">=</span><a href="./init_c.html#robo103">csplineeval</a><span class="sign">(</span>x<span class="sign">,</span> j<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">,</span>
<span class="line_number">1200 </span>                theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1201 </span>        <span class="comment">// normalize the frailty basis</span>
<span class="line_number">1202 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span>
<span class="line_number">1203 </span>            <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>0<span class="sign">;</span> j<span class="sign">&lt;</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> tempBasis<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">/</span><span class="sign">=</span> <span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisInt<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">*</span>
<span class="line_number">1204 </span>                    theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">1205 </span>        <span class="comment">// compute the spline value at X</span>
<span class="line_number">1206 </span>        splY <span class="sign">=</span> F77_CALL<span class="sign">(</span>ddot<span class="sign">)</span><span class="sign">(</span> <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">,</span> tempBasis<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1207 </span>        <span class="keyword">free</span><span class="sign">(</span>tempBasis<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1208 </span>    <span class="sign">}</span>
<span class="line_number">1209 </span>    <span class="keyword">return</span> splY<span class="sign">;</span>
<span class="line_number">1210 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fFrailtySplineVar"></a>
<a name="robo34"></a><h2>CcurveUpdate/FrailtySplineVar [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>FrailtySplineVar</strong> --- compute frailty variance of a spline component
</pre>
<p class="item_name">FUNCTION</p>
<p>    For the spline component of a frailty density curve, compute the corresponding
    frailty variance.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">577 </span><span class="keyword">double</span> <strong>FrailtySplineVar</strong><span class="sign">(</span>curveP frailty<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    frailty   a frailty <a href="#robo23">CCurve</a>
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    fvar      variance of the frailty density
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">581 </span><span class="sign">{</span>
<span class="line_number">582 </span>    <span class="keyword">double</span> fvar<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">583 </span>    <span class="keyword">double</span> <span class="sign">*</span> Moment2 <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>nj <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">584 </span>    <span class="keyword">int</span> ord <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">;</span>
<span class="line_number">585 </span>    <span class="keyword">int</span> K <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">;</span>
<span class="line_number">586 </span>    <span class="keyword">int</span> N<span class="sign">=</span>2<span class="sign">;</span>
<span class="line_number">587 </span>    <span class="comment">// vector of second moments of each basis function</span>
<span class="line_number">588 </span>    <a href="./init_c.html#robo98">cevalEinte</a><span class="sign">(</span>Moment2<span class="sign">,</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">,</span><span class="sign">&amp;</span>ord<span class="sign">,</span><span class="sign">&amp;</span>K<span class="sign">,</span><span class="sign">&amp;</span>N<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">589 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> Moment2<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> 1<span class="sign">-</span>Moment2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">590 </span>    <span class="comment">// second moment of the entire density</span>
<span class="line_number">591 </span>    fvar <span class="sign">=</span> <a href="#robo81">ddotWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> Moment2<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">)</span><span class="sign">/</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum<span class="sign">;</span>
<span class="line_number">592 </span>    <span class="comment">// subtract mean^2</span>
<span class="line_number">593 </span>    fvar <span class="sign">=</span> fvar <span class="sign">-</span> 1<span class="sign">.</span>0<span class="sign">;</span>
<span class="line_number">594 </span>    <span class="keyword">return</span> fvar<span class="sign">;</span>
<span class="line_number">595 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fMakeSplineBasis"></a>
<a name="robo35"></a><h2>CcurveUpdate/MakeSplineBasis [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>MakeSplineBasis</strong> --- make a the spline basis from scratch
</pre>
<p class="item_name">FUNCTION</p>
<p>    Function to make the spline basis, analogous to <a href="../R/splinefrailty_r.html#robo184">makesplinebasis</a> in R. It can
    be called when the knots, or X values of the curve have changed.
    This turned out to be rather inefficient, and was replaced by <a href="#robo39">RemakeSplineBasis</a>,
    but this function remains in the codebase for debugging.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1030 </span><span class="keyword">void</span> <strong>MakeSplineBasis</strong><span class="sign">(</span>curveP theCurve<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      a <a href="#robo23">CCurve</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    theCurve, with SplineBasis, SplineBasisCum, SplineBasisInt and SplineBasisExp updated
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1034 </span><span class="sign">{</span>
<span class="line_number">1035 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">1036 </span>    <span class="keyword">double</span> <span class="sign">*</span> knots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">;</span>
<span class="line_number">1037 </span>    <span class="keyword">int</span> ord <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">;</span>
<span class="line_number">1038 </span>    <span class="keyword">int</span> nknots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">;</span>
<span class="line_number">1039 </span>    <span class="keyword">int</span> nj <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span>
<span class="line_number">1040 </span>    <span class="keyword">double</span> <span class="sign">*</span> x <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">;</span>
<span class="line_number">1041 </span>    <span class="keyword">int</span> c1 <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1042 </span>
<span class="line_number">1043 </span>    <span class="comment">// compute integrals over each basis spline</span>
<span class="line_number">1044 </span>    <a href="../R/splinefrailty_r.html#robo112">cevalBinte</a><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisInt<span class="sign">,</span> knots<span class="sign">,</span> <span class="sign">&amp;</span>ord<span class="sign">,</span> <span class="sign">&amp;</span>nknots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1045 </span>
<span class="line_number">1046 </span>    <span class="comment">// For frailty, compute the expectations</span>
<span class="line_number">1047 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> 
<span class="line_number">1048 </span>        <a href="./init_c.html#robo98">cevalEinte</a><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">,</span> knots<span class="sign">,</span> <span class="sign">&amp;</span>ord<span class="sign">,</span> <span class="sign">&amp;</span>nknots<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1049 </span>    
<span class="line_number">1050 </span>    <span class="comment">// Make basis</span>
<span class="line_number">1051 </span>    <a href="#robo43">UpdateSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="sign">-</span>1<span class="sign">,</span>0<span class="sign">,</span>nj<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">1052 </span>    
<span class="line_number">1053 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fPopulateLocalCurve"></a>
<a name="robo36"></a><h2>CcurveUpdate/PopulateLocalCurve [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>PopulateLocalCurve</strong> --- populate a <a href="#robo23">CCurve</a> structure from an <a href="../R/splinefrailty_r.html#robo26">RCurve</a>
</pre>
<p class="item_name">FUNCTION</p>
<p>    At initialization of the <a href="#robo22">SplineSurvMainLoop</a>, this routine populates a local
    curve that is easier to work with in C. Much of this just consists of 
    creating a set of pointers that point to the appropriate locations in R memory.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">610 </span><span class="keyword">void</span> <strong>PopulateLocalCurve</strong><span class="sign">(</span> curveP theCurve<span class="sign">,</span> SEXP Rcurve<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve  a <a href="#robo23">CCurve</a> to be populated
    Rcurve    the <a href="../R/splinefrailty_r.html#robo26">RCurve</a> that contains the current values
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">614 </span><span class="sign">{</span>
<span class="line_number">615 </span>    <span class="comment">// has a parametric component?</span>
<span class="line_number">616 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasPar <span class="sign">=</span> asInteger<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"<a href="../R/splinefrailty_r.html#robo154">haspar</a>"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">617 </span>    <span class="comment">// has a spline component?</span>
<span class="line_number">618 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline <span class="sign">=</span> asInteger<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"<a href="../R/splinefrailty_r.html#robo155">hasspline</a>"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">619 </span>    <span class="comment">// does it use adaptive knot selection?</span>
<span class="line_number">620 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineAdaptive <span class="sign">=</span> asInteger<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.adaptive"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">621 </span>    <span class="comment">// length of observations (times/frailties)</span>
<span class="line_number">622 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> <span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"x"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">623 </span>    <span class="comment">// minimum spline parameter value</span>
<span class="line_number">624 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineMin <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.min"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">625 </span>    <span class="comment">// spline prior varianc3</span>
<span class="line_number">626 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePriorvar <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.priorvar"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">627 </span>    <span class="comment">// spline hyperparameters</span>
<span class="line_number">628 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineHyper <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.hyper"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">629 </span>    <span class="comment">// spline tuning parameters</span>
<span class="line_number">630 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineTun <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.tun"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">631 </span>    <span class="comment">// spline accept/reject of the last step</span>
<span class="line_number">632 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineAccept <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.accept"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">633 </span>    <span class="comment">// parameter prior variance</span>
<span class="line_number">634 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamPriorvar <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"param.priorvar"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">635 </span>    <span class="comment">// parametric tuning parameter</span>
<span class="line_number">636 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamTun <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"param.tun"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">637 </span>    <span class="comment">// parametric hyperparameters</span>
<span class="line_number">638 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamHyper <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"param.hyper"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">639 </span>    <span class="comment">// parametric accept/reject of last step</span>
<span class="line_number">640 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamAccept <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"param.accept"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">641 </span>    <span class="comment">// weight of spline component</span>
<span class="line_number">642 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>Weight <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"weight"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">643 </span>    <span class="comment">// prior variance of weight</span>
<span class="line_number">644 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>WeightPriorvar <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"weight.priorvar"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">645 </span>    <span class="comment">// hyperparameters of weight</span>
<span class="line_number">646 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>WeightHyper <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"weight.hyper"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">647 </span>    <span class="comment">// tuning parameter of weight</span>
<span class="line_number">648 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>WeightTun <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"weight.tun"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">649 </span>    <span class="comment">// accept/reject for last step of weight</span>
<span class="line_number">650 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>WeightAccept <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"weight.accept"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">651 </span>    <span class="comment">// vector of observations</span>
<span class="line_number">652 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>X <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"x"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">653 </span>    <span class="comment">// vector of the curve evaluated at X</span>
<span class="line_number">654 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>Y <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"y"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">655 </span>    <span class="comment">// hazard curves also need a vector of cumulative hazard integrals</span>
<span class="line_number">656 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Ycum <span class="sign">=</span>REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"ycum"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">657 </span>    <span class="comment">// frailty curve needs to keep track of acceptance of the frailties themselves</span>
<span class="line_number">658 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Accept <span class="sign">=</span>REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"accept"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">659 </span>    <span class="comment">// tuning parameter for the frailties</span>
<span class="line_number">660 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>tun <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"tun"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">661 </span>
<span class="line_number">662 </span>    <span class="comment">// special terms for spline components</span>
<span class="line_number">663 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span><span class="sign">{</span>  
<span class="line_number">664 </span>        <span class="comment">// order of the spline</span>
<span class="line_number">665 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">=</span>asInteger<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.ord"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">666 </span>        <span class="comment">// number of knots of the spline</span>
<span class="line_number">667 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots <span class="sign">=</span> asInteger<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.nknots"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">668 </span>        <span class="comment">// max number of knots</span>
<span class="line_number">669 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsMax <span class="sign">=</span> asInteger<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.maxoccknots"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">670 </span>        <span class="comment">// hyperparameters for the number of knots</span>
<span class="line_number">671 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsHyper <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.nknots.hyper"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">672 </span>        <span class="comment">// number of candidate knots</span>
<span class="line_number">673 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNCandKnots <span class="sign">=</span> asInteger<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.ncandknots"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">674 </span>        <span class="comment">// vector of candidate knot positions</span>
<span class="line_number">675 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineCandKnots <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.candknots"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">676 </span>        <span class="comment">// vector of occupancies of candidate knots</span>
<span class="line_number">677 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineCandOcc <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.candocc"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">678 </span>        <span class="comment">// constant used for birth-death-move step</span>
<span class="line_number">679 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBDMConst <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.bdmconst"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">680 </span>        <span class="comment">// number of spline basis functions</span>
<span class="line_number">681 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots <span class="sign">+</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">;</span>
<span class="line_number">682 </span>        <span class="comment">// get the type of prior on the number of knots</span>
<span class="line_number">683 </span>        const char <span class="sign">*</span> charNknotsPrior <span class="sign">=</span> 
<span class="line_number">684 </span>            CHAR<span class="sign">(</span>STRING_ELT<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.nknots.prior"</span><span class="sign">)</span><span class="sign">,</span>0<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">685 </span>        nknotsprior iNknotsPrior<span class="sign">;</span>
<span class="line_number">686 </span>        <span class="keyword">if</span><span class="sign">(</span>strcmp<span class="sign">(</span>charNknotsPrior<span class="sign">,</span><span class="quote">"poisson"</span><span class="sign">)</span><span class="sign">=</span><span class="sign">=</span>0<span class="sign">)</span> iNknotsPrior<span class="sign">=</span>PrPoisson<span class="sign">;</span>
<span class="line_number">687 </span>        <span class="keyword">if</span><span class="sign">(</span>strcmp<span class="sign">(</span>charNknotsPrior<span class="sign">,</span><span class="quote">"geometric"</span><span class="sign">)</span><span class="sign">=</span><span class="sign">=</span>0<span class="sign">)</span> iNknotsPrior<span class="sign">=</span>PrGeometric<span class="sign">;</span>
<span class="line_number">688 </span>        <span class="keyword">if</span><span class="sign">(</span>strcmp<span class="sign">(</span>charNknotsPrior<span class="sign">,</span><span class="quote">"poissonmix"</span><span class="sign">)</span><span class="sign">=</span><span class="sign">=</span>0<span class="sign">)</span> iNknotsPrior<span class="sign">=</span>PrPoissonMix<span class="sign">;</span>
<span class="line_number">689 </span>        <span class="keyword">if</span><span class="sign">(</span>strcmp<span class="sign">(</span>charNknotsPrior<span class="sign">,</span><span class="quote">"negbin"</span><span class="sign">)</span><span class="sign">=</span><span class="sign">=</span>0<span class="sign">)</span> iNknotsPrior<span class="sign">=</span>PrNegBin<span class="sign">;</span>
<span class="line_number">690 </span>        <span class="keyword">if</span><span class="sign">(</span>strcmp<span class="sign">(</span>charNknotsPrior<span class="sign">,</span><span class="quote">"power"</span><span class="sign">)</span><span class="sign">=</span><span class="sign">=</span>0<span class="sign">)</span> iNknotsPrior<span class="sign">=</span>PrPower<span class="sign">;</span>
<span class="line_number">691 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsPrior <span class="sign">=</span> iNknotsPrior<span class="sign">;</span>
<span class="line_number">692 </span>
<span class="line_number">693 </span>        <span class="comment">// get the type of smoothness penalty</span>
<span class="line_number">694 </span>        const char <span class="sign">*</span> charPenaltyType <span class="sign">=</span> 
<span class="line_number">695 </span>            CHAR<span class="sign">(</span>STRING_ELT<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.penalty"</span><span class="sign">)</span><span class="sign">,</span>0<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">696 </span>        penalty iPenaltyType<span class="sign">;</span>
<span class="line_number">697 </span>        <span class="keyword">if</span> <span class="sign">(</span>strcmp<span class="sign">(</span>charPenaltyType<span class="sign">,</span><span class="quote">"2diff"</span><span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span>0<span class="sign">)</span> <span class="sign">{</span> iPenaltyType<span class="sign">=</span>pdiff<span class="sign">;</span> <span class="sign">}</span>
<span class="line_number">698 </span>        <span class="keyword">else</span> <span class="keyword">if</span> <span class="sign">(</span>strcmp<span class="sign">(</span>charPenaltyType<span class="sign">,</span><span class="quote">"2deriv"</span><span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span>0<span class="sign">)</span> <span class="sign">{</span> iPenaltyType<span class="sign">=</span>pderiv<span class="sign">;</span> <span class="sign">}</span>
<span class="line_number">699 </span>        <span class="keyword">else</span> <span class="keyword">if</span> <span class="sign">(</span>strcmp<span class="sign">(</span>charPenaltyType<span class="sign">,</span><span class="quote">"log2deriv"</span><span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span>0<span class="sign">)</span> <span class="sign">{</span> iPenaltyType<span class="sign">=</span>plogderiv<span class="sign">;</span><span class="sign">}</span>
<span class="line_number">700 </span>        <span class="keyword">else</span> <span class="sign">{</span> iPenaltyType<span class="sign">=</span>pnone<span class="sign">;</span><span class="sign">}</span>
<span class="line_number">701 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePenaltyType <span class="sign">=</span> iPenaltyType<span class="sign">;</span>
<span class="line_number">702 </span>        <span class="keyword">if</span><span class="sign">(</span>iPenaltyType <span class="sign">!</span><span class="sign">=</span> pnone<span class="sign">)</span> <span class="comment">// if there is a penalty matrix, get it</span>
<span class="line_number">703 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePenaltyMatrix <span class="sign">=</span> 
<span class="line_number">704 </span>                REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span> <span class="quote">"spline.penaltymatrix"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">705 </span>        <span class="comment">// scaling factor for penalty</span>
<span class="line_number">706 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePenaltyFactor <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.penaltyfactor"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">707 </span>        <span class="comment">// vector of spline knots</span>
<span class="line_number">708 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.knots"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">709 </span>        <span class="comment">// spline basis matrix</span>
<span class="line_number">710 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasis <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.basis"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">711 </span>        <span class="comment">// vector of integrals of each basis function</span>
<span class="line_number">712 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisInt <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.basisint"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">713 </span>        <span class="comment">// spline parameters</span>
<span class="line_number">714 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.par"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">715 </span>        <span class="comment">// exponentials of spline parameters</span>
<span class="line_number">716 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> 
<span class="line_number">717 </span>                <span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsMax <span class="sign">+</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">)</span> <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">718 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>0<span class="sign">;</span> j<span class="sign">&lt;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span>
<span class="line_number">719 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">720 </span>        <span class="comment">// covariance matrix for candidate generation</span>
<span class="line_number">721 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineCandCov <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.candcov"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">722 </span>        <span class="comment">// cholesky factorization of the covariance matrix</span>
<span class="line_number">723 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineCholCov <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.cholcandcov"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">724 </span>        <span class="comment">// standard deviations for candidate generation</span>
<span class="line_number">725 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineCandSD <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.candsd"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">726 </span>        <span class="comment">// spline component evaluated at X</span>
<span class="line_number">727 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineY <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.y"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">728 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">729 </span>            <span class="comment">// hazards additionally need cumulative basis functions and cumulative</span>
<span class="line_number">730 </span>            <span class="comment">// spline component integrals</span>
<span class="line_number">731 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisCum <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.basiscum"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">732 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineYcum <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.ycum"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">733 </span>        <span class="sign">}</span>
<span class="line_number">734 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">735 </span>            <span class="comment">// frailties need integrals of each basis function</span>
<span class="line_number">736 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisInt <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.basisint"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">737 </span>            <span class="comment">// 1-expected value of each basis function</span>
<span class="line_number">738 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.basisexp"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">739 </span>            <span class="comment">// sum of exponentials of spline parameters</span>
<span class="line_number">740 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">741 </span>            <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>0<span class="sign">;</span> j<span class="sign">&lt;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> 
<span class="line_number">742 </span>                theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum <span class="sign">+</span><span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">743 </span>            <span class="comment">// variance of spline component of frailty</span>
<span class="line_number">744 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineFvar <span class="sign">=</span> <a href="#robo34">FrailtySplineVar</a><span class="sign">(</span>theCurve<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">745 </span>            <span class="comment">// penalty on the distance of the mean from 1</span>
<span class="line_number">746 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineMeanPenalty <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"spline.meanpenalty"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">747 </span>            <span class="comment">// which of the spline parameters is held fixed</span>
<span class="line_number">748 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineFixedInd <span class="sign">=</span> 
<span class="line_number">749 </span>                asInteger<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span> <span class="quote">"spline.fixedind"</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> 1<span class="sign">;</span>
<span class="line_number">750 </span>        <span class="sign">}</span>
<span class="line_number">751 </span>    <span class="sign">}</span>
<span class="line_number">752 </span>
<span class="line_number">753 </span>    <span class="comment">// parametric component only</span>
<span class="line_number">754 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasPar<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">755 </span>        <span class="comment">// parametric component parameters</span>
<span class="line_number">756 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamPar <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"param.par"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">757 </span>        <span class="comment">// parametric component evaluated at X</span>
<span class="line_number">758 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamY <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"param.y"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">759 </span>        <span class="comment">// cumulative integral for hazard</span>
<span class="line_number">760 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span>
<span class="line_number">761 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamYcum <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"param.ycum"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">762 </span>        <span class="comment">// get parametric distribution</span>
<span class="line_number">763 </span>        const char <span class="sign">*</span> charParamDist <span class="sign">=</span> CHAR<span class="sign">(</span>STRING_ELT<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"param.dist"</span><span class="sign">)</span><span class="sign">,</span>0<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">764 </span>        distribution iParamDist<span class="sign">;</span>
<span class="line_number">765 </span>        <span class="keyword">if</span><span class="sign">(</span>strcmp<span class="sign">(</span>charParamDist<span class="sign">,</span><span class="quote">"exponential"</span><span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="sign">{</span> iParamDist <span class="sign">=</span> Dexponential<span class="sign">;</span> <span class="sign">}</span> 
<span class="line_number">766 </span>        <span class="keyword">else</span> <span class="keyword">if</span><span class="sign">(</span>strcmp<span class="sign">(</span>charParamDist<span class="sign">,</span><span class="quote">"weibull"</span><span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="sign">{</span> iParamDist <span class="sign">=</span> Dweibull<span class="sign">;</span> <span class="sign">}</span> 
<span class="line_number">767 </span>        <span class="keyword">else</span> <span class="keyword">if</span><span class="sign">(</span>strcmp<span class="sign">(</span>charParamDist<span class="sign">,</span><span class="quote">"gamma"</span><span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="sign">{</span> iParamDist <span class="sign">=</span> Dgamma<span class="sign">;</span> <span class="sign">}</span> 
<span class="line_number">768 </span>        <span class="keyword">else</span> <span class="keyword">if</span><span class="sign">(</span>strcmp<span class="sign">(</span>charParamDist<span class="sign">,</span><span class="quote">"lognormal"</span><span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="sign">{</span> iParamDist <span class="sign">=</span> Dlognormal<span class="sign">;</span> <span class="sign">}</span> 
<span class="line_number">769 </span>        <span class="keyword">else</span> <span class="sign">{</span> iParamDist <span class="sign">=</span> Dnone<span class="sign">;</span> <span class="sign">}</span> 
<span class="line_number">770 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParDist <span class="sign">=</span> iParamDist<span class="sign">;</span>
<span class="line_number">771 </span>        <span class="comment">// number of parametric component parameters</span>
<span class="line_number">772 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>np <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> <span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"param.par"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">773 </span>        <span class="comment">// candidate generation for parametric component parameters</span>
<span class="line_number">774 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamCandCov <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"param.candcov"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">775 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamCholCov <span class="sign">=</span>  REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rcurve<span class="sign">,</span><span class="quote">"param.cholcandcov"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">776 </span>    <span class="sign">}</span>
<span class="line_number">777 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fPopulateLocalHistory"></a>
<a name="robo37"></a><h2>CcurveUpdate/PopulateLocalHistory [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>PopulateLocalHistory</strong> --- populate a local <a href="#robo24">CHistory</a> curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    Given an <a href="../R/splinefrailty_r.html#robo27">RHistory</a>, populate a <a href="#robo24">CHistory</a> structure with pointers to the
    memory allocated by R.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">829 </span><span class="keyword">void</span> <strong>PopulateLocalHistory</strong><span class="sign">(</span> historyP theHist<span class="sign">,</span> SEXP Rhistory<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<p class="item_name">OUTPUTS</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">833 </span><span class="sign">{</span>
<span class="line_number">834 </span>    SEXP elmt<span class="sign">;</span>
<span class="line_number">835 </span>    <span class="comment">// frailties</span>
<span class="line_number">836 </span>    elmt <span class="sign">=</span> <a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"frailty"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">837 </span>    theHist<span class="sign">-</span><span class="sign">&gt;</span>ny <span class="sign">=</span> INTEGER<span class="sign">(</span>getAttrib<span class="sign">(</span>elmt<span class="sign">,</span> R_DimSymbol<span class="sign">)</span><span class="sign">)</span><span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">838 </span>    theHist<span class="sign">-</span><span class="sign">&gt;</span>frailty <span class="sign">=</span> REAL<span class="sign">(</span>elmt<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">839 </span>    <span class="comment">// regression coefficients</span>
<span class="line_number">840 </span>    theHist<span class="sign">-</span><span class="sign">&gt;</span>coefficients <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"coefficients"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">841 </span>    <span class="comment">// Only populate history components if there is a spline/parametric component</span>
<span class="line_number">842 </span>    <span class="comment">// hazard spline</span>
<span class="line_number">843 </span>    elmt <span class="sign">=</span> <a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"hazard.spline.par"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">844 </span>    <span class="keyword">if</span><span class="sign">(</span>elmt <span class="sign">!</span><span class="sign">=</span> R_NilValue <span class="sign">)</span> theHist<span class="sign">-</span><span class="sign">&gt;</span>HazardSplinePar <span class="sign">=</span> REAL<span class="sign">(</span>elmt<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">845 </span>    elmt <span class="sign">=</span> <a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"hazard.spline.knots"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">846 </span>    <span class="keyword">if</span><span class="sign">(</span>elmt <span class="sign">!</span><span class="sign">=</span> R_NilValue <span class="sign">)</span> theHist<span class="sign">-</span><span class="sign">&gt;</span>HazardSplineKnots <span class="sign">=</span> REAL<span class="sign">(</span>elmt<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">847 </span>    <span class="comment">// hazard parametric</span>
<span class="line_number">848 </span>    elmt <span class="sign">=</span> <a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"hazard.param.par"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">849 </span>    <span class="keyword">if</span><span class="sign">(</span>elmt <span class="sign">!</span><span class="sign">=</span> R_NilValue <span class="sign">)</span> theHist<span class="sign">-</span><span class="sign">&gt;</span>HazardParamPar <span class="sign">=</span> REAL<span class="sign">(</span>elmt<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">850 </span>    <span class="comment">// hazard weight</span>
<span class="line_number">851 </span>    elmt <span class="sign">=</span> <a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"hazard.weight"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">852 </span>    <span class="keyword">if</span><span class="sign">(</span>elmt <span class="sign">!</span><span class="sign">=</span> R_NilValue <span class="sign">)</span> theHist<span class="sign">-</span><span class="sign">&gt;</span>HazardWeight <span class="sign">=</span> REAL<span class="sign">(</span>elmt<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">853 </span>    <span class="comment">// frailty spline</span>
<span class="line_number">854 </span>    elmt <span class="sign">=</span> <a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"frailty.spline.par"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">855 </span>    <span class="keyword">if</span><span class="sign">(</span>elmt <span class="sign">!</span><span class="sign">=</span> R_NilValue <span class="sign">)</span> theHist<span class="sign">-</span><span class="sign">&gt;</span>FrailtySplinePar <span class="sign">=</span> REAL<span class="sign">(</span>elmt<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">856 </span>    elmt <span class="sign">=</span> <a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"frailty.spline.knots"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">857 </span>    <span class="keyword">if</span><span class="sign">(</span>elmt <span class="sign">!</span><span class="sign">=</span> R_NilValue <span class="sign">)</span> theHist<span class="sign">-</span><span class="sign">&gt;</span>FrailtySplineKnots <span class="sign">=</span> REAL<span class="sign">(</span>elmt<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">858 </span>    elmt <span class="sign">=</span> <a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"frailty.spline.fvar"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">859 </span>    <span class="keyword">if</span><span class="sign">(</span>elmt <span class="sign">!</span><span class="sign">=</span> R_NilValue <span class="sign">)</span> theHist<span class="sign">-</span><span class="sign">&gt;</span>FrailtySplineFvar <span class="sign">=</span> REAL<span class="sign">(</span>elmt<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">860 </span>    <span class="comment">// frailty parametric </span>
<span class="line_number">861 </span>    elmt <span class="sign">=</span> <a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"frailty.param.par"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">862 </span>    <span class="keyword">if</span><span class="sign">(</span>elmt <span class="sign">!</span><span class="sign">=</span> R_NilValue <span class="sign">)</span> theHist<span class="sign">-</span><span class="sign">&gt;</span>FrailtyParamPar <span class="sign">=</span> REAL<span class="sign">(</span>elmt<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">863 </span>    elmt <span class="sign">=</span> <a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"frailty.weight"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">864 </span>    <span class="keyword">if</span><span class="sign">(</span>elmt <span class="sign">!</span><span class="sign">=</span> R_NilValue <span class="sign">)</span> theHist<span class="sign">-</span><span class="sign">&gt;</span>FrailtyWeight <span class="sign">=</span> REAL<span class="sign">(</span>elmt<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">865 </span>    theHist<span class="sign">-</span><span class="sign">&gt;</span>priorvar <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"priorvar"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">866 </span>    theHist<span class="sign">-</span><span class="sign">&gt;</span>accept <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rhistory<span class="sign">,</span> <span class="quote">"accept"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">867 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fPopulateLocalRegression"></a>
<a name="robo38"></a><h2>CcurveUpdate/PopulateLocalRegression [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>PopulateLocalRegression</strong>
</pre>
<p class="item_name">FUNCTION</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">784 </span> <span class="sign">*</span>    <span class="keyword">void</span> <strong>PopulateLocalRegression</strong><span class="sign">(</span> regressionP theReg<span class="sign">,</span> SEXP Rregression<span class="sign">)</span><span class="sign">{</span>
</pre>
<p class="item_name">INPUTS</p>
<p class="item_name">OUTPUTS</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">790 </span><span class="keyword">void</span> <strong>PopulateLocalRegression</strong><span class="sign">(</span> regressionP theReg<span class="sign">,</span> SEXP Rregression<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">791 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>m <span class="sign">=</span> asInteger<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span> <span class="quote">"m"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">792 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>Ji <span class="sign">=</span> INTEGER<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span> <span class="quote">"Ji"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">793 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>Jicum <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> <span class="sign">(</span>theReg<span class="sign">-</span><span class="sign">&gt;</span>m <span class="sign">+</span> 1<span class="sign">)</span> <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">794 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>Jicum<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">795 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i <span class="sign">&lt;</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>m<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>Jicum<span class="sign">[</span>i<span class="sign">+</span>1<span class="sign">]</span> <span class="sign">=</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>Jicum<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">796 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>n <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> <span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"cluster"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">797 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>p <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> <span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"coefficients"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">798 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>cluster <span class="sign">=</span> INTEGER<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span> <span class="quote">"cluster"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">799 </span>
<span class="line_number">800 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>coefficients <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"coefficients"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">801 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>covariates <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"covariates"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">802 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>lp <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"lp"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">803 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>status <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"status"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">804 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>time <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"time"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">805 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>frailrep <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>n <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>    
<span class="line_number">806 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>frailelp <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>n <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>    
<span class="line_number">807 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>CandCov <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"candcov"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">808 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>CholCov <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"cholcandcov"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">809 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>priorvar <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"priorvar"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">810 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>hyper <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"hyper"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">811 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>Accept <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"accept"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">812 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>tun <span class="sign">=</span> REAL<span class="sign">(</span><a href="#robo88">getListElement</a><span class="sign">(</span>Rregression<span class="sign">,</span><span class="quote">"tun"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">813 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>elp <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>n <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">814 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i<span class="sign">&lt;</span>theReg<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>elp<span class="sign">[</span>i<span class="sign">]</span><span class="sign">=</span><span class="keyword">exp</span><span class="sign">(</span>theReg<span class="sign">-</span><span class="sign">&gt;</span>lp<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">815 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fRemakeSplineBasis"></a>
<a name="robo39"></a><h2>CcurveUpdate/RemakeSplineBasis [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>RemakeSplineBasis</strong> --- update spline basis after a birth-death-move operation
</pre>
<p class="item_name">FUNCTION</p>
<p>    This function is called by <a href="#robo70">MH_BDM</a>, to update the spline basis after adding, moving
    or deleting a knot. It's a more efficient version of <a href="#robo35">MakeSplineBasis</a> that only
    updates the basis functions required by the operation.
</p>

<p>    For move steps, this means simply updating a subset of basis functions. For birth and move
    steps, existing basis functions are moved, and the intermediate ones updated.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1074 </span><span class="keyword">void</span> <strong>RemakeSplineBasis</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> char oper<span class="sign">,</span> <span class="keyword">int</span> j<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      a <a href="#robo23">CCurve</a> structure
    oper          character, either 'm' for move, 'b' for birth or 'd' for death.
    j             index of the knot that was moved, added or deleted.
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    theCurve, with SplineBasis, SplineBasisCum, SplineBasisInt and SplineBasisExp updated
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1078 </span><span class="sign">{</span>
<span class="line_number">1079 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">1080 </span>    <span class="keyword">double</span> <span class="sign">*</span> knots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">;</span>
<span class="line_number">1081 </span>    <span class="keyword">int</span> ord <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">;</span>
<span class="line_number">1082 </span>    <span class="keyword">int</span> nknots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">;</span>
<span class="line_number">1083 </span>    <span class="keyword">int</span> nj <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span>
<span class="line_number">1084 </span>    <span class="keyword">int</span> nx <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">;</span>
<span class="line_number">1085 </span>    <span class="keyword">double</span> <span class="sign">*</span> x <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">;</span>
<span class="line_number">1086 </span>    <span class="keyword">int</span> c1 <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1087 </span>
<span class="line_number">1088 </span>    <span class="comment">// compute integrals over each basis spline</span>
<span class="line_number">1089 </span>    <a href="../R/splinefrailty_r.html#robo112">cevalBinte</a><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisInt<span class="sign">,</span> knots<span class="sign">,</span> <span class="sign">&amp;</span>ord<span class="sign">,</span> <span class="sign">&amp;</span>nknots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1090 </span>
<span class="line_number">1091 </span>    <span class="comment">// For frailty, compute the expectations</span>
<span class="line_number">1092 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> 
<span class="line_number">1093 </span>        <a href="./init_c.html#robo98">cevalEinte</a><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">,</span> knots<span class="sign">,</span> <span class="sign">&amp;</span>ord<span class="sign">,</span> <span class="sign">&amp;</span>nknots<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1094 </span>        
<span class="line_number">1095 </span>    <span class="keyword">if</span><span class="sign">(</span>oper<span class="sign">=</span><span class="sign">=</span><span class="squote">'m'</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1096 </span>        <span class="comment">// Update basis from j to j+ord (j here is the moveind, in internal knot numbering)</span>
<span class="line_number">1097 </span>        <a href="#robo43">UpdateSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="sign">-</span>1<span class="sign">,</span>j<span class="sign">,</span><a href="#robo90">imin</a><span class="sign">(</span>nj<span class="sign">,</span>j<span class="sign">+</span>ord<span class="sign">+</span>1<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">1098 </span>    <span class="sign">}</span>
<span class="line_number">1099 </span>    <span class="keyword">if</span><span class="sign">(</span>oper<span class="sign">=</span><span class="sign">=</span><span class="squote">'d'</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1100 </span>        <span class="comment">//move basis j+1 through nj into j through nj-1</span>
<span class="line_number">1101 </span>        <span class="keyword">int</span> nmv <span class="sign">=</span> <span class="sign">(</span><span class="sign">(</span>nj<span class="sign">)</span> <span class="sign">-</span> <span class="sign">(</span>j<span class="sign">+</span>1<span class="sign">)</span><span class="sign">)</span><span class="sign">*</span>nx<span class="sign">;</span>
<span class="line_number">1102 </span>        nmv <span class="sign">=</span> nmv<span class="sign">&gt;</span>0 <span class="sign">?</span> nmv <span class="sign">:</span> 0<span class="sign">;</span>
<span class="line_number">1103 </span>        <span class="keyword">if</span><span class="sign">(</span>nmv<span class="sign">&gt;</span>0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1104 </span>            F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>nmv<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasis <span class="sign">+</span> <span class="sign">(</span>j<span class="sign">+</span>1<span class="sign">)</span><span class="sign">*</span>nx<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span>
<span class="line_number">1105 </span>                    theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasis <span class="sign">+</span> j<span class="sign">*</span>nx<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1106 </span>            <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span>
<span class="line_number">1107 </span>                F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>nmv<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisCum <span class="sign">+</span> <span class="sign">(</span>j<span class="sign">+</span>1<span class="sign">)</span><span class="sign">*</span>nx<span class="sign">,</span>
<span class="line_number">1108 </span>                    <span class="sign">&amp;</span>c1<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisCum <span class="sign">+</span> j<span class="sign">*</span>nx<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1109 </span>        <span class="sign">}</span>
<span class="line_number">1110 </span>        <span class="comment">// update basis functions j-ord through j</span>
<span class="line_number">1111 </span>        <a href="#robo43">UpdateSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="sign">-</span>1<span class="sign">,</span><a href="#robo89">imax</a><span class="sign">(</span>0<span class="sign">,</span>j<span class="sign">-</span>ord<span class="sign">)</span><span class="sign">,</span>j<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1112 </span>    <span class="sign">}</span>
<span class="line_number">1113 </span>    <span class="keyword">if</span><span class="sign">(</span>oper<span class="sign">=</span><span class="sign">=</span><span class="squote">'b'</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1114 </span>        <span class="comment">// //move basis j+1 : nj to j+2 : nj+1</span>
<span class="line_number">1115 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> k<span class="sign">=</span>nj<span class="sign">-</span>2<span class="sign">;</span>k<span class="sign">&gt;</span>j<span class="sign">;</span>k<span class="sign">-</span><span class="sign">-</span><span class="sign">)</span> F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>nx<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasis <span class="sign">+</span> k<span class="sign">*</span>nx<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span>
<span class="line_number">1116 </span>                theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasis <span class="sign">+</span> <span class="sign">(</span>k<span class="sign">+</span>1<span class="sign">)</span><span class="sign">*</span>nx<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1117 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> k<span class="sign">=</span>nj<span class="sign">-</span>2<span class="sign">;</span>k<span class="sign">&gt;</span>j<span class="sign">;</span>k<span class="sign">-</span><span class="sign">-</span><span class="sign">)</span> F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>nx<span class="sign">,</span>
<span class="line_number">1118 </span>                theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisCum <span class="sign">+</span> k<span class="sign">*</span>nx<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisCum <span class="sign">+</span> <span class="sign">(</span>k<span class="sign">+</span>1<span class="sign">)</span><span class="sign">*</span>nx<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1119 </span>        <span class="comment">// update basis from j-ord to j+2</span>
<span class="line_number">1120 </span>        <a href="#robo43">UpdateSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="sign">-</span>1<span class="sign">,</span><a href="#robo89">imax</a><span class="sign">(</span>0<span class="sign">,</span>j<span class="sign">-</span>ord<span class="sign">)</span><span class="sign">,</span><a href="#robo90">imin</a><span class="sign">(</span>nj<span class="sign">,</span>j<span class="sign">+</span>2<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1121 </span>    <span class="sign">}</span>
<span class="line_number">1122 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fReweightCurve"></a>
<a name="robo40"></a><h2>CcurveUpdate/ReweightCurve [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>ReweightCurve</strong> --- weight a curve's parametric and spline components
</pre>
<p class="item_name">FUNCTION</p>
<p>    After updating either the parametric or spline component of a curve, or their
    relative weight, the total curve must be recomputed.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">932 </span><span class="keyword">void</span> <strong>ReweightCurve</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> <span class="keyword">int</span> i<span class="sign">)</span><span class="sign">{</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve  a <a href="#robo23">CCurve</a> structure
    i         the index of the observation that should be reweighted, or -1 for all
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    theCurve  the original curve, with Y and Ycum components updated.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">936 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasPar <span class="sign">&amp;</span> <span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="sign">{</span> <span class="comment">//parametric only</span>
<span class="line_number">937 </span>        <span class="comment">// just copy ParamY and ParamYcum to Y and Ycum</span>
<span class="line_number">938 </span>        <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamY<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">939 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamYcum<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">940 </span>        <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">941 </span>    <span class="sign">}</span>
<span class="line_number">942 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasPar <span class="sign">&amp;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="sign">{</span> <span class="comment">//spline only</span>
<span class="line_number">943 </span>        <span class="comment">// just copy SplineY and SplineYcum to Y and Ycum</span>
<span class="line_number">944 </span>        <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">945 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineYcum<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">946 </span>        <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">947 </span>    <span class="sign">}</span>
<span class="line_number">948 </span>    <span class="keyword">double</span> w <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">949 </span>    <span class="keyword">if</span><span class="sign">(</span>i<span class="sign">&gt;</span><span class="sign">=</span>0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">950 </span>        <span class="comment">// reweight a single observation</span>
<span class="line_number">951 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> w <span class="sign">*</span>  theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> <span class="sign">(</span>1<span class="sign">-</span>w<span class="sign">)</span> <span class="sign">*</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamY<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">952 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> w <span class="sign">*</span>  theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> <span class="sign">(</span>1<span class="sign">-</span>w<span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">953 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamY<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">954 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">955 </span>        <span class="comment">// reweight the entire curve</span>
<span class="line_number">956 </span>        <span class="keyword">double</span> c0<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">957 </span>        <span class="keyword">int</span> c0i<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">958 </span>        <span class="keyword">int</span> c1<span class="sign">=</span>1<span class="sign">;</span>
<span class="line_number">959 </span>        <span class="keyword">int</span> n <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">;</span>
<span class="line_number">960 </span>        <span class="keyword">double</span> wm1<span class="sign">=</span>1<span class="sign">-</span>w<span class="sign">;</span>
<span class="line_number">961 </span>        F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>n<span class="sign">,</span> <span class="sign">&amp;</span>c0<span class="sign">,</span> <span class="sign">&amp;</span>c0i<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span> <span class="comment">//set Y=0</span>
<span class="line_number">962 </span>        F77_CALL<span class="sign">(</span>daxpy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>n<span class="sign">,</span> <span class="sign">&amp;</span>w<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span> <span class="comment">//add w*splineY</span>
<span class="line_number">963 </span>        F77_CALL<span class="sign">(</span>daxpy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>n<span class="sign">,</span> <span class="sign">&amp;</span>wm1<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamY<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span> <span class="comment">//add (1-w)*paramY</span>
<span class="line_number">964 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">965 </span>            F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>n<span class="sign">,</span> <span class="sign">&amp;</span>c0<span class="sign">,</span> <span class="sign">&amp;</span>c0i<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span> <span class="comment">//set Y=0</span>
<span class="line_number">966 </span>            F77_CALL<span class="sign">(</span>daxpy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>n<span class="sign">,</span> <span class="sign">&amp;</span>w<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineYcum<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span> <span class="comment">//add w*splineY</span>
<span class="line_number">967 </span>            F77_CALL<span class="sign">(</span>daxpy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>n<span class="sign">,</span> <span class="sign">&amp;</span>wm1<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamYcum<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span> <span class="comment">//add (1-w)*paramY</span>
<span class="line_number">968 </span>        <span class="sign">}</span>
<span class="line_number">969 </span>    <span class="sign">}</span>
<span class="line_number">970 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fUpdateCurveX"></a>
<a name="robo41"></a><h2>CcurveUpdate/UpdateCurveX [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>UpdateCurveX</strong> --- change an X value of a <a href="#robo23">CCurve</a> structure
</pre>
<p class="item_name">FUNCTION</p>
<p>    Changes theCurve-&gt;X[i] to x, and updates Y[i] accordingly
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1429 </span><span class="keyword">void</span> <strong>UpdateCurveX</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> <span class="keyword">double</span> x<span class="sign">,</span> <span class="keyword">int</span> i<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      a <a href="#robo23">CCurve</a> structure
    x             double, to replace theCurve-&gt;X[i]
    i             index between 0 and theCurve-&gt;nx
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1433 </span><span class="sign">{</span>
<span class="line_number">1434 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> Rprintf<span class="sign">(</span><span class="quote">"Error: using <strong>UpdateCurveX</strong> on hazard."</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1435 </span>    <span class="comment">// copy x into theCurve</span>
<span class="line_number">1436 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> x<span class="sign">;</span>
<span class="line_number">1437 </span>    <span class="comment">// re-evaluate the curve basis and values</span>
<span class="line_number">1438 </span>    <a href="#robo43">UpdateSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span> i<span class="sign">,</span> 0<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1439 </span>    <a href="#robo32">EvalSpline</a><span class="sign">(</span>theCurve<span class="sign">,</span>i<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1440 </span>    <a href="#robo31">EvalParametric</a><span class="sign">(</span>theCurve<span class="sign">,</span>i<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1441 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fUpdateParamPar"></a>
<a name="robo42"></a><h2>CcurveUpdate/UpdateParamPar [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>UpdateParamPar</strong> --- update parametric component with new parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update the parametric component of a curve, given a new set of parameters. This just
    involves copying the new parameters into the <a href="#robo23">CCurve</a> and calling <a href="#robo31">EvalParametric</a>
    to re-evaluate the curve.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1368 </span><span class="keyword">void</span> <strong>UpdateParamPar</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span> newPar<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve  <a href="#robo23">CCurve</a> structure
    newPar    new parametric component parameters
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    theCurve  <a href="#robo23">CCurve</a> structure, with newPar copied into ParamPar and Y and Ycum updated.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1372 </span><span class="sign">{</span>
<span class="line_number">1373 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasPar<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">1374 </span>    <span class="comment">// copy new parameters into the curve</span>
<span class="line_number">1375 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i<span class="sign">&lt;</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span>
<span class="line_number">1376 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> newPar<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1377 </span>    <span class="comment">// evaluate the curve</span>
<span class="line_number">1378 </span>    <a href="#robo31">EvalParametric</a><span class="sign">(</span>theCurve<span class="sign">,</span> <span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1379 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fUpdateSplineBasis"></a>
<a name="robo43"></a><h2>CcurveUpdate/UpdateSplineBasis [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>UpdateSplineBasis</strong> --- recompute basis if one of the X values changes
</pre>
<p class="item_name">FUNCTION</p>
<p>    Re-evaluates the spline basis at its X values. This is called indirectly by <a href="#robo71">MH_Frail</a>, as
    well as during the Birth-Death-Move steps in <a href="#robo70">MH_BDM</a>.
</p>

<p>    The function can evaluate only a subset of spline basis functions (as needed when
    changing the knot set), or evaluate
    at a single observation (as when changing one frailty).
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">991 </span><span class="keyword">void</span> <strong>UpdateSplineBasis</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> <span class="keyword">int</span> i<span class="sign">,</span> <span class="keyword">int</span> startj<span class="sign">,</span> <span class="keyword">int</span> endj<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      <a href="#robo23">CCurve</a> structure to be re-evaluated
    i             index of the observation to evaluate, or -1 for all
    startj        start index of the basis functions to evaluate
    endj          stop index of the basis functions to evaluate
</pre>
<p class="item_name">OUTPUTS</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number"> 995 </span><span class="sign">{</span>
<span class="line_number"> 996 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number"> 997 </span>    <span class="keyword">if</span><span class="sign">(</span>i<span class="sign">&lt;</span>0<span class="sign">)</span>
<span class="line_number"> 998 </span>        <span class="comment">// evaluate every row separately</span>
<span class="line_number"> 999 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> ind<span class="sign">=</span>0<span class="sign">;</span> ind<span class="sign">&lt;</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">;</span> ind<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> <strong>UpdateSplineBasis</strong><span class="sign">(</span>theCurve<span class="sign">,</span> ind<span class="sign">,</span> startj<span class="sign">,</span> endj<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1000 </span>    <span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1001 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>startj<span class="sign">;</span> j<span class="sign">&lt;</span>endj<span class="sign">;</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1002 </span>            <span class="comment">// evaluate the basis at entry [i,j]</span>
<span class="line_number">1003 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasis<span class="sign">[</span>i <span class="sign">+</span> j <span class="sign">*</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">]</span> <span class="sign">=</span> <a href="./init_c.html#robo103">csplineeval</a><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>i<span class="sign">]</span><span class="sign">,</span> j<span class="sign">,</span>
<span class="line_number">1004 </span>                    theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1005 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> 
<span class="line_number">1006 </span>                theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasis<span class="sign">[</span>i<span class="sign">+</span>j <span class="sign">*</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">]</span> <span class="sign">/</span><span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisInt<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1007 </span>        <span class="sign">}</span>
<span class="line_number">1008 </span>        <span class="comment">// for the hazard, also evaluate cumulative hazards</span>
<span class="line_number">1009 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> 
<span class="line_number">1010 </span>            <a href="./init_c.html#robo96">cevalCinte2</a><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisCum<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">,</span>
<span class="line_number">1011 </span>                theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisInt<span class="sign">,</span> i<span class="sign">,</span> startj<span class="sign">,</span> endj<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1012 </span>    <span class="sign">}</span>
<span class="line_number">1013 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CcurveUpdate2fUpdateSplinePar"></a>
<a name="robo44"></a><h2>CcurveUpdate/UpdateSplinePar [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">CcurveUpdate</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>UpdateSplinePar</strong> --- update the spline parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Function called to update the spline parameters in a <a href="#robo23">CCurve</a>. It copies a set
    of new parameters into the curve and re-evaluates the curve appropriately.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1227 </span><span class="keyword">void</span> <strong>UpdateSplinePar</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span> newpar<span class="sign">,</span> <span class="keyword">int</span> j<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      a <a href="#robo23">CCurve</a> structure whose spline parameters should be updated
    newpar        new spline parameters
    j             index of single parameter to be updated (or -1 for all)
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    theCurve      <a href="#robo23">CCurve</a> with updated Y and Ycum
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1231 </span><span class="sign">{</span>
<span class="line_number">1232 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">1233 </span>    <span class="keyword">if</span><span class="sign">(</span>j<span class="sign">&gt;</span><span class="sign">=</span>0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1234 </span>        <span class="comment">// updateSplinePar can only be called with j&gt;0 for hazard curve</span>
<span class="line_number">1235 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> Rprintf<span class="sign">(</span><span class="quote">"Bad call to <strong>UpdateSplinePar</strong>\n"</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1236 </span>        <span class="keyword">double</span> oldeparj <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1237 </span>        <span class="keyword">double</span> neweparj <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>newpar<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1238 </span>        <span class="keyword">double</span> epardiff <span class="sign">=</span> neweparj <span class="sign">-</span> oldeparj<span class="sign">;</span>
<span class="line_number">1239 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> newpar<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1240 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> neweparj<span class="sign">;</span>
<span class="line_number">1241 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum <span class="sign">+</span><span class="sign">=</span> epardiff<span class="sign">;</span>
<span class="line_number">1242 </span>        <span class="keyword">int</span> c1 <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1243 </span>        <span class="comment">// update the curve by changing only the j-th parameter</span>
<span class="line_number">1244 </span>        F77_CALL<span class="sign">(</span>daxpy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">)</span><span class="sign">,</span> <span class="sign">&amp;</span>epardiff<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasis<span class="sign">+</span>j<span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span>
<span class="line_number">1245 </span>                theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">1246 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> F77_CALL<span class="sign">(</span>daxpy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">)</span><span class="sign">,</span> <span class="sign">&amp;</span>epardiff<span class="sign">,</span>
<span class="line_number">1247 </span>                theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisCum<span class="sign">+</span>j<span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineYcum<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">1248 </span>        <a href="#robo40">ReweightCurve</a><span class="sign">(</span>theCurve<span class="sign">,</span> <span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1249 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1250 </span>        <span class="comment">// copy the new parameters into the curve structure</span>
<span class="line_number">1251 </span>        <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> newpar<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1252 </span>        <span class="comment">// make sure that for the frailty, the parameter at the fixed index = 0</span>
<span class="line_number">1253 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> 
<span class="line_number">1254 </span>            <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span><span class="sign">=</span> newpar<span class="sign">[</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineFixedInd<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1255 </span>        <span class="comment">// compute exponentials of parameters</span>
<span class="line_number">1256 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i<span class="sign">&lt;</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1257 </span>        <span class="comment">// normalize parameters for frailty</span>
<span class="line_number">1258 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1259 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">1260 </span>            <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>0<span class="sign">;</span> j<span class="sign">&lt;</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum<span class="sign">+</span><span class="sign">=</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1261 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineFvar <span class="sign">=</span> <a href="#robo34">FrailtySplineVar</a><span class="sign">(</span>theCurve<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1262 </span>        <span class="sign">}</span>
<span class="line_number">1263 </span>        <span class="comment">// evaluate the spline at the new parameters</span>
<span class="line_number">1264 </span>        <a href="#robo32">EvalSpline</a><span class="sign">(</span>theCurve<span class="sign">,</span> <span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1265 </span>    <span class="sign">}</span>
<span class="line_number">1266 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CDefines2fDEBUG"></a>
<a name="robo45"></a><h2>CDefines/DEBUG [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo8">CDefines</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>DEBUG</strong> --- debugging marker
</pre>
<p class="item_name">FUNCTION</p>
<p>    If true, additional debug information is printed to the screen
</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">79 </span><span class="comment">#define <strong>DEBUG</strong></span>
</pre>

<hr />
<a name="CDefines2fenumDistribution"></a>
<a name="robo46"></a><h2>CDefines/enumDistribution [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo8">CDefines</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>enumDistribution</strong> --- an enum for different parametric distributions
</pre>
<p class="item_name">FUNCTION</p>
<p>    Index parametric component distributions to use for parametric components of
    the hazard or density. Options are:
</p>
<pre>      0   None
      1   Exponential
      2   Weibull
      3   Lognormal
      4   Gamma
</pre>
<p></p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">131 </span><span class="keyword">typedef</span> enum <span class="sign">{</span>Dnone<span class="sign">=</span>0<span class="sign">,</span> Dexponential<span class="sign">=</span>1<span class="sign">,</span> Dweibull<span class="sign">=</span>2<span class="sign">,</span> Dlognormal<span class="sign">=</span>3<span class="sign">,</span> Dgamma<span class="sign">=</span>4<span class="sign">}</span> distribution<span class="sign">;</span>
</pre>

<hr />
<a name="CDefines2fenumNknotsPrior"></a>
<a name="robo47"></a><h2>CDefines/enumNknotsPrior [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo8">CDefines</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>enumNknotsPrior</strong> --- an enum for different priors on the number of knots
</pre>
<p class="item_name">FUNCTION</p>
<p>    Index possible priors on the number of knots for use with adaptive model
    selection. Options are:
</p>
<pre>      0   Poisson
      1   Geometric
      2   Poisson Mixture
      3   Negative Binomial
      4   Power (x^a)
</pre>
<p></p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">147 </span><span class="keyword">typedef</span> enum <span class="sign">{</span>PrPoisson<span class="sign">=</span>0<span class="sign">,</span> PrGeometric<span class="sign">=</span>1<span class="sign">,</span> PrPoissonMix<span class="sign">=</span>2<span class="sign">,</span>
<span class="line_number">148 </span>    PrNegBin<span class="sign">=</span>3<span class="sign">,</span> PrPower<span class="sign">=</span>4<span class="sign">}</span> nknotsprior<span class="sign">;</span>
</pre>

<hr />
<a name="CDefines2fenumPenalty"></a>
<a name="robo48"></a><h2>CDefines/enumPenalty [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo8">CDefines</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>enumPenalty</strong> --- an enum for different penalty types
</pre>
<p class="item_name">FUNCTION</p>
<p>    Index the penalty functions to use. Options are:
</p>
<pre>      0   Gaussian penalty
      1   Sum of squared second differences
      2   Integrated squared second derivative
      3   log of 2
</pre>
<p></p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">115 </span><span class="keyword">typedef</span> enum <span class="sign">{</span>pnone<span class="sign">=</span>0<span class="sign">,</span> pdiff<span class="sign">=</span>1<span class="sign">,</span> pderiv<span class="sign">=</span>2<span class="sign">,</span> plogderiv<span class="sign">=</span>3<span class="sign">}</span> penalty<span class="sign">;</span>
</pre>

<hr />
<a name="CDefines2fLIK5fMOD"></a>
<a name="robo49"></a><h2>CDefines/LIK_MOD [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo8">CDefines</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>LIK_MOD</strong> --- modulus to use for summing likelihoods
</pre>
<p class="item_name">FUNCTION</p>
<p>    Modulus used when summing loglikelihoods, see <a href="#robo60">LikelihoodHazardLogSum</a> for its use.
</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">89 </span><span class="comment">#define <strong>LIK_MOD</strong> 10</span>
</pre>

<hr />
<a name="CDefines2fMAX5fPAR"></a>
<a name="robo50"></a><h2>CDefines/MAX_PAR [ Definitions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo8">CDefines</a> ] [ <a href="../robo_definitions.html#robo_top_of_doc">Definitions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>MAX_PAR</strong> --- hard limit on maximum parameter value allowed
</pre>
<p class="item_name">FUNCTION</p>
<p>    For numerical reasons, it's necessary to impose an upper limit on spline
    parameter values. It's set to 20, because exp(20) should be a sufficiently
    large number.
</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">101 </span><span class="comment">#define <strong>MAX_PAR</strong> 20</span>
</pre>

<hr />
<a name="CmakeLikelihood2fLikelihoodFrailty"></a>
<a name="robo58"></a><h2>CmakeLikelihood/LikelihoodFrailty [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">CmakeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>LikelihoodFrailty</strong> --- likelihood of the frailty itself
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute frailty likelihoods as part of <a href="#robo71">MH_Frail</a>. See also <a href="../R/splinefrailty_r.html#robo132">mklik.frail</a>
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1494 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>LikelihoodFrailty</strong><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">,</span> curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    i             index of the frailty whose likelihood should be evaluated
    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik   loglikelihood of frailty-&gt;X[i]
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1498 </span><span class="sign">{</span>
<span class="line_number">1499 </span>   <span class="keyword">double</span> Ui <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1500 </span>   <span class="keyword">double</span> lUi <span class="sign">=</span> log<span class="sign">(</span>Ui<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1501 </span>   <span class="keyword">double</span> lik <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">1502 </span>   <span class="keyword">int</span> c1 <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1503 </span>   lik <span class="sign">+</span><span class="sign">=</span> log<span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1504 </span>   <span class="keyword">int</span> start <span class="sign">=</span> regression<span class="sign">-</span><span class="sign">&gt;</span>Jicum<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1505 </span>   <span class="keyword">int</span> n <span class="sign">=</span> regression<span class="sign">-</span><span class="sign">&gt;</span>Jicum<span class="sign">[</span>i<span class="sign">+</span>1<span class="sign">]</span> <span class="sign">-</span> start<span class="sign">;</span>
<span class="line_number">1506 </span>   lik <span class="sign">+</span><span class="sign">=</span> lUi <span class="sign">*</span> F77_CALL<span class="sign">(</span>dasum<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>n<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>status<span class="sign">+</span>start<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1507 </span>   lik <span class="sign">-</span><span class="sign">=</span> Ui <span class="sign">*</span> <a href="#robo81">ddotWrapper</a><span class="sign">(</span>n<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">+</span>start<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>elp<span class="sign">+</span>start<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1508 </span>   <span class="keyword">return</span><span class="sign">(</span>lik<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1509 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmakeLikelihood2fLikelihoodFrailtyLogSum"></a>
<a name="robo59"></a><h2>CmakeLikelihood/LikelihoodFrailtyLogSum [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">CmakeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>LikelihoodFrailtyLogSum</strong> --- utility to efficiently compute a sum of log-frailties
</pre>
<p class="item_name">FUNCTION</p>
<p>    Because the log function is quite slow (especially it seems on the MacIntel architecture),
    this function computes the sum of log-frailties by multiplying several together at a time,
    then taking logs.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1561 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>LikelihoodFrailtyLogSum</strong><span class="sign">(</span><span class="keyword">int</span> nx<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>Y<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    nx        number of observations
    Y         vector of length nx
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik       sum of log(Y)
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1565 </span><span class="sign">{</span>
<span class="line_number">1566 </span>    <span class="keyword">double</span> lik<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">1567 </span>    <span class="keyword">double</span> thislik <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1568 </span>
<span class="line_number">1569 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i<span class="sign">&lt;</span>nx<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">1570 </span>        thislik <span class="sign">*</span><span class="sign">=</span> Y<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1571 </span>        <span class="keyword">if</span><span class="sign">(</span>i <span class="sign">%</span> <a href="#robo49">LIK_MOD</a> <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1572 </span>            lik <span class="sign">+</span><span class="sign">=</span> log<span class="sign">(</span>thislik<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1573 </span>            thislik <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1574 </span>        <span class="sign">}</span>
<span class="line_number">1575 </span>    <span class="sign">}</span>
<span class="line_number">1576 </span>    lik <span class="sign">+</span><span class="sign">=</span> log<span class="sign">(</span>thislik<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1577 </span>    <span class="keyword">return</span> lik<span class="sign">;</span>
<span class="line_number">1578 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmakeLikelihood2fLikelihoodHazardLogSum"></a>
<a name="robo60"></a><h2>CmakeLikelihood/LikelihoodHazardLogSum [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">CmakeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>LikelihoodHazardLogSum</strong> --- utility to efficiently compute a sum of log-hazards
</pre>
<p class="item_name">FUNCTION</p>
<p>    Because the log function is quite slow (especially it seems on the MacIntel architecture),
    this function computes the sum of log-hazards by multiplying several together at a time,
    then taking logs.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1527 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>LikelihoodHazardLogSum</strong><span class="sign">(</span><span class="keyword">int</span> nx<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>status<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>Y<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    nx        number of observations
    Y         vector of length nx
    status    vector of length nx
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik       sum of status*log(Y)
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1531 </span><span class="sign">{</span>
<span class="line_number">1532 </span>    <span class="keyword">double</span> lik<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">1533 </span>    <span class="keyword">double</span> thislik <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1534 </span>    <span class="comment">// sum <a href="#robo49">LIK_MOD</a> elements at a time</span>
<span class="line_number">1535 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i<span class="sign">&lt;</span>nx<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">1536 </span>        thislik <span class="sign">*</span><span class="sign">=</span> status<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&gt;</span> 0 <span class="sign">?</span> Y<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">:</span> 1<span class="sign">.</span>0<span class="sign">;</span>
<span class="line_number">1537 </span>        <span class="keyword">if</span><span class="sign">(</span>i <span class="sign">%</span> <a href="#robo49">LIK_MOD</a> <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1538 </span>            lik <span class="sign">+</span><span class="sign">=</span> log<span class="sign">(</span>thislik<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1539 </span>            thislik <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1540 </span>        <span class="sign">}</span>
<span class="line_number">1541 </span>    <span class="sign">}</span>  
<span class="line_number">1542 </span>    lik<span class="sign">+</span><span class="sign">=</span>log<span class="sign">(</span>thislik<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1543 </span>    <span class="keyword">return</span> lik<span class="sign">;</span>  
<span class="line_number">1544 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmakeLikelihood2fLikelihoodParamFrailty"></a>
<a name="robo61"></a><h2>CmakeLikelihood/LikelihoodParamFrailty [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">CmakeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>LikelihoodParamFrailty</strong> --- likelihood of frailty parametric parameter
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute loglikelihood of parameters for the parametric component of the frailty curve.
    See also <a href="../R/splinefrailty_r.html#robo133">mklik.param.frail</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1723 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>LikelihoodParamFrailty</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik    loglikelihood of frailty-&gt;ParamPar
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1727 </span><span class="sign">{</span>
<span class="line_number">1728 </span>    <span class="comment">// sum of log-frailties</span>
<span class="line_number">1729 </span>    <span class="keyword">double</span> lik <span class="sign">=</span> <a href="#robo59">LikelihoodFrailtyLogSum</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>ParamY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1730 </span>
<span class="line_number">1731 </span>    <span class="keyword">int</span> c1<span class="sign">=</span>1<span class="sign">;</span>
<span class="line_number">1732 </span>    <span class="comment">// Gaussian prior for parameters</span>
<span class="line_number">1733 </span>    lik <span class="sign">-</span><span class="sign">=</span> <span class="keyword">pow</span><span class="sign">(</span>F77_CALL<span class="sign">(</span>dnrm2<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">)</span><span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">,</span>2<span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>2<span class="sign">*</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>ParamPriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1734 </span>    <span class="keyword">return</span> lik<span class="sign">;</span>
<span class="line_number">1735 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmakeLikelihood2fLikelihoodParamHazard"></a>
<a name="robo62"></a><h2>CmakeLikelihood/LikelihoodParamHazard [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">CmakeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>LikelihoodParamHazard</strong> --- likelihood of hazard parametric parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute loglikelihood of parameters for the parametric component of the hazard curve.
    See also <a href="../R/splinefrailty_r.html#robo134">mklik.param.haz</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1691 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>LikelihoodParamHazard</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik    loglikelihood of hazard-&gt;ParamPar
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1695 </span><span class="sign">{</span>
<span class="line_number">1696 </span>    <span class="keyword">double</span> <span class="sign">*</span> frailelp <span class="sign">=</span> regression<span class="sign">-</span><span class="sign">&gt;</span>frailelp<span class="sign">;</span>
<span class="line_number">1697 </span>    <span class="keyword">double</span> <span class="sign">*</span> hazYcum <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">;</span>
<span class="line_number">1698 </span>   
<span class="line_number">1699 </span>    <span class="comment">// point process likelihood</span>
<span class="line_number">1700 </span>    <span class="keyword">double</span> lik <span class="sign">=</span> <a href="#robo60">LikelihoodHazardLogSum</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>status<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1701 </span>    lik <span class="sign">-</span><span class="sign">=</span> <a href="#robo81">ddotWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> frailelp<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamYcum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1702 </span>    <span class="keyword">int</span> c1<span class="sign">=</span>1<span class="sign">;</span>
<span class="line_number">1703 </span>    <span class="comment">// Gaussian prior for parameters</span>
<span class="line_number">1704 </span>    lik <span class="sign">-</span><span class="sign">=</span> <span class="keyword">pow</span><span class="sign">(</span>F77_CALL<span class="sign">(</span>dnrm2<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">)</span><span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">,</span>2<span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>2<span class="sign">*</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamPriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1705 </span>    <span class="keyword">return</span> lik<span class="sign">;</span>
<span class="line_number">1706 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmakeLikelihood2fLikelihoodRegression"></a>
<a name="robo63"></a><h2>CmakeLikelihood/LikelihoodRegression [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">CmakeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>LikelihoodRegression</strong> --- likelihood of regression coefficients
</pre>
<p class="item_name">FUNCTION</p>
<p>    Computes the likelihood of regression coefficients beta, called by <a href="#robo74">MH_Regression</a>. See
    also <a href="../R/splinefrailty_r.html#robo131">mklik.coef</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1595 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>LikelihoodRegression</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span>curveP frailty<span class="sign">,</span>regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik    loglikelihood of regression-&gt;coefficients
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1599 </span><span class="sign">{</span>
<span class="line_number">1600 </span>    <span class="keyword">double</span> lik<span class="sign">;</span> 
<span class="line_number">1601 </span>    <span class="keyword">double</span> <span class="sign">*</span> hazYcum <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">;</span>
<span class="line_number">1602 </span>    <span class="keyword">double</span> <span class="sign">*</span> frailelp <span class="sign">=</span> regression<span class="sign">-</span><span class="sign">&gt;</span>frailelp<span class="sign">;</span>
<span class="line_number">1603 </span>    lik <span class="sign">=</span> <a href="#robo81">ddotWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>status<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>lp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1604 </span>    lik <span class="sign">-</span><span class="sign">=</span> <a href="#robo81">ddotWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> frailelp<span class="sign">,</span> hazYcum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1605 </span>    <span class="keyword">int</span> c1 <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1606 </span>    lik <span class="sign">-</span><span class="sign">=</span> <span class="keyword">pow</span><span class="sign">(</span>F77_CALL<span class="sign">(</span>dnrm2<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>p<span class="sign">)</span><span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>coefficients<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">,</span>2<span class="sign">)</span><span class="sign">/</span>
<span class="line_number">1607 </span>        <span class="sign">(</span>2<span class="sign">*</span>regression<span class="sign">-</span><span class="sign">&gt;</span>priorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1608 </span>    <span class="keyword">return</span> lik<span class="sign">;</span>
<span class="line_number">1609 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmakeLikelihood2fLikelihoodSplineFrailty"></a>
<a name="robo64"></a><h2>CmakeLikelihood/LikelihoodSplineFrailty [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">CmakeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>LikelihoodSplineFrailty</strong> --- likelihood of frailty spline parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute loglikelihood of parameters for the spline component of the frailty curve.
    See also <a href="../R/splinefrailty_r.html#robo135">mklik.spline.frail</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1660 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>LikelihoodSplineFrailty</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik    loglikelihood of frailty-&gt;SplinePar
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1664 </span><span class="sign">{</span>
<span class="line_number">1665 </span>    <span class="comment">// sum of log-hazards</span>
<span class="line_number">1666 </span>    <span class="keyword">double</span> lik <span class="sign">=</span>  <a href="#robo59">LikelihoodFrailtyLogSum</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1667 </span>    <span class="comment">// smoothness penalty</span>
<span class="line_number">1668 </span>    lik <span class="sign">-</span><span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplinePenaltyFactor<span class="sign">[</span>0<span class="sign">]</span><span class="sign">*</span><a href="#robo68">SmoothnessPenalty</a><span class="sign">(</span>frailty<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">1669 </span>    <span class="comment">// penalize parameters that are too small or too big</span>
<span class="line_number">1670 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i<span class="sign">&lt;</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> lik <span class="sign">-</span><span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>i<span class="sign">]</span><span class="sign">&lt;</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineMin<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">?</span>
<span class="line_number">1671 </span>        <span class="keyword">pow</span><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineMin<span class="sign">[</span>0<span class="sign">]</span><span class="sign">,</span>2<span class="sign">)</span> <span class="sign">:</span> 0<span class="sign">.</span>0<span class="sign">;</span>
<span class="line_number">1672 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i<span class="sign">&lt;</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> lik <span class="sign">+</span><span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&gt;</span> <a href="#robo50">MAX_PAR</a> <span class="sign">?</span> <span class="sign">-</span>INFINITY<span class="sign">:</span> 0<span class="sign">.</span>0<span class="sign">;</span> 
<span class="line_number">1673 </span>    <span class="keyword">return</span> lik<span class="sign">;</span>
<span class="line_number">1674 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmakeLikelihood2fLikelihoodSplineHazard"></a>
<a name="robo65"></a><h2>CmakeLikelihood/LikelihoodSplineHazard [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">CmakeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>LikelihoodSplineHazard</strong> --- likelihood of hazard spline parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute loglikelihood of parameters for the spline component of the hazard curve.
    See also <a href="../R/splinefrailty_r.html#robo137">mklik.spline.haz</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1626 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>LikelihoodSplineHazard</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik    loglikelihood of hazard-&gt;SplinePar
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1630 </span><span class="sign">{</span>
<span class="line_number">1631 </span>    <span class="keyword">double</span> <span class="sign">*</span> frailelp <span class="sign">=</span> regression<span class="sign">-</span><span class="sign">&gt;</span>frailelp<span class="sign">;</span>
<span class="line_number">1632 </span>    <span class="keyword">double</span> <span class="sign">*</span> hazYcum <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">;</span>
<span class="line_number">1633 </span>    
<span class="line_number">1634 </span>    <span class="comment">// point process likelihood</span>
<span class="line_number">1635 </span>    <span class="keyword">double</span> lik <span class="sign">=</span> <a href="#robo60">LikelihoodHazardLogSum</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>status<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1636 </span>    lik <span class="sign">-</span><span class="sign">=</span> <a href="#robo81">ddotWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> frailelp<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineYcum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1637 </span>    <span class="comment">// smoothness penalty</span>
<span class="line_number">1638 </span>    lik <span class="sign">-</span><span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplinePenaltyFactor<span class="sign">[</span>0<span class="sign">]</span><span class="sign">*</span><a href="#robo68">SmoothnessPenalty</a><span class="sign">(</span>hazard<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">1639 </span>    <span class="comment">// penalize parameters that are too small or too large</span>
<span class="line_number">1640 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i<span class="sign">&lt;</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> lik <span class="sign">-</span><span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>i<span class="sign">]</span><span class="sign">&lt;</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineMin<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">?</span>
<span class="line_number">1641 </span>        <span class="keyword">pow</span><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineMin<span class="sign">[</span>0<span class="sign">]</span><span class="sign">,</span>2<span class="sign">)</span> <span class="sign">:</span> 0<span class="sign">.</span>0<span class="sign">;</span>
<span class="line_number">1642 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i<span class="sign">&lt;</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> lik <span class="sign">+</span><span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&gt;</span> <a href="#robo50">MAX_PAR</a> <span class="sign">?</span> <span class="sign">-</span>INFINITY<span class="sign">:</span> 0<span class="sign">.</span>0<span class="sign">;</span> <span class="keyword">return</span> lik<span class="sign">;</span>
<span class="line_number">1643 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmakeLikelihood2fLikelihoodWeightFrailty"></a>
<a name="robo66"></a><h2>CmakeLikelihood/LikelihoodWeightFrailty [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">CmakeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>LikelihoodWeightFrailty</strong> --- likelihood of weight for frailty curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute loglikelihood of weight parameter for the frailty curve, if the frailty curve
    has both. See also <a href="../R/splinefrailty_r.html#robo138">mklik.weight.frail</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1784 </span><span class="keyword">double</span> <strong>LikelihoodWeightFrailty</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik   loglikelihood of frailty-&gt;Weight
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1788 </span><span class="sign">{</span>
<span class="line_number">1789 </span>    <span class="keyword">double</span> lik <span class="sign">=</span>  <a href="#robo59">LikelihoodFrailtyLogSum</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1790 </span>
<span class="line_number">1791 </span>    lik <span class="sign">+</span><span class="sign">=</span> <span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>WeightHyper<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">.</span>0<span class="sign">)</span> <span class="sign">*</span> log<span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1792 </span>          <span class="sign">+</span><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>WeightHyper<span class="sign">[</span>1<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">.</span>0<span class="sign">)</span> <span class="sign">*</span> log<span class="sign">(</span>1<span class="sign">.</span>0 <span class="sign">-</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1793 </span>    <span class="keyword">return</span> lik<span class="sign">;</span>
<span class="line_number">1794 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmakeLikelihood2fLikelihoodWeightHazard"></a>
<a name="robo67"></a><h2>CmakeLikelihood/LikelihoodWeightHazard [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">CmakeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>LikelihoodWeightHazard</strong> --- likelihood of weight for hazard curve
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute loglikelihood of weight parameter for the hazard curve, if the hazard curve
    has both. See also <a href="../R/splinefrailty_r.html#robo139">mklik.weight.haz</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1752 </span><span class="keyword">double</span> <strong>LikelihoodWeightHazard</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    lik   loglikelihood of hazard-&gt;Weight
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1756 </span><span class="sign">{</span> 
<span class="line_number">1757 </span>    <span class="keyword">double</span> <span class="sign">*</span> frailelp <span class="sign">=</span> regression<span class="sign">-</span><span class="sign">&gt;</span>frailelp<span class="sign">;</span>
<span class="line_number">1758 </span>    <span class="keyword">double</span> <span class="sign">*</span> hazYcum <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">;</span>
<span class="line_number">1759 </span>    
<span class="line_number">1760 </span>    <span class="comment">// point process likelihood</span>
<span class="line_number">1761 </span>    <span class="keyword">double</span> lik <span class="sign">=</span> <a href="#robo60">LikelihoodHazardLogSum</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>status<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1762 </span>    lik <span class="sign">-</span><span class="sign">=</span> <a href="#robo81">ddotWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> frailelp<span class="sign">,</span> hazYcum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1763 </span>    <span class="comment">// prior on the weight</span>
<span class="line_number">1764 </span>    lik <span class="sign">+</span><span class="sign">=</span> <span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>WeightHyper<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">.</span>0<span class="sign">)</span> <span class="sign">*</span> log<span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1765 </span>          <span class="sign">+</span><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>WeightHyper<span class="sign">[</span>1<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">.</span>0<span class="sign">)</span> <span class="sign">*</span> log<span class="sign">(</span>1<span class="sign">.</span>0 <span class="sign">-</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1766 </span>    <span class="keyword">return</span> lik<span class="sign">;</span>
<span class="line_number">1767 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmakeLikelihood2fSmoothnessPenalty"></a>
<a name="robo68"></a><h2>CmakeLikelihood/SmoothnessPenalty [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">CmakeLikelihood</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>SmoothnessPenalty</strong> --- compute smoothness penalties
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the smoothness penalty for a spline <a href="#robo23">CCurve</a> as part of
    making likelihoods.
</p>

<p>    The penalty can be either a penalty on the sum of squared second differences
    or the integrated squared second derivative, or a Gaussian penalty. The
    penalty matrix and penalty type stored in the <a href="#robo23">CCurve</a> structure should be
    of matching type.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">888 </span><span class="keyword">double</span> <strong>SmoothnessPenalty</strong><span class="sign">(</span>curveP theCurve<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve  <a href="#robo23">CCurve</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    pen   the smoothness penalty, already divided by 2*(prior variance)
          that is, the entire smoothness penalty term.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">892 </span><span class="sign">{</span>
<span class="line_number">893 </span>    <span class="keyword">double</span> pen<span class="sign">;</span>
<span class="line_number">894 </span>    <span class="keyword">int</span> c1 <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">895 </span>    <span class="comment">// Gaussian penalty</span>
<span class="line_number">896 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePenaltyType <span class="sign">=</span><span class="sign">=</span> pnone<span class="sign">)</span><span class="sign">{</span> 
<span class="line_number">897 </span>        pen <span class="sign">=</span> <span class="keyword">pow</span><span class="sign">(</span>F77_CALL<span class="sign">(</span>dnrm2<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">,</span>2<span class="sign">.</span>0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">898 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">899 </span>        <span class="keyword">double</span> <span class="sign">*</span> temp <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">calloc</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">900 </span>        <span class="keyword">double</span> <span class="sign">*</span> par<span class="sign">;</span>
<span class="line_number">901 </span>        <span class="comment">// 2diff penalty works directly with parameters, 2deriv works with exp(theta)</span>
<span class="line_number">902 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePenaltyType <span class="sign">=</span><span class="sign">=</span> pdiff<span class="sign">)</span> par <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">;</span>
<span class="line_number">903 </span>        <span class="keyword">else</span> par <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">;</span>
<span class="line_number">904 </span>        <span class="keyword">double</span> c1d <span class="sign">=</span> 1<span class="sign">.</span>0<span class="sign">;</span>
<span class="line_number">905 </span>        char uplo <span class="sign">=</span> <span class="squote">'U'</span><span class="sign">;</span>
<span class="line_number">906 </span>        <span class="comment">// compute par %*% P %*% par</span>
<span class="line_number">907 </span>        F77_CALL<span class="sign">(</span>dsymv<span class="sign">)</span><span class="sign">(</span> <span class="sign">&amp;</span>uplo<span class="sign">,</span> <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">,</span> <span class="sign">&amp;</span>c1d<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePenaltyMatrix<span class="sign">,</span>
<span class="line_number">908 </span>                <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">,</span> par<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> <span class="sign">&amp;</span>c1d<span class="sign">,</span> temp<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">909 </span>        pen <span class="sign">=</span> F77_CALL<span class="sign">(</span>ddot<span class="sign">)</span><span class="sign">(</span> <span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">,</span> temp<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> par<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">910 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePenaltyType <span class="sign">=</span><span class="sign">=</span> plogderiv<span class="sign">)</span> pen<span class="sign">=</span>log<span class="sign">(</span>pen<span class="sign">+</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">911 </span>        <span class="keyword">free</span><span class="sign">(</span>temp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">912 </span>    <span class="sign">}</span>
<span class="line_number">913 </span>    <span class="comment">// normalize by prior variance</span>
<span class="line_number">914 </span>    pen <span class="sign">=</span> pen <span class="sign">/</span> <span class="sign">(</span>2 <span class="sign">*</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">915 </span>    <span class="keyword">return</span> pen<span class="sign">;</span>
<span class="line_number">916 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CMetropolisHastings2fAcceptReject"></a>
<a name="robo69"></a><h2>CMetropolisHastings/AcceptReject [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">CMetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>AcceptReject</strong> --- accept-reject step for Metropolis-Hastings
</pre>
<p class="item_name">FUNCTION</p>
<p>    Executes the MH accept-reject decision.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1810 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <strong>AcceptReject</strong><span class="sign">(</span><span class="keyword">double</span> baselik<span class="sign">,</span> <span class="keyword">double</span> candlik<span class="sign">,</span> <span class="keyword">double</span> ratio<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    baselik   loglikelihood of the base case
    candlik   loglikelihood of the candidate
    ratio     additional multiplier (e.g. prior ratio)
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    out       integer, if 1, accept, if 0, reject
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1814 </span><span class="sign">{</span>
<span class="line_number">1815 </span>    <span class="keyword">if</span><span class="sign">(</span>isnan<span class="sign">(</span>candlik<span class="sign">)</span><span class="sign">)</span> candlik <span class="sign">=</span> <span class="sign">-</span>DBL_MAX<span class="sign">;</span>
<span class="line_number">1816 </span>    <span class="keyword">double</span> r <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>candlik <span class="sign">-</span> baselik<span class="sign">)</span> <span class="sign">*</span> ratio<span class="sign">;</span> 
<span class="line_number">1817 </span>    <span class="keyword">double</span> pAccept <span class="sign">=</span> <a href="#robo85">dmin</a><span class="sign">(</span>1<span class="sign">,</span>r<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1818 </span>    <span class="keyword">int</span> out<span class="sign">;</span>
<span class="line_number">1819 </span>    <span class="keyword">if</span><span class="sign">(</span>isnan<span class="sign">(</span>pAccept<span class="sign">)</span><span class="sign">)</span> pAccept <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">1820 </span>    <span class="keyword">if</span><span class="sign">(</span>runif<span class="sign">(</span>0<span class="sign">,</span>1<span class="sign">)</span> <span class="sign">&lt;</span> pAccept<span class="sign">)</span> out <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1821 </span>    <span class="keyword">else</span> out <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">1822 </span>    <span class="keyword">return</span> out<span class="sign">;</span>
<span class="line_number">1823 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CMetropolisHastings2fMH5fBDM"></a>
<a name="robo70"></a><h2>CMetropolisHastings/MH_BDM [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">CMetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>MH_BDM</strong> --- birth-death-move steps for spline knots
</pre>
<p class="item_name">FUNCTION</p>
<p>    Reversible-Jump MCMC steps for adding, deleting, or moving knots as part of the
    adaptive knot selection procedure. Can work with either the hazard or frailty
    curve, see also <a href="../R/splinefrailty_r.html#robo143">mh.bdm</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2284 </span><span class="keyword">void</span> <strong>MH_BDM</strong><span class="sign">(</span>char <span class="keyword">which</span><span class="sign">,</span> curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    which         character, can be either 'h' or 'f', for hazard or frailty respectively
    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2288 </span><span class="sign">{</span>
<span class="line_number">2289 </span>    curveP theCurve<span class="sign">;</span>
<span class="line_number">2290 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="squote">'h'</span><span class="sign">)</span> theCurve <span class="sign">=</span> hazard<span class="sign">;</span>
<span class="line_number">2291 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">which</span> <span class="sign">=</span><span class="sign">=</span> <span class="squote">'f'</span><span class="sign">)</span> theCurve <span class="sign">=</span> frailty<span class="sign">;</span>
<span class="line_number">2292 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">2293 </span>    <span class="comment">// Pointers to useful components</span>
<span class="line_number">2294 </span>    <span class="keyword">int</span> ord <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">;</span>
<span class="line_number">2295 </span>    <span class="keyword">int</span> nknots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">;</span>
<span class="line_number">2296 </span>    <span class="keyword">double</span> <span class="sign">*</span> candknots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineCandKnots<span class="sign">;</span>
<span class="line_number">2297 </span>    <span class="keyword">int</span> ncandknots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNCandKnots<span class="sign">;</span>
<span class="line_number">2298 </span>    <span class="keyword">double</span> <span class="sign">*</span> occ <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineCandOcc<span class="sign">;</span> <span class="comment">// occupied candidate knots</span>
<span class="line_number">2299 </span>    <span class="keyword">int</span> <span class="sign">*</span> occind <span class="sign">=</span> <span class="keyword">malloc</span><span class="sign">(</span>nknots <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2300 </span>    <span class="comment">// allocate temporary storage</span>
<span class="line_number">2301 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldKnots <span class="sign">=</span> <span class="keyword">calloc</span><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2302 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldPar <span class="sign">=</span> <span class="keyword">calloc</span><span class="sign">(</span>nknots<span class="sign">+</span>ord<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2303 </span>    <span class="keyword">double</span> <span class="sign">*</span> knots2 <span class="sign">=</span> <span class="keyword">calloc</span><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">+</span>1<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2304 </span>    <span class="keyword">double</span> <span class="sign">*</span> params2 <span class="sign">=</span> <span class="keyword">calloc</span><span class="sign">(</span>nknots<span class="sign">+</span>ord<span class="sign">+</span>1<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2305 </span>    <span class="keyword">double</span> <span class="sign">*</span> knots <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">;</span>
<span class="line_number">2306 </span>    <span class="keyword">double</span> <span class="sign">*</span> params <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">;</span>
<span class="line_number">2307 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">,</span>oldKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2308 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>ord<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">,</span>oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2309 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">,</span>knots2<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2310 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>ord<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">,</span>params2<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2311 </span>
<span class="line_number">2312 </span>    <span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">2313 </span>    <span class="comment">// compute probability of birth-death and move steps</span>
<span class="line_number">2314 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>ord<span class="sign">;</span>j<span class="sign">&lt;</span>ncandknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">;</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> <span class="keyword">if</span><span class="sign">(</span>occ<span class="sign">[</span>j<span class="sign">]</span><span class="sign">=</span><span class="sign">=</span>1<span class="sign">)</span> occind<span class="sign">[</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">]</span><span class="sign">=</span>j<span class="sign">;</span>
<span class="line_number">2315 </span>    <span class="keyword">double</span> pk <span class="sign">=</span> <a href="#robo87">EvalNknotsPrior</a><span class="sign">(</span> nknots<span class="sign">,</span> theCurve <span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2316 </span>    <span class="keyword">double</span> pkp1 <span class="sign">=</span> <span class="sign">(</span>nknots <span class="sign">&lt;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsMax<span class="sign">)</span> <span class="sign">?</span> <a href="#robo87">EvalNknotsPrior</a><span class="sign">(</span>nknots<span class="sign">+</span>1<span class="sign">,</span> theCurve<span class="sign">)</span> <span class="sign">:</span> 0<span class="sign">;</span>
<span class="line_number">2317 </span>    <span class="keyword">double</span> pkm1 <span class="sign">=</span> <span class="sign">(</span>nknots <span class="sign">&gt;</span> 1<span class="sign">)</span> <span class="sign">?</span> <a href="#robo87">EvalNknotsPrior</a><span class="sign">(</span>nknots<span class="sign">-</span>1<span class="sign">,</span> theCurve<span class="sign">)</span> <span class="sign">:</span> 0<span class="sign">;</span>
<span class="line_number">2318 </span>    <span class="keyword">double</span> pb <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBDMConst<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">*</span> <a href="#robo85">dmin</a><span class="sign">(</span>1<span class="sign">.</span>0<span class="sign">,</span>pkp1<span class="sign">/</span>pk<span class="sign">)</span><span class="sign">;</span> <span class="comment">// P(birth)</span>
<span class="line_number">2319 </span>    <span class="keyword">double</span> pd <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBDMConst<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">*</span> <a href="#robo85">dmin</a><span class="sign">(</span>1<span class="sign">.</span>0<span class="sign">,</span>pkm1<span class="sign">/</span>pk<span class="sign">)</span><span class="sign">;</span> <span class="comment">// P(death)</span>
<span class="line_number">2320 </span>    <span class="keyword">double</span> pm <span class="sign">=</span> <a href="#robo84">dmax</a><span class="sign">(</span>0<span class="sign">.</span>0<span class="sign">,</span>1<span class="sign">.</span>0<span class="sign">-</span>pb<span class="sign">-</span>pd<span class="sign">)</span><span class="sign">;</span> <span class="comment">// P(move)</span>
<span class="line_number">2321 </span>    <span class="keyword">double</span> u <span class="sign">=</span> runif<span class="sign">(</span>0<span class="sign">,</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2322 </span>    <span class="keyword">double</span> baselik<span class="sign">,</span>candlik<span class="sign">;</span>
<span class="line_number">2323 </span>    <span class="comment">// base likelihood</span>
<span class="line_number">2324 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> baselik <span class="sign">=</span> <a href="#robo65">LikelihoodSplineHazard</a><span class="sign">(</span>theCurve<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2325 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> baselik <span class="sign">=</span> <a href="#robo64">LikelihoodSplineFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>theCurve<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2326 </span>    <span class="keyword">if</span><span class="sign">(</span>u<span class="sign">&lt;</span>pd<span class="sign">)</span><span class="sign">{</span> <span class="comment">// death step</span>
<span class="line_number">2327 </span>        <span class="keyword">int</span> j  <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> floor<span class="sign">(</span>runif<span class="sign">(</span>0<span class="sign">,</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> nknots<span class="sign">)</span><span class="sign">)</span><span class="sign">+</span>ord<span class="sign">;</span> <span class="comment">// index of dying knot</span>
<span class="line_number">2328 </span>        <span class="keyword">double</span> x <span class="sign">=</span> knots<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>  <span class="comment">// value of dying knot</span>
<span class="line_number">2329 </span>            <span class="comment">//Rprintf("Remove knot %d at %f (occ: %d)\n",j,knots[j],(int) occ[occind[j-ord]]);</span>
<span class="line_number">2330 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>nknots<span class="sign">+</span>ord<span class="sign">;</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> <span class="keyword">if</span><span class="sign">(</span>i<span class="sign">&gt;</span><span class="sign">=</span>j<span class="sign">-</span>1<span class="sign">)</span> params2<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> params2<span class="sign">[</span>i<span class="sign">+</span>1<span class="sign">]</span><span class="sign">;</span> <span class="comment">//remove params2[j];</span>
<span class="line_number">2331 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>nknots<span class="sign">+</span>ord<span class="sign">;</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> <span class="keyword">if</span><span class="sign">(</span>i<span class="sign">&gt;</span><span class="sign">=</span>j<span class="sign">)</span> knots2<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> knots2<span class="sign">[</span>i<span class="sign">+</span>1<span class="sign">]</span><span class="sign">;</span> <span class="comment">//remove knots2[j2];</span>
<span class="line_number">2332 </span>        <span class="comment">// update spline parameters for knot deletion</span>
<span class="line_number">2333 </span>        <span class="keyword">if</span><span class="sign">(</span>ord<span class="sign">&gt;</span>2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j2<span class="sign">=</span>j<span class="sign">-</span>ord<span class="sign">+</span>1<span class="sign">;</span> j2<span class="sign">&lt;</span>j<span class="sign">-</span>1<span class="sign">;</span> j2<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2334 </span>            <span class="keyword">double</span> r2 <span class="sign">=</span> <span class="sign">(</span>x<span class="sign">-</span>knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>knots2<span class="sign">[</span>j2<span class="sign">+</span>ord<span class="sign">-</span>1<span class="sign">]</span><span class="sign">-</span>knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2335 </span>            <span class="keyword">double</span> inner <span class="sign">=</span> 1<span class="sign">/</span>r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">-</span><span class="sign">(</span>1<span class="sign">-</span>r2<span class="sign">)</span><span class="sign">/</span>r2<span class="sign">*</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">-</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2336 </span>            <span class="keyword">if</span><span class="sign">(</span>inner<span class="sign">&gt;</span>0<span class="sign">)</span> params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">=</span>log<span class="sign">(</span>inner<span class="sign">)</span><span class="sign">;</span> <span class="keyword">else</span> params2<span class="sign">[</span>j2<span class="sign">]</span> <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineMin<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2337 </span>        <span class="sign">}</span>
<span class="line_number">2338 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">-</span><span class="sign">-</span><span class="sign">;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">-</span><span class="sign">-</span><span class="sign">;</span>
<span class="line_number">2339 </span>        <span class="comment">// Jacobian for the transformation</span>
<span class="line_number">2340 </span>        <span class="keyword">double</span> J <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j<span class="sign">-</span>1<span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j<span class="sign">-</span>1<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j<span class="sign">-</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2341 </span>        <span class="keyword">if</span><span class="sign">(</span>ord<span class="sign">&gt;</span>2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j2 <span class="sign">=</span> j<span class="sign">-</span>ord<span class="sign">+</span>2<span class="sign">;</span> j2<span class="sign">&lt;</span>j<span class="sign">-</span>1<span class="sign">;</span> j2<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2342 </span>            <span class="keyword">double</span> r2 <span class="sign">=</span> <span class="sign">(</span>x<span class="sign">-</span>knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>knots2<span class="sign">[</span>j2<span class="sign">+</span>ord<span class="sign">-</span>1<span class="sign">]</span><span class="sign">-</span>knots2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2343 </span>            J <span class="sign">=</span> J <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>r2<span class="sign">*</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2344 </span>        <span class="sign">}</span>
<span class="line_number">2345 </span>        <span class="comment">// update the curve with the new knot set</span>
<span class="line_number">2346 </span>        <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span> knots2<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2347 </span>        <a href="#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'d'</span><span class="sign">,</span>j<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2348 </span>        <span class="comment">// update curve with new parameters</span>
<span class="line_number">2349 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2350 </span>            <a href="#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>params2<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2351 </span>            candlik <span class="sign">=</span> <a href="#robo65">LikelihoodSplineHazard</a><span class="sign">(</span>theCurve<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2352 </span>        <span class="sign">}</span>
<span class="line_number">2353 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2354 </span>            <span class="comment">// for the frailty curve, make sure that the mean is 1</span>
<span class="line_number">2355 </span>            <span class="keyword">double</span> newmean <span class="sign">=</span> <span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j<span class="sign">-</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>j<span class="sign">-</span>2<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2356 </span>            <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>nknots<span class="sign">+</span>ord<span class="sign">-</span>1<span class="sign">;</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> newmean <span class="sign">+</span><span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2357 </span>            <span class="keyword">double</span> newinner <span class="sign">=</span> <span class="sign">-</span>newmean<span class="sign">/</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>j<span class="sign">-</span>2<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2358 </span>            <span class="keyword">if</span><span class="sign">(</span>newinner<span class="sign">&lt;</span>0<span class="sign">)</span> candlik <span class="sign">=</span> <span class="sign">-</span>INFINITY<span class="sign">;</span>
<span class="line_number">2359 </span>            <span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2360 </span>                params2<span class="sign">[</span>j<span class="sign">-</span>2<span class="sign">]</span> <span class="sign">=</span> log<span class="sign">(</span>newinner<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2361 </span>                <a href="#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>params2<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2362 </span>                candlik <span class="sign">=</span> <a href="#robo64">LikelihoodSplineFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>theCurve<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2363 </span>            <span class="sign">}</span>
<span class="line_number">2364 </span>        <span class="sign">}</span>
<span class="line_number">2365 </span>        <span class="comment">// prior ratio * Jacobian</span>
<span class="line_number">2366 </span>        <span class="keyword">double</span> ratio <span class="sign">=</span> <span class="keyword">sqrt</span><span class="sign">(</span>2<span class="sign">*</span>M_PI<span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>fabs<span class="sign">(</span>J<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2367 </span>        <span class="keyword">int</span> acc <span class="sign">=</span> <a href="#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> ratio<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2368 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2369 </span>            <span class="comment">// Update occupied index and candsd</span>
<span class="line_number">2370 </span>            occ<span class="sign">[</span>occind<span class="sign">[</span>j<span class="sign">-</span>ord<span class="sign">]</span><span class="sign">]</span> <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">2371 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> <span class="comment">//undo damage</span>
<span class="line_number">2372 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span>
<span class="line_number">2373 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span> oldKnots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2374 </span>            <a href="#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'b'</span><span class="sign">,</span>j<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2375 </span>            <a href="#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>oldPar<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2376 </span>        <span class="sign">}</span>
<span class="line_number">2377 </span>    <span class="sign">}</span>
<span class="line_number">2378 </span>    <span class="keyword">if</span><span class="sign">(</span>u<span class="sign">&gt;</span>pd <span class="sign">&amp;</span> u<span class="sign">&lt;</span>pd<span class="sign">+</span>pb<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2379 </span>        <span class="comment">// Birth</span>
<span class="line_number">2380 </span>        <span class="keyword">int</span> birthind <span class="sign">=</span> occind<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2381 </span>        <span class="comment">// choose a random unoccupied location for the knot to be born</span>
<span class="line_number">2382 </span>        <span class="keyword">while</span><span class="sign">(</span>occ<span class="sign">[</span>birthind<span class="sign">]</span><span class="sign">)</span> birthind <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> floor<span class="sign">(</span>runif<span class="sign">(</span>0<span class="sign">,</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> ncandknots<span class="sign">)</span><span class="sign">)</span><span class="sign">+</span>ord<span class="sign">;</span>
<span class="line_number">2383 </span>        <span class="keyword">double</span> x <span class="sign">=</span> candknots<span class="sign">[</span>birthind<span class="sign">]</span><span class="sign">;</span> <span class="comment">// value of the new knot</span>
<span class="line_number">2384 </span>        <span class="keyword">int</span> j <span class="sign">=</span> 0<span class="sign">;</span> <span class="keyword">while</span><span class="sign">(</span>knots<span class="sign">[</span>j<span class="sign">]</span><span class="sign">&lt;</span>x<span class="sign">)</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span> j<span class="sign">-</span><span class="sign">-</span><span class="sign">;</span> <span class="comment">// find the interval in which x lies</span>
<span class="line_number">2385 </span>            <span class="comment">//Rprintf("Birth at %f after knot %d\n",x,j);</span>
<span class="line_number">2386 </span>        <span class="comment">// update knot set and spline parameters</span>
<span class="line_number">2387 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">;</span>i<span class="sign">&gt;</span>j<span class="sign">;</span>i<span class="sign">-</span><span class="sign">-</span><span class="sign">)</span> knots2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">=</span>knots2<span class="sign">[</span>i<span class="sign">-</span>1<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2388 </span>        knots2<span class="sign">[</span>j<span class="sign">+</span>1<span class="sign">]</span><span class="sign">=</span>x<span class="sign">;</span>
<span class="line_number">2389 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>nknots<span class="sign">+</span>ord<span class="sign">;</span>i<span class="sign">&gt;</span>j<span class="sign">-</span>ord<span class="sign">+</span>1<span class="sign">;</span>i<span class="sign">-</span><span class="sign">-</span><span class="sign">)</span> params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">=</span>params2<span class="sign">[</span>i<span class="sign">-</span>1<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2390 </span>        <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j2 <span class="sign">=</span> j<span class="sign">-</span>ord<span class="sign">+</span>2<span class="sign">;</span> j2<span class="sign">&lt;</span>j<span class="sign">+</span>1<span class="sign">;</span> j2<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2391 </span>            <span class="keyword">double</span> r2 <span class="sign">=</span> <span class="sign">(</span>x<span class="sign">-</span>knots<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>knots<span class="sign">[</span>j2<span class="sign">+</span>ord<span class="sign">-</span>1<span class="sign">]</span><span class="sign">-</span>knots<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2392 </span>            <span class="keyword">if</span><span class="sign">(</span>j2<span class="sign">=</span><span class="sign">=</span>j<span class="sign">)</span> r2 <span class="sign">=</span> runif<span class="sign">(</span>0<span class="sign">,</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2393 </span>            params2<span class="sign">[</span>j2<span class="sign">]</span> <span class="sign">=</span> log<span class="sign">(</span>r2<span class="sign">*</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">+</span><span class="sign">(</span>1<span class="sign">-</span>r2<span class="sign">)</span><span class="sign">*</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j2<span class="sign">-</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2394 </span>        <span class="sign">}</span>
<span class="line_number">2395 </span>            <span class="comment">//Rprintf("Birthind,x,j: %d %f %d\n",birthind,x,j);</span>
<span class="line_number">2396 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span>
<span class="line_number">2397 </span>        <span class="comment">// Jacobian of the transformation</span>
<span class="line_number">2398 </span>        <span class="keyword">double</span> J <span class="sign">=</span> <span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j<span class="sign">-</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">/</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2399 </span>        <span class="keyword">if</span><span class="sign">(</span>ord<span class="sign">&gt;</span>2<span class="sign">)</span> <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j2 <span class="sign">=</span> j<span class="sign">-</span>ord<span class="sign">+</span>2<span class="sign">;</span> j2<span class="sign">&lt;</span>j<span class="sign">;</span> j2<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2400 </span>            <span class="keyword">double</span> r2 <span class="sign">=</span> <span class="sign">(</span>x<span class="sign">-</span>knots<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="sign">(</span>knots<span class="sign">[</span>j2<span class="sign">+</span>ord<span class="sign">-</span>1<span class="sign">]</span><span class="sign">-</span>knots<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2401 </span>            J <span class="sign">=</span> J <span class="sign">*</span> r2 <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>params<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">/</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j2<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2402 </span>        <span class="sign">}</span>
<span class="line_number">2403 </span>        <span class="comment">// update curve with new knots and parameters</span>
<span class="line_number">2404 </span>        <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">+</span>1<span class="sign">,</span> knots2<span class="sign">,</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2405 </span>        <a href="#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'b'</span><span class="sign">,</span>j<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2406 </span>        <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2407 </span>            <a href="#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>params2<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2408 </span>            candlik <span class="sign">=</span> <a href="#robo65">LikelihoodSplineHazard</a><span class="sign">(</span>theCurve<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2409 </span>        <span class="sign">}</span>
<span class="line_number">2410 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2411 </span>            <span class="comment">// for frailty, make sure the mean is 1</span>
<span class="line_number">2412 </span>            <span class="keyword">double</span> newmean <span class="sign">=</span> <span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2413 </span>            <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>nknots<span class="sign">+</span>ord<span class="sign">+</span>1<span class="sign">;</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> newmean <span class="sign">+</span><span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2414 </span>            <span class="keyword">double</span> newinner <span class="sign">=</span> <span class="sign">-</span>newmean<span class="sign">/</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2415 </span>            <span class="keyword">if</span><span class="sign">(</span>newinner<span class="sign">&lt;</span>0<span class="sign">)</span> candlik <span class="sign">=</span> <span class="sign">-</span>INFINITY<span class="sign">;</span>
<span class="line_number">2416 </span>            <span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2417 </span>                params2<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> log<span class="sign">(</span>newinner<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2418 </span>                <a href="#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>params2<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2419 </span>                candlik <span class="sign">=</span> <a href="#robo64">LikelihoodSplineFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>theCurve<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2420 </span>            <span class="sign">}</span>
<span class="line_number">2421 </span>        <span class="sign">}</span>
<span class="line_number">2422 </span>        <span class="comment">// prior ratio * Jacobian</span>
<span class="line_number">2423 </span>        <span class="keyword">double</span> ratio <span class="sign">=</span> 1<span class="sign">/</span><span class="keyword">sqrt</span><span class="sign">(</span>2<span class="sign">*</span>M_PI<span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> fabs<span class="sign">(</span>J<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2424 </span>        <span class="keyword">int</span> acc <span class="sign">=</span> <a href="#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> ratio<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2425 </span>            <span class="comment">//Rprintf("Lik: %f %f %f %f %d\n",baselik,candlik, J, ratio,acc);</span>
<span class="line_number">2426 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2427 </span>            <span class="comment">// Update set of occupied candidate knots</span>
<span class="line_number">2428 </span>            occ<span class="sign">[</span>birthind<span class="sign">]</span> <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">2429 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> <span class="comment">//undo damage</span>
<span class="line_number">2430 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots<span class="sign">-</span><span class="sign">-</span><span class="sign">;</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">-</span><span class="sign">-</span><span class="sign">;</span>
<span class="line_number">2431 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>nknots<span class="sign">+</span>2<span class="sign">*</span>ord<span class="sign">,</span> oldKnots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2432 </span>            <a href="#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'d'</span><span class="sign">,</span>j<span class="sign">+</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2433 </span>            <a href="#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>oldPar<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2434 </span>        <span class="sign">}</span>
<span class="line_number">2435 </span>    <span class="sign">}</span>
<span class="line_number">2436 </span>    <span class="keyword">if</span><span class="sign">(</span>u<span class="sign">&gt;</span>pb<span class="sign">+</span>pd<span class="sign">)</span> <span class="sign">{</span> <span class="comment">// Move a knot</span>
<span class="line_number">2437 </span>        <span class="comment">// choose a random knot to move</span>
<span class="line_number">2438 </span>        <span class="keyword">int</span> moveind<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">2439 </span>        moveind  <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> floor<span class="sign">(</span>runif<span class="sign">(</span>0<span class="sign">,</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> nknots<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2440 </span>        <span class="comment">// find range of movement</span>
<span class="line_number">2441 </span>        <span class="keyword">int</span> leftknotind <span class="sign">=</span> <span class="sign">(</span>moveind <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="sign">?</span> ord <span class="sign">:</span> occind<span class="sign">[</span>moveind<span class="sign">-</span>1<span class="sign">]</span><span class="sign">+</span>1<span class="sign">;</span>
<span class="line_number">2442 </span>        <span class="keyword">int</span> rightknotind <span class="sign">=</span> <span class="sign">(</span>moveind <span class="sign">=</span><span class="sign">=</span> nknots<span class="sign">-</span>1<span class="sign">)</span> <span class="sign">?</span> ncandknots <span class="sign">+</span> ord <span class="sign">-</span> 1 <span class="sign">:</span> occind<span class="sign">[</span>moveind<span class="sign">+</span>1<span class="sign">]</span><span class="sign">-</span>1<span class="sign">;</span>
<span class="line_number">2443 </span>        <span class="comment">// choose a candidate knot to place the new knot in</span>
<span class="line_number">2444 </span>        <span class="keyword">int</span> newknotind <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> floor<span class="sign">(</span>runif<span class="sign">(</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> leftknotind<span class="sign">,</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> rightknotind<span class="sign">+</span>1<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2445 </span>        <span class="comment">// if the knot doesn't stay the same, update the curve</span>
<span class="line_number">2446 </span>        <span class="keyword">if</span><span class="sign">(</span>candknots<span class="sign">[</span>newknotind<span class="sign">]</span> <span class="sign">!</span><span class="sign">=</span> oldKnots<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span> 
<span class="line_number">2447 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span> <span class="sign">=</span> candknots<span class="sign">[</span>newknotind<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2448 </span>            <span class="comment">// update spline basis with new knot position</span>
<span class="line_number">2449 </span>            <a href="#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'m'</span><span class="sign">,</span>moveind<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2450 </span>            <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span> <span class="comment">//hazard</span>
<span class="line_number">2451 </span>                <a href="#robo32">EvalSpline</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2452 </span>                candlik <span class="sign">=</span> <a href="#robo65">LikelihoodSplineHazard</a><span class="sign">(</span>theCurve<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2453 </span>            <span class="sign">}</span>
<span class="line_number">2454 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span> <span class="comment">//frailty</span>
<span class="line_number">2455 </span>                <span class="comment">// frailty needs to ensure the mean is 1</span>
<span class="line_number">2456 </span>                <span class="keyword">double</span> newmean <span class="sign">=</span> <span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2457 </span>                <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span>i<span class="sign">&lt;</span>nknots<span class="sign">+</span>ord<span class="sign">;</span>i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> newmean <span class="sign">+</span><span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>params2<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">*</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2458 </span>                <span class="keyword">double</span> newinner <span class="sign">=</span> <span class="sign">-</span>newmean<span class="sign">/</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2459 </span>                <span class="keyword">if</span><span class="sign">(</span>newinner<span class="sign">&lt;</span>0<span class="sign">)</span> candlik <span class="sign">=</span> <span class="sign">-</span>INFINITY<span class="sign">;</span>
<span class="line_number">2460 </span>                <span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2461 </span>                    params2<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span> <span class="sign">=</span> log<span class="sign">(</span>newinner<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2462 </span>                    <a href="#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>params2<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2463 </span>                    candlik <span class="sign">=</span> <a href="#robo64">LikelihoodSplineFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>theCurve<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2464 </span>                <span class="sign">}</span>
<span class="line_number">2465 </span>            <span class="sign">}</span>
<span class="line_number">2466 </span>            <span class="keyword">int</span> acc <span class="sign">=</span> <a href="#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span>candlik<span class="sign">,</span>1<span class="sign">.</span>0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2467 </span>            <span class="comment">//Rprintf("Lik: %f %f %d\n",baselik,candlik,acc);</span>
<span class="line_number">2468 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>acc<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2469 </span>                <span class="comment">// not accepted, undo the damage</span>
<span class="line_number">2470 </span>                theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span> <span class="sign">=</span> oldKnots<span class="sign">[</span>moveind<span class="sign">+</span>ord<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2471 </span>                <a href="#robo39">RemakeSplineBasis</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="squote">'m'</span><span class="sign">,</span>moveind<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2472 </span>                <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span><span class="sign">{</span> <span class="comment">// hazard</span>
<span class="line_number">2473 </span>                    <a href="#robo32">EvalSpline</a><span class="sign">(</span>theCurve<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2474 </span>                <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>      <span class="comment">// frailty</span>
<span class="line_number">2475 </span>                    <a href="#robo44">UpdateSplinePar</a><span class="sign">(</span>theCurve<span class="sign">,</span>oldPar<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2476 </span>                <span class="sign">}</span>
<span class="line_number">2477 </span>            <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> <span class="comment">// update occupied index</span>
<span class="line_number">2478 </span>                occ<span class="sign">[</span>occind<span class="sign">[</span>moveind<span class="sign">]</span><span class="sign">]</span><span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">2479 </span>                occ<span class="sign">[</span>newknotind<span class="sign">]</span> <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">2480 </span>            <span class="sign">}</span>
<span class="line_number">2481 </span>        <span class="sign">}</span>
<span class="line_number">2482 </span>    <span class="sign">}</span>
<span class="line_number">2483 </span>
<span class="line_number">2484 </span>    <span class="keyword">free</span><span class="sign">(</span>oldKnots<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2485 </span>    <span class="keyword">free</span><span class="sign">(</span>oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2486 </span>    <span class="keyword">free</span><span class="sign">(</span>knots2<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2487 </span>    <span class="keyword">free</span><span class="sign">(</span>params2<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2488 </span>    <span class="keyword">free</span><span class="sign">(</span>occind<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2489 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CMetropolisHastings2fMH5fFrail"></a>
<a name="robo71"></a><h2>CMetropolisHastings/MH_Frail [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">CMetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>MH_Frail</strong> --- MH step for frailties
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update frailty estimates by Metropolis-Hastings. See also <a href="../R/splinefrailty_r.html#robo145">mh.frail</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1837 </span><span class="keyword">void</span> <strong>MH_Frail</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1841 </span><span class="sign">{</span>
<span class="line_number">1842 </span>    <span class="keyword">double</span> acc <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">1843 </span>    <span class="keyword">double</span> baselik<span class="sign">,</span> candlik<span class="sign">;</span>
<span class="line_number">1844 </span>    <span class="keyword">int</span> j<span class="sign">;</span>
<span class="line_number">1845 </span>    <span class="comment">// update the frailties one at a time</span>
<span class="line_number">1846 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i <span class="sign">&lt;</span> regression<span class="sign">-</span><span class="sign">&gt;</span>m<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1847 </span>        <span class="keyword">double</span> u <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1848 </span>        <span class="keyword">double</span> y <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1849 </span>        <span class="keyword">double</span> v <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>tun<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1850 </span>        <span class="keyword">double</span> uj<span class="sign">,</span>yj<span class="sign">,</span>candj<span class="sign">;</span>
<span class="line_number">1851 </span>        <span class="comment">// generate candidate from gamma distribution</span>
<span class="line_number">1852 </span>        <span class="keyword">double</span> cand <span class="sign">=</span> <span class="keyword">rgamma</span><span class="sign">(</span> <span class="keyword">pow</span><span class="sign">(</span>u<span class="sign">,</span>2<span class="sign">)</span><span class="sign">/</span>v<span class="sign">,</span> v<span class="sign">/</span>u<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1853 </span>        <span class="keyword">double</span> pcu <span class="sign">=</span> 1<span class="sign">;</span> <span class="keyword">double</span> puc <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1854 </span>        <span class="comment">// if the candidate is invalid (e.g. beyond boundary knots), fail</span>
<span class="line_number">1855 </span>        <span class="keyword">if</span><span class="sign">(</span>isnan<span class="sign">(</span>cand<span class="sign">)</span> <span class="sign">|</span><span class="sign">|</span> <span class="sign">(</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>hasSpline <span class="sign">&amp;</span><span class="sign">&amp;</span>
<span class="line_number">1856 </span>            <span class="sign">(</span>cand <span class="sign">&gt;</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">[</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj <span class="sign">+</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd <span class="sign">-</span>1<span class="sign">]</span>
<span class="line_number">1857 </span>             <span class="sign">|</span> cand <span class="sign">&lt;</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span> <span class="sign">)</span> <span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1858 </span>            <span class="keyword">continue</span><span class="sign">;</span>
<span class="line_number">1859 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1860 </span>            <span class="comment">// find another frailty to move by the same amount</span>
<span class="line_number">1861 </span>            j <span class="sign">=</span> i<span class="sign">;</span>
<span class="line_number">1862 </span>            <span class="keyword">while</span><span class="sign">(</span>j <span class="sign">=</span><span class="sign">=</span> i<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1863 </span>                j <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> floor<span class="sign">(</span>runif<span class="sign">(</span>0<span class="sign">,</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1864 </span>            <span class="sign">}</span>
<span class="line_number">1865 </span>            <span class="comment">//Rprintf("i: %d,  j: %d\n",i,j);</span>
<span class="line_number">1866 </span>            uj <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1867 </span>            yj <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1868 </span>            candj <span class="sign">=</span> u <span class="sign">+</span> uj <span class="sign">-</span> cand<span class="sign">;</span>
<span class="line_number">1869 </span>            <span class="comment">// if the moved element is invalid, fail</span>
<span class="line_number">1870 </span>            <span class="keyword">if</span><span class="sign">(</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>hasSpline <span class="sign">&amp;</span><span class="sign">&amp;</span>
<span class="line_number">1871 </span>                <span class="sign">(</span>candj <span class="sign">&gt;</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">[</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj <span class="sign">+</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd <span class="sign">-</span>1<span class="sign">]</span>
<span class="line_number">1872 </span>                 <span class="sign">|</span> candj <span class="sign">&lt;</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span> <span class="sign">)</span> <span class="keyword">continue</span><span class="sign">;</span>
<span class="line_number">1873 </span>            <span class="comment">// base likelihood</span>
<span class="line_number">1874 </span>            baselik <span class="sign">=</span> <a href="#robo58">LikelihoodFrailty</a><span class="sign">(</span>i<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">1875 </span>                <span class="sign">+</span> <a href="#robo58">LikelihoodFrailty</a><span class="sign">(</span>j<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1876 </span>            <span class="comment">// update the curve with the candidate, without touching the basis</span>
<span class="line_number">1877 </span>            frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> cand<span class="sign">;</span>
<span class="line_number">1878 </span>            frailty<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> <a href="#robo29">EvalCurveAtOnePoint</a><span class="sign">(</span>frailty<span class="sign">,</span> cand<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1879 </span>            frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> candj<span class="sign">;</span>
<span class="line_number">1880 </span>            frailty<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> <a href="#robo29">EvalCurveAtOnePoint</a><span class="sign">(</span>frailty<span class="sign">,</span> candj<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1881 </span>            <span class="comment">// candidate likelihood</span>
<span class="line_number">1882 </span>            candlik <span class="sign">=</span> <a href="#robo58">LikelihoodFrailty</a><span class="sign">(</span>i<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span>
<span class="line_number">1883 </span>                <span class="sign">+</span> <a href="#robo58">LikelihoodFrailty</a><span class="sign">(</span>j<span class="sign">,</span> hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1884 </span>            <span class="comment">// transition probabilities</span>
<span class="line_number">1885 </span>            puc <span class="sign">=</span> dgamma<span class="sign">(</span>cand<span class="sign">,</span> <span class="keyword">pow</span><span class="sign">(</span>u<span class="sign">,</span>2<span class="sign">)</span><span class="sign">/</span>v<span class="sign">,</span> v<span class="sign">/</span>u<span class="sign">,</span> 0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1886 </span>            pcu <span class="sign">=</span> dgamma<span class="sign">(</span>u<span class="sign">,</span> <span class="keyword">pow</span><span class="sign">(</span>cand<span class="sign">,</span>2<span class="sign">)</span><span class="sign">/</span>v<span class="sign">,</span> v<span class="sign">/</span>cand<span class="sign">,</span> 0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1887 </span>        <span class="sign">}</span>
<span class="line_number">1888 </span>        <span class="keyword">int</span> thisacc <span class="sign">=</span> <a href="#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> pcu<span class="sign">/</span>puc<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1889 </span>        <span class="keyword">if</span><span class="sign">(</span>thisacc<span class="sign">=</span><span class="sign">=</span>0<span class="sign">)</span> <span class="sign">{</span> <span class="comment">//Did not accept, so undo the damage</span>
<span class="line_number">1890 </span>            frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> u<span class="sign">;</span>
<span class="line_number">1891 </span>            frailty<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> y<span class="sign">;</span>
<span class="line_number">1892 </span>            frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> uj<span class="sign">;</span>
<span class="line_number">1893 </span>            frailty<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> yj<span class="sign">;</span>
<span class="line_number">1894 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> <span class="comment">// accepted, so update the curve fully</span>
<span class="line_number">1895 </span>            <a href="#robo41">UpdateCurveX</a><span class="sign">(</span>frailty<span class="sign">,</span> cand<span class="sign">,</span> i<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1896 </span>            <a href="#robo41">UpdateCurveX</a><span class="sign">(</span>frailty<span class="sign">,</span> candj<span class="sign">,</span> j<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1897 </span>            <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> k<span class="sign">=</span>regression<span class="sign">-</span><span class="sign">&gt;</span>Jicum<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span> k<span class="sign">&lt;</span>regression<span class="sign">-</span><span class="sign">&gt;</span>Jicum<span class="sign">[</span>i<span class="sign">+</span>1<span class="sign">]</span><span class="sign">;</span> k<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1898 </span>                regression<span class="sign">-</span><span class="sign">&gt;</span>frailrep<span class="sign">[</span>k<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1899 </span>                regression<span class="sign">-</span><span class="sign">&gt;</span>frailelp<span class="sign">[</span>k<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>i<span class="sign">]</span><span class="sign">*</span>regression<span class="sign">-</span><span class="sign">&gt;</span>elp<span class="sign">[</span>k<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1900 </span>            <span class="sign">}</span>
<span class="line_number">1901 </span>            <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> k<span class="sign">=</span>regression<span class="sign">-</span><span class="sign">&gt;</span>Jicum<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span> k<span class="sign">&lt;</span>regression<span class="sign">-</span><span class="sign">&gt;</span>Jicum<span class="sign">[</span>j<span class="sign">+</span>1<span class="sign">]</span><span class="sign">;</span> k<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1902 </span>                regression<span class="sign">-</span><span class="sign">&gt;</span>frailrep<span class="sign">[</span>k<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1903 </span>                regression<span class="sign">-</span><span class="sign">&gt;</span>frailelp<span class="sign">[</span>k<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">[</span>j<span class="sign">]</span><span class="sign">*</span>regression<span class="sign">-</span><span class="sign">&gt;</span>elp<span class="sign">[</span>k<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">1904 </span>            <span class="sign">}</span>
<span class="line_number">1905 </span>        <span class="sign">}</span>
<span class="line_number">1906 </span>        <span class="comment">// update acceptance rate</span>
<span class="line_number">1907 </span>        acc <span class="sign">+</span><span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> thisacc<span class="sign">;</span>
<span class="line_number">1908 </span>    <span class="sign">}</span>
<span class="line_number">1909 </span>    acc <span class="sign">/</span><span class="sign">=</span> regression<span class="sign">-</span><span class="sign">&gt;</span>m<span class="sign">;</span>
<span class="line_number">1910 </span>    frailty<span class="sign">-</span><span class="sign">&gt;</span>Accept<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> acc<span class="sign">;</span>
<span class="line_number">1911 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CMetropolisHastings2fMH5fParamFrailty"></a>
<a name="robo72"></a><h2>CMetropolisHastings/MH_ParamFrailty [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">CMetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>MH_ParamFrailty</strong> --- MH for frailty parametric component parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update the parameters indexing the parametric component by Metropolis-Hastings,
    see also <a href="../R/splinefrailty_r.html#robo146">mh.frailty.param</a>
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2189 </span><span class="keyword">void</span> <strong>MH_ParamFrailty</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2193 </span><span class="sign">{</span> 
<span class="line_number">2194 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>hasPar<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">2195 </span>    <span class="keyword">double</span> baselik<span class="sign">,</span> candlik<span class="sign">;</span>
<span class="line_number">2196 </span>    <span class="comment">// base likelihood</span>
<span class="line_number">2197 </span>    baselik <span class="sign">=</span> <a href="#robo61">LikelihoodParamFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2198 </span>    <span class="keyword">double</span> <span class="sign">*</span> cand <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">calloc</span><span class="sign">(</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2199 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldPar <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>np <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2200 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">,</span> oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2201 </span>    <span class="comment">// generate candidate</span>
<span class="line_number">2202 </span>    <a href="#robo91">mvrnorm</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">,</span> cand<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>ParamCholCov<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>ParamTun<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2203 </span>    <span class="comment">// update curve with candidate parameter</span>
<span class="line_number">2204 </span>    <a href="#robo42">UpdateParamPar</a><span class="sign">(</span>frailty<span class="sign">,</span>cand<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2205 </span>    <span class="comment">// candidate likelihood</span>
<span class="line_number">2206 </span>    candlik <span class="sign">=</span> <a href="#robo61">LikelihoodParamFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2207 </span>    <span class="keyword">int</span> acc <span class="sign">=</span> <a href="#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> 1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2208 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>acc<span class="sign">)</span> <span class="comment">// rejected, undo damage</span>
<span class="line_number">2209 </span>        <a href="#robo42">UpdateParamPar</a><span class="sign">(</span>frailty<span class="sign">,</span>oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2210 </span>    frailty<span class="sign">-</span><span class="sign">&gt;</span>ParamAccept<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> acc<span class="sign">;</span>
<span class="line_number">2211 </span>    <span class="keyword">free</span><span class="sign">(</span>cand<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2212 </span>    <span class="keyword">free</span><span class="sign">(</span>oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2213 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CMetropolisHastings2fMH5fParamHazard"></a>
<a name="robo73"></a><h2>CMetropolisHastings/MH_ParamHazard [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">CMetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>MH_ParamHazard</strong> --- MH for hazard parametric component parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update the parameters indexing the parametric component by Metropolis-Hastings,
    see also <a href="../R/splinefrailty_r.html#robo148">mh.hazard.param</a>
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2150 </span><span class="keyword">void</span> <strong>MH_ParamHazard</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2154 </span><span class="sign">{</span>
<span class="line_number">2155 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>hasPar<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">2156 </span>    <span class="keyword">double</span> baselik<span class="sign">,</span> candlik<span class="sign">;</span>
<span class="line_number">2157 </span>    <span class="comment">// base likelihoood</span>
<span class="line_number">2158 </span>    baselik <span class="sign">=</span> <a href="#robo62">LikelihoodParamHazard</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2159 </span>    <span class="comment">// storage for old settings</span>
<span class="line_number">2160 </span>    <span class="keyword">double</span> <span class="sign">*</span> cand <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">calloc</span><span class="sign">(</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2161 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldPar <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>np <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2162 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">,</span> oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2163 </span>    <a href="#robo91">mvrnorm</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">,</span> cand<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamCholCov<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamTun<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2164 </span>    <span class="comment">// update curve at candidate</span>
<span class="line_number">2165 </span>    <a href="#robo42">UpdateParamPar</a><span class="sign">(</span>hazard<span class="sign">,</span>cand<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2166 </span>    <span class="comment">// candidate likelihodo</span>
<span class="line_number">2167 </span>    candlik <span class="sign">=</span> <a href="#robo62">LikelihoodParamHazard</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2168 </span>    <span class="keyword">int</span> acc <span class="sign">=</span> <a href="#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> 1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2169 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>acc<span class="sign">)</span> <span class="comment">// rejected, undo damage</span>
<span class="line_number">2170 </span>        <a href="#robo42">UpdateParamPar</a><span class="sign">(</span>hazard<span class="sign">,</span>oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2171 </span>    hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamAccept<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> acc<span class="sign">;</span>
<span class="line_number">2172 </span>    <span class="keyword">free</span><span class="sign">(</span>cand<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2173 </span>    <span class="keyword">free</span><span class="sign">(</span>oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2174 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CMetropolisHastings2fMH5fRegression"></a>
<a name="robo74"></a><h2>CMetropolisHastings/MH_Regression [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">CMetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>MH_Regression</strong> --- MH step for regression coefficients
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update the regression coefficients by Metropolis-Hastings. See also <a href="../R/splinefrailty_r.html#robo144">mh.coef</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1925 </span><span class="keyword">void</span> <strong>MH_Regression</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1929 </span><span class="sign">{</span>
<span class="line_number">1930 </span>    <span class="keyword">double</span> baselik<span class="sign">,</span> candlik<span class="sign">;</span>
<span class="line_number">1931 </span>    <span class="comment">// base likelihood</span>
<span class="line_number">1932 </span>    baselik <span class="sign">=</span> <a href="#robo63">LikelihoodRegression</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1933 </span>    <span class="keyword">double</span> <span class="sign">*</span> cand <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">calloc</span><span class="sign">(</span> regression<span class="sign">-</span><span class="sign">&gt;</span>p<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1934 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldlp <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> regression<span class="sign">-</span><span class="sign">&gt;</span>n <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1935 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldelp <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> regression<span class="sign">-</span><span class="sign">&gt;</span>n <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1936 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldfrailelp <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> regression<span class="sign">-</span><span class="sign">&gt;</span>n <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1937 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldcoef <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> regression<span class="sign">-</span><span class="sign">&gt;</span>p <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1938 </span>    <span class="comment">// store the old regression information</span>
<span class="line_number">1939 </span>    char trans <span class="sign">=</span> <span class="squote">'N'</span><span class="sign">;</span> <span class="keyword">double</span> c0 <span class="sign">=</span> 0<span class="sign">;</span> <span class="keyword">int</span> c1 <span class="sign">=</span> 1<span class="sign">;</span> <span class="keyword">double</span> c1d <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">1940 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>p<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>coefficients<span class="sign">,</span> oldcoef<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1941 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>lp<span class="sign">,</span> oldlp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1942 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>elp<span class="sign">,</span> oldelp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1943 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>frailelp<span class="sign">,</span> oldfrailelp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1944 </span>    <span class="comment">//generate candidate parameters</span>
<span class="line_number">1945 </span>    <a href="#robo91">mvrnorm</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>p<span class="sign">,</span> cand<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>coefficients<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>CholCov<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>tun<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">1946 </span>    <span class="comment">// Change the regression object with the new lp and elps</span>
<span class="line_number">1947 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>p<span class="sign">,</span> cand<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>coefficients<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1948 </span>    F77_CALL<span class="sign">(</span>dgemv<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>trans<span class="sign">,</span> <span class="sign">&amp;</span><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">)</span><span class="sign">,</span> <span class="sign">&amp;</span><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>p<span class="sign">)</span><span class="sign">,</span> <span class="sign">&amp;</span>c1d<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>covariates<span class="sign">,</span>
<span class="line_number">1949 </span>            <span class="sign">&amp;</span><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">)</span><span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>coefficients<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> <span class="sign">&amp;</span>c0<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>lp<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1950 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i <span class="sign">&lt;</span> regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> regression<span class="sign">-</span><span class="sign">&gt;</span>elp<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> <span class="keyword">exp</span><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>lp<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1951 </span>    <a href="#robo83">diagmvWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>frailrep<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>elp<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>frailelp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1952 </span>    candlik <span class="sign">=</span> <a href="#robo63">LikelihoodRegression</a><span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1953 </span>    <span class="keyword">int</span> acc <span class="sign">=</span> <a href="#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> 1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1954 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>acc<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1955 </span>        <span class="comment">// not accepted, so restore old regression</span>
<span class="line_number">1956 </span>        <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>p<span class="sign">,</span> oldcoef<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>coefficients<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1957 </span>        <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> oldlp<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>lp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1958 </span>        <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> oldelp<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>elp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1959 </span>        <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>n<span class="sign">,</span> oldfrailelp<span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>frailelp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1960 </span>    <span class="sign">}</span>
<span class="line_number">1961 </span>    regression<span class="sign">-</span><span class="sign">&gt;</span>Accept<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> acc<span class="sign">;</span> 
<span class="line_number">1962 </span>    <span class="keyword">free</span><span class="sign">(</span>cand<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1963 </span>    <span class="keyword">free</span><span class="sign">(</span>oldlp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1964 </span>    <span class="keyword">free</span><span class="sign">(</span>oldelp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1965 </span>    <span class="keyword">free</span><span class="sign">(</span>oldfrailelp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1966 </span>    <span class="keyword">free</span><span class="sign">(</span>oldcoef<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1967 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CMetropolisHastings2fMH5fSplineFrailty"></a>
<a name="robo75"></a><h2>CMetropolisHastings/MH_SplineFrailty [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">CMetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>MH_SplineFrailty</strong> --- MH for frailty spline parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update frailty spline parameters by Metropolis-Hastings. See also <a href="../R/splinefrailty_r.html#robo147">mh.frailty.spline</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2063 </span><span class="keyword">void</span> <strong>MH_SplineFrailty</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2067 </span><span class="sign">{</span>
<span class="line_number">2068 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">2069 </span>    <span class="keyword">double</span> baselik<span class="sign">,</span> candlik<span class="sign">;</span>
<span class="line_number">2070 </span>    <span class="keyword">double</span> sumacc<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">2071 </span>    <span class="comment">// base likelihood</span>
<span class="line_number">2072 </span>    baselik <span class="sign">=</span> <a href="#robo64">LikelihoodSplineFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">2073 </span>    <span class="keyword">double</span> <span class="sign">*</span> cand <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">calloc</span><span class="sign">(</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2074 </span>    <span class="comment">// allocate storage for parameters of old spline</span>
<span class="line_number">2075 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldPar <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> <span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span> <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2076 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldEPar <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>nj <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2077 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldY <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>nx <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2078 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldSplineY <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>nx <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2079 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">,</span> oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2080 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">,</span> oldEPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2081 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">,</span> oldY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2082 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">,</span> oldSplineY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2083 </span>    <span class="keyword">double</span> oldSplineEParSum <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum<span class="sign">;</span>
<span class="line_number">2084 </span>    <span class="keyword">double</span> oldSplineFvar <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineFvar<span class="sign">;</span>
<span class="line_number">2085 </span>    <span class="keyword">int</span> ord2 <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd <span class="sign">/</span> 2<span class="sign">;</span>
<span class="line_number">2086 </span>
<span class="line_number">2087 </span>    <span class="comment">// update the frailty spline parameters one by one</span>
<span class="line_number">2088 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>0<span class="sign">;</span> j<span class="sign">&lt;</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2089 </span>        <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> oldPar<span class="sign">,</span> cand<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2090 </span>        <span class="comment">// choose which parameter will compensate for j</span>
<span class="line_number">2091 </span>        <span class="comment">// to ensure the frailty mean remains 1</span>
<span class="line_number">2092 </span>        <span class="keyword">int</span> k <span class="sign">=</span> j<span class="sign">;</span>
<span class="line_number">2093 </span>        <span class="keyword">while</span><span class="sign">(</span>j <span class="sign">=</span><span class="sign">=</span> k <span class="sign">|</span> k<span class="sign">&lt;</span>ord2<span class="sign">-</span>1 <span class="sign">|</span> k<span class="sign">&gt;</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">-</span>ord2<span class="sign">-</span>1<span class="sign">)</span> 
<span class="line_number">2094 </span>            k <span class="sign">=</span> <span class="sign">(</span><span class="keyword">int</span><span class="sign">)</span> floor<span class="sign">(</span>runif<span class="sign">(</span>0<span class="sign">,</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2095 </span>        
<span class="line_number">2096 </span>        <span class="comment">// Generate candidate parameter at j</span>
<span class="line_number">2097 </span>        cand<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>j<span class="sign">]</span><span class="sign">+</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineTun<span class="sign">[</span>0<span class="sign">]</span><span class="sign">*</span>
<span class="line_number">2098 </span>            <span class="keyword">rnorm</span><span class="sign">(</span>0<span class="sign">,</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineCandSD<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2099 </span>        <span class="comment">// Try to compute value at k to compensate for change at j</span>
<span class="line_number">2100 </span>        <span class="keyword">double</span> newmean <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span><span class="keyword">exp</span><span class="sign">(</span>cand<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span>oldPar<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2101 </span>        <span class="keyword">double</span> candk <span class="sign">=</span> log<span class="sign">(</span>oldEPar<span class="sign">[</span>k<span class="sign">]</span> <span class="sign">-</span> newmean<span class="sign">/</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineBasisExp<span class="sign">[</span>k<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2102 </span>        <span class="keyword">if</span><span class="sign">(</span>isnan<span class="sign">(</span>candk<span class="sign">)</span><span class="sign">)</span> <span class="keyword">continue</span><span class="sign">;</span>
<span class="line_number">2103 </span>        cand<span class="sign">[</span>k<span class="sign">]</span> <span class="sign">=</span> candk<span class="sign">;</span>
<span class="line_number">2104 </span>        <span class="comment">// Compute candidate likelihood</span>
<span class="line_number">2105 </span>        <a href="#robo44">UpdateSplinePar</a><span class="sign">(</span>frailty<span class="sign">,</span>cand<span class="sign">,</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">2106 </span>        candlik <span class="sign">=</span> <a href="#robo64">LikelihoodSplineFrailty</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2107 </span>        <span class="keyword">int</span> acc <span class="sign">=</span> <a href="#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> 1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2108 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span><span class="sign">{</span> <span class="comment">// accepted, save and continue</span>
<span class="line_number">2109 </span>            baselik <span class="sign">=</span> candlik<span class="sign">;</span>
<span class="line_number">2110 </span>            sumacc<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span>
<span class="line_number">2111 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">,</span> oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2112 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">,</span> oldEPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2113 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">,</span> oldY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2114 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">,</span> oldSplineY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2115 </span>            oldSplineEParSum <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum<span class="sign">;</span>
<span class="line_number">2116 </span>            oldSplineFvar <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineFvar<span class="sign">;</span>
<span class="line_number">2117 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> <span class="comment">// rejected, restore old values and continue</span>
<span class="line_number">2118 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> oldPar<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2119 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> oldEPar<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2120 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> oldY<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2121 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> oldSplineY<span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2122 </span>            frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineEParSum <span class="sign">=</span> oldSplineEParSum <span class="sign">;</span>
<span class="line_number">2123 </span>            frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineFvar <span class="sign">=</span> oldSplineFvar <span class="sign">;</span>
<span class="line_number">2124 </span>        <span class="sign">}</span>
<span class="line_number">2125 </span>    <span class="sign">}</span>
<span class="line_number">2126 </span>    <span class="comment">// acceptance rate</span>
<span class="line_number">2127 </span>    frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineAccept<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> sumacc <span class="sign">/</span> <span class="sign">(</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2128 </span>    <span class="comment">// free memory</span>
<span class="line_number">2129 </span>    <span class="keyword">free</span><span class="sign">(</span>cand<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2130 </span>    <span class="keyword">free</span><span class="sign">(</span>oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2131 </span>    <span class="keyword">free</span><span class="sign">(</span>oldEPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2132 </span>    <span class="keyword">free</span><span class="sign">(</span>oldY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2133 </span>    <span class="keyword">free</span><span class="sign">(</span>oldSplineY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2134 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CMetropolisHastings2fMH5fSplineHazard"></a>
<a name="robo76"></a><h2>CMetropolisHastings/MH_SplineHazard [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">CMetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>MH_SplineHazard</strong> --- MH for hazard spline parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update the parameters of the hazard spline component by Metropolis-Hastings.
    See also <a href="../R/splinefrailty_r.html#robo149">mh.hazard.spline</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1982 </span><span class="keyword">void</span> <strong>MH_SplineHazard</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1986 </span><span class="sign">{</span>
<span class="line_number">1987 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">1988 </span>    <span class="keyword">double</span> baselik<span class="sign">,</span> candlik<span class="sign">;</span>
<span class="line_number">1989 </span>    <span class="keyword">double</span> sumacc<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">1990 </span>    <span class="comment">// base likelihood</span>
<span class="line_number">1991 </span>    baselik <span class="sign">=</span> <a href="#robo65">LikelihoodSplineHazard</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">1992 </span>    <span class="keyword">double</span> <span class="sign">*</span> cand <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">calloc</span><span class="sign">(</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1993 </span>    <span class="keyword">double</span> <span class="sign">*</span> thiscand <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">calloc</span><span class="sign">(</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1994 </span>    <span class="comment">// allocate storage for parameters of old spline</span>
<span class="line_number">1995 </span>    <span class="comment">// if the move is not accepted, these will be used to restore it, to make it faster</span>
<span class="line_number">1996 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldPar <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>nj <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1997 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldEPar <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>nj <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1998 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldY <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>nx <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1999 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldYcum <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>nx <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2000 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldSplineY <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>nx <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2001 </span>    <span class="keyword">double</span> <span class="sign">*</span> oldSplineYcum <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>nx <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2002 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">,</span> oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2003 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">,</span> oldEPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2004 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">,</span> thiscand<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2005 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">,</span> oldY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2006 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">,</span> oldSplineY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2007 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">,</span> oldYcum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2008 </span>    <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineYcum<span class="sign">,</span> oldSplineYcum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2009 </span>    <span class="comment">// create candidate parameters</span>
<span class="line_number">2010 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>0<span class="sign">;</span>j<span class="sign">&lt;</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span>j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span>
<span class="line_number">2011 </span>        cand<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">[</span>j<span class="sign">]</span><span class="sign">+</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineTun<span class="sign">[</span>0<span class="sign">]</span><span class="sign">*</span>
<span class="line_number">2012 </span>            <span class="keyword">rnorm</span><span class="sign">(</span>0<span class="sign">,</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineCandSD<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2013 </span>    <span class="comment">// update spline parameters one at a time</span>
<span class="line_number">2014 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> j<span class="sign">=</span>0<span class="sign">;</span> j <span class="sign">&lt;</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">;</span> j<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2015 </span>        thiscand<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">=</span> cand<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2016 </span>        <a href="#robo44">UpdateSplinePar</a><span class="sign">(</span>hazard<span class="sign">,</span>thiscand<span class="sign">,</span>j<span class="sign">)</span><span class="sign">;</span> 
<span class="line_number">2017 </span>        <span class="comment">// candidate likelihod</span>
<span class="line_number">2018 </span>        candlik <span class="sign">=</span> <a href="#robo65">LikelihoodSplineHazard</a><span class="sign">(</span>hazard<span class="sign">,</span>frailty<span class="sign">,</span>regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2019 </span>        <span class="keyword">int</span> acc <span class="sign">=</span> <a href="#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> 1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2020 </span>        <span class="keyword">if</span><span class="sign">(</span>acc<span class="sign">)</span><span class="sign">{</span> <span class="comment">// accepted, so store the new information</span>
<span class="line_number">2021 </span>            baselik <span class="sign">=</span> candlik<span class="sign">;</span>
<span class="line_number">2022 </span>            sumacc<span class="sign">+</span><span class="sign">+</span><span class="sign">;</span>
<span class="line_number">2023 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">,</span> oldEPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2024 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">,</span> oldY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2025 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">,</span> oldSplineY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2026 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">,</span> oldYcum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2027 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineYcum<span class="sign">,</span> oldSplineYcum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2028 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span> <span class="comment">// rejected, so restore the old information</span>
<span class="line_number">2029 </span>            thiscand<span class="sign">[</span>j<span class="sign">]</span><span class="sign">=</span>oldPar<span class="sign">[</span>j<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2030 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> thiscand<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2031 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">,</span> oldEPar<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineEPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2032 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> oldY<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Y<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2033 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> oldSplineY<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2034 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> oldYcum<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Ycum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2035 </span>            <a href="#robo80">dcopyWrapper</a><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">,</span> oldSplineYcum<span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineYcum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2036 </span>        <span class="sign">}</span>
<span class="line_number">2037 </span>    <span class="sign">}</span>
<span class="line_number">2038 </span>    <span class="comment">// acceptance rate</span>
<span class="line_number">2039 </span>    hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineAccept<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span>  sumacc <span class="sign">/</span> <span class="sign">(</span><span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2040 </span>    <span class="comment">// free memory</span>
<span class="line_number">2041 </span>    <span class="keyword">free</span><span class="sign">(</span>cand<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2042 </span>    <span class="keyword">free</span><span class="sign">(</span>thiscand<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2043 </span>    <span class="keyword">free</span><span class="sign">(</span>oldPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2044 </span>    <span class="keyword">free</span><span class="sign">(</span>oldEPar<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2045 </span>    <span class="keyword">free</span><span class="sign">(</span>oldY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2046 </span>    <span class="keyword">free</span><span class="sign">(</span>oldYcum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2047 </span>    <span class="keyword">free</span><span class="sign">(</span>oldSplineY<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2048 </span>    <span class="keyword">free</span><span class="sign">(</span>oldSplineYcum<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2049 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CMetropolisHastings2fMH5fWeight"></a>
<a name="robo77"></a><h2>CMetropolisHastings/MH_Weight [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">CMetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>MH_Weight</strong> --- MH for weight of spline component
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update the relative weight of the spline component in a curve with both spline
    and parametric components by Metropolis-Hastings. See also <a href="../R/splinefrailty_r.html#robo150">mh.weight</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2229 </span><span class="keyword">void</span> <strong>MH_Weight</strong><span class="sign">(</span>curveP theCurve<span class="sign">,</span> curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      <a href="#robo23">CCurve</a> to be updated, can be either hazard or frailty
    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2233 </span><span class="sign">{</span>
<span class="line_number">2234 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasPar <span class="sign">|</span> <span class="sign">!</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">2235 </span>    <span class="comment">// get the likelihood function, depending on whether the curve is the hazard or frailty</span>
<span class="line_number">2236 </span>    <span class="keyword">double</span> <span class="sign">(</span> <span class="sign">*</span>likfun <span class="sign">)</span><span class="sign">(</span>curveP<span class="sign">,</span> curveP<span class="sign">,</span> regressionP<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2237 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>isHazard<span class="sign">)</span> likfun <span class="sign">=</span> <span class="sign">&amp;</span><a href="#robo67">LikelihoodWeightHazard</a><span class="sign">;</span>
<span class="line_number">2238 </span>    <span class="keyword">else</span> likfun <span class="sign">=</span> <span class="sign">&amp;</span><a href="#robo66">LikelihoodWeightFrailty</a><span class="sign">;</span>  
<span class="line_number">2239 </span>    <span class="keyword">double</span> oldW <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2240 </span>    <span class="keyword">double</span> w <span class="sign">=</span> <a href="#robo85">dmin</a><span class="sign">(</span><a href="#robo84">dmax</a><span class="sign">(</span>oldW<span class="sign">,</span> <span class="sign">.</span>01<span class="sign">)</span><span class="sign">,</span> 0<span class="sign">.</span>99<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2241 </span>    <span class="keyword">double</span> v <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>WeightTun<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2242 </span>    <span class="keyword">double</span> alpha <span class="sign">=</span> w<span class="sign">*</span><span class="sign">(</span>w<span class="sign">*</span><span class="sign">(</span>1<span class="sign">-</span>w<span class="sign">)</span><span class="sign">/</span>v<span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2243 </span>    <span class="keyword">double</span> beta <span class="sign">=</span> <span class="sign">(</span>1<span class="sign">-</span>w<span class="sign">)</span><span class="sign">/</span>w<span class="sign">*</span>alpha<span class="sign">;</span>
<span class="line_number">2244 </span>    <span class="comment">// generate candidate as beta</span>
<span class="line_number">2245 </span>    <span class="keyword">double</span> cand <span class="sign">=</span> rbeta<span class="sign">(</span>alpha<span class="sign">,</span> beta<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2246 </span>    <span class="keyword">if</span><span class="sign">(</span>isnan<span class="sign">(</span>cand<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2247 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>WeightAccept<span class="sign">[</span>0<span class="sign">]</span><span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">2248 </span>        <span class="keyword">return</span><span class="sign">;</span>
<span class="line_number">2249 </span>    <span class="sign">}</span>
<span class="line_number">2250 </span>    <span class="keyword">double</span> alphac <span class="sign">=</span> cand<span class="sign">*</span><span class="sign">(</span>cand<span class="sign">*</span><span class="sign">(</span>1<span class="sign">-</span>cand<span class="sign">)</span><span class="sign">/</span>v<span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2251 </span>    <span class="keyword">double</span> betac <span class="sign">=</span> <span class="sign">(</span>1<span class="sign">-</span>cand<span class="sign">)</span><span class="sign">/</span>cand<span class="sign">*</span>alphac<span class="sign">;</span>
<span class="line_number">2252 </span>    <span class="comment">//base likelihood</span>
<span class="line_number">2253 </span>    <span class="keyword">double</span> baselik <span class="sign">=</span> likfun<span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2254 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> cand<span class="sign">;</span>
<span class="line_number">2255 </span>    <a href="#robo40">ReweightCurve</a><span class="sign">(</span>theCurve<span class="sign">,</span> <span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2256 </span>    <span class="comment">// candidate likelihood</span>
<span class="line_number">2257 </span>    <span class="keyword">double</span> candlik <span class="sign">=</span> likfun<span class="sign">(</span>hazard<span class="sign">,</span> frailty<span class="sign">,</span> regression<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2258 </span>    <span class="comment">// transition rates</span>
<span class="line_number">2259 </span>    <span class="keyword">double</span> puc <span class="sign">=</span> dbeta<span class="sign">(</span>cand<span class="sign">,</span> alpha<span class="sign">,</span> beta<span class="sign">,</span> 0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2260 </span>    <span class="keyword">double</span> pcu <span class="sign">=</span> dbeta<span class="sign">(</span>w<span class="sign">,</span> alphac<span class="sign">,</span> betac<span class="sign">,</span> 0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2261 </span>    <span class="keyword">int</span> acc <span class="sign">=</span> <a href="#robo69">AcceptReject</a><span class="sign">(</span>baselik<span class="sign">,</span> candlik<span class="sign">,</span> pcu<span class="sign">/</span>puc<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2262 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="sign">!</span>acc<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2263 </span>        theCurve<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> oldW<span class="sign">;</span>
<span class="line_number">2264 </span>        <a href="#robo40">ReweightCurve</a><span class="sign">(</span>theCurve<span class="sign">,</span> <span class="sign">-</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2265 </span>    <span class="sign">}</span>
<span class="line_number">2266 </span>    theCurve<span class="sign">-</span><span class="sign">&gt;</span>WeightAccept<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> acc<span class="sign">;</span>
<span class="line_number">2267 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CMetropolisHastings2fUpdatePostvarCurve"></a>
<a name="robo78"></a><h2>CMetropolisHastings/UpdatePostvarCurve [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">CMetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>UpdatePostvarCurve</strong> --- update prior variance for a <a href="#robo23">CCurve</a>
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update the prior variance for the spline and parametric parameters of a hazard or frailty curve,
    with an inverse-gamma prior on the hyperparameters. See also <a href="../R/splinefrailty_r.html#robo152">updatepostvar.curve</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2504 </span><span class="keyword">void</span> <strong>UpdatePostvarCurve</strong><span class="sign">(</span>curveP theCurve<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theCurve      a <a href="#robo23">CCurve</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    theCurve      the input, with SplinePriorVar component updated
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2508 </span><span class="sign">{</span>
<span class="line_number">2509 </span>    <span class="keyword">int</span> c1 <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">2510 </span>    <span class="comment">// spline prior variance</span>
<span class="line_number">2511 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePriorvar<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> <a href="#robo92">rinvgamma</a><span class="sign">(</span>
<span class="line_number">2512 </span>            <span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>nj <span class="sign">/</span> 2 <span class="sign">+</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineHyper<span class="sign">[</span>0<span class="sign">]</span><span class="sign">,</span>
<span class="line_number">2513 </span>            theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePenaltyFactor<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">*</span> <a href="#robo68">SmoothnessPenalty</a><span class="sign">(</span>theCurve<span class="sign">)</span> <span class="sign">*</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplinePriorvar<span class="sign">[</span>0<span class="sign">]</span> 
<span class="line_number">2514 </span>                <span class="sign">+</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineHyper<span class="sign">[</span>1<span class="sign">]</span> <span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2515 </span>
<span class="line_number">2516 </span>    <span class="comment">// parametric component prior variance</span>
<span class="line_number">2517 </span>    <span class="keyword">if</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>hasPar<span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamPriorvar<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> <a href="#robo92">rinvgamma</a><span class="sign">(</span>
<span class="line_number">2518 </span>            <span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>np <span class="sign">/</span> 2 <span class="sign">+</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamHyper<span class="sign">[</span>0<span class="sign">]</span><span class="sign">,</span>
<span class="line_number">2519 </span>            <span class="keyword">pow</span><span class="sign">(</span>F77_CALL<span class="sign">(</span>dnrm2<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>theCurve<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">)</span><span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">,</span>2<span class="sign">)</span><span class="sign">/</span>2 <span class="sign">+</span> 
<span class="line_number">2520 </span>                theCurve<span class="sign">-</span><span class="sign">&gt;</span>ParamHyper<span class="sign">[</span>1<span class="sign">]</span> <span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2521 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CMetropolisHastings2fUpdatePostvarRegression"></a>
<a name="robo79"></a><h2>CMetropolisHastings/UpdatePostvarRegression [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">CMetropolisHastings</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>UpdatePostvarRegression</strong> --- update prior variance for regression coefficients
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update the prior varaince of regression coefficients using inverse-gamma prior and
    the given hyperparameters.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2536 </span><span class="keyword">void</span> <strong>UpdatePostvarRegression</strong><span class="sign">(</span>regressionP theReg<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    theReg        a <a href="#robo25">CRegression</a> structure
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    theReg        the input, with theReg-&gt;priorvar updated
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2540 </span><span class="sign">{</span>
<span class="line_number">2541 </span>    <span class="keyword">int</span> c1 <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">2542 </span>    theReg<span class="sign">-</span><span class="sign">&gt;</span>priorvar<span class="sign">[</span>0<span class="sign">]</span> <span class="sign">=</span> <a href="#robo92">rinvgamma</a><span class="sign">(</span>
<span class="line_number">2543 </span>            <span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>p <span class="sign">/</span> 2 <span class="sign">+</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>hyper<span class="sign">[</span>0<span class="sign">]</span><span class="sign">,</span>
<span class="line_number">2544 </span>            <span class="keyword">pow</span><span class="sign">(</span>F77_CALL<span class="sign">(</span>dnrm2<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>theReg<span class="sign">-</span><span class="sign">&gt;</span>p<span class="sign">)</span><span class="sign">,</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>coefficients<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">,</span>2<span class="sign">)</span><span class="sign">/</span>2<span class="sign">+</span> theReg<span class="sign">-</span><span class="sign">&gt;</span>hyper<span class="sign">[</span>1<span class="sign">]</span> <span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2545 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fdcopyWrapper"></a>
<a name="robo80"></a><h2>CmiscUtils/dcopyWrapper [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>dcopyWrapper</strong> --- wrapper for Fortran call to dcopy
</pre>
<p class="item_name">FUNCTION</p>
<p>    Copies the first n elements of vector x to vector y.
</p>

<p>    Wrapper for BLAS call to dcopy, with fixed incx and incy at 1,
    to make it easier to copy vectors.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">409 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <strong>dcopyWrapper</strong><span class="sign">(</span> <span class="keyword">int</span> n<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>x<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>y<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    n     number of elements to copy
    x     source vector (unchanged on exit)
    y     destination vector
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">413 </span><span class="sign">{</span>
<span class="line_number">414 </span>    <span class="keyword">int</span> c1<span class="sign">=</span>1<span class="sign">;</span>
<span class="line_number">415 </span>    F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>n<span class="sign">,</span> x<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> y<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">416 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fddotWrapper"></a>
<a name="robo81"></a><h2>CmiscUtils/ddotWrapper [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>ddotWrapper</strong> --- Wrapper for Fortran call to ddot
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the dot product of vectors x and y
</p>

<p>    Wrapper for BLAS call to ddot, with fixed incx and incy at 1.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">434 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>ddotWrapper</strong><span class="sign">(</span> <span class="keyword">int</span> n<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>x<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>y<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    n     number of elements
    x     vector 1
    y     vector 2
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    dot product of x and y.
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">438 </span><span class="sign">{</span>
<span class="line_number">439 </span>    <span class="keyword">int</span> c1<span class="sign">=</span>1<span class="sign">;</span>
<span class="line_number">440 </span>    <span class="keyword">return</span> F77_CALL<span class="sign">(</span>ddot<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>n<span class="sign">,</span> x<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> y<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">441 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fdfactorial"></a>
<a name="robo82"></a><h2>CmiscUtils/dfactorial [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>dfactorial</strong> --- compute the factorial of a double
</pre>
<p class="item_name">FUNCTION</p>
<p>    Factorial function, needed by <a href="../R/splinefrailty_r.html#robo172">dnegbin</a> to compute negative binomial density.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">522 </span><span class="keyword">double</span> <strong>dfactorial</strong><span class="sign">(</span><span class="keyword">double</span> x<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    x     double
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    x!
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">526 </span><span class="sign">{</span>
<span class="line_number">527 </span>    <span class="keyword">return</span> x<span class="sign">&gt;</span>1 <span class="sign">?</span> x<span class="sign">*</span><strong>dfactorial</strong><span class="sign">(</span>x<span class="sign">-</span>1<span class="sign">)</span> <span class="sign">:</span> x<span class="sign">;</span>
<span class="line_number">528 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fdiagmvWrapper"></a>
<a name="robo83"></a><h2>CmiscUtils/diagmvWrapper [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>diagmvWrapper</strong> --- Wrapper for Fortran call to diagmv
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the element by element product of vectors v1 and v2.
    This is equivalent to computing diag(v1) %*% v2.
</p>
    
<p>    Wrapper for BLAS call to dsbmv for this special case.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">459 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <strong>diagmvWrapper</strong><span class="sign">(</span><span class="keyword">int</span> n<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>v1<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>v2<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>out<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    n     number of elements to multiply
    v1    first vector
    v2    second vector
    out   storage for output vector
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">463 </span><span class="sign">{</span>
<span class="line_number">464 </span>    <span class="keyword">int</span> c1 <span class="sign">=</span> 1<span class="sign">;</span>
<span class="line_number">465 </span>    <span class="keyword">int</span> c0 <span class="sign">=</span> 0<span class="sign">;</span>
<span class="line_number">466 </span>    <span class="keyword">double</span> d1 <span class="sign">=</span> 1<span class="sign">.</span>0<span class="sign">;</span>
<span class="line_number">467 </span>    <span class="keyword">double</span> d0 <span class="sign">=</span> 0<span class="sign">.</span>0<span class="sign">;</span>
<span class="line_number">468 </span>    char uplo <span class="sign">=</span> <span class="squote">'u'</span><span class="sign">;</span>
<span class="line_number">469 </span>    F77_CALL<span class="sign">(</span>dsbmv<span class="sign">)</span><span class="sign">(</span> <span class="sign">&amp;</span>uplo<span class="sign">,</span> <span class="sign">&amp;</span>n<span class="sign">,</span> <span class="sign">&amp;</span>c0<span class="sign">,</span>
<span class="line_number">470 </span>        <span class="sign">&amp;</span>d1<span class="sign">,</span> v1<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> 
<span class="line_number">471 </span>        v2<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span>
<span class="line_number">472 </span>        <span class="sign">&amp;</span>d0<span class="sign">,</span> out<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">473 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fdmax"></a>
<a name="robo84"></a><h2>CmiscUtils/dmax [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>dmax</strong> --- maximum of two doubles
</pre>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">321 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>dmax</strong><span class="sign">(</span><span class="keyword">double</span> x<span class="sign">,</span> <span class="keyword">double</span> y<span class="sign">)</span> 
</pre>
<p class="item_name">INPUTS</p>
<pre>   x,y    doubles
</pre>
<p class="item_name">OUTPUTS</p>
<pre>   max(x,y)
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">325 </span><span class="sign">{</span>
<span class="line_number">326 </span>    <span class="keyword">return</span> x<span class="sign">&gt;</span>y <span class="sign">?</span> x <span class="sign">:</span> y<span class="sign">;</span>
<span class="line_number">327 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fdmin"></a>
<a name="robo85"></a><h2>CmiscUtils/dmin [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>dmin</strong> --- minimum of two doubles
</pre>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">303 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>dmin</strong><span class="sign">(</span><span class="keyword">double</span> x<span class="sign">,</span> <span class="keyword">double</span> y<span class="sign">)</span> 
</pre>
<p class="item_name">INPUTS</p>
<pre>    x, y  doubles
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    min(x,y)
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">307 </span><span class="sign">{</span>
<span class="line_number">308 </span>    <span class="keyword">return</span> x<span class="sign">&lt;</span>y <span class="sign">?</span> x <span class="sign">:</span> y<span class="sign">;</span>
<span class="line_number">309 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fdnegbin"></a>
<a name="robo86"></a><h2>CmiscUtils/dnegbin [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>dnegbin</strong> --- negative binomial density
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the density of a NB(r,p) evaluated at x.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">555 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>dnegbin</strong><span class="sign">(</span><span class="keyword">double</span> x<span class="sign">,</span> <span class="keyword">double</span> r<span class="sign">,</span> <span class="keyword">double</span> p<span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">559 </span><span class="sign">{</span>
<span class="line_number">560 </span>    <span class="keyword">double</span> out <span class="sign">=</span> gammafn<span class="sign">(</span>x<span class="sign">+</span>r<span class="sign">)</span><span class="sign">/</span><span class="sign">(</span> <a href="#robo82">dfactorial</a><span class="sign">(</span>x<span class="sign">)</span><span class="sign">)</span><span class="sign">/</span>gammafn<span class="sign">(</span>r<span class="sign">)</span><span class="sign">*</span><span class="keyword">pow</span><span class="sign">(</span>p<span class="sign">,</span>r<span class="sign">)</span><span class="sign">*</span><span class="keyword">pow</span><span class="sign">(</span>1<span class="sign">-</span>p<span class="sign">,</span>x<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">561 </span>    <span class="keyword">return</span> out<span class="sign">;</span>
<span class="line_number">562 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fEvalNknotsPrior"></a>
<a name="robo87"></a><h2>CmiscUtils/EvalNknotsPrior [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>EvalNknotsPrior</strong> --- evaluate the prior on the number of knots
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the prior probability of a given number of knots for a curve. Used
    in <a href="#robo70">MH_BDM</a>.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1457 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>EvalNknotsPrior</strong><span class="sign">(</span> <span class="keyword">int</span> nknots<span class="sign">,</span> curveP theCurve<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>     nknots       the value at which the prior should be evaluated
     theCurve     a <a href="#robo23">CCurve</a> structure with SplineNknotsPrior and SplineNknotsHyper components
</pre>
<p class="item_name">OUTPUTS</p>
<pre>     p        prior probability of nknots for a distribution given by SplineNknotsPrior
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1461 </span><span class="sign">{</span>
<span class="line_number">1462 </span>    <span class="keyword">double</span> dnknots <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span> nknots<span class="sign">;</span>
<span class="line_number">1463 </span>    <span class="comment">// fetch the prior probability distribution</span>
<span class="line_number">1464 </span>    nknotsprior prior <span class="sign">=</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsPrior<span class="sign">;</span>
<span class="line_number">1465 </span>    <span class="comment">// evaluate different types of distribution</span>
<span class="line_number">1466 </span>    <span class="keyword">if</span><span class="sign">(</span>prior<span class="sign">=</span><span class="sign">=</span>PrPoisson<span class="sign">)</span>  <span class="comment">// Poisson prior</span>
<span class="line_number">1467 </span>        <span class="keyword">return</span> dpois<span class="sign">(</span> dnknots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsHyper<span class="sign">[</span>0<span class="sign">]</span><span class="sign">,</span> 0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1468 </span>    <span class="keyword">if</span><span class="sign">(</span>prior<span class="sign">=</span><span class="sign">=</span>PrGeometric<span class="sign">)</span>  <span class="comment">// Geometric prior</span>
<span class="line_number">1469 </span>        <span class="keyword">return</span> dgeom<span class="sign">(</span> dnknots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsHyper<span class="sign">[</span>0<span class="sign">]</span><span class="sign">,</span> 0<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1470 </span>    <span class="keyword">if</span><span class="sign">(</span>prior<span class="sign">=</span><span class="sign">=</span>PrPoissonMix<span class="sign">)</span>  <span class="comment">// Poisson mixture</span>
<span class="line_number">1471 </span>        <span class="keyword">return</span> 0<span class="sign">.</span>5<span class="sign">*</span><span class="sign">(</span> dpois<span class="sign">(</span> dnknots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsHyper<span class="sign">[</span>0<span class="sign">]</span><span class="sign">,</span> 0<span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">1472 </span>                dpois<span class="sign">(</span> dnknots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsHyper<span class="sign">[</span>0<span class="sign">]</span><span class="sign">,</span> 0<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1473 </span>    <span class="keyword">if</span><span class="sign">(</span>prior<span class="sign">=</span><span class="sign">=</span>PrNegBin<span class="sign">)</span>  <span class="comment">// Negative binomial</span>
<span class="line_number">1474 </span>        <span class="keyword">return</span> <a href="../R/splinefrailty_r.html#robo172">dnegbin</a><span class="sign">(</span> dnknots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsHyper<span class="sign">[</span>0<span class="sign">]</span><span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsHyper<span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1475 </span>    <span class="keyword">if</span><span class="sign">(</span>prior<span class="sign">=</span><span class="sign">=</span>PrPower<span class="sign">)</span>  <span class="comment">// Power</span>
<span class="line_number">1476 </span>        <span class="keyword">return</span> <span class="keyword">pow</span><span class="sign">(</span> dnknots<span class="sign">,</span> theCurve<span class="sign">-</span><span class="sign">&gt;</span>SplineNknotsHyper<span class="sign">[</span>0<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1477 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fgetListElement"></a>
<a name="robo88"></a><h2>CmiscUtils/getListElement [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>getListElement</strong> --- get an element of a SEXP list by name
</pre>
<p class="item_name">FUNCTION</p>
<p>    Given an R list structure as a SEXP, get a named list element. This is taken
    almost verbatim from "Writing R extensions".
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">379 </span>SEXP <strong>getListElement</strong><span class="sign">(</span>SEXP <span class="keyword">list</span><span class="sign">,</span> const char <span class="sign">*</span>str<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    list  a list in R memory
    str   the name of the desired element
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    elmt  a pointer to the element of list whose name is str
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">383 </span><span class="sign">{</span>
<span class="line_number">384 </span>    SEXP elmt <span class="sign">=</span> R_NilValue<span class="sign">,</span> names <span class="sign">=</span> getAttrib<span class="sign">(</span><span class="keyword">list</span><span class="sign">,</span> R_NamesSymbol<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">385 </span>    <span class="keyword">int</span> i<span class="sign">;</span>
<span class="line_number">386 </span>    <span class="keyword">for</span> <span class="sign">(</span>i <span class="sign">=</span> 0<span class="sign">;</span> i <span class="sign">&lt;</span> <span class="keyword">length</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">)</span><span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span>
<span class="line_number">387 </span>     <span class="keyword">if</span><span class="sign">(</span>strcmp<span class="sign">(</span>CHAR<span class="sign">(</span>STRING_ELT<span class="sign">(</span>names<span class="sign">,</span> i<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> str<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">388 </span>       elmt <span class="sign">=</span> VECTOR_ELT<span class="sign">(</span><span class="keyword">list</span><span class="sign">,</span> i<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">389 </span>       break<span class="sign">;</span>
<span class="line_number">390 </span>     <span class="sign">}</span>
<span class="line_number">391 </span>    <span class="keyword">return</span> elmt<span class="sign">;</span>
<span class="line_number">392 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fimax"></a>
<a name="robo89"></a><h2>CmiscUtils/imax [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>imax</strong> --- maximum of two integers
</pre>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">357 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>imax</strong><span class="sign">(</span><span class="keyword">int</span> x<span class="sign">,</span> <span class="keyword">int</span> y<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    x,y   integers
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    max(x,y)
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">361 </span><span class="sign">{</span>
<span class="line_number">362 </span>    <span class="keyword">return</span> x<span class="sign">&gt;</span>y <span class="sign">?</span> x <span class="sign">:</span> y<span class="sign">;</span>
<span class="line_number">363 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fimin"></a>
<a name="robo90"></a><h2>CmiscUtils/imin [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>imin</strong> --- minimum of two integers
</pre>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">339 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>imin</strong><span class="sign">(</span><span class="keyword">int</span> x<span class="sign">,</span> <span class="keyword">int</span> y<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>     x,y  integers
</pre>
<p class="item_name">OUTPUTS</p>
<pre>     min(x,y)
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">343 </span><span class="sign">{</span>
<span class="line_number">344 </span>    <span class="keyword">return</span> x<span class="sign">&lt;</span>y <span class="sign">?</span> x <span class="sign">:</span> y<span class="sign">;</span>
<span class="line_number">345 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fmvrnorm"></a>
<a name="robo91"></a><h2>CmiscUtils/mvrnorm [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mvrnorm</strong> --- multivariate normal random numbers
</pre>
<p class="item_name">FUNCTION</p>
<p>    Generate multivariate normal random numbers, given a mean and Cholesky-factored
    covariance matrix.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">490 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <strong>mvrnorm</strong><span class="sign">(</span><span class="keyword">int</span> n<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>out<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>mu<span class="sign">,</span> <span class="keyword">double</span> <span class="sign">*</span>CholSigma<span class="sign">,</span> <span class="keyword">double</span> tun<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    n         length of the vector to be generated
    out       storage for output of length n
    mu        mean vector (length n)
    CholSigma Cholesky factorization of the covariance matrix nxn
    tun       tuning parameter for the variance
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">494 </span><span class="sign">{</span>
<span class="line_number">495 </span>    <span class="keyword">double</span> <span class="sign">*</span> temp <span class="sign">=</span> <span class="sign">(</span><span class="keyword">double</span> <span class="sign">*</span><span class="sign">)</span> <span class="keyword">malloc</span><span class="sign">(</span>n <span class="sign">*</span> sizeof<span class="sign">(</span><span class="keyword">double</span><span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">496 </span>    <span class="comment">// iid N(0,1) random numbers:</span>
<span class="line_number">497 </span>    <span class="keyword">for</span><span class="sign">(</span><span class="keyword">int</span> i<span class="sign">=</span>0<span class="sign">;</span> i<span class="sign">&lt;</span>n<span class="sign">;</span> i<span class="sign">+</span><span class="sign">+</span><span class="sign">)</span> temp<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">=</span> <span class="keyword">rnorm</span><span class="sign">(</span>0<span class="sign">,</span>1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">498 </span>    <span class="keyword">int</span> c1<span class="sign">=</span>1<span class="sign">;</span> 
<span class="line_number">499 </span>    char trans<span class="sign">=</span><span class="squote">'T'</span><span class="sign">;</span>
<span class="line_number">500 </span>    <span class="keyword">double</span> c0<span class="sign">=</span>0<span class="sign">;</span>
<span class="line_number">501 </span>    <span class="keyword">double</span> c1d<span class="sign">=</span>1<span class="sign">;</span>
<span class="line_number">502 </span>    <span class="keyword">double</span> sqrttun <span class="sign">=</span> <span class="keyword">sqrt</span><span class="sign">(</span>tun<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">503 </span>    <span class="comment">// set out = 0*out + t(Ch)%*%temp</span>
<span class="line_number">504 </span>    F77_CALL<span class="sign">(</span>dgemv<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>trans<span class="sign">,</span> <span class="sign">&amp;</span>n<span class="sign">,</span> <span class="sign">&amp;</span>n<span class="sign">,</span> <span class="sign">&amp;</span>sqrttun<span class="sign">,</span> CholSigma<span class="sign">,</span> <span class="sign">&amp;</span>n<span class="sign">,</span> temp<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> <span class="sign">&amp;</span>c0<span class="sign">,</span> out<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">505 </span>    <span class="comment">// out = out + mu</span>
<span class="line_number">506 </span>    F77_CALL<span class="sign">(</span>daxpy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span>n<span class="sign">,</span> <span class="sign">&amp;</span>c1d<span class="sign">,</span> mu<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> out<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">507 </span>    <span class="keyword">free</span><span class="sign">(</span>temp<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">508 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2frinvgamma"></a>
<a name="robo92"></a><h2>CmiscUtils/rinvgamma [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>rinvgamma</strong> --- inverse gamma random numbers
</pre>
<p class="item_name">FUNCTION</p>
<p>    Generate inverse gamma random numbers, using the gamma RNG function in R.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">538 </span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">double</span> <strong>rinvgamma</strong><span class="sign">(</span><span class="keyword">double</span> shape<span class="sign">,</span> <span class="keyword">double</span> scale<span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">542 </span><span class="sign">{</span>
<span class="line_number">543 </span>    <span class="keyword">double</span> out <span class="sign">=</span> 1<span class="sign">.</span>0 <span class="sign">/</span> <span class="keyword">rgamma</span><span class="sign">(</span>shape<span class="sign">,</span> 1<span class="sign">.</span>0<span class="sign">/</span>scale<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">544 </span>    <span class="keyword">return</span> out<span class="sign">;</span>
<span class="line_number">545 </span><span class="sign">}</span>
</pre>

<hr />
<a name="CmiscUtils2fUpdateHistory"></a>
<a name="robo93"></a><h2>CmiscUtils/UpdateHistory [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo11">CmiscUtils</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>UpdateHistory</strong> --- update history of parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Store the state of the chain at the current iteration in the <a href="#robo24">CHistory</a> structure
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2561 </span><span class="keyword">void</span> <strong>UpdateHistory</strong><span class="sign">(</span>curveP hazard<span class="sign">,</span> curveP frailty<span class="sign">,</span> regressionP regression<span class="sign">,</span> historyP history<span class="sign">,</span> <span class="keyword">int</span> iter<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    hazard        <a href="#robo23">CCurve</a> for the hazard
    frailty       <a href="#robo23">CCurve</a> for the frailty
    regression    <a href="#robo25">CRegression</a> structure
    history       a <a href="#robo24">CHistory</a> structure
    iter          the current iteration counter
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2565 </span><span class="sign">{</span>
<span class="line_number">2566 </span>    <span class="keyword">int</span> c1<span class="sign">=</span>1<span class="sign">;</span>
<span class="line_number">2567 </span>    <span class="keyword">int</span> ny <span class="sign">=</span> history<span class="sign">-</span><span class="sign">&gt;</span>ny<span class="sign">;</span>
<span class="line_number">2568 </span>    <span class="comment">// store frailties</span>
<span class="line_number">2569 </span>    F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nx<span class="sign">)</span><span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>X<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> history<span class="sign">-</span><span class="sign">&gt;</span>frailty <span class="sign">+</span> iter<span class="sign">-</span>1<span class="sign">,</span> <span class="sign">&amp;</span><span class="sign">(</span>history<span class="sign">-</span><span class="sign">&gt;</span>ny<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2570 </span>    <span class="comment">// store regression coefficients</span>
<span class="line_number">2571 </span>    F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>regression<span class="sign">-</span><span class="sign">&gt;</span>p<span class="sign">)</span><span class="sign">,</span> regression<span class="sign">-</span><span class="sign">&gt;</span>coefficients<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> history<span class="sign">-</span><span class="sign">&gt;</span>coefficients <span class="sign">+</span> iter<span class="sign">-</span>1<span class="sign">,</span>
<span class="line_number">2572 </span>            <span class="sign">&amp;</span><span class="sign">(</span>history<span class="sign">-</span><span class="sign">&gt;</span>ny<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2573 </span>
<span class="line_number">2574 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2575 </span>        <span class="comment">// store frailty spline knots and parameters</span>
<span class="line_number">2576 </span>        <span class="keyword">int</span> lknots <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots <span class="sign">+</span> 2<span class="sign">*</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">;</span>
<span class="line_number">2577 </span>        F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> history<span class="sign">-</span><span class="sign">&gt;</span>FrailtySplinePar <span class="sign">+</span> iter<span class="sign">-</span>1<span class="sign">,</span>
<span class="line_number">2578 </span>                <span class="sign">&amp;</span><span class="sign">(</span>history<span class="sign">-</span><span class="sign">&gt;</span>ny<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2579 </span>        F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>lknots<span class="sign">)</span><span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> history<span class="sign">-</span><span class="sign">&gt;</span>FrailtySplineKnots <span class="sign">+</span> iter<span class="sign">-</span>1<span class="sign">,</span>
<span class="line_number">2580 </span>                <span class="sign">&amp;</span><span class="sign">(</span>history<span class="sign">-</span><span class="sign">&gt;</span>ny<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2581 </span>        history<span class="sign">-</span><span class="sign">&gt;</span>FrailtySplineFvar<span class="sign">[</span>iter<span class="sign">-</span>1<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineFvar<span class="sign">;</span>
<span class="line_number">2582 </span>    <span class="sign">}</span>
<span class="line_number">2583 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2584 </span>        <span class="comment">// store hazard spline knots and parameters</span>
<span class="line_number">2585 </span>        <span class="keyword">int</span> lknots <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineNknots <span class="sign">+</span> 2<span class="sign">*</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineOrd<span class="sign">;</span>
<span class="line_number">2586 </span>        F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>nj<span class="sign">)</span><span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplinePar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> history<span class="sign">-</span><span class="sign">&gt;</span>HazardSplinePar <span class="sign">+</span> iter<span class="sign">-</span>1<span class="sign">,</span>
<span class="line_number">2587 </span>                <span class="sign">&amp;</span><span class="sign">(</span>history<span class="sign">-</span><span class="sign">&gt;</span>ny<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2588 </span>        F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>lknots<span class="sign">)</span><span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineKnots<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> history<span class="sign">-</span><span class="sign">&gt;</span>HazardSplineKnots <span class="sign">+</span> iter<span class="sign">-</span>1<span class="sign">,</span>
<span class="line_number">2589 </span>                <span class="sign">&amp;</span><span class="sign">(</span>history<span class="sign">-</span><span class="sign">&gt;</span>ny<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2590 </span>    <span class="sign">}</span>
<span class="line_number">2591 </span>    <span class="comment">// store parametric component parameters</span>
<span class="line_number">2592 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>hasPar<span class="sign">)</span>
<span class="line_number">2593 </span>        F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">)</span><span class="sign">,</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> history<span class="sign">-</span><span class="sign">&gt;</span>FrailtyParamPar <span class="sign">+</span> iter<span class="sign">-</span>1<span class="sign">,</span>
<span class="line_number">2594 </span>                <span class="sign">&amp;</span><span class="sign">(</span>history<span class="sign">-</span><span class="sign">&gt;</span>ny<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2595 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>hasPar<span class="sign">)</span>
<span class="line_number">2596 </span>        F77_CALL<span class="sign">(</span>dcopy<span class="sign">)</span><span class="sign">(</span><span class="sign">&amp;</span><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>np<span class="sign">)</span><span class="sign">,</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamPar<span class="sign">,</span> <span class="sign">&amp;</span>c1<span class="sign">,</span> history<span class="sign">-</span><span class="sign">&gt;</span>HazardParamPar <span class="sign">+</span> iter<span class="sign">-</span>1<span class="sign">,</span>
<span class="line_number">2597 </span>                <span class="sign">&amp;</span><span class="sign">(</span>history<span class="sign">-</span><span class="sign">&gt;</span>ny<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">2598 </span>    <span class="comment">// store weights</span>
<span class="line_number">2599 </span>    <span class="keyword">if</span><span class="sign">(</span>hazard<span class="sign">-</span><span class="sign">&gt;</span>hasPar <span class="sign">&amp;</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span>
<span class="line_number">2600 </span>        history<span class="sign">-</span><span class="sign">&gt;</span>HazardWeight<span class="sign">[</span>iter<span class="sign">-</span>1<span class="sign">]</span> <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2601 </span>    <span class="keyword">if</span><span class="sign">(</span>frailty<span class="sign">-</span><span class="sign">&gt;</span>hasPar <span class="sign">&amp;</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>hasSpline<span class="sign">)</span>
<span class="line_number">2602 </span>        history<span class="sign">-</span><span class="sign">&gt;</span>FrailtyWeight<span class="sign">[</span>iter<span class="sign">-</span>1<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>Weight<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2603 </span>
<span class="line_number">2604 </span>    <span class="comment">// store prior variances</span>
<span class="line_number">2605 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>priorvar<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>0<span class="sign">]</span> <span class="sign">=</span> regression<span class="sign">-</span><span class="sign">&gt;</span>priorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2606 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>priorvar<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>1<span class="sign">]</span> <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplinePriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2607 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>priorvar<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>2<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplinePriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2608 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>priorvar<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>3<span class="sign">]</span> <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamPriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2609 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>priorvar<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>4<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>ParamPriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2610 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>priorvar<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>5<span class="sign">]</span> <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>WeightPriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2611 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>priorvar<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>6<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>WeightPriorvar<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2612 </span>
<span class="line_number">2613 </span>    <span class="comment">// store acceptance rates</span>
<span class="line_number">2614 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>accept<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>0<span class="sign">]</span> <span class="sign">=</span> regression<span class="sign">-</span><span class="sign">&gt;</span>Accept<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2615 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>accept<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>1<span class="sign">]</span> <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>SplineAccept<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2616 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>accept<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>2<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>SplineAccept<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2617 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>accept<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>3<span class="sign">]</span> <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>ParamAccept<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2618 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>accept<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>4<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>ParamAccept<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2619 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>accept<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>5<span class="sign">]</span> <span class="sign">=</span> hazard<span class="sign">-</span><span class="sign">&gt;</span>WeightAccept<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2620 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>accept<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>6<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>WeightAccept<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2621 </span>    history<span class="sign">-</span><span class="sign">&gt;</span>accept<span class="sign">[</span>iter<span class="sign">-</span>1 <span class="sign">+</span> ny<span class="sign">*</span>7<span class="sign">]</span> <span class="sign">=</span> frailty<span class="sign">-</span><span class="sign">&gt;</span>Accept<span class="sign">[</span>0<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">2622 </span><span class="sign">}</span>
</pre>

</div> <!-- content -->
<div id="footer">
<p>Generated from ./splinesurv/src/mainloop.c with <a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> V4.99.36 on Fri Jun 27 2008 18:25:39
</p>
</div> <!-- footer -->
</body>
</html>
